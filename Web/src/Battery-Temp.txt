using System;
using System.Data;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data.SqlClient;
using System.Drawing;
using System.Globalization;
using Obout.Grid;
using System.Diagnostics;
using System.Configuration;
using System.Diagnostics.Eventing.Reader;
using static System.Net.WebRequestMethods;

namespace WebApp
{

    public partial class BatteryReadingsTemp : System.Web.UI.Page
    {
        public static string CallNbr = string.Empty;
        public static int EquipID = 0;
        public int BatteryAge = 0;
        public static string BatStrId = string.Empty;
        public static string TechID = string.Empty;
        EtechDataAcess.DAL da = new EtechDataAcess.DAL();
        EtechDataAcess.LogProperties objlog = new EtechDataAcess.LogProperties();
        EtechDataAcess.LoginProfile LP = new EtechDataAcess.LoginProfile();
        protected void Page_Load(object sender, EventArgs e)
        {
            btnSave.Attributes.Add("OnClick", "return Validate();");
            btn2Save.Attributes.Add("OnClick", "return Validate();");
            btn3Save.Attributes.Add("OnClick", "return Validate();");

            CallNbr = Request.QueryString["CallNbr"];
            EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
            BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);

            TechID = Request.QueryString["Tech"];
            if (!Page.IsPostBack)
            {
                try
                {
                    BindManufs();
                    
                   
                    lblSummary.Text = "Job No :" + CallNbr + " -- Equipment:" + BatStrId + " -- Id :" + EquipID.ToString();
                    DisplayBatteryStringInfo();
                    BindReferenceValues();
                    DisplayBatteryInfo();
                    //DisplayReconciliationInfo();
                    //ShowHideGridColumns();
                }
                catch (Exception ex)
                {
                    
                    objlog.ProcessName = "ETech.BatteryReadings";
                    objlog.MethodName = "Page_Load";
                    objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                    objlog.CreatedBy = LP.getUID();
                    LP.InsertLog(objlog);
                    lblErrMsg.ForeColor = Color.Red;
                    lblErrMsg.Text = ex.Message;
                }

            }
            backLink.NavigateUrl = "DTechEquipDetails.aspx?CallNbr=" + CallNbr + "&Tech=" + TechID + "&Digest=" + Request.QueryString["Digest"] + "&TechName=" + Request.QueryString["TechName"];
        }

        private decimal cvtDecimal(string p_num)
        {
            decimal result = 0m;
            try
            {
                result = Convert.ToDecimal(p_num);
            }
            catch (Exception)
            {
                //ex.Message();
            }
            return result;

        }
        private double cvtDouble(string p_num)
        {
            double result = 0.0;
            try
            {
                result = Double.Parse(p_num);
            }
            catch (Exception)
            {
                //ex.Message();
            }
            return result;

        }
        public string GetEmpStatus()
        {
            string value = string.Empty;
            DataSet EmpStatus = da.GetEmployeeStatusForJobList();
            if (EmpStatus != null)
            {
                foreach (DataRow dr in EmpStatus.Tables[0].Rows)
                {
                    if (dr["Status"].ToString() == "Technician")
                    {
                        ddlRepMonCal.Enabled = false;
                        ddlRepMonCal.SelectedValue = "1";


                    }
                    else if ((dr["Status"].ToString() == "Manager") || (dr["Status"].ToString() == "Other"))
                    {
                       
                        
                    }
                    else
                    {
                        Response.Redirect("GetETechLoginID.aspx", false);
                    }
                }

            }
            return value;
        }
        public string GetEquipStatus()
        {
            CallNbr = Request.QueryString["CallNbr"];
            EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
            BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);
            string ResultStatus = "Online";
            //if (ResultStatus == "Offline" || ResultStatus == "OnLine(MajorDeficiency)")
            //{
            //    return ResultStatus;
            //}
            try
            {
                if ((ddlStatus.SelectedValue != "Offline"))
                {
                    if(cvt2Int(txtUsedQuantity.Text)>0)
                    {
                        return "CriticalDeficiency";
                    }
                    else if (RecommendtoReplace() || (ddlReasonToReplace.SelectedValue == "DA" && chkReplace.Checked))
                    {
                        ResultStatus = "ReplacementRecommended";
                        return ResultStatus;
                    }
                    else if(ProactiveReplace())
                    {
                        ResultStatus = "ProactiveReplacement";
                        return ResultStatus;
                    }
                    else
                    {
                        if (ddlStatus.SelectedValue != "Online")
                            ResultStatus = ddlStatus.SelectedValue;
                    }
                }
                else
                {
                    return "CriticalDeficiency";
                }
                DataSet dsDetails = new DataSet();
                DataSet dsStatus = new DataSet();
                dsDetails = da.JobSummaryReportTemp(CallNbr, EquipID, "BATTERY", "T");
                dsStatus = da.GetStatusDescription("BATTERY");

                if (dsDetails != null && dsStatus!=null)
                {

                    if (dsDetails.Tables[0].Rows.Count > 0)
                    {

                        string TempField = string.Empty;

                        for (int z = 0; z < dsDetails.Tables[0].Columns.Count - 1; z++)
                        {
                            string TempColumn = dsDetails.Tables[0].Columns[z].ColumnName;
                            TempField = dsDetails.Tables[0].Rows[0][TempColumn].ToString();
                            if (TempColumn.Contains("Action"))
                            {
                                if (TempField == "Y")
                                {
                                    if ((ResultStatus != "OnLine(MajorDeficiency)") && (ResultStatus != "ReplacementRecommended") && (ResultStatus != "ProactiveReplacement"))
                                    {
                                        ResultStatus = "OnLine(MinorDeficiency)";
                                    }
                                    foreach (DataRow dr in dsStatus.Tables[0].Rows)
                                    {
                                        if (TempColumn == dr["ColumnName"].ToString().Trim())
                                        {
                                            //lblStatusNotes.Visible = true;
                                            //txtUsedCmts.Visible = true;
                                            //btnSave.Attributes.Add("onClick", "if(!confirm('Are you sure you want to delete this entry?')) return false;");
                                            if (dr["StatusType"].ToString().Trim() == "CriticalDeficiency")
                                            {
                                                return "CriticalDeficiency";
                                            }
                                            else if (dr["StatusType"].ToString().Trim() == "ReplacementRecommended")
                                            {
                                                ResultStatus = "ReplacementRecommended";
                                            }
                                            else if (dr["StatusType"].ToString().Trim() == "OnLine(MajorDeficiency)")
                                            {
                                                ResultStatus = "OnLine(MajorDeficiency)";
                                            }

                                        }

                                    }

                                }

                            }
                            else
                            {

                                if ((TempField == "N" || TempField == "F" || TempField == "True" || TempField == "12") && (TempColumn != "BatteryPackCount") && (TempColumn != "SaveAsDraft") && (TempColumn != "BatteryTypeName") && (TempColumn != "chkmVAC") && (TempColumn != "chkStrap"))
                                {
                                    if ((ResultStatus != "OnLine(MajorDeficiency)") && (ResultStatus != "ReplacementRecommended") && (ResultStatus != "ProactiveReplacement"))
                                    {
                                        ResultStatus = "OnLine(MinorDeficiency)";
                                    }
                                    foreach (DataRow dr in dsStatus.Tables[0].Rows)
                                    {
                                        if (TempColumn == dr["ColumnName"].ToString().Trim())
                                        {
                                            //lblStatusNotes.Visible = true;
                                            //txtUsedCmts.Visible = true;
                                            //btnSave.Attributes.Add("onClick", "if(!confirm('Are you sure you want to delete this entry?')) return false;");
                                            if (dr["StatusType"].ToString().Trim() == "CriticalDeficiency")
                                            {
                                                return "CriticalDeficiency";
                                            }
                                            else if (dr["StatusType"].ToString().Trim() == "ReplacementRecommended")
                                            {
                                                ResultStatus = "ReplacementRecommended";
                                            }
                                            else if (dr["StatusType"].ToString().Trim() == "OnLine(MajorDeficiency)")
                                            {
                                                ResultStatus = "OnLine(MajorDeficiency)";
                                            }
                                            else if (dr["StatusType"].ToString().Trim() == "ProactiveReplacement")
                                            {
                                                ResultStatus = "ProactiveReplacement";
                                            }


                                        }

                                    }
                                }



                            }

                        }


                    }
                    
                }
            }

            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "GetEquipmentStatus";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }

            return ResultStatus;


        }
        public double getBatteryTypeValue()
        {
            double BatteryType = 12;
            try
            {
                switch (ddlUsedBatteryType.SelectedValue)
                {
                    case "1V":
                        BatteryType = 1.2;
                        break;
                    case "2V":
                        BatteryType = 2;
                        break;
                    case "4V":
                        BatteryType = 4;
                        break;
                    case "8V":
                        BatteryType = 8;
                        break;
                    case "TV":
                        BatteryType = 10;
                        break;
                    case "V":
                        BatteryType = 12;
                        break;
                    case "FV":
                        BatteryType = 12;
                        break;
                    case "SV":
                        BatteryType = 16;
                        break;
                    case "6V":
                        BatteryType = 6;
                        break;
                    case "FL":
                        BatteryType = 12;
                        break;
                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "getBatteryTypeValue";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();

            }

            return BatteryType;
        }
        public int getBatteryAge()
        {

            try
            {
                switch (ddlUsedBatteryType.SelectedValue)
                {
                    case "2V":
                        BatteryAge = 15;
                        break;
                    case "4V":
                        BatteryAge = 15;
                        break;
                    case "8V":
                        BatteryAge = 15;
                        break;
                    case "TV":
                        BatteryAge = 10;
                        break;
                    case "V":
                        if (ddlBattType.SelectedValue == "L")
                        {
                            BatteryAge = 10;
                        }
                        else if (ddlBattType.SelectedValue == "S")
                        {
                            BatteryAge = 4;
                        }
                        else if (ddlBattType.SelectedValue == "F")
                        {
                            BatteryAge = 15;
                        }
                        else
                        {
                            BatteryAge = 20;
                        }
                        break;
                    case "FV":
                        BatteryAge = 10;
                        break;
                    case "SV":
                        BatteryAge = 10;
                        break;
                    case "6V":
                        BatteryAge = 10;
                        break;
                    case "FL":
                        BatteryAge = 15;
                        break;
                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "getBatteryAge";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();

            }

            return BatteryAge;
        }

        public void CalculateBatteryDef()
        {
            EtechDataAcess.ETechEquipmentData dl = new EtechDataAcess.ETechEquipmentData();
            //decimal Monitor1 = 0;
            decimal Monitor2 = 0;
            decimal Replace = 0;
            decimal VDC = 0;
            decimal MHOS = 0;
            decimal refValue = 0;
            decimal MHWarning = 0;
            decimal MHError = 0;

            int TotReplace = 0;
            int TotMonitor = 0;

            try
            {
                SqlDataReader reader = dl.GetBatteryTypeValues(ddlUsedBatteryType.SelectedValue, ddlBattType.SelectedValue, ddlFloatVoltS.SelectedValue, cvt2Int(ddlFloatVoltV.SelectedValue));
                if (reader != null)
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            //Monitor1 = cvtDecimal(reader["MonitorStrt"].ToString());
                            Monitor2 = cvtDecimal(reader["MonitorEnd"].ToString());
                            Replace = cvtDecimal(reader["Replace"].ToString());
                            BatteryAge = cvt2Int(reader["BatteryAge"].ToString());
                        }
                    }
                }
                if (ddlReadingType.SelectedValue == "2")
                {
                    refValue = cvtDecimal(txtRefValue.Text);
                    if(ddlMidType.SelectedValue=="1")
                    {
                        MHWarning = refValue * 70 / 100;
                        MHError = refValue * 60 / 100;
                    }
                    else
                    {
                        MHWarning = refValue * 140 / 100;
                        MHError = refValue * 150 / 100;
                    }
                    
                }
                else if (ddlReadingType.SelectedValue == "3")
                {
                    Replace = cvtDecimal((Convert.ToInt32(txtBatteriesNo.Text) * getBatteryTypeValue() + 0.2).ToString());
                    Monitor2 = cvtDecimal((Convert.ToInt32(txtBatteriesNo.Text) * getBatteryTypeValue() + 0.5).ToString());
                    //Monitor1 = cvtDecimal(txtBatteriesNo.Text) * cvtDecimal("12.5");
                    //MHError = refValue * 60 / 100;

                }
                if (ddlRepMonCal.SelectedValue == "1")
                {
                    foreach (GridViewRow dg in dgReadingsTemp.Rows)
                    {

                        TextBox TempVDCText = (TextBox)dg.FindControl("txtTempVDC");

                        TextBox TempMHOSText = (TextBox)dg.FindControl("txtTempMHOS");

                        TextBox TempActionPlan = (TextBox)dg.FindControl("txtTempAction");
                        DropDownList ddlReplace = (DropDownList)dg.FindControl("ddlReplace");
                        DropDownList ddlMonitor = (DropDownList)dg.FindControl("ddlMonitor");
                        DropDownList ddlCrack = (DropDownList)dg.FindControl("ddlCrack");

                        VDC = cvtDecimal(TempVDCText.Text);
                        MHOS = cvtDecimal(TempMHOSText.Text);

                        if (VDC <= Replace)
                        {
                            TempActionPlan.Text = "Float voltage is less than or equal to " + Replace + ". To be Replaced";
                            ddlReplace.SelectedValue = "Y";
                            ddlMonitor.SelectedValue = "N";
                            TotReplace += 1;

                        }
                        else if (VDC <= Monitor2)
                        {
                            TempActionPlan.Text = "Float voltage is less than or equal to " + Monitor2 + ". To be Monitored";
                            ddlMonitor.SelectedValue = "Y";
                            ddlReplace.SelectedValue = "N";
                            TotMonitor += 1;
                        }
                        else
                        {
                            ddlReplace.SelectedValue = "N";
                            ddlMonitor.SelectedValue = "N";
                            if(ddlCrack.SelectedValue!="F")
                            {
                                TempActionPlan.Text = "";
                            }
                            else
                            {
                                TempActionPlan.Text = "Battery is leaking / damaged / corrosion";
                            }
                            
                        }
                        if (ddlReadingType.SelectedValue == "2")
                        {
                            MHOS = cvtDecimal(TempMHOSText.Text);
                            if(ddlMidType.SelectedValue=="1")
                            {
                                if (MHOS <= MHError)
                                {
                                    if (ddlReplace.SelectedValue == "N")
                                    {
                                        TempActionPlan.Text = "Fail value:" + MHError + ". Battery to be Replaced";
                                        ddlReplace.SelectedValue = "Y";
                                        ddlMonitor.SelectedValue = "N";
                                        TotReplace += 1;
                                    }
                                }
                                else if (MHOS <= MHWarning)
                                {
                                    if (ddlMonitor.SelectedValue == "N")
                                    {
                                        TempActionPlan.Text = "Warning value:" + MHWarning + ". Battery to be Monitored";
                                        ddlMonitor.SelectedValue = "Y";
                                        ddlReplace.SelectedValue = "N";
                                        TotMonitor += 1;
                                    }
                                }
                            }
                            else if (ddlMidType.SelectedValue == "2")
                            {
                                if (MHOS > MHError)
                                {
                                    if (ddlReplace.SelectedValue == "N")
                                    {
                                        TempActionPlan.Text = "Fail value:" + MHError + ". Battery to be Replaced";
                                        ddlReplace.SelectedValue = "Y";
                                        ddlMonitor.SelectedValue = "N";
                                        TotReplace += 1;
                                    }
                                }
                                else if (MHOS > MHWarning && MHOS <= MHError)
                                {
                                    if (ddlMonitor.SelectedValue == "N")
                                    {
                                        TempActionPlan.Text = "Warning value:" + MHWarning + ". Battery to be Monitored";
                                        ddlMonitor.SelectedValue = "Y";
                                        ddlReplace.SelectedValue = "N";
                                        TotMonitor += 1;
                                    }
                                }
                            }
                            

                        }

                    }
                    txtUsedQuantity.Text = TotReplace.ToString();
                    txtMonitored.Text = TotMonitor.ToString();
                }


            }

            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "CalculateBatteryDef";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = "Error occured : " + ex.Message.ToString();
            }


        }
        public void getBatteryFloatVoltage(ref double LowVolt, ref double MaxVolt)
        {
            string ABMCharger = string.Empty;
            ABMCharger = ddlFloatVoltV.SelectedValue.Trim();
            try
            {
                switch (ddlUsedBatteryType.SelectedValue)
                {
                    case "2V":
                        LowVolt = 2.11;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 2.33;
                        }
                        else
                        {
                            MaxVolt = 2.30;
                        }

                        break;
                    case "4V":
                        LowVolt = 4.22;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 4.66;
                        }
                        else
                        {
                            MaxVolt = 4.60;
                        }

                        break;
                    case "8V":
                        LowVolt = 8.44;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 9.33;
                        }
                        else
                        {
                            MaxVolt = 9.20;
                        }

                        break;
                    case "TV":
                        LowVolt = 10.56;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 11.66;
                        }
                        else
                        {
                            MaxVolt = 11.51;
                        }

                        break;
                    case "V":
                        LowVolt = 12.68;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 14.30;
                        }
                        else
                        {
                            MaxVolt = 13.82;
                        }

                        break;
                    case "FV":
                        LowVolt = 14.79;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 16.33;
                        }
                        else
                        {
                            MaxVolt = 16.12;
                        }

                        break;
                    case "SV":
                        LowVolt = 16.90;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 18.66;
                        }
                        else
                        {
                            MaxVolt = 18.42;
                        }

                        break;
                    case "6V":
                        LowVolt = 6.34;
                        if (ABMCharger == "2")
                        {
                            MaxVolt = 7.0;
                        }
                        else
                        {
                            MaxVolt = 6.91;
                        }

                        break;

                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "getBatteryFloatVoltage";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = "Error occured : " + ex.Message.ToString();
                //lblErrMsg.Text = ex.Message.ToString();

            }


        }

        public bool RecommendtoReplace()
        {
            try
            {
                DateTime temp;
                if (DateTime.TryParse(txtStartDt.Text, out temp))
                {
                    BatteryAge = getBatteryAge();
                    int days = Convert.ToInt32((DateTime.Now - Convert.ToDateTime(txtStartDt.Text)).TotalDays) / 365;
                    if (days >= BatteryAge)
                    {
                        return true;
                    }
                }
                else
                {
                    lblErrMsg.Text = "Please enter valid date code";
                }

            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "RecommendtoReplace";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }
            return false;
        }
        public bool ProactiveReplace()
        {
            try
            {

                DateTime temp;
                if (DateTime.TryParse(txtStartDt.Text, out temp))
                {
                    BatteryAge = getBatteryAge();
                    int days = Convert.ToInt32((DateTime.Now - Convert.ToDateTime(txtStartDt.Text)).TotalDays) / 365;
                    if (days == BatteryAge - 1)
                    {
                        return true;
                    }
                }
                else
                {
                    lblErrMsg.Text = "Please enter valid date code";
                }
                
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "ProactiveReplacement";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" + ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }
            return false;
        }
        private void DisplayReconciliationInfo()
        {
            try
            {
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);
                //EtechDataAcess.ETechEquipmentData de = new EtechDataAcess.ETechEquipmentData();
                EtechDataAcess.ETechEquipmentData dl = new EtechDataAcess.ETechEquipmentData();
                EtechDataAcess.EquipReconciliationInfo ARI = new EtechDataAcess.EquipReconciliationInfo();
                ARI.CallNbr = CallNbr;
                ARI.EquipID = EquipID;

                string ErrMsg = string.Empty;
                ARI = dl.GetEquipReconciliationInfo(ARI, ref ErrMsg);
                if (ErrMsg == string.Empty)
                {
                    if (ARI.Make.Trim() == string.Empty)
                    {
                        txtRecMake.Text = ddlUsedManuf.SelectedValue.Trim();
                    }
                    else
                    {
                        txtRecMake.Text = ARI.Make;
                    }
                    ddlRecMakeCorrect.SelectedValue = ARI.MakeCorrect;
                    txtActMake.Text = ARI.ActMake;
                    txtRecModel.Text = ARI.Model;
                    ddlRecModCorrect.SelectedValue = ARI.ModelCorrect;
                    txtActModel.Text = ARI.ActModel.Trim();

                    txtRecSerialNo.Text = ARI.SerialNo;
                    ddlRecSNoCorrect.SelectedValue = ARI.SerialNoCorrect;
                    txtActSerialNo.Text = ARI.ActSerialNo.Trim();
                    chkRecon.Checked = ARI.Verified;
                    if (ARI.ASCStringsNo != 0) { txtASCStrings.Text = ARI.ASCStringsNo.ToString(); }
                    ddlASCStrings.SelectedValue = ARI.ASCStringsCorrect;
                    if (ARI.ActASCStringNo != 0) { txtActASCStrings.Text = ARI.ActASCStringNo.ToString(); }
                    if (ARI.BattPerString != 0) { txtBPerString.Text = ARI.BattPerString.ToString(); }
                    ddlBPerString.SelectedValue = ARI.BattPerStringCorrect;
                    if (ARI.ActBattPerString != 0) { txtActBPerString.Text = ARI.ActBattPerString.ToString(); }

                }






            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "DisplayReconciliationInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }
        }
        private void SaveUpdateReconciliationInfo()
        {
            try
            {
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);
                EtechDataAcess.ETechEquipmentData dl = new EtechDataAcess.ETechEquipmentData();
                EtechDataAcess.EquipReconciliationInfo ARI = new EtechDataAcess.EquipReconciliationInfo();
                ARI.CallNbr = CallNbr;
                ARI.EquipID = EquipID;

                ARI.Make = txtRecMake.Text;
                ARI.MakeCorrect = ddlRecMakeCorrect.SelectedValue;
                ARI.ActMake = txtActMake.Text;

                ARI.Model = txtRecModel.Text.Trim();
                ARI.ModelCorrect = ddlRecModCorrect.SelectedValue;
                ARI.ActModel = txtActModel.Text.Trim();

                ARI.SerialNo = txtRecSerialNo.Text.Trim();
                ARI.SerialNoCorrect = ddlRecSNoCorrect.SelectedValue;
                ARI.ActSerialNo = txtActSerialNo.Text.Trim();

                ARI.ASCStringsNo = cvt2Int(txtASCStrings.Text);
                ARI.ASCStringsCorrect = ddlASCStrings.SelectedValue;
                ARI.ActASCStringNo = cvt2Int(txtActASCStrings.Text);

                ARI.BattPerString = cvt2Int(txtBPerString.Text);
                ARI.BattPerStringCorrect = ddlBPerString.SelectedValue;
                ARI.ActBattPerString = cvt2Int(txtActBPerString.Text);

                ARI.TotalEquips = cvt2Int("");
                ARI.TotalEquipsCorrect = "";
                ARI.ActTotalEquips = cvt2Int("");

                ARI.KVA = "";
                ARI.KVACorrect = "";
                ARI.ActKVA = "";

                ARI.Verified = chkRecon.Checked;

                string ErrMsg = string.Empty;
                //dl.SaveUpdateEquipReconciliationInfo(ARI, ref ErrMsg);
                if (ErrMsg == string.Empty)
                {

                }
                else
                {
                    lblErrMsg.Text = ErrMsg.ToString();
                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "SaveUpdateReconciliationInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }
            finally
            {

            }

        }

        public void DisplayBatteryStringInfo()
        {
            try
            {
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);
                EtechDataAcess.BatteryStringInfo binfo = new EtechDataAcess.BatteryStringInfo();

                binfo.BatStrId = BatStrId;
                binfo.CallNbr = CallNbr;
                binfo.EquipId = EquipID;
                string ErrMsg = string.Empty;
                binfo = da.GetBatteryStringReadingsInfoTemp(binfo, ref ErrMsg);

                if (ErrMsg == "")
                {
                    ddlUsedManuf.SelectedValue = binfo.Manufacturer.ToString();
                    ddlUsedBatteryHouse.SelectedValue = binfo.BatteryHousing.ToString();
                    txtUsedModelNo.Text = binfo.ModelNo.ToString();
                    txtSerialNo.Text = binfo.SerialNo.ToString();
                    ddlUsedBatteryType.SelectedValue = binfo.BatteryType.ToString();
                    ddlBattType.SelectedValue = binfo.BatteryTypeName.ToString();
                    ddlStatus.SelectedValue = binfo.EquipStatus.ToString();

                    txtStartDt.Text = (Convert.ToDateTime(binfo.MonthName.ToString() + "/01/" + Convert.ToInt32(binfo.Year))).ToString("MM/dd/yyyy");
                    txtUsedCmts.Text = binfo.Comments_Used.ToString();
                    chkBulged.Checked = (bool)binfo.Bulged_Check;
                    ddlBulged.SelectedValue = binfo.Bulged_PF.ToString();
                    chkCracked.Checked = (bool)binfo.Cracked_Check;
                    ddlCracked.SelectedValue = binfo.Cracked_PF.ToString();
                    chkDebris.Checked = (bool)binfo.Debris_Check;
                    ddlDebris.SelectedValue = binfo.Debris_PF.ToString();
                    ddlRotten.SelectedValue = binfo.Rotten.ToString();
                    ddlSaftey.SelectedValue = binfo.VerifySaftey.ToString();
                    txtSealedCmnts3.Text = binfo.ContainerComments.ToString();
                    txtSealedCmnts4.Text = binfo.EnvironmentComments.ToString();
                    txtTotalBatteryVoltage.Text = binfo.BatVoltage.ToString();
                    txtPlusTerminalToGND.Text = binfo.PlusTerminal.ToString();
                    txtMinusTerminalToGND.Text = binfo.MinusTerminal.ToString();
                    txtDCChargeCurrent.Text = binfo.DCCharging.ToString(); ;
                    txtACRippleVoltage.Text = binfo.ACRipple.ToString();
                    txtACRippleCurrent.Text = binfo.ACRippleCurrent.ToString();
                    ddlVoltage.SelectedValue = binfo.BatVoltate_PF.ToString();
                    ddlPlusTerminal.SelectedValue = binfo.PlusTerminal_PF.ToString();
                    ddlMinusTerminal.SelectedValue = binfo.MinusTerminal_PF.ToString();
                    ddlDcCharging.SelectedValue = binfo.DCCharging_PF.ToString();
                    ddlACRippleV.SelectedValue = binfo.ACRipple_PF.ToString();
                    ddlACRippleC.SelectedValue = binfo.ACRippleCurrent_PF.ToString();
                    ddlInterCell.SelectedValue = binfo.Resistance_PF.ToString();
                    ddlTorque.SelectedValue = binfo.CodeTorque_PF.ToString();
                    txtChargingComments.Text = binfo.Comment.ToString();
                    ddlWrapped.SelectedValue = binfo.PlusWrapped_PF.ToString();
                    ChkWrapped.Checked = (bool)binfo.PlusWrapped_Check;
                    ChkSulfated.Checked = (bool)binfo.PlusSulfated_Check;
                    Chkmispos.Checked = (bool)binfo.PlusMisPos_Check;
                    ChkMissing.Checked = (bool)binfo.Missing_Check;
                    ddlMissing.SelectedValue = binfo.Missing_PF.ToString();
                    chkBroken.Checked = (bool)binfo.Broken_Check;
                    ChkNeedsCleaning.Checked = (bool)binfo.NeedsCleaning_Check;
                    txtFloodedCmts1.Text = binfo.PlatesComments.ToString();
                    ddlWaterLevel.SelectedValue = binfo.WaterLevelV.ToString();
                    ddlWaterLevelPF.SelectedValue = binfo.WaterLevelPF.ToString();
                    txtCoverCmts1.Text = binfo.ElectrolytesComments.ToString();
                    ddlRoomTemp.SelectedValue = binfo.BatteryTemp_PF.ToString();
                    txtTemp.Text = binfo.RoomTemp.ToString();
                    txtBattTemp.Text = binfo.BattTemp.ToString();
                    ddlBattTemp.SelectedValue = binfo.BattTemp_PF.ToString();
                    txtUsedQuantity.Text = binfo.Quantity_Used.ToString();
                    txtMonitored.Text = binfo.Quantity_Needed.ToString();
                    ddlReasonToReplace.SelectedValue = binfo.Reason_Replace.ToString();
                    ddlFloatVoltS.SelectedValue = binfo.FloatVoltS.ToString();
                    ddlFloatVoltV.SelectedValue = binfo.FloatVoltV.ToString();
                    ddlInter.SelectedValue = binfo.IntercellConnector.ToString();
                    chkReplace.Checked = (bool)binfo.ReplaceWholeString;
                    ddlRepMonCal.SelectedValue = binfo.RepMonCalc.ToString();
                    txtPackNo.Text = binfo.BatteryPackCount.ToString();
                    ddlBattDisconnect.SelectedValue = binfo.IndBattDisconnect.ToString();
                    ddlIndBattInter.SelectedValue = binfo.IndBattInterConn.ToString();
                    ddlRackIntegrity.SelectedValue = binfo.RackIntegrity.ToString();
                    ddlVentFan.SelectedValue = binfo.VentFanOperation.ToString();
                    txtLocation.Text = binfo.Location.ToString();
                    ddlReadingType.SelectedValue = binfo.ReadingType.ToString();
                    ddlStringType.SelectedValue = binfo.StringType.ToString();
                    chkmVAC.Checked = (bool)binfo.chckmVAC;
                    chkStrap.Checked = (bool)binfo.chkStrap;
                    ddlBattTerminal.SelectedValue = binfo.ddlBattTerminal.ToString().Trim();
                    ddlBattTermType.SelectedValue = binfo.ddlBattTypeTerminal.ToString().Trim();
                    txtBattTerminal.Text = binfo.txtBattTerminal.ToString().Trim();
                    ddlMidType.SelectedValue = binfo.ReadingMethod.ToString().Trim();
                    GetEmpStatus();


                }
                else
                {
                    GetEquipInfo();
                }

            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "DisplayBatteryStringInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.ForeColor = Color.Red;
                lblErrMsg.Text = ex.Message.ToString() + "\n" + lblErrMsg.Text.ToString();
            }


        }
        public bool SaveUpdateBatteryString(string SaveType)
        {
            try
            {
                EtechDataAcess.BatteryStringInfo binfo = new EtechDataAcess.BatteryStringInfo();
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);


                string ErrMsg = string.Empty;
                binfo.BatStrId = BatStrId;
                binfo.CallNbr = CallNbr;
                binfo.EquipId = EquipID;
                binfo.Manufacturer = ddlUsedManuf.SelectedValue;
                binfo.BatteryHousing = ddlUsedBatteryHouse.SelectedValue;
                binfo.ModelNo = txtUsedModelNo.Text;
                binfo.SerialNo = txtSerialNo.Text;
                binfo.Location = txtLocation.Text;
                binfo.BatteryType = ddlUsedBatteryType.SelectedValue;
                binfo.BatteryTypeName = ddlBattType.SelectedValue;
                binfo.EquipStatus = ddlStatus.SelectedValue;
                ddlStatus.SelectedValue = binfo.EquipStatus;
                if (txtStartDt.Text == "")
                {
                    txtStartDt.Text = "01/01/1900";
                }
                DateTime DtDateCode = Convert.ToDateTime("01/01/1900");
                if (CheckDate(txtStartDt.Text))
                {
                    DtDateCode = Convert.ToDateTime(txtStartDt.Text);
                }
                else
                {
                    lblErrMsg.ForeColor = Color.Red;
                    lblErrMsg.Text = "Please enter valid datecode";
                    return false;
                }
                
                if (DtDateCode > DateTime.Today)
                {
                    lblErrMsg.ForeColor = Color.Red;
                    lblErrMsg.Text = "DateCode cannot be higher than today's date";
                    return false;
                }
                binfo.MonthName = DateTimeFormatInfo.CurrentInfo.GetMonthName(DtDateCode.Month);
                binfo.Year = DtDateCode.Year;
                binfo.Comments_Used = txtUsedCmts.Text;
                binfo.Bulged_Check = chkBulged.Checked;
                binfo.Bulged_PF = ddlBulged.SelectedValue;
                binfo.Cracked_Check = chkCracked.Checked;
                binfo.Cracked_PF = ddlCracked.SelectedValue;
                binfo.Debris_Check = chkDebris.Checked;
                binfo.Debris_PF = ddlDebris.SelectedValue;
                binfo.Rotten = ddlRotten.SelectedValue;
                binfo.VerifySaftey = ddlSaftey.SelectedValue;
                binfo.ContainerComments = txtSealedCmnts3.Text;
                binfo.EnvironmentComments = txtSealedCmnts4.Text;
                binfo.BatVoltage = cvtDouble(txtTotalBatteryVoltage.Text);
                binfo.PlusTerminal = cvtDouble(txtPlusTerminalToGND.Text);
                binfo.MinusTerminal = cvtDouble(txtMinusTerminalToGND.Text);
                binfo.DCCharging = cvtDouble(txtDCChargeCurrent.Text);
                binfo.ACRipple = cvtDouble(txtACRippleVoltage.Text);
                binfo.ACRippleCurrent = cvtDouble(txtACRippleCurrent.Text);
                // Check Min , Max Batt Float Voltage
                if (binfo.BatVoltage > 0 && ddlStringType.SelectedValue != "3")
                {
                    double MinVolt = 0;
                    double MaxVolt = 0;
                    getBatteryFloatVoltage(ref MinVolt, ref MaxVolt);
                    if (binfo.BatVoltage >= MinVolt * Convert.ToInt32(txtBatteriesNo.Text) && binfo.BatVoltage <= MaxVolt * Convert.ToInt32(txtBatteriesNo.Text))
                    {
                        binfo.BatVoltate_PF = ddlVoltage.SelectedValue;
                        txtTotalBatteryVoltage.BorderColor = Color.FromName("#CCCCCC");
                        binfo.BatVoltate_PF = "P";
                    }
                    //else if (txtChargingComments.Text.Length == 0)
                    //{
                    //    if (SaveType != "Save As Draft")
                    //    {
                    //        txtTotalBatteryVoltage.BorderColor = Color.Red;
                    //        txtChargingComments.Focus();
                    //        ddlVoltage.SelectedValue = "F";
                    //        binfo.BatVoltate_PF = "F";
                    //        lblErrMsg.ForeColor = Color.Red;
                    //        lblErrMsg.Text = "Total Float Voltage verification failed. Please add notes";
                    //        return false;
                    //    }
                    //    else
                    //    {
                    //        binfo.BatVoltate_PF = ddlVoltage.SelectedValue;
                    //    }

                    //}
                    else
                    {
                        binfo.BatVoltate_PF = ddlVoltage.SelectedValue;
                    }

                }
                else
                {
                    binfo.BatVoltate_PF = ddlVoltage.SelectedValue;
                }
                binfo.PlusTerminal_PF = ddlPlusTerminal.SelectedValue;
                binfo.MinusTerminal_PF = ddlMinusTerminal.SelectedValue;
                binfo.DCCharging_PF = ddlDcCharging.SelectedValue;
                binfo.ACRipple_PF = ddlACRippleV.SelectedValue;
                binfo.ACRippleCurrent_PF = ddlACRippleC.SelectedValue;
                binfo.Resistance_PF = ddlInterCell.SelectedValue;
                binfo.CodeTorque_PF = ddlTorque.SelectedValue;
                binfo.Comment = txtChargingComments.Text;

                binfo.PlusWrapped_PF = ddlWrapped.SelectedValue;
                binfo.PlusWrapped_Check = ChkWrapped.Checked;
                binfo.PlusSulfated_Check = ChkSulfated.Checked;
                binfo.PlusMisPos_Check = Chkmispos.Checked;
                binfo.Missing_Check = ChkMissing.Checked;
                binfo.Missing_PF = ddlMissing.SelectedValue;
                binfo.Broken_Check = chkBroken.Checked;
                binfo.NeedsCleaning_Check = ChkNeedsCleaning.Checked;
                binfo.PlatesComments = txtFloodedCmts1.Text;
                binfo.WaterLevelV = ddlWaterLevel.SelectedValue;
                binfo.WaterLevelPF = ddlWaterLevelPF.SelectedValue;
                binfo.ReadingType = ddlReadingType.SelectedValue;
                binfo.StringType = ddlStringType.SelectedValue;
                binfo.ElectrolytesComments = txtCoverCmts1.Text;
                binfo.BatteryTemp_PF = ddlRoomTemp.SelectedValue;
                binfo.RoomTemp = cvtInt(txtTemp.Text);
                binfo.BattTemp = cvt2Int(txtBattTemp.Text);
                binfo.BattTemp_PF = ddlBattTemp.SelectedValue;
                binfo.Quantity_Used = cvtInt(txtUsedQuantity.Text);
                binfo.TobeMonitored = cvtInt(txtMonitored.Text);
                binfo.Reason_Replace = ddlReasonToReplace.SelectedValue;
                binfo.FloatVoltS = ddlFloatVoltS.SelectedValue;
                binfo.FloatVoltV = ddlFloatVoltV.SelectedValue;
                binfo.IntercellConnector = ddlInter.SelectedValue;
                binfo.ReplaceWholeString = chkReplace.Checked;
                binfo.chckmVAC = chkmVAC.Checked;
                binfo.chkStrap = chkStrap.Checked;
                binfo.Maint_Auth_Id = da.getUID();
                binfo.RepMonCalc = ddlRepMonCal.SelectedValue;
                binfo.BatteryPackCount = cvt2Int(txtPackNo.Text);
                binfo.IndBattDisconnect = ddlBattDisconnect.SelectedValue;
                binfo.IndBattInterConn = ddlIndBattInter.SelectedValue;
                binfo.RackIntegrity = ddlRackIntegrity.SelectedValue;
                binfo.VentFanOperation = ddlVentFan.SelectedValue;
                binfo.ddlBattTerminal = ddlBattTerminal.SelectedValue;
                binfo.ddlBattTypeTerminal = ddlBattTermType.SelectedValue;
                binfo.txtBattTerminal = txtBattTerminal.Text;
                binfo.ReadingMethod = ddlMidType.SelectedValue;
                //log.Debug("Battery String Values : " + binfo.ToString());
                
                if (SaveType == "Save As Draft") { binfo.SaveAsDraft = true; } else { binfo.SaveAsDraft = false; }
                da.SaveUpdateBatteryStringReadingsTemp(binfo, ref ErrMsg);
                if (ErrMsg == string.Empty)
                {
                    lblErrMsg.ForeColor = System.Drawing.Color.Green;
                    lblErrMsg.Font.Bold = true;
                    lblErrMsg.Text = "Update Successfull";
                }
                else
                {
                    lblErrMsg.Text = ErrMsg.ToString();
                    return false;//Error occured while saving or updating data;
                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "UpdateBatteryInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
                return false;//Error occured while saving or updating data;
            }
            return true;

        }
        private int cvtInt(string p_num)
        {
            int result = 0;
            try
            {
                result = Convert.ToInt32(p_num);
            }
            catch (Exception)
            {
                //ex.Message();
            }
            return result;

        }
        protected bool CheckDate(String date)
        {
            DateTime Temp;


            if (DateTime.TryParse(date, out Temp) == true)
                return true;
            else
                return false;
        }
        private void UpdateBatteryInfo(int i)
        {
            try
            {
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);

                SqlCommand cmd = new SqlCommand(); ;
                EtechDataAcess.DAL dl = new EtechDataAcess.DAL();
                SqlConnection con = dl.GetSqlConnection();
                con.Open();
                string strSQL = string.Empty;
                if (i == 2)
                {
                    strSQL = "Update ETechEquipmentInfo set BatteriesPerString=" + cvt2Int(txtBatteriesNo.Text) + ",BatteriesPerPack=" + cvt2Int(txtPackNo.Text) + " where CallNbr=" + CallNbr + " and EquipID=" + EquipID + " and EquipNo='" + BatStrId + "'";
                }
                else
                {
                    strSQL = "Update ETechEquipmentInfo set ReadingType=" + ddlReadingType.SelectedValue + " where CallNbr='" + CallNbr + "' and EquipID=" + EquipID + " and EquipNo='" + BatStrId + "'";

                }
                cmd = new SqlCommand(strSQL.ToString(), con);
                try
                {
                    cmd.ExecuteNonQuery();
                }
                catch (Exception ex)
                {
                    lblErrMsg.Text = ex.Message;
                }
                finally
                {
                    cmd.Dispose();

                    if (con.State == ConnectionState.Open)
                    {
                        con.Close();
                    }
                }
                GetEquipInfo();
            }
            catch (Exception ex)
            {

                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "UpdateBatteryInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }
        }
        public void DisplayBatteryInfo()
        {
            try
            {
                int BattNum = 0;
                EtechDataAcess.DAL dl = new EtechDataAcess.DAL();
                DataSet ds = new DataSet();
                string ErrMsg = string.Empty;
                ds = dl.GetBatteryInfoTemp(CallNbr, EquipID, BatStrId, ref ErrMsg);
                if(txtBatteriesNo.Text.Length==0)
                { 
                    if(ds!=null)
                    {
                        txtBatteriesNo.Text = ds.Tables[0].Rows.Count.ToString();
                    }
                    else
                    {
                        txtBatteriesNo.Text = "0";
                    }
                }
                
                
                if (ddlStringType.SelectedValue == "3")
                {
                    BattNum = cvt2Int(txtPackNo.Text);
                    lblRecBatt.Text = "# Of Battery Packs";

                }
                else if (ddlStringType.SelectedValue == "2")
                {
                    BattNum = (cvt2Int(txtPackNo.Text) * cvt2Int(txtBatteriesNo.Text));
                    lblRecBatt.Text = "Batteries per string:";
                }
                else
                {
                    BattNum = cvt2Int(txtBatteriesNo.Text);
                    lblRecBatt.Text = "Batteries per string:";
                }
                txtBPerString.Text = BattNum.ToString();
              
                string strSQL = string.Empty;
                
                if (txtTemp.Text == "")
                {
                    txtTemp.Text = "70";
                }
                int roomTemp = Convert.ToInt32(txtTemp.Text);
                string UID = dl.getUID();
                SqlCommand cmd;
                SqlConnection con = dl.GetSqlConnection();
                if (ErrMsg == string.Empty)
                {
                    if (ds.Tables[0].Rows.Count != BattNum)
                    {
                        
                        
                        con.Open();
                        if (ds.Tables[0].Rows.Count < BattNum)
                        {
                            strSQL = " INSERT INTO DBO.BatteryTemp ";
                            strSQL = String.Concat(strSQL, "(CallNbr, EquipID,BatteryStringID,BatteryID,Temp,VDC,VAC,Cracks,ReplacementNeeded,MonitoringBattery,ActionPlan,LastModified,Maint_Auth_ID)");
                            for (int i = ds.Tables[0].Rows.Count + 1; i <= BattNum; i++)
                            {
                                strSQL = String.Concat(strSQL, " (SELECT '", CallNbr, "',", EquipID, ",'", BatStrId, "','", i, "',", roomTemp, ",", cvtDecimal(""), ",", cvtDecimal(""), ",'P','N','N','', CURRENT_TIMESTAMP,'", UID, "')");
                                if (i == BattNum)
                                { }
                                else { strSQL = String.Concat(strSQL, "UNION"); }
                            }
                        }
                        else if (ds.Tables[0].Rows.Count > BattNum)
                        {

                            strSQL = "DELETE FROM DBO.BatteryTemp where BatteryStringID='" + BatStrId + "' and CallNbr='" + CallNbr + "' and EquipID=" + EquipID + " and BatteryID  > " + BattNum;
                        }

                        SqlTransaction myTrans = default(SqlTransaction);
                        myTrans = con.BeginTransaction();
                        cmd = new SqlCommand(strSQL.ToString(), con);
                        cmd.Transaction = myTrans;
                        try
                        {
                            cmd.ExecuteNonQuery();
                            myTrans.Commit();
                        }
                        catch (Exception ex)
                        {
                            if (strSQL == string.Empty)
                            {
                                lblErrMsg.Text = ex.Message.ToString();
                            }
                            else
                            {
                                lblErrMsg.Text = ex.Message;
                            }
                            myTrans.Rollback();
                        }
                        finally
                        {
                            cmd = null;

                            if (con.State == ConnectionState.Open)
                            {
                                con.Close();
                            }
                        }
                        ds = dl.GetBatteryInfoTemp(CallNbr, EquipID, BatStrId, ref ErrMsg);
                    }
                    
                }

                       
                if (ds != null)
                {
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        cmdReadingsGraph.Visible = true;
                        dgReadingsTemp.DataSource = ds;
                        dgReadingsTemp.DataBind();
                        //foreach(GridViewRow gv)
                    }
                    else
                    {
                        cmdReadingsGraph.Visible = false;
                    }
                }

                int count = 0;
                int CountReplace = 0;
                int CountMonitor = 0;
                foreach (GridViewRow dg in dgReadingsTemp.Rows)
                {
                    DropDownList ddlReplace = (DropDownList)dg.FindControl("ddlReplace");
                    DropDownList ddlMonitor = (DropDownList)dg.FindControl("ddlMonitor");
                    DropDownList ddlCrack = (DropDownList)dg.FindControl("ddlCrack");
                    ddlCrack.SelectedValue = ds.Tables[0].Rows[count]["Cracks"].ToString();
                    ddlReplace.SelectedValue = ds.Tables[0].Rows[count]["ReplacementNeeded"].ToString();
                    ddlMonitor.SelectedValue = ds.Tables[0].Rows[count]["MonitoringBattery"].ToString();
                    TextBox BatteryID = (TextBox)dg.FindControl("txtTempBatteryID");
                    TextBox TempVDC = (TextBox)dg.FindControl("txtTempVDC");
                    TextBox TempVAC = (TextBox)dg.FindControl("txtTempVAC");
                    TextBox TemptxtMHOS = (TextBox)dg.FindControl("txtTempMHOS");
                    TextBox TemptxtStrap1 = (TextBox)dg.FindControl("txtTempStrap1");
                    TextBox TemptxtStrap2 = (TextBox)dg.FindControl("txtTempStrap2");
                    TextBox TemptxtSpGravity = (TextBox)dg.FindControl("txtTempSpGravity");
                    if (ddlReplace.SelectedValue == "Y")
                    {
                        CountReplace += 1;
                        ddlStatus.SelectedValue = "CriticalDeficiency";
                    }
                    if (ddlMonitor.SelectedValue == "Y")
                    {
                        CountMonitor += 1;
                    }
                    if (BatteryID.Text == "0")
                    {
                        BatteryID.Text = string.Empty;
                    }
                    if (TempVDC.Text == "0.00")
                    {
                        TempVDC.Text = string.Empty;
                    }
                    if (TempVAC.Text == "0.00")
                    {
                        TempVAC.Text = string.Empty;
                    }
                    if (TemptxtMHOS.Text == "0.00")
                    {
                        TemptxtMHOS.Text = string.Empty;
                    }
                    if (TemptxtStrap1.Text == "0.00")
                    {
                        TemptxtStrap1.Text = string.Empty;
                    }
                    //else
                    //{
                    //    txtStrap1.Text = (1 / cvtDecimal(txtStrap1.Text) - 1 / cvtDecimal(txtMHOS.Text)).ToString();
                    //    txtStrap1.Text = (cvtDecimal(txtStrap1.Text) * 1000000).ToString();
                    //}
                    if (TemptxtStrap2.Text == "0.00")
                    {
                        TemptxtStrap2.Text = string.Empty;
                    }
                    //else
                    //{
                    //    txtStrap2.Text = (1 / cvtDecimal(txtStrap2.Text) - 1 / cvtDecimal(txtMHOS.Text)).ToString();
                    //    txtStrap2.Text = (cvtDecimal(txtStrap2.Text) * 1000000).ToString();
                    //}
                    if (TemptxtSpGravity.Text == "0.0000")
                    {
                        TemptxtSpGravity.Text = string.Empty;
                    }
                    count++;
                }
                //txtUsedQuantity.Text = CountReplace.ToString();
                //txtMonitored.Text = CountMonitor.ToString();
            }
            catch (Exception ex)
            {

                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "DisplayBatteryInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.Text = ex.Message.ToString();
            }
        }
        private void BindManufs()
        {
            try
            {
                da.GetManufNames(ref ddlUsedManuf);
            }
            catch (Exception)
            {

                //log.Error(ex.Message, ex);
                lblErrMsg.Text = "Error occured while loading Manufacturers";
            }
        }
        public void BindReferenceValues()
        {
            try
            {
                SqlDataReader dr = da.GetReferenceValues(EquipID, "G","", "", 0,0);

                SqlDataReader dr1 = da.GetReferenceValues(0, "G", "", "", 0,0);
                ddlBattMakeModel.DataSource = dr1;
                ddlBattMakeModel.DataBind();

                if (dr.HasRows)
                {
                    
                    while (dr.Read())
                    {
                        ddlBattMakeModel.SelectedItem.Text = dr.GetValue(0).ToString();
                        ddlBattMakeModel.SelectedItem.Value = dr.GetValue(1).ToString();

                        if (ddlMidType.SelectedValue=="1")
                        {
                            txtRefValue.Text = dr.GetValue(2).ToString();
                        }
                        else
                        { txtRefValue.Text = dr.GetValue(3).ToString(); }
                        
                        if (txtRefValue.Text == "0")
                        {
                            txtRefValue.Text = string.Empty;
                        }
                    }
                }
                else if(dr1.HasRows)
                {
                  
                    while (dr1.Read())
                    {
                        ddlBattMakeModel.SelectedItem.Text = dr1.GetValue(0).ToString();
                        ddlBattMakeModel.SelectedValue = dr1.GetValue(1).ToString();

                        if (ddlMidType.SelectedValue == "1")
                        {
                            txtRefValue.Text = dr1.GetValue(2).ToString();
                        }
                        else
                        { txtRefValue.Text = dr1.GetValue(3).ToString(); }

                        if (txtRefValue.Text == "0")
                        {
                            txtRefValue.Text = string.Empty;
                        }
                    }
                }
                else
                {
                    ddlBattMakeModel.SelectedValue = "-1";
                }

                dr.Close();
                dr1.Close();
            }
            catch (Exception ex)
            {
                lblErrMsg.Text = "Error occured while loading Reference Values" + "\n" + ex.Message.ToString();
            }

        }
        private int cvt2Int(string p_num)
        {
            int result = 0;
            try
            {
                if (p_num != string.Empty)
                    result = Convert.ToInt32(p_num);
            }
            catch (Exception)
            {

            }
            return result;

        }
        public void GetEquipInfo()
        {

            DataSet ds = da.EditEquipInfo(CallNbr, EquipID);
            try
            {
                if (ds != null)
                {
                    foreach (DataRow dr1 in ds.Tables[1].Rows)
                    {
                        if (ddlUsedBatteryHouse.SelectedValue == "Please Select")
                        {
                            ddlUsedBatteryHouse.SelectedValue = dr1["BatteryHousing"].ToString();
                        }
                        if (ddlUsedBatteryType.SelectedValue == "PS")
                        {
                            ddlUsedBatteryType.SelectedValue = dr1["BatteryType"].ToString();
                        }
                        if (ddlFloatVoltS.SelectedValue == "PS")
                        {
                            ddlFloatVoltS.SelectedValue = dr1["FloatVoltS"].ToString();
                        }
                        if (ddlFloatVoltV.SelectedValue == "PS")
                        {
                            ddlFloatVoltV.SelectedValue = dr1["FloatVoltV"].ToString();
                        }
                    }
                    foreach (DataRow dr in ds.Tables[0].Rows)
                    {

                        BatStrId = dr["EquipNo"].ToString();
                        if (BatStrId.Contains("&"))
                        { }
                        else
                        {
                            BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);
                        }
                        if (txtSerialNo.Text == string.Empty)
                        {
                            txtSerialNo.Text = dr["SerialID"].ToString().Trim();
                        }
                        if (txtLocation.Text == string.Empty)
                        {
                            txtLocation.Text = dr["Location"].ToString().Trim();
                        }
                        if (!IsPostBack)
                        {

                            if (ddlUsedManuf.SelectedValue == "")
                            {
                                ddlUsedManuf.Items.Add(new ListItem("Please Select", "PS"));
                                ddlUsedManuf.SelectedValue = "PS";
                            }
                            if (txtUsedModelNo.Text == string.Empty)
                            {
                                txtUsedModelNo.Text = dr["Version"].ToString().Trim();
                            }
                            if (ddlStringType.SelectedValue == "3")
                            {
                                txtBatteriesNo.Text = dr["BatteriesPerPack"].ToString();
                            }
                            else if (ddlStringType.SelectedValue == "2")
                            {
                                txtBatteriesNo.Text = dr["BatteriesPerPack"].ToString();
                            }
                            else
                            {
                                txtBatteriesNo.Text = dr["BatteriesPerString"].ToString();
                            }
                            //txtBatteriesNo.Text = dr["BatteriesPerString"].ToString();

                            if (txtStartDt.Text == string.Empty)
                            {
                                if (cvt2Int(dr["EquipYear"].ToString()) > 0 && dr["EquipMonth"].ToString() != string.Empty)
                                {
                                    txtStartDt.Text = (Convert.ToDateTime(dr["EquipMonth"] + "/01/" + cvt2Int(dr["EquipYear"].ToString()))).ToString("MM/dd/yyyy");
                                }
                            }

                            foreach (ListItem item in ddlUsedManuf.Items)
                            {
                                if (item.Value.ToString().Trim() == dr["VendorId"].ToString().Trim())
                                {
                                    if (dr["VendorId"].ToString().Trim() != "")
                                    {
                                        ddlUsedManuf.SelectedValue = dr["VendorId"].ToString().Trim();
                                        return;
                                    }
                                }
                                else
                                {
                                    ddlUsedManuf.SelectedValue = "PS";
                                }
                            }
                        }
                    }

                }
                // }

            }
            catch (Exception ex) 
            {

                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "GetEquipInfo";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" + ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.ForeColor = Color.Red;
                lblErrMsg.Text = ex.Message;
            }
            finally
            {

            }

        }
        protected void cmdReadingsGraph_Click(object sender, EventArgs e)
        {
            try
            {
                if (BatStrId.Contains("&"))
                {
                    BatStrId = BatStrId.Replace("&", "%26");
                }
                string webint = string.Empty;
                if(ConfigurationManager.AppSettings["Canada"].ToString() == "Yes")
                {
                    webint = "http://dcgwebint:8888";
                }
                else
                    webint= "http://dcgwebint";
                

                string url = webint+"/BatteryReadingsGraph.aspx?CallNbr=" + CallNbr + "&EquipID=" + CallNbr + "&EquipNo=" + BatStrId + "&chkEnablemVAC=" + chkmVAC.Checked + "&ReadingType=" + ddlReadingType.SelectedValue;
                ClientScript.RegisterStartupScript(this.GetType(), "OpenWin", "<script>openNewWin('" + url + "')</script>");
            }
            catch (Exception ex)
            {
                lblErrMsg.Text = ex.Message.ToString();
            }
        }
        private void SaveData(string ButtonType)
        {
            try
            {
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);
                BatteryData();
                if (SaveUpdateBatteryString(ButtonType))
                {
                    
                    UpdateBatteryInfo(1);
                    //SaveUpdateReconciliationInfo();
                    if (ddlStatus.SelectedValue != "Offline")
                    {
                        ddlStatus.SelectedValue = GetEquipStatus();
                    }
                    
                    //SqlDataReader dr = da.GetReferenceValues(EquipID, "U", ddlMidType.SelectedValue, ddlBattMakeModel.SelectedItem.Text, cvtDecimal(txtRefValue.Text), cvtDecimal(txtRefValue.Text));
                    EtechDataAcess.UpdateEquipStatus UES = new EtechDataAcess.UpdateEquipStatus();
                    
                    if (ddlStringType.SelectedValue == "3" || ddlStringType.SelectedValue == "2")
                    {
                        UES.BatteriesPerPack = cvt2Int(txtPackNo.Text);
                        UES.BatteriesPerString = cvt2Int(txtBatteriesNo.Text);
                    }
                    else
                    {
                        UES.BatteriesPerString = cvt2Int(txtBatteriesNo.Text);
                        UES.BatteriesPerPack = 0;
                    }
                    
                    UES.CallNbr = CallNbr;
                    UES.EquipId = EquipID;
                    UES.Status = ddlStatus.SelectedValue;

                    UES.StatusNotes = txtUsedCmts.Text;
                    UES.TableName = "BatteryString";
                    UES.Manufacturer = ddlUsedManuf.SelectedValue;
                    UES.ModelNo = txtUsedModelNo.Text;
                    UES.SerialNo = txtSerialNo.Text;
                    UES.Location = txtLocation.Text;

                    DateTime DtDateCode = Convert.ToDateTime(txtStartDt.Text);
                    UES.MonthName = DateTimeFormatInfo.CurrentInfo.GetMonthName(DtDateCode.Month);
                    UES.Year = DtDateCode.Year;
                    UES.ReadingType = ddlReadingType.SelectedValue;
                    UES.VFSelection = ddlFloatVoltS.SelectedValue;
                    //UES.BatteriesPerString = cvt2Int(txtBatteriesNo.Text);
                    da.UpdateEquipStatus(UES); 
                    DisplayBatteryStringInfo();
                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "SaveData";
                objlog.ErrorMessage = "Job No:" + CallNbr + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                lblErrMsg.ForeColor = Color.Red;
                lblErrMsg.Text = ex.Message;
            }

        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            SaveData(btnSave.Text);
        }
        protected void btnDraft_Click(object sender, EventArgs e)
        {
            SaveData(btn1Draft.Text);
        }
        public void ShowHideGridColumns()
        {
            try
            {
                if ((ddlFloatVoltS.SelectedValue != "ON") && (ddlReadingType.SelectedValue == "1"))
                {
                    dgReadingsTemp.Columns[2].Visible = true;
                    dgReadingsTemp.Columns[3].Visible = false;
                    dgReadingsTemp.Columns[4].Visible = false;
                    dgReadingsTemp.Columns[5].Visible = false;
                }
                else if ((ddlFloatVoltS.SelectedValue == "ON") && (ddlReadingType.SelectedValue == "1"))
                {
                    dgReadingsTemp.Columns[2].Visible = false;
                    dgReadingsTemp.Columns[3].Visible = false;
                    dgReadingsTemp.Columns[4].Visible = false;
                    dgReadingsTemp.Columns[5].Visible = false;
                }
                else if ((ddlFloatVoltS.SelectedValue != "ON") && (ddlReadingType.SelectedValue == "2"))
                {
                    dgReadingsTemp.Columns[2].Visible = false;
                    dgReadingsTemp.Columns[3].Visible = true;
                    dgReadingsTemp.Columns[4].Visible = true;
                    dgReadingsTemp.Columns[5].Visible = true;
                }
                else
                {
                    dgReadingsTemp.Columns[2].Visible = false;
                    dgReadingsTemp.Columns[3].Visible = true;
                    dgReadingsTemp.Columns[4].Visible = true;
                    dgReadingsTemp.Columns[5].Visible = true;
                }

            }
            catch (Exception ex)
            {

                lblErrMsg.Text = ex.Message.ToString();
            }
        }
        protected void BatteryData()
        {

            try
            {
                CallNbr = Request.QueryString["CallNbr"];
                EquipID = Convert.ToInt32(Request.QueryString["EquipId"]);
                BatStrId = Server.UrlDecode(Request.QueryString["EquipNo"]);

                string strSQL=string.Empty;
                string ErrMsg = string.Empty;
                SqlCommand cmd;
                SqlTransaction myTrans = default(SqlTransaction);
                EtechDataAcess.DAL dl = new EtechDataAcess.DAL();
                string UID = dl.getUID();
                int BatteryCount;
                SqlConnection con = dl.GetSqlConnection();
                int roomTemp = 75;
                con.Open();
                int Majcount = 0;
                int Mincount = 0;
                int ReplaceCount = 0;
                decimal MHOSValue = 0;
                ErrMsg = "Entered The BatteryData";
                try
                {
                    BatteryCount = dl.GetBatteryCountTemp(CallNbr, EquipID, BatStrId);
                    CalculateBatteryDef();
                    if (BatteryCount > 0)
                    {
                        dl.DeleteBatteryTemp(CallNbr, EquipID, BatStrId);
                    }
                    int BatteryId;
                    int i = 0;
                    string Log = string.Empty;
                    strSQL = " INSERT INTO DBO.BatteryTemp ";
                    strSQL = String.Concat(strSQL, "(CallNbr, EquipID,BatteryStringID,BatteryID,Temp,VDC,MHOS,Strap1,Strap2,SPGravity,VAC,Cracks,ReplacementNeeded,MonitoringBattery,ActionPlan,LastModified,Maint_Auth_ID)");
                    ErrMsg += strSQL;
                    foreach (GridViewRow dg in dgReadingsTemp.Rows)
                    {
                        i++;
                        ErrMsg += "- i:" + i.ToString();
                        TextBox txtTempBatteryID = (TextBox)dg.FindControl("txtTempBatteryID");
                        TextBox TempVDC = (TextBox)dg.FindControl("txtTempVDC");
                        TextBox TempVAC = (TextBox)dg.FindControl("txtTempVAC");
                        TextBox TempMHOS = (TextBox)dg.FindControl("txtTempMHOS");
                        TextBox TempStrap1 = (TextBox)dg.FindControl("txtTempStrap1");
                        TextBox TempStrap2 = (TextBox)dg.FindControl("txtTempStrap2");
                        TextBox TempSPGravity = (TextBox)dg.FindControl("txtTempSpGravity");
                        TextBox TempActionPlan = (TextBox)dg.FindControl("txtTempAction");
                        DropDownList ddlReplace = (DropDownList)dg.FindControl("ddlReplace");
                        DropDownList ddlMonitor = (DropDownList)dg.FindControl("ddlMonitor");
                        DropDownList ddlCrack = (DropDownList)dg.FindControl("ddlCrack");
                        if (ddlCrack.SelectedValue == "F")
                        {
                            Majcount += 1;
                        }
                        else if (ddlReplace.SelectedValue == "Y")
                        {
                            ReplaceCount += 1;
                        }
                        else if (ddlMonitor.SelectedValue == "Y")
                        {
                            Mincount += 1;
                        }
                        BatteryId = Convert.ToInt32(txtTempBatteryID.Text);
                        if (TempVDC.Text == "0.00")
                        {
                            TempVDC.Text = string.Empty;
                        }
                        if (TempVAC.Text == "0.00")
                        {
                            TempVAC.Text = string.Empty;
                        }
                        
                        if (ddlMidType.SelectedValue == "2")
                        {
                            MHOSValue = cvtDecimal(TempMHOS.Text);
                            if (MHOSValue > 0)
                                MHOSValue = 1000 / MHOSValue;
                        }
                        else if (ddlMidType.SelectedValue == "1")
                        {
                            MHOSValue = cvtDecimal(TempMHOS.Text);

                        }
                        strSQL = String.Concat(strSQL, " SELECT '", CallNbr, "',", EquipID, ",'", BatStrId, "',", BatteryId, ",", roomTemp, ",", cvtDecimal(TempVDC.Text), ",", MHOSValue, ",", cvtDecimal(TempStrap1.Text), ",", cvtDecimal(TempStrap2.Text), ",", cvtDecimal(TempSPGravity.Text), ",", cvtDecimal(TempVAC.Text), ",'", ddlCrack.SelectedValue, "','", ddlReplace.SelectedValue, "','", ddlMonitor.SelectedValue, "','", TempActionPlan.Text, "', CURRENT_TIMESTAMP,'", UID, "'");
                        if (i == dgReadingsTemp.Rows.Count)
                        { }
                        else { strSQL = String.Concat(strSQL, " UNION"); }
                        ErrMsg += "- Battery Count:" + BatteryId.ToString();

                    }

                    if (dgReadingsTemp.Rows.Count > 0)
                    {
                        myTrans = con.BeginTransaction();
                        cmd = new SqlCommand(strSQL.ToString(), con);
                        cmd.Transaction = myTrans;


                        cmd.ExecuteNonQuery();
                        myTrans.Commit();
                        ErrMsg += " - Command Executed";
                    }
                    else
                    {
                        ErrMsg += " - Rows count :0 ";
                    }
                    if (ddlStatus.SelectedValue != "Offline")
                    {
                        if (Majcount > 0 || ReplaceCount > 0)
                        {
                            ddlStatus.SelectedValue = "CriticalDeficiency";
                        }
                        
                        else if (Mincount > 0)
                        {
                            ddlStatus.SelectedValue = "OnLine(MinorDeficiency)";
                        }
                        else
                        {
                            ddlStatus.SelectedValue = "Online";
                        }
                        
                    }
                }
                catch (Exception ex)
                {
                    objlog.ProcessName = "ETech.BatteryReadings";
                    objlog.MethodName = "BatteryData";
                    var st = new StackTrace(ex, true);
                    // Get the top stack frame
                    var frame = st.GetFrame(0);
                    // Get the line number from the stack frame
                    var line = frame.GetFileLineNumber();
                    objlog.ErrorMessage = "Job No:" + CallNbr + "- SQL String" + ErrMsg + " - ErrorLine:" + line + " -  Error Message:" +   ex.Message;
                    objlog.CreatedBy = LP.getUID();
                    LP.InsertLog(objlog);
                    lblErrMsg.ForeColor = Color.Red;
                    lblErrMsg.Text = ex.Message;
                    myTrans.Rollback();
                }
                finally
                {
                    cmd = null;

                    if (con.State == ConnectionState.Open)
                    {
                        con.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                objlog.ProcessName = "ETech.BatteryReadings";
                objlog.MethodName = "BatteryData";
                objlog.ErrorMessage = "Job No:" + CallNbr + "- EquipID:" + EquipID.ToString() + "Bat Str ID:" + BatStrId + " - Error:" +   ex.Message;
                objlog.CreatedBy = LP.getUID();
                LP.InsertLog(objlog);
                
            }


        }
        protected void cmdChange_Click(object sender, EventArgs e)
        {
            SaveUpdateBatteryString("Save As Draft");
            UpdateBatteryInfo(2);
            
            DisplayBatteryInfo();
            DisplayBatteryStringInfo();
        }

    }
}
