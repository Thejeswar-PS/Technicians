<div class="container-fluid tool-tracking-container">

  <!-- Loading Overlay -->
  <div *ngIf="loading"
       class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center loading-overlay">
    <div class="spinner-border text-primary"></div>
  </div>

  <div class="card shadow-sm main-card">

    <!-- ================= HEADER ================= -->
    <div class="card-header border-0 py-4 position-relative">

      <h3 class="fw-bold text-primary text-center mb-0">
        Tool Tracking Entry
      </h3>

      <button type="button"
              class="btn btn-primary position-absolute top-50 end-0 translate-middle-y me-3"
              (click)="onSave()"
              [disabled]="loading">
        <i class="bi bi-check-circle me-2"></i>
        Save
      </button>

    </div>

    <div class="card-body">

      <!-- Error -->
      <div class="mb-3" *ngIf="error">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ error }}
        </div>
      </div>

      <!-- Success -->
      <div class="mb-3" *ngIf="successMessage">
        <div class="alert alert-success">
          <i class="bi bi-check-circle-fill me-2"></i>
          {{ successMessage }}
        </div>
      </div>

      <!-- ================= TECHNICIAN FILTER ================= -->
      <div class="filter-panel mb-4">
        <div class="row g-3 align-items-end">

          <div class="col-md-6">
            <label class="form-label fw-semibold">Technician</label>
            <select class="form-select"
                    [(ngModel)]="selectedTech"
                    (ngModelChange)="onTechnicianChange($event)"
                    [disabled]="loading || loadingTechnicians">
              <option value="All">Select Technician</option>
              <option *ngFor="let tech of technicians"
                      [value]="tech.techID">
                {{ tech.techname }}
              </option>
            </select>
          </div>

          <div class="col-md-6" *ngIf="techInfo">
            <div class="tech-info-box">
              <div class="fw-bold">
                {{ getSelectedTechName() }}
              </div>
              <small class="text-muted">
                {{ trackingData.length }} assigned tools
              </small>
            </div>
          </div>

        </div>
      </div>

      <!-- ================= TABLE ================= -->
      <div *ngIf="trackingData && trackingData.length > 0"
           class="table-responsive">

        <table class="table table-bordered mb-0">

          <thead>
            <tr>
              <th>Tool Name</th>
              <th>Serial No</th>
              <th>Due Date</th>
              <th>New Meter Tracking</th>
              <th>Old Meter S/N</th>
              <th>Old Meter Tracking</th>
              <th class="text-center">Received</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let item of trackingData; let i = index; trackBy: trackByFn">

              <td>
                <i class="bi bi-tools me-2 text-primary"></i>
                <span class="fw-semibold">{{ item.toolName || 'â€”' }}</span>
              </td>

              <td>
                <input type="text"
                       class="form-control form-control-sm"
                       [(ngModel)]="item.serialNo"
                       (ngModelChange)="onFieldChange(i, 'serialNo', $event)">
              </td>

              <td>
                <input type="date"
                       class="form-control form-control-sm"
                       [ngModel]="formatDateForInput(item.dueDt)"
                       (ngModelChange)="item.dueDt = $event; onFieldChange(i, 'dueDt', $event)">
              </td>

              <td>
                <input type="text"
                       class="form-control form-control-sm"
                       [(ngModel)]="item.newMTracking"
                       (ngModelChange)="onFieldChange(i, 'newMTracking', $event)">
              </td>

              <td>
                <input type="text"
                       class="form-control form-control-sm"
                       [(ngModel)]="item.oldMSerialNo"
                       (ngModelChange)="onFieldChange(i, 'oldMSerialNo', $event)">
              </td>

              <td>
                <input type="text"
                       class="form-control form-control-sm"
                       [(ngModel)]="item.oldMTracking"
                       (ngModelChange)="onFieldChange(i, 'oldMTracking', $event)">
              </td>

              <td class="text-center">
                <input type="checkbox"
                       class="form-check-input"
                       [checked]="isReceivedTrue(item.received)"
                       (change)="updateReceived(item, $event, i)">
              </td>

            </tr>
          </tbody>

        </table>
      </div>

      <!-- ================= ATTACHMENTS ================= -->
      <div class="attachments-section mt-5">

        <div class="attachment-card">

          <div class="attachment-header">
            <i class="bi bi-paperclip text-primary me-2"></i>
            <span class="fw-semibold">Attachments</span>
          </div>

          <div class="upload-area">

            <input type="file"
                   id="fileInput"
                   multiple
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt"
                   (change)="onFileSelected($event)"
                   hidden>

            <label for="fileInput" class="upload-trigger">
              <i class="bi bi-cloud-upload"></i>
              <span>Select Files</span>
            </label>

            <button class="btn btn-primary ms-3"
                    [disabled]="uploadingFiles || selectedFiles.length === 0"
                    (click)="uploadFiles()">
              <span *ngIf="!uploadingFiles">
                <i class="bi bi-upload me-2"></i>
                Upload
              </span>
              <span *ngIf="uploadingFiles">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Uploading...
              </span>
            </button>

          </div>

          <!-- Selected Files -->
          <div *ngIf="selectedFiles && selectedFiles.length > 0"
               class="file-preview">

            <div class="file-preview-header">
              {{ selectedFiles.length }} file(s) selected
            </div>

            <div *ngFor="let file of selectedFiles; let i = index"
                 class="file-row">

              <div class="file-name">
                <i class="bi bi-file-earmark me-2 text-primary"></i>
                {{ file.name }}
                <small class="text-muted ms-2">
                  ({{ (file.size / 1024 / 1024).toFixed(2) }} MB)
                </small>
              </div>

              <button type="button"
                      class="btn btn-sm btn-danger"
                      (click)="removeFile(i)">
                <i class="bi bi-x"></i>
              </button>

            </div>

          </div>

          <!-- NOTE -->
          <div class="attachment-note">
            <i class="bi bi-info-circle text-primary me-2"></i>
            <strong>Note:</strong>
            File name must not contain spaces (one word only).
            Accepted file types:
            PDF, DOC, DOCX, XLS, XLSX, JPG, JPEG, PNG, TXT.
            Maximum file size: 5MB.
          </div>

        </div>
      </div>

      <!-- Empty -->
      <div *ngIf="!loading && trackingData.length === 0"
           class="alert alert-info text-center mt-4">
        No tools found for selected technician.
      </div>

    </div>
  </div>
</div>
