<!-- Job Notes Information Page -->
<div class="container-fluid">
  <!-- Loading spinner -->
  <div *ngIf="loading" class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Main content -->
  <div *ngIf="!loading">
    <!-- Header section -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
          <!-- Error/Success Messages -->
          <div class="flex-grow-1 text-center">
            <div *ngIf="errorMessage" class="alert alert-danger mb-2">
              {{ errorMessage }}
            </div>
            <div *ngIf="successMessage" class="alert alert-success mb-2">
              {{ successMessage }}
            </div>
          </div>
        </div>

        <!-- Title -->
        <div class="text-center my-3">
          <h4 class="fw-bold" [class.text-danger]="jobInfo?.svcDescr?.toLowerCase()?.includes('emergency')">
            {{ jobTitle }}
          </h4>
        </div>

        <!-- Navigation buttons -->
        <div class="d-flex justify-content-between mb-3">
          <button 
            type="button" 
            class="btn btn-link p-0" 
            (click)="onGoBack()"
            [disabled]="saving">
            <img src="assets/media/icons/backblue.gif" alt="Back" style="border: none;">
          </button>

          <button 
            *ngIf="!isReadOnlyMode"
            type="button" 
            class="btn btn-primary" 
            (click)="onSave()"
            [disabled]="saving">
            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
            {{ saving ? 'Saving...' : 'Save Info' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Job Information Section -->
    <div class="row mb-4" *ngIf="jobInfo">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-borderless job-info-table">
            <tbody>
              <!-- Row 1 -->
              <tr>
                <td class="fw-bold text-end pe-3" style="width: 120px;">Site ID:</td>
                <td style="width: 200px;">
                  <a [href]="getSiteHistoryUrl()" class="text-primary text-decoration-underline">
                    {{ jobInfo.custNmbr }}
                  </a>
                  <small class="text-muted d-block">(Click to View History)</small>
                </td>
                <td class="fw-bold text-end pe-3" style="width: 150px;">Customer Name:</td>
                <td>{{ jobInfo.custName }}</td>
              </tr>

              <!-- Row 2 -->
              <tr>
                <td class="fw-bold text-end pe-3">Contract Type:</td>
                <td>{{ jobInfo.contType }}</td>
                <td class="fw-bold text-end pe-3">Address:</td>
                <td>{{ jobInfo.addr1 }}</td>
              </tr>

              <!-- Row 3 -->
              <tr>
                <td class="fw-bold text-end pe-3">Account Manager:</td>
                <td>{{ jobInfo.accMgr }}</td>
                <td class="fw-bold text-end pe-3">Contact Name:</td>
                <td>{{ jobInfo.contact }}</td>
              </tr>

              <!-- Row 4 -->
              <tr>
                <td class="fw-bold text-end pe-3">Service Call Date:</td>
                <td>{{ jobInfo.strtDate | date:'shortDate' }} {{ jobInfo.strtTime | date:'shortTime' }}</td>
                <td class="fw-bold text-end pe-3">Contact Phone:</td>
                <td>{{ jobInfo.contactPhone }}</td>
              </tr>

              <!-- Row 5 -->
              <tr>
                <td class="fw-bold text-end pe-3">Job Description:</td>
                <td>
                  <input 
                    type="text" 
                    class="form-control-plaintext border-0 p-0" 
                    [value]="jobInfo.svcDescr" 
                    readonly>
                </td>
                <td class="fw-bold text-end pe-3">Techs on this Job:</td>
                <td>{{ otherTechsDisplay }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="row">
          <!-- AM Notes -->
          <div class="col-md-4">
            <label class="fw-bold">AM Notes:</label>
          </div>
          <div class="col-md-8">
            <label class="fw-bold">Service Call Notes:</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Form section (only show if not in read-only mode) -->
    <form [formGroup]="jobNotesForm" *ngIf="!isReadOnlyMode">
      <!-- Tech Notes Section -->
      <div class="row mb-4" *ngIf="jobInfo">
        <div class="col-12">
          <!-- Previous tech notes display -->
          <div class="row mb-3" *ngIf="jobInfo.pmVisualNotes">
            <div class="col-2 text-end">
              <label class="fw-bold">Previous Notes:</label>
            </div>
            <div class="col-10">
              <div class="border p-2 bg-light small" [innerHTML]="jobInfo.pmVisualNotes"></div>
            </div>
          </div>

          <!-- Spell checker info -->
          <div class="row mb-3">
            <div class="col-2"></div>
            <div class="col-10">
              <div class="alert alert-info py-2 px-3 d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <small>
                  <strong>Spell Check:</strong> Right-click on underlined words in text areas for spelling suggestions.
                  Browser spell check is enabled for all text fields.
                </small>
              </div>
            </div>
          </div>

          <!-- Tech Notes Input -->
          <div class="row mb-3">
            <div class="col-2 text-end">
              <label class="fw-bold">Technician Notes:</label>
            </div>
            <div class="col-10">
              <div formArrayName="techNotes">
                <div 
                  *ngFor="let techNoteGroup of techNotesFormArray.controls; let i = index" 
                  [formGroupName]="i" 
                  class="mb-4">
                  
                  <!-- Equipment info header -->
                  <div class="equipment-header mb-2">
                    <strong>
                      <u>{{ techNoteGroup.get('equipNo')?.value }}</u>
                    </strong>
                    - Make: <strong>{{ techNoteGroup.get('vendorId')?.value }}</strong>
                    - Model: <strong>{{ techNoteGroup.get('version')?.value }}</strong>
                    - KVA/Batt: <strong>{{ techNoteGroup.get('rating')?.value }}</strong>
                    - Serial No: <strong>{{ techNoteGroup.get('serialID')?.value }}</strong>
                    - Location: <strong>{{ techNoteGroup.get('location')?.value }}</strong>
                  </div>

                  <!-- Tech note input -->
                  <textarea 
                    formControlName="noteText"
                    class="form-control"
                    rows="4"
                    spellcheck="true"
                    lang="en-US"
                    [class.is-invalid]="techNoteGroup.get('noteText')?.invalid && techNoteGroup.get('noteText')?.touched"
                    placeholder="Enter technician notes for this equipment...">
                  </textarea>
                  
                  <div *ngIf="techNoteGroup.get('noteText')?.invalid && techNoteGroup.get('noteText')?.touched" 
                       class="invalid-feedback">
                    Notes are required for all equipment.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quote Priority -->
          <div class="row mb-3">
            <div class="col-12">
              <table class="table table-borderless">
                <tbody>
                  <tr>
                    <td style="width: 220px;">
                      <label class="fw-bold">Quote Priority</label>
                    </td>
                    <td>
                      <div class="form-check-inline" *ngFor="let option of quotePriorityOptions">
                        <input 
                          class="form-check-input" 
                          type="radio" 
                          [id]="'quotePriority_' + option.value"
                          formControlName="quotePriority" 
                          [value]="option.value">
                        <label class="form-check-label ms-1" [for]="'quotePriority_' + option.value">
                          {{ option.label }}
                        </label>
                      </div>
                      <div *ngIf="jobNotesForm.get('quotePriority')?.invalid && jobNotesForm.get('quotePriority')?.touched" 
                           class="text-danger small mt-1">
                        At least one Quote Priority must be selected
                      </div>
                    </td>
                  </tr>

                  <!-- Equipment Reconciliation -->
                  <tr>
                    <td>
                      <label class="fw-bold text-danger">
                        Did you notice any new equipment or extra battery strings at the site?<br/>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <strong>OR</strong><br/>
                        are there fewer battery strings or has any equipment been removed?
                      </label>
                    </td>
                    <td>
                      <div class="form-check-inline" *ngFor="let option of reconciliationOptions">
                        <input 
                          class="form-check-input" 
                          type="radio" 
                          [id]="'reconciliation_' + option.value"
                          formControlName="reconciliationNewEquip" 
                          [value]="option.value">
                        <label class="form-check-label ms-1" [for]="'reconciliation_' + option.value">
                          {{ option.label }}
                        </label>
                      </div>
                      <div *ngIf="jobNotesForm.get('reconciliationNewEquip')?.invalid && jobNotesForm.get('reconciliationNewEquip')?.touched" 
                           class="text-danger small mt-1">
                        At least one checkbox value must be selected
                      </div>
                    </td>
                  </tr>

                  <!-- Reconciliation Notes -->
                  <tr *ngIf="showReconciliationNotes">
                    <td>
                      <label class="fw-bold">Please enter new equipment details:</label>
                    </td>
                    <td>
                      <textarea 
                        formControlName="reconciliationNotes"
                        class="form-control"
                        rows="5"
                        spellcheck="true"
                        lang="en-US"
                        [class.is-invalid]="jobNotesForm.get('reconciliationNotes')?.invalid && jobNotesForm.get('reconciliationNotes')?.touched"
                        placeholder="Enter details about new or removed equipment...">
                      </textarea>
                      <div *ngIf="jobNotesForm.get('reconciliationNotes')?.invalid && jobNotesForm.get('reconciliationNotes')?.touched" 
                           class="invalid-feedback">
                        Please enter the new equipment details
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Deficiency Notes Section -->
          <div class="row mb-3">
            <div class="col-2 text-end align-top">
              <label class="fw-bold">E-Tech Generated Notes</label>
            </div>
            <div class="col-10">
              <div class="mb-2">
                <button 
                  type="button" 
                  class="btn btn-outline-primary me-3"
                  (click)="onRefreshNotes()"
                  [disabled]="saving">
                  Update Notes
                </button>
                <span class="text-danger small fw-bold">
                  Is the deficiencies and corrective action correct:
                </span>
                <div class="form-check form-check-inline ms-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="deficiencyNotesVerified"
                    formControlName="deficiencyNotesVerified">
                  <label class="form-check-label" for="deficiencyNotesVerified">
                    Verified
                  </label>
                </div>
              </div>
              <div *ngIf="jobNotesForm.get('deficiencyNotesVerified')?.invalid && jobNotesForm.get('deficiencyNotesVerified')?.touched" 
                   class="text-danger small mb-2">
                Please check that you have verified the deficiency notes and corrective action
              </div>
            </div>
          </div>

          <!-- System Generated Notes Display -->
          <div class="row mb-3" *ngIf="systemNotes">
            <div class="col-2"></div>
            <div class="col-10">
              <div class="border p-3 bg-light" [innerHTML]="systemNotes"></div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Read-only display for CON status -->
    <div *ngIf="isReadOnlyMode" class="alert alert-info">
      <h5>Job Completed</h5>
      <p>This job is in completed status. Information is displayed in read-only mode.</p>
      
      <!-- Display job info in read-only format -->
      <div *ngIf="jobInfo" class="mt-3">
        <div class="row mb-2" *ngIf="jobInfo.pmVisualNotes">
          <div class="col-3"><strong>Tech Notes:</strong></div>
          <div class="col-9" [innerHTML]="jobInfo.pmVisualNotes"></div>
        </div>
        
        <div class="row mb-2">
          <div class="col-3"><strong>Quote Priority:</strong></div>
          <div class="col-9">
            <span *ngFor="let option of quotePriorityOptions">
              <span *ngIf="option.value === jobInfo.qtePriority">{{ option.label }}</span>
            </span>
          </div>
        </div>
        
        <div class="row mb-2" *ngIf="reconciliationInfo">
          <div class="col-3"><strong>Equipment Changes:</strong></div>
          <div class="col-9">
            <span *ngFor="let option of reconciliationOptions">
              <span *ngIf="option.value === reconciliationInfo.newEquipment">{{ option.label }}</span>
            </span>
            <div *ngIf="reconciliationInfo.equipmentNotes" class="mt-1">
              <small><strong>Details:</strong> {{ reconciliationInfo.equipmentNotes }}</small>
            </div>
          </div>
        </div>
        
        <div class="row mb-2">
          <div class="col-3"><strong>Deficiency Notes Verified:</strong></div>
          <div class="col-9">{{ jobInfo.defCheck ? 'Yes' : 'No' }}</div>
        </div>
      </div>
    </div>
  </div>
</div>