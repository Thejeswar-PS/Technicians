<div class="container-fluid">
  <!-- Loading State -->
  <div *ngIf="loading" class="d-flex justify-content-center align-items-center p-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <span class="ms-3">Loading equipment details...</span>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !loading" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ errorMessage }}
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage" class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    {{ successMessage }}
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="card">
    <!-- Header -->
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="card-title mb-0">
        <i class="fas fa-edit me-2"></i>
        Edit Equipment Details
      </h4>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" (click)="goBack()">
          <i class="fas fa-arrow-left me-1"></i>
          Back
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="onSave()"
          [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-1" role="status"></span>
          <i *ngIf="!saving" class="fas fa-save me-1"></i>
          {{ saving ? 'Saving...' : 'Save Equipment' }}
        </button>
      </div>
    </div>

    <div class="card-body">
      <div class="row">
        <!-- Left Column - Basic Information -->
        <div class="col-lg-6">
          <form [formGroup]="basicInfoForm" class="equipment-form">
            <h5 class="text-primary border-bottom pb-2 mb-4">Equipment Information</h5>
            
            <!-- Job Number -->
            <div class="form-group mb-3">
              <label class="form-label required">Job Number:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="callNbr"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'callNbr')"
                readonly>
              <div *ngIf="isFieldInvalid(basicInfoForm, 'callNbr')" class="invalid-feedback">
                {{ getFieldError(basicInfoForm, 'callNbr') }}
              </div>
            </div>

            <!-- Equipment No -->
            <div class="form-group mb-3">
              <label class="form-label required">Equipment No:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="equipNo"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'equipNo')"
                readonly>
              <div *ngIf="isFieldInvalid(basicInfoForm, 'equipNo')" class="invalid-feedback">
                {{ getFieldError(basicInfoForm, 'equipNo') }}
              </div>
            </div>

            <!-- Serial No -->
            <div class="form-group mb-3">
              <label class="form-label">Serial No:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="serialId"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'serialId')">
            </div>

            <!-- Location -->
            <div class="form-group mb-3">
              <label class="form-label">Location:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="location"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'location')">
            </div>

            <!-- DateCode Month & Year -->
            <div class="form-group mb-3">
              <label class="form-label">DateCode Month & Year:</label>
              <div class="d-flex gap-2">
                <input 
                  type="text" 
                  class="form-control" 
                  placeholder="Month"
                  formControlName="dateCodeMonth"
                  [class.is-invalid]="isFieldInvalid(basicInfoForm, 'dateCodeMonth')">
                <input 
                  type="number" 
                  class="form-control" 
                  placeholder="Year"
                  min="1900"
                  max="2100"
                  formControlName="dateCodeYear"
                  [class.is-invalid]="isFieldInvalid(basicInfoForm, 'dateCodeYear')">
              </div>
              <div *ngIf="isFieldInvalid(basicInfoForm, 'dateCodeYear')" class="invalid-feedback d-block">
                {{ getFieldError(basicInfoForm, 'dateCodeYear') }}
              </div>
            </div>

            <!-- Status -->
            <div class="form-group mb-3">
              <label class="form-label required">Status:</label>
              <select 
                class="form-select" 
                formControlName="status"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'status')">
                <option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid(basicInfoForm, 'status')" class="invalid-feedback">
                {{ getFieldError(basicInfoForm, 'status') }}
              </div>
            </div>

            <!-- Equipment Type -->
            <div class="form-group mb-3">
              <label class="form-label required">Equipment Type:</label>
              <select 
                class="form-select" 
                formControlName="equipType"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'equipType')">
                <option *ngFor="let option of equipmentTypeOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid(basicInfoForm, 'equipType')" class="invalid-feedback">
                {{ getFieldError(basicInfoForm, 'equipType') }}
              </div>
            </div>

            <!-- Float Voltage Selection -->
            <div class="form-group mb-3">
              <label class="form-label">Float Voltage Selection:</label>
              <select class="form-select" formControlName="floatVoltageSelection">
                <option *ngFor="let option of floatVoltageOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>

            <!-- # of Battery Packs -->
            <div class="form-group mb-3">
              <label class="form-label"># of Battery Packs:</label>
              <input 
                type="number" 
                class="form-control" 
                formControlName="batteryPackCount"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'batteryPackCount')">
              <div *ngIf="isFieldInvalid(basicInfoForm, 'batteryPackCount')" class="invalid-feedback">
                {{ getFieldError(basicInfoForm, 'batteryPackCount') }}
              </div>
            </div>

            <!-- Battery Panel (shown for BATTERY type) -->
            <div *ngIf="showBatteryPanel" class="battery-panel border rounded p-3 mb-3 bg-light">
              <h6 class="text-secondary mb-3">Battery Information</h6>
              
              <!-- Batteries per string -->
              <div class="form-group mb-3">
                <label class="form-label required">Batteries per string:</label>
                <input 
                  type="number" 
                  class="form-control" 
                  formControlName="batteriesPerString"
                  [class.is-invalid]="isFieldInvalid(basicInfoForm, 'batteriesPerString')">
                <div *ngIf="isFieldInvalid(basicInfoForm, 'batteriesPerString')" class="invalid-feedback">
                  {{ getFieldError(basicInfoForm, 'batteriesPerString') }}
                </div>
              </div>

              <!-- Reading Type -->
              <div class="form-group mb-3">
                <label class="form-label">Reading Type:</label>
                <select class="form-select" formControlName="readingType">
                  <option *ngFor="let option of readingTypeOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>
            </div>

            <!-- UPS KVA -->
            <div class="form-group mb-3">
              <label class="form-label">UPS KVA:</label>
              <input 
                type="number" 
                step="0.1"
                class="form-control" 
                formControlName="kva"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'kva')">
              <div *ngIf="isFieldInvalid(basicInfoForm, 'kva')" class="invalid-feedback">
                {{ getFieldError(basicInfoForm, 'kva') }}
              </div>
            </div>

            <!-- Vendor ID -->
            <div class="form-group mb-3">
              <label class="form-label">Vendor ID:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="vendorId"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'vendorId')">
            </div>

            <!-- Version -->
            <div class="form-group mb-3">
              <label class="form-label">Version:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="version"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'version')">
            </div>

            <!-- Tag -->
            <div class="form-group mb-3">
              <label class="form-label">Tag:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="tag"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'tag')">
            </div>

            <!-- Contract -->
            <div class="form-group mb-3">
              <label class="form-label">Contract:</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="contract"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'contract')">
            </div>

            <!-- Task Description -->
            <div class="form-group mb-3">
              <label class="form-label">Task Description:</label>
              <textarea 
                class="form-control" 
                rows="3"
                formControlName="taskDescription"
                [class.is-invalid]="isFieldInvalid(basicInfoForm, 'taskDescription')">
              </textarea>
            </div>
          </form>
        </div>

        <!-- Right Column - Capacitor Panel & Board Details -->
        <div class="col-lg-6">
          
          <!-- Capacitor Panel (shown for UPS type) -->
          <div *ngIf="showCapacitorPanel" class="capacitor-panel mb-4">
            <form [formGroup]="capacitorForm">
              <h5 class="text-primary border-bottom pb-2 mb-4">UPS Capacitor Information</h5>
              
              <!-- DC Caps -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">DC Capacitors</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">DC Caps Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="dcfCapsPartNo" maxlength="50"
                           [class.is-invalid]="hasError('dcfCapsPartNo', capacitorForm, 'maxlength')"
                           (input)="onPartNumberInput($event, 'dcfCapsPartNo', 50)"
                           (focus)="onPartNumberFocus($event, 'dcfCapsPartNo')"
                           (blur)="onPartNumberBlur($event, 'dcfCapsPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('dcfCapsPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('dcfCapsPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="dcfQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="dcfMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="dcfYear">
                  </div>
                </div>
              </div>

              <!-- AC I/P Caps -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">AC Input Capacitors</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">AC I/P Caps Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="acfipCapsPartNo" maxlength="50"
                           [class.is-invalid]="hasError('acfipCapsPartNo', capacitorForm, 'maxlength')"
                           (input)="onPartNumberInput($event, 'acfipCapsPartNo', 50)"
                           (focus)="onPartNumberFocus($event, 'acfipCapsPartNo')"
                           (blur)="onPartNumberBlur($event, 'acfipCapsPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('acfipCapsPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('acfipCapsPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="acfQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="acfMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="acfYear">
                  </div>
                </div>
              </div>

              <!-- AC O/P WYE Caps -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">AC Output WYE Capacitors</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">AC O/P WYE Caps Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="dcCommCapsPartNo" maxlength="50"
                           [class.is-invalid]="hasError('dcCommCapsPartNo', capacitorForm, 'maxlength')"
                           (input)="onPartNumberInput($event, 'dcCommCapsPartNo', 50)"
                           (focus)="onPartNumberFocus($event, 'dcCommCapsPartNo')"
                           (blur)="onPartNumberBlur($event, 'dcCommCapsPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('dcCommCapsPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('dcCommCapsPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="commQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="commMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="commYear">
                  </div>
                </div>
              </div>

              <!-- AC O/P Delta Caps -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">AC Output Delta Capacitors</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">AC O/P Delta Caps Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="acfopCapsPartNo" maxlength="50"
                           [class.is-invalid]="hasError('acfopCapsPartNo', capacitorForm, 'maxlength')"
                           (input)="onPartNumberInput($event, 'acfopCapsPartNo', 50)"
                           (focus)="onPartNumberFocus($event, 'acfopCapsPartNo')"
                           (blur)="onPartNumberBlur($event, 'acfopCapsPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('acfopCapsPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('acfopCapsPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="acfopQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="acfopMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="acfopYear">
                  </div>
                </div>
              </div>

              <!-- Fans -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">Fans</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">Fans Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="fansPartNo" maxlength="100"
                           [class.is-invalid]="hasError('fansPartNo', capacitorForm, 'maxlength')"
                           (focus)="onPartNumberFocus($event, 'fansPartNo')"
                           (blur)="onPartNumberBlur($event, 'fansPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('fansPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('fansPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="fansQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="fansMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="fansYear">
                  </div>
                </div>
              </div>

              <!-- Blowers -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">Blowers</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">Blowers Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="blowersPartNo" maxlength="100"
                           [class.is-invalid]="hasError('blowersPartNo', capacitorForm, 'maxlength')"
                           (focus)="onPartNumberFocus($event, 'blowersPartNo')"
                           (blur)="onPartNumberBlur($event, 'blowersPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('blowersPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('blowersPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="blowersQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="blowersMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="blowersYear">
                  </div>
                </div>
              </div>

              <!-- Miscellaneous -->
              <div class="cap-section mb-4">
                <h6 class="text-secondary mb-3">Miscellaneous</h6>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label small">Miscellaneous Part #</label>
                    <input type="text" class="form-control form-control-sm" formControlName="miscPartNo" maxlength="100"
                           [class.is-invalid]="hasError('miscPartNo', capacitorForm, 'maxlength')"
                           (focus)="onPartNumberFocus($event, 'miscPartNo')"
                           (blur)="onPartNumberBlur($event, 'miscPartNo')">
                    <div class="invalid-feedback" *ngIf="hasError('miscPartNo', capacitorForm, 'maxlength')">
                      {{ getErrorMessage('miscPartNo', capacitorForm) }}
                    </div>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Qty</label>
                    <input type="number" class="form-control form-control-sm" formControlName="miscQty">
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label small">Month</label>
                    <select class="form-select form-control-sm" formControlName="miscMonth">
                      <option value="">Select Month</option>
                      <option *ngFor="let month of monthOptions" [value]="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Year</label>
                    <input type="number" class="form-control form-control-sm" formControlName="miscYear">
                  </div>
                </div>
              </div>

              <!-- Comments -->
              <div class="form-group mb-3">
                <label class="form-label">Comments:</label>
                <textarea 
                  class="form-control form-control-sm" 
                  rows="4"
                  formControlName="comments"
                  maxlength="1000"
                  [class.is-invalid]="hasError('comments', capacitorForm, 'maxlength')"
                  (focus)="onPartNumberFocus($event, 'comments')"
                  (blur)="onPartNumberBlur($event, 'comments')">
                </textarea>
                <div class="invalid-feedback" *ngIf="hasError('comments', capacitorForm, 'maxlength')">
                  {{ getErrorMessage('comments', capacitorForm) }}
                </div>
              </div>
            </form>
          </div>

          <!-- Board Details Panel (shown for UPS type) -->
          <div *ngIf="showBoardPanel" class="board-panel">
            <form [formGroup]="boardDetailsForm">
              <h5 class="text-primary border-bottom pb-2 mb-4">Equipment Board / Assembly Details</h5>
              
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-primary">
                    <tr>
                      <th style="width: 40px;">ID</th>
                      <th style="width: 150px;">Part No</th>
                      <th style="width: 60px;">Qty</th>
                      <th style="width: 200px;">Description</th>
                      <th>Comments</th>
                    </tr>
                  </thead>
                  <tbody formArrayName="boardItems">
                    <tr *ngFor="let item of boardItemsArray.controls; let i = index" [formGroupName]="i">
                      <td class="text-center align-middle">{{ i + 1 }}</td>
                      <td>
                        <input 
                          type="text" 
                          class="form-control form-control-sm border-0" 
                          formControlName="partNo"
                          placeholder="Enter part number">
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-control form-control-sm border-0 text-center" 
                          formControlName="qty"
                          placeholder="Qty">
                      </td>
                      <td>
                        <input 
                          type="text" 
                          class="form-control form-control-sm border-0" 
                          formControlName="description"
                          placeholder="Enter description">
                      </td>
                      <td>
                        <input 
                          type="text" 
                          class="form-control form-control-sm border-0" 
                          formControlName="comments"
                          placeholder="Enter comments">
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="card-footer d-flex justify-content-between">
      <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
        <i class="fas fa-times me-1"></i>
        Cancel
      </button>
      <button 
        type="button" 
        class="btn btn-success" 
        (click)="onSave()"
        [disabled]="saving">
        <span *ngIf="saving" class="spinner-border spinner-border-sm me-1" role="status"></span>
        <i *ngIf="!saving" class="fas fa-save me-1"></i>
        {{ saving ? 'Saving...' : 'Save Equipment' }}
      </button>
    </div>
  </div>
</div>