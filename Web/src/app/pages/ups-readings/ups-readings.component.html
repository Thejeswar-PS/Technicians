<!-- UPS Readings Page -->
<div class="container-fluid ups-readings-container">
  <!-- Loading spinner -->
  <div
    *ngIf="loading"
    class="d-flex justify-content-center align-items-center ups-readings-loading"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="ups-readings-header__top mb-4 d-flex justify-content-between align-items-center">
    <button
      type="button"
      class="btn btn-sm btn-primary ups-readings-header__back"
      (click)="onGoBack()"
      [disabled]="saving"
    >
      <i class="bi bi-arrow-left me-2"></i>
      Back
    </button>
    
    <!-- Page Title - Centered between buttons -->
    <div class="ups-page-title">
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-speedometer2 me-2"></i>
        UPS Readings & Verification
      </h2>
      <!-- Job and Equipment Information -->
      <div class="text-dark mt-2" *ngIf="!loading">
        <span class="fw-semibold">Job ID: {{ callNbr || 'N/A' }} | Equipment ID: {{ equipId || 'N/A' }} | UPS ID: {{ upsId || 'N/A' }}</span>
      </div>
    </div>
    
    <button
      type="button"
      class="btn btn-sm btn-primary ups-readings-header__action"
      (click)="onSave()"
      [disabled]="saving"
    >
      <span
        *ngIf="saving"
        class="spinner-border spinner-border-sm me-2"
        role="status"
      ></span>
      <i *ngIf="!saving" class="bi bi-check-circle me-2"></i>
      {{ saving ? "Saving..." : "Save UPS Data" }}
    </button>
  </div>

  <!-- Main content -->
  <div *ngIf="!loading">
    <div class="card shadow-sm ups-main-card">
      <div class="card-header border-0 py-4">
        <div class="ups-readings-header">
          <div class="ups-readings-header__group"></div>

        <!-- Messages -->
        <div
          class="ups-readings-messages"
          *ngIf="errorMessage || successMessage"
        >
          <div
            *ngIf="errorMessage"
            class="alert alert-danger d-inline-flex align-items-center"
          >
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span>{{ errorMessage }}</span>
          </div>
          <div
            *ngIf="
              successMessage && successMessage.includes('No Information Found')
            "
            class="alert alert-warning d-inline-flex align-items-center"
          >
            <i class="bi bi-info-circle-fill me-2"></i>
            <span>{{ successMessage }}</span>
          </div>
          <div
            *ngIf="
              successMessage && !successMessage.includes('No Information Found')
            "
            class="alert alert-success d-inline-flex align-items-center"
          >
            <i class="bi bi-check-circle-fill me-2"></i>
            <span>{{ successMessage }}</span>
          </div>
        </div>
      </div>

      <!-- Form sections within card body -->
      <div class="card-body">
        <div class="ups-readings-form">
      <!-- Equipment Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showReconciliation = !showReconciliation"
          >
            <div class="ups-section-title">
              <i class="bi bi-gear-wide-connected me-2 text-primary"></i>
              <h5 class="mb-0">Equipment Verification</h5>
              <small class="text-muted"
                >Verify UPS equipment details and specifications</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showReconciliation"
              [class.bi-chevron-right]="!showReconciliation"
              [class.rotate-90]="showReconciliation"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showReconciliation">
            <form [formGroup]="equipmentForm" class="ups-form">
              <!-- Basic Equipment Information -->
              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="manufacturer"
                        [class.is-invalid]="
                          equipmentForm.get('manufacturer')?.invalid &&
                          equipmentForm.get('manufacturer')?.touched
                        "
                        id="manufacturer"
                      >
                        <option value="">Choose manufacturer...</option>
                        <option
                          *ngFor="let mfg of manufacturers"
                          [value]="mfg.value"
                        >
                          {{ mfg.text }}
                        </option>
                      </select>
                      <label for="manufacturer"
                        >Make <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('manufacturer')?.invalid &&
                          equipmentForm.get('manufacturer')?.touched
                        "
                      >
                        Make is required
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="model"
                        [class.is-invalid]="
                          equipmentForm.get('model')?.invalid &&
                          equipmentForm.get('model')?.touched
                        "
                        id="model"
                        placeholder="e.g., 9315-225"
                        [maxlength]="getCharacterLimit('modelNo') || null"
                      />
                      <label for="model"
                        >Model No <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('model')?.invalid &&
                          equipmentForm.get('model')?.touched
                        "
                      >
                        Model No is required
                      </div>
                      <!-- Character Limit Warning -->
                      <div
                        class="text-warning small mt-1"
                        *ngIf="hasCharacterLimitError('EquipmentForm', 'model')"
                      >
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ getCharacterLimitError('EquipmentForm', 'model') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="ctoPartNo"
                        id="ctoPartNo"
                        placeholder="e.g., P30002167714104"
                        [maxlength]="getCharacterLimit('ctoPartNo') || null"
                      />
                      <label for="ctoPartNo">CTO / Part No</label>
                      <!-- Character Limit Warning -->
                      <div
                        class="text-warning small mt-1"
                        *ngIf="hasCharacterLimitError('EquipmentForm', 'ctoPartNo')"
                      >
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ getCharacterLimitError('EquipmentForm', 'ctoPartNo') }}
                      </div>

                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="serialNo"
                        [class.is-invalid]="
                          equipmentForm.get('serialNo')?.invalid &&
                          equipmentForm.get('serialNo')?.touched
                        "
                        id="serialNo"
                        placeholder="e.g., EB033ZBX02"
                        [maxlength]="getCharacterLimit('serialNo') || null"
                      />
                      <label for="serialNo"
                        >Serial No <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('serialNo')?.invalid &&
                          equipmentForm.get('serialNo')?.touched
                        "
                      >
                        Serial No is required
                      </div>
                      <!-- Character Limit Warning -->
                      <div
                        class="text-warning small mt-1"
                        *ngIf="hasCharacterLimitError('EquipmentForm', 'serialNo')"
                      >
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ getCharacterLimitError('EquipmentForm', 'serialNo') }}
                      </div>

                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="location"
                        [class.is-invalid]="
                          equipmentForm.get('location')?.invalid &&
                          equipmentForm.get('location')?.touched
                        "
                        id="location"
                        placeholder="e.g., Room A224A, 2nd Floor"
                        [maxlength]="getCharacterLimit('location') || null"
                      />
                      <label for="location"
                        >Location <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('location')?.invalid &&
                          equipmentForm.get('location')?.touched
                        "
                      >
                        Location is required
                      </div>
                      <!-- Restricted Character Error -->
                      <div
                        class="text-danger small mt-1"
                        *ngIf="hasRestrictedCharError('EquipmentForm', 'location')"
                      >
                        <i class="bi bi-exclamation-circle me-1"></i>
                        {{ getRestrictedCharError('EquipmentForm', 'location') }}
                      </div>
                      <!-- Character Limit Warning -->
                      <div
                        class="text-warning small mt-1"
                        *ngIf="hasCharacterLimitError('EquipmentForm', 'location')"
                      >
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ getCharacterLimitError('EquipmentForm', 'location') }}
                      </div>

                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="status"
                        [class.is-invalid]="
                          equipmentForm.get('status')?.invalid &&
                          equipmentForm.get('status')?.touched
                        "
                        (change)="onStatusDropdownChange($event)"
                        id="status"
                      >
                        <option value="" disabled selected>Please select status</option>
                        <option
                          *ngFor="let status of currentStatusOptions"
                          [value]="status.value"
                        >
                          {{ status.text }}
                        </option>
                      </select>
                      <label for="status"
                        >Status <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('status')?.invalid &&
                          equipmentForm.get('status')?.touched
                        "
                      >
                        Status is required
                      </div>
                    </div>
                    

                  </div>
                </div>
              </div>

              <!-- Additional Equipment Details -->
              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="maintByPass"
                        id="maintByPass"
                      >
                        <option value="">Choose bypass type...</option>
                        <option
                          *ngFor="let option of maintenanceBypassTypes"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="maintByPass">Maintenance Bypass</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="number"
                        class="form-control"
                        formControlName="kva"
                        [class.is-invalid]="
                          equipmentForm.get('kva')?.invalid &&
                          equipmentForm.get('kva')?.touched
                        "
                        id="kva"
                        step="any"
                        min="0"
                        max="10000"
                      />
                      <label for="kva"
                        >KVA Rating <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('kva')?.invalid &&
                          equipmentForm.get('kva')?.touched
                        "
                      >
                        <span *ngIf="equipmentForm.get('kva')?.errors?.['required']">KVA Rating is required</span>
                        <span *ngIf="equipmentForm.get('kva')?.errors?.['pattern']">{{ equipmentForm.get('kva')?.errors?.['pattern']?.message || 'Please enter valid KVA (integers, decimals, or floats like 16.5, 225.00)' }}</span>
                        <span *ngIf="equipmentForm.get('kva')?.errors?.['min']">{{ equipmentForm.get('kva')?.errors?.['min']?.message || 'KVA must be greater than 0' }}</span>
                        <span *ngIf="equipmentForm.get('kva')?.errors?.['max']">{{ equipmentForm.get('kva')?.errors?.['max']?.message || 'KVA value is too high' }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="multiModule"
                        id="multiModule"
                      >
                        <option value="">Choose configuration...</option>
                        <option
                          *ngFor="let option of multiModuleTypes"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="multiModule">Multi-Module</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="parallelCabinet"
                        id="parallelCabinet"
                      >
                        <option value="Y">Yes</option>
                        <option value="NO">No</option>
                        <option value="NA">N/A</option>
                      </select>
                      <label for="parallelCabinet">Parallel Cabinet</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="snmpPresent"
                        id="snmpPresent"
                      >
                        <option *ngFor="let option of snmpOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="snmpPresent">SNMP Card Present</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="upsType"
                        id="upsType"
                      >
                        <option value="">Choose type...</option>
                        <option
                          *ngFor="let option of upsTypes"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="upsType">UPS Type</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating position-relative">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="monthName"
                        [class.is-invalid]="
                          equipmentForm.get('monthName')?.invalid &&
                          equipmentForm.get('monthName')?.touched
                        "
                        id="monthName"
                        placeholder="Enter month (e.g., Jan, Feb, Mar...)"
                        (focus)="toggleMonthCalendar()">
                      
                      <label for="monthName">
                        Month <span class="text-danger">*</span>
                      </label>
                      
                      <!-- Month calendar toggle button -->
                      <button
                        type="button"
                        class="btn btn-sm btn-primary calendar-toggle-btn"
                        (click)="toggleMonthCalendar()"
                        [title]="showMonthCalendar ? 'Hide Month Picker' : 'Show Month Picker'"
                      >
                        <i class="bi bi-calendar-date"></i>
                      </button>
                      
                      <!-- Month Calendar Picker -->
                      <div class="compact-calendar-dropdown" *ngIf="showMonthCalendar">
                        <div class="calendar-header">
                          <h6 class="mb-0">Select Month</h6>
                        </div>
                        <div class="month-grid-compact">
                          <button
                            type="button"
                            *ngFor="let month of monthNames; let i = index"
                            class="btn btn-sm month-btn-compact"
                            [class.btn-primary]="isCurrentMonthSelected(i)"
                            [class.btn-outline-primary]="!isCurrentMonthSelected(i)"
                            (click)="onCalendarMonthSelect(i)"
                          >
                            {{ month.substring(0, 3) }}
                          </button>
                        </div>
                      </div>
                      
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('monthName')?.invalid &&
                          equipmentForm.get('monthName')?.touched
                        "
                      >
                        <span *ngIf="equipmentForm.get('monthName')?.errors?.['required']">Month is required</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating position-relative">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="year"
                        [class.is-invalid]="
                          equipmentForm.get('year')?.invalid &&
                          equipmentForm.get('year')?.touched
                        "
                        id="year"
                        placeholder="Enter year (e.g., 2024, 2025...)"
                        (focus)="toggleYearCalendar()">
                      
                      <label for="year">
                        Year <span class="text-danger">*</span>
                      </label>
                      
                      <!-- Year calendar toggle button -->
                      <button
                        type="button"
                        class="btn btn-sm btn-primary calendar-toggle-btn"
                        (click)="toggleYearCalendar()"
                        [title]="showYearCalendar ? 'Hide Year Picker' : 'Show Year Picker'"
                      >
                        <i class="bi bi-calendar-date"></i>
                      </button>
                      
                      <!-- Year Calendar Picker -->
                      <div class="compact-calendar-dropdown" *ngIf="showYearCalendar" (click)="$event.stopPropagation()">
                        <div class="calendar-header">
                          <div class="year-navigation-header" (click)="$event.stopPropagation()">
                            <button 
                              type="button" 
                              class="btn btn-sm btn-link text-white year-nav-btn"
                              (click)="navigateYearRange('prev'); $event.stopPropagation()"
                              title="Previous years"
                              [disabled]="yearRangeStart <= minYear"
                            >
                              <i class="bi bi-chevron-double-left"></i>
                            </button>
                            <span class="year-range-display">{{ getCurrentYearRange() }}</span>
                            <button 
                              type="button" 
                              class="btn btn-sm btn-link text-white year-nav-btn"
                              (click)="navigateYearRange('next'); $event.stopPropagation()"
                              title="Next years"
                              [disabled]="yearRangeEnd >= maxYear"
                            >
                              <i class="bi bi-chevron-double-right"></i>
                            </button>
                          </div>
                        </div>
                        <div class="year-grid-compact" [attr.data-change-counter]="yearRangeChangeCounter">
                          <button
                            type="button"
                            *ngFor="let year of currentYears; trackBy: trackByYear"
                            class="btn btn-sm year-btn-compact"
                            [class.btn-primary]="isCurrentYearSelected(year)"
                            [class.btn-outline-primary]="!isCurrentYearSelected(year)"
                            (click)="onCalendarYearSelect(year)"
                          >
                            {{ year }}
                          </button>
                        </div>
                      </div>
                      
                      <div
                        class="invalid-feedback"
                        *ngIf="
                          equipmentForm.get('year')?.invalid &&
                          equipmentForm.get('year')?.touched
                        "
                      >
                        <span *ngIf="equipmentForm.get('year')?.errors?.['required']">Year is required</span>
                        <span *ngIf="equipmentForm.get('year')?.errors?.['min']">Year must be at least 1990</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Equipment Reconciliation Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showReconciliationDetails = !showReconciliationDetails"
          >
            <div class="ups-section-title">
              <i class="bi bi-check2-square me-2 text-success"></i>
              <h5 class="mb-0">Equipment Reconciliation</h5>
              <small class="text-muted"
                >Verify equipment data matches physical observations</small
              >
            </div>
            <div class="d-flex align-items-center gap-3" [formGroup]="reconciliationForm" (click)="$event.stopPropagation()">
              <div class="verification-status">
                <div class="form-check d-flex align-items-center">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    formControlName="verified"
                    id="verifiedHeader"
                  />
                  <label
                    class="form-check-label fw-semibold"
                    [class]="
                      reconciliationForm.get('verified')?.value
                        ? 'text-success'
                        : 'text-muted'
                    "
                    for="verifiedHeader"
                  >
                    <i
                      class="bi me-1"
                      [class]="
                        reconciliationForm.get('verified')?.value
                          ? 'bi-check-circle-fill text-success'
                          : 'bi-circle text-muted'
                      "
                    ></i>
                    Verified
                  </label>
                </div>
              </div>
              <i
                class="bi transition-transform"
                [class.bi-chevron-down]="showReconciliationDetails"
                [class.bi-chevron-right]="!showReconciliationDetails"
                [class.rotate-90]="showReconciliationDetails"
              ></i>
            </div>
          </div>

          <div
            class="ups-section-content"
            [class.show]="showReconciliationDetails"
          >
            <div
              class="alert alert-info ups-info-tip d-flex align-items-center mb-4"
            >
              <i class="bi bi-info-circle me-2"></i>
              <small>
                Verify that the current equipment values match what is
                physically observed. Select "Yes" if correct, "No" if incorrect,
                or "N/A" if not applicable.
              </small>
            </div>

            <form [formGroup]="reconciliationForm" class="ups-form">
              <!-- Model Reconciliation -->
              <div class="reconciliation-row">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="model"
                        id="reconModel"
                        readonly
                      />
                      <label for="reconModel">Current Model</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="modelCorrect"
                        id="modelCorrect"
                      >
                        <option value="" disabled>Please select</option>
                        <option
                          *ngFor="let option of yesNoNAOptions"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="modelCorrect">Is this Correct ?</label>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="actModel"
                        [readonly]="reconciliationForm.get('modelCorrect')?.value !== 'N'"
                        [class.is-invalid]="hasRestrictedCharError('ReconciliationForm', 'actModel')"
                        id="actModel"
                        placeholder="Enter actual model if different"
                      />
                      <label for="actModel"
                        >Actual Model
                        <span class="text-muted">(if different)</span></label
                      >
                      <!-- Restricted Character Error -->
                      <div
                        class="text-danger small mt-1"
                        *ngIf="hasRestrictedCharError('ReconciliationForm', 'actModel')"
                      >
                        <i class="bi bi-exclamation-circle me-1"></i>
                        {{ getRestrictedCharError('ReconciliationForm', 'actModel') }}
                      </div>
                    </div>
                  </div>
                  <div
                    class="col-md-1 d-flex align-items-center justify-content-center"
                  >
                    <div class="verification-indicator">
                      <i
                        class="bi bi-check-circle-fill text-success"
                        *ngIf="
                          reconciliationForm.get('modelCorrect')?.value === 'Y'
                        "
                      ></i>
                      <i
                        class="bi bi-dash-circle text-muted"
                        *ngIf="
                          reconciliationForm.get('modelCorrect')?.value ===
                          'N/A'
                        "
                      ></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Serial Number Reconciliation -->
              <div class="reconciliation-row">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="serialNo"
                        id="reconSerialNo"
                        readonly
                      />
                      <label for="reconSerialNo">Current Serial No</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="serialNoCorrect"
                        id="serialNoCorrect"
                      >
                        <option value="" disabled>Please select</option>
                        <option
                          *ngFor="let option of yesNoNAOptions"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="serialNoCorrect">Is this Correct ?</label>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="actSerialNo"
                        [readonly]="reconciliationForm.get('serialNoCorrect')?.value !== 'N'"
                        [class.is-invalid]="hasRestrictedCharError('ReconciliationForm', 'actSerialNo')"
                        id="actSerialNo"
                        placeholder="Enter actual serial number if different"
                      />
                      <label for="actSerialNo"
                        >Actual Serial No
                        <span class="text-muted">(if different)</span></label
                      >
                      <!-- Restricted Character Error -->
                      <div
                        class="text-danger small mt-1"
                        *ngIf="hasRestrictedCharError('ReconciliationForm', 'actSerialNo')"
                      >
                        <i class="bi bi-exclamation-circle me-1"></i>
                        {{ getRestrictedCharError('ReconciliationForm', 'actSerialNo') }}
                      </div>
                    </div>
                  </div>
                  <div
                    class="col-md-1 d-flex align-items-center justify-content-center"
                  >
                    <div class="verification-indicator">
                      <i
                        class="bi bi-check-circle-fill text-success"
                        *ngIf="
                          reconciliationForm.get('serialNoCorrect')?.value ===
                          'Y'
                        "
                      ></i>
                      <i
                        class="bi bi-dash-circle text-muted"
                        *ngIf="
                          reconciliationForm.get('serialNoCorrect')?.value ===
                          'N/A'
                        "
                      ></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- KVA Size Reconciliation -->
              <div class="reconciliation-row">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="kvaSize"
                        id="reconKvaSize"
                        readonly
                      />
                      <label for="reconKvaSize">Current KVA Size</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="kvaCorrect"
                        id="kvaCorrect"
                      >
                        <option value="" disabled>Please select</option>
                        <option
                          *ngFor="let option of yesNoNAOptions"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="kvaCorrect">Is this Correct ?</label>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="actKVA"
                        [readonly]="reconciliationForm.get('kvaCorrect')?.value !== 'N'"
                        [class.is-invalid]="hasRestrictedCharError('ReconciliationForm', 'actKVA')"
                        id="actKVA"
                        placeholder="Enter actual KVA if different"
                      />
                      <label for="actKVA"
                        >Actual KVA
                        <span class="text-muted">(if different)</span></label
                      >
                      <!-- Restricted Character Error -->
                      <div
                        class="text-danger small mt-1"
                        *ngIf="hasRestrictedCharError('ReconciliationForm', 'actKVA')"
                      >
                        <i class="bi bi-exclamation-circle me-1"></i>
                        {{ getRestrictedCharError('ReconciliationForm', 'actKVA') }}
                      </div>
                    </div>
                  </div>
                  <div
                    class="col-md-1 d-flex align-items-center justify-content-center"
                  >
                    <div class="verification-indicator">
                      <i
                        class="bi bi-check-circle-fill text-success"
                        *ngIf="
                          reconciliationForm.get('kvaCorrect')?.value === 'Y'
                        "
                      ></i>
                      <i
                        class="bi bi-dash-circle text-muted"
                        *ngIf="
                          reconciliationForm.get('kvaCorrect')?.value === 'N/A'
                        "
                      ></i>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Measurements Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showMeasurements = !showMeasurements"
          >
            <div class="ups-section-title">
              <i class="bi bi-clipboard-data me-2 text-warning"></i>
              <h5 class="mb-0">System Measurements</h5>
              <small class="text-muted"
                >Verify UPS operational parameters and performance</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showMeasurements"
              [class.bi-chevron-right]="!showMeasurements"
              [class.rotate-90]="showMeasurements"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showMeasurements">
            <form [formGroup]="measurementsForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-power text-primary"></i>
                    <h6 class="mb-0">Power Synchronization</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Verifying that the UPS is properly synchronized to INPUT
                      power and operating properly:</label
                    >
                    <select class="form-select" formControlName="inputPower">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-display text-info"></i>
                    <h6 class="mb-0">Display Functionality</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Verifying LCD backlight and contrast controls are
                      functional and all display pixels are visible:</label
                    >
                    <select class="form-select" formControlName="lcd">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-speedometer text-danger"></i>
                    <h6 class="mb-0">Load Verification</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >% load (KVA) on UPS is not overloaded > 85%:</label
                    >
                    <select class="form-select" formControlName="loadKVA">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-diagram-3 text-success"></i>
                    <h6 class="mb-0">Phase Balance</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Are all 3 input currents within 20% balance?</label
                    >
                    <select class="form-select" formControlName="threePhase">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-check-circle text-success"></i>
                    <h6 class="mb-0">Normal Operation</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >UPS is in normal operational mode:</label
                    >
                    <select class="form-select" formControlName="normal">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-gear text-secondary"></i>
                    <h6 class="mb-0">Calibration</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label">Verify system calibration:</label>
                    <select class="form-select" formControlName="caliberation">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-calendar-x text-warning"></i>
                    <h6 class="mb-0">End of Life</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >UPS date code is < 25 years (End of Life):</label
                    >
                    <select class="form-select" formControlName="endOfLife">
                      <option
                        *ngFor="let option of measurementOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Visual and Mechanical Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div class="ups-section-header" (click)="showVisual = !showVisual">
            <div class="ups-section-title">
              <i class="bi bi-eye me-2 text-info"></i>
              <h5 class="mb-0">Visual & Mechanical Verification</h5>
              <small class="text-muted"
                >Inspect physical condition and mechanical components</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showVisual"
              [class.bi-chevron-right]="!showVisual"
              [class.rotate-90]="showVisual"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showVisual">
            <form [formGroup]="visualForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-power text-success"></i>
                    <h6 class="mb-0">UPS Online Status</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >UPS on-line without alarms:</label
                    >
                    <select class="form-select" formControlName="upsOnline">
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-wrench text-primary"></i>
                    <h6 class="mb-0">Connection Tightness</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Check all nuts, bolts, screws and connections for tightness:</label
                    >
                    <select class="form-select" formControlName="checkConnections">
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-search text-warning"></i>
                    <h6 class="mb-0">Damage Inspection</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Inspect for broken, damaged, or burned components as well as cables:</label
                    >
                    <select class="form-select" formControlName="inspectDamage">
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-brush text-info"></i>
                    <h6 class="mb-0">Cleaning & Maintenance</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Vacuum interior of UPS and wipe down exterior:</label
                    >
                    <select class="form-select" formControlName="vacuumClean">
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-shield-exclamation text-danger"></i>
                    <h6 class="mb-0">EPO Switch Cover</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Verify there is a cover on the EPO switch:</label
                    >
                    <select class="form-select" formControlName="epoSwitch">
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-fan text-secondary"></i>
                    <h6 class="mb-0">Cooling Fan Operation</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Verify all cooling fans are operating without noise:</label
                    >
                    <select class="form-select" formControlName="coolingFans">
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-calendar-check text-success"></i>
                    <h6 class="mb-0">Fan Age Verification</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Fans are less than 7 years old:</label
                    >
                    <select class="form-select" formControlName="fansAge">
                      <option
                        *ngFor="let option of fansAgeOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-funnel text-primary"></i>
                    <h6 class="mb-0">Air Filter Maintenance</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Inspect and clean or replace UPS air filters:</label
                    >
                    <select class="form-select" formControlName="airFilters">
                      <option
                        *ngFor="let option of airFilterOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

              </div>

              <!-- Filter Information Section -->
              <div class="filter-section mt-4">
                <h6 class="section-title mb-3">Filter Information</h6>
                
                <!-- Requirement notice for replacement needed -->
                <div class="alert alert-warning d-flex align-items-center mb-3" 
                     *ngIf="visualForm.get('airFilters')?.value === 'RN'">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <small>
                    <strong>Filter dimensions required:</strong> Please enter all filter measurements when replacement is needed for parts ordering.
                  </small>
                </div>
                
                <div class="measurements-grid">
                  <div class="measurement-card">
                    <div class="measurement-header">
                      <i class="bi bi-filter-square text-primary"></i>
                      <h6 class="mb-0">Filter Set 1</h6>
                    </div>
                    <div class="measurement-content">
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              [class.is-invalid]="visualForm.get('filterSet1Length')?.invalid && visualForm.get('filterSet1Length')?.touched"
                              formControlName="filterSet1Length"
                              id="filter1Length"
                              [maxlength]="getCharacterLimit('filterSet1Length') || null"
                            />
                            <label for="filter1Length">Length <span class="text-danger" *ngIf="visualForm.get('airFilters')?.value === 'RN'">*</span></label>
                            <div class="invalid-feedback" *ngIf="visualForm.get('filterSet1Length')?.invalid && visualForm.get('filterSet1Length')?.touched">
                              Length is required when replacement is needed
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              [class.is-invalid]="visualForm.get('filterSet1Width')?.invalid && visualForm.get('filterSet1Width')?.touched"
                              formControlName="filterSet1Width"
                              id="filter1Width"
                              [maxlength]="getCharacterLimit('filterSet1Width') || null"
                            />
                            <label for="filter1Width">Width <span class="text-danger" *ngIf="visualForm.get('airFilters')?.value === 'RN'">*</span></label>
                            <div class="invalid-feedback" *ngIf="visualForm.get('filterSet1Width')?.invalid && visualForm.get('filterSet1Width')?.touched">
                              Width is required when replacement is needed
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              [class.is-invalid]="visualForm.get('filterSet1Thickness')?.invalid && visualForm.get('filterSet1Thickness')?.touched"
                              formControlName="filterSet1Thickness"
                              id="filter1Thickness"
                              [maxlength]="getCharacterLimit('filterSet1Thickness') || null"
                            />
                            <label for="filter1Thickness">Thickness <span class="text-danger" *ngIf="visualForm.get('airFilters')?.value === 'RN'">*</span></label>
                            <div class="invalid-feedback" *ngIf="visualForm.get('filterSet1Thickness')?.invalid && visualForm.get('filterSet1Thickness')?.touched">
                              Thickness is required when replacement is needed
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              [class.is-invalid]="visualForm.get('filterSet1Quantity')?.invalid && visualForm.get('filterSet1Quantity')?.touched"
                              formControlName="filterSet1Quantity"
                              id="filter1Quantity"
                            />
                            <label for="filter1Quantity">Quantity <span class="text-danger" *ngIf="visualForm.get('airFilters')?.value === 'RN'">*</span></label>
                            <div class="invalid-feedback" *ngIf="visualForm.get('filterSet1Quantity')?.invalid && visualForm.get('filterSet1Quantity')?.touched">
                              Quantity is required when replacement is needed
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="measurement-card">
                    <div class="measurement-header">
                      <i class="bi bi-filter-square text-secondary"></i>
                      <h6 class="mb-0">Filter Set 2 (Optional)</h6>
                    </div>
                    <div class="measurement-content">
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              formControlName="filterSet2Length"
                              id="filter2Length"
                            />
                            <label for="filter2Length">Length</label>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              formControlName="filterSet2Width"
                              id="filter2Width"
                            />
                            <label for="filter2Width">Width</label>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              formControlName="filterSet2Thickness"
                              id="filter2Thickness"
                            />
                            <label for="filter2Thickness">Thickness</label>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              formControlName="filterSet2Quantity"
                              id="filter2Quantity"
                            />
                            <label for="filter2Quantity">Quantity</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>



              <!-- Comments -->
              <div class="form-group-modern mt-4">
                <div class="form-floating">
                  <textarea
                    class="form-control"
                    formControlName="visualComments"
                    [class.is-invalid]="hasRestrictedCharError('VisualForm', 'visualComments') || hasCharacterLimitError('VisualForm', 'visualComments')"
                    id="visualComments"
                    placeholder="Enter any additional comments or notes..."
                    style="height: 100px"
                    [maxlength]="getCharacterLimit('visualComments') || null"
                  ></textarea>
                  <label for="visualComments"
                    >Visual and Mechanical Verification Comments</label
                  >
                  <!-- Restricted Character Error -->
                  <div
                    class="text-danger small mt-1"
                    *ngIf="hasRestrictedCharError('VisualForm', 'visualComments')"
                  >
                    <i class="bi bi-exclamation-circle me-1"></i>
                    {{ getRestrictedCharError('VisualForm', 'visualComments') }}
                  </div>
                  <!-- Character Limit Warning -->
                  <div
                    class="text-warning small mt-1"
                    *ngIf="hasCharacterLimitError('VisualForm', 'visualComments')"
                  >
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {{ getCharacterLimitError('VisualForm', 'visualComments') }}
                  </div>
                  <!-- Character Limit Info (only for large text fields) -->
                  <div class="text-muted small" *ngIf="getCharacterLimit('visualComments')">
                    <i class="bi bi-info-circle me-1"></i>
                    Maximum {{ getCharacterLimit('visualComments') }} characters allowed
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Environment Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showEnvironment = !showEnvironment"
          >
            <div class="ups-section-title">
              <i class="bi bi-thermometer-half me-2 text-warning"></i>
              <h5 class="mb-0">Environment Verification</h5>
              <small class="text-muted"
                >Assess environmental conditions and safety requirements</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showEnvironment"
              [class.bi-chevron-right]="!showEnvironment"
              [class.rotate-90]="showEnvironment"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showEnvironment">
            <form [formGroup]="environmentForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-thermometer text-warning"></i>
                    <h6 class="mb-0">Temperature Control</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >UPS room temperature / ventilation is acceptable:</label
                    >
                    <select class="form-select" formControlName="roomTempVentilation">
                      <option value="">Select status...</option>
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-shield-check text-success"></i>
                    <h6 class="mb-0">Safety Equipment</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Safety equipment is present:</label
                    >
                    <select class="form-select" formControlName="safetyEquipment">
                      <option value="">Select status...</option>
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                    <h6 class="mb-0">Environmental Hazards</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Any hostile environment (water, heat, dust, debris, burn marks, or tampering):</label
                    >
                    <select class="form-select" formControlName="hostileEnvironment">
                      <option value="">Select status...</option>
                      <option
                        *ngFor="let option of yesNoNAOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-rulers text-info"></i>
                    <h6 class="mb-0">Service Space</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Adequate service space is available:</label
                    >
                    <select class="form-select" formControlName="serviceSpace">
                      <option value="">Select status...</option>
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-toggles text-primary"></i>
                    <h6 class="mb-0">Circuit Breaker Labels</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Circuit breakers are labeled accurately:</label
                    >
                    <select class="form-select" formControlName="circuitBreakers">
                      <option value="">Select status...</option>
                      <option
                        *ngFor="let option of visualMechanicalOptions"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Action Buttons within Environment Verification -->
              <div class="ups-action-buttons d-flex justify-content-center gap-3 mt-4 pt-3 border-top">
                <button
                  type="button"
                  class="btn btn-primary btn-lg px-4 py-2 save-draft-btn"
                  (click)="onSaveAsDraft()"
                  [disabled]="saving"
                >
                  <span
                    *ngIf="saving && saveMode === 'draft'"
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  ></span>
                  <i *ngIf="!saving || saveMode !== 'draft'" class="bi bi-file-earmark me-2"></i>
                  {{ saving && saveMode === 'draft' ? "Saving Draft..." : "Save as Draft" }}
                </button>
                
                <button
                  type="button"
                  class="btn btn-primary btn-lg px-4 py-2 save-ups-btn"
                  (click)="onSaveUPS()"
                  [disabled]="saving"
                >
                  <span
                    *ngIf="saving && saveMode === 'ups'"
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  ></span>
                  <i *ngIf="!saving || saveMode !== 'ups'" class="bi bi-save me-2"></i>
                  {{ saving && saveMode === 'ups' ? "Saving UPS..." : "Save UPS" }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>
<!-- Power Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showPowerVerification = !showPowerVerification"
          >
            <div class="ups-section-title">
              <i class="bi bi-lightning me-2 text-danger"></i>
              <h5 class="mb-0">Power Verification</h5>
              <small class="text-muted"
                >Verify electrical power readings and thresholds</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showPowerVerification"
              [class.bi-chevron-right]="!showPowerVerification"
              [class.rotate-90]="showPowerVerification"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showPowerVerification">
            <!-- Input Section -->
            <div class="mb-4">
              <form [formGroup]="inputReadingsForm">
                <!-- Inline Configuration Bar -->
                <div class="input-config-bar d-flex align-items-center justify-content-between p-3 bg-light border rounded-3 shadow-sm">
                  <!-- Input Configuration Dropdown -->
                  <div class="config-item d-flex align-items-center">
                    <label class="form-label mb-0 me-2 fw-semibold text-white input-label">
                      <i class="bi bi-arrow-down-circle me-1"></i>Input Configuration:
                    </label>
                    <select
                      class="form-select form-select-sm custom-select"
                      formControlName="configuration"
                      (change)="onVoltageConfigurationChange('input', $any($event.target).value)"
                      id="inputConfiguration"
                      style="min-width: 150px; max-width: 150px;"
                    >
                      <option value="">Select...</option>
                      <option *ngFor="let config of voltageConfigurations" [value]="config.id">
                        {{ config.name }}
                      </option>
                    </select>
                  </div>

                  <!-- Tolerance Display -->
                  <div class="tolerance-info d-flex align-items-center" *ngIf="inputConfig">
                    <div class="d-flex flex-column">
                      <small class="text-primary fw-semibold mb-1">
                        <i class="bi bi-info-circle me-1"></i>
                        V-Tolerance: {{ getVoltageToleranceRange(inputReadingsForm.get('configuration')?.value, 'input') }}
                      </small>
                      <small class="text-info fw-semibold">
                        <i class="bi bi-speedometer me-1"></i>
                        Freq: {{ getFrequencyToleranceRange('input') }}
                      </small>
                    </div>
                  </div>

                  <!-- Filter Current Toggle -->
                  <div class="config-item d-flex align-items-center">
                    <div class="custom-toggle-container">
                      <input
                        class="custom-toggle-input"
                        type="checkbox"
                        formControlName="inputFilterCurrent"
                        id="inputFilterCurrent"
                      />
                      <label class="custom-toggle-label" for="inputFilterCurrent">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                          <i class="bi bi-funnel me-1"></i>Filter Current
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- THD % Toggle -->
                  <div class="config-item d-flex align-items-center">
                    <div class="custom-toggle-container">
                      <input
                        class="custom-toggle-input"
                        type="checkbox"
                        formControlName="inputThdPercent"
                        id="inputThdPercent"
                      />
                      <label class="custom-toggle-label" for="inputThdPercent">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                          <i class="bi bi-graph-up me-1"></i>THD %
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- Phase Count Display -->
                  <div class="phase-indicator d-flex align-items-center" *ngIf="inputConfig">
                    <span class="badge bg-primary fs-6 px-3 py-2">
                      <i class="bi bi-diagram-3 me-1"></i>
                      Phase {{ inputConfig.phaseCount }}
                    </span>
                  </div>
                </div>

                <!-- Input Phase Cards -->
                <div *ngIf="inputConfig" class="mb-4">
                  <h6 class="fw-bold text-success mb-3">
                    <i class="bi bi-plug me-2"></i>
                    Input Phase Measurements
                    <small class="text-muted ms-2">Voltage, Current, and Frequency readings</small>
                  </h6>
                  
                  <div class="row g-3">
                    <!-- Phase A/Single Phase -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="inputConfig.phaseCount >= 1">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">
                              {{ inputConfig.phaseCount === 1 ? 'Voltage A' : (inputConfig.phaseCount === 2 ? 'Voltage A' : 'Voltage A-B') }}
                            </span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="voltA"
                                  step="0.01"
                                  id="inputVoltA"
                                />
                                <label for="inputVoltA" class="text-muted">Voltage</label>
                              </div>
                              <!-- Phase-to-Neutral Display under voltage label -->
                              <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('input')">
                                <small class="text-muted d-flex align-items-center justify-content-between">
                                  <span>
                                    <i class="bi bi-calculator text-info me-1"></i>
                                    {{ getPhaseToNeutralLabel('A') }}:
                                  </span>
                                  <span class="badge bg-light text-dark ms-2">
                                    {{ getPhaseToNeutralDisplay('input', 'A') || '—' }}V
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="voltA_PF"
                                  id="inputVoltAStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputVoltAStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Current A -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="inputConfig.phaseCount >= 1">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Current A</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="currA"
                                  step="0.01"
                                  id="inputCurrA"
                                />
                                <label for="inputCurrA" class="text-muted">Current</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="currA_PF"
                                  id="inputCurrAStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputCurrAStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Phase B (for 2 and 3 phase) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="inputConfig.phaseCount >= 2">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">
                              {{ inputConfig.phaseCount === 2 ? 'Voltage B' : 'Voltage B-C' }}
                            </span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="voltB"
                                  step="0.01"
                                  id="inputVoltB"
                                />
                                <label for="inputVoltB" class="text-muted">Voltage</label>
                              </div>
                              <!-- Phase-to-Neutral Display under voltage label -->
                              <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('input')">
                                <small class="text-muted d-flex align-items-center justify-content-between">
                                  <span>
                                    <i class="bi bi-calculator text-info me-1"></i>
                                    {{ getPhaseToNeutralLabel('B') }}:
                                  </span>
                                  <span class="badge bg-light text-dark ms-2">
                                    {{ getPhaseToNeutralDisplay('input', 'B') || '—' }}V
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="voltB_PF"
                                  id="inputVoltBStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputVoltBStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Current B (for 2 and 3 phase) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="inputConfig.phaseCount >= 2">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Current B</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="currB"
                                  step="0.01"
                                  id="inputCurrB"
                                />
                                <label for="inputCurrB" class="text-muted">Current</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="currB_PF"
                                  id="inputCurrBStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputCurrBStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Phase C (for 3 phase only) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="inputConfig.phaseCount >= 3">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Voltage C-A</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="voltC"
                                  step="0.01"
                                  id="inputVoltC"
                                />
                                <label for="inputVoltC" class="text-muted">Voltage</label>
                              </div>
                              <!-- Phase-to-Neutral Display under voltage label -->
                              <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('input')">
                                <small class="text-muted d-flex align-items-center justify-content-between">
                                  <span>
                                    <i class="bi bi-calculator text-info me-1"></i>
                                    {{ getPhaseToNeutralLabel('C') }}:
                                  </span>
                                  <span class="badge bg-light text-dark ms-2">
                                    {{ getPhaseToNeutralDisplay('input', 'C') || '—' }}V
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="voltC_PF"
                                  id="inputVoltCStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputVoltCStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Current C (for 3 phase only) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="inputConfig.phaseCount >= 3">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Current C</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="currC"
                                  step="0.01"
                                  id="inputCurrC"
                                />
                                <label for="inputCurrC" class="text-muted">Current</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="currC_PF"
                                  id="inputCurrCStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputCurrCStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Frequency -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Frequency</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="freq"
                                  step="0.01"
                                  id="inputFreq"
                                />
                                <label for="inputFreq" class="text-muted">Frequency</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="freq_PF"
                                  id="inputFreqStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="inputFreqStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Input Filter Current Detail Section - Card Design -->
                <div *ngIf="showInputFilterCurrent" class="dynamic-section mt-3">
                  <div class="mb-3">
                    <h6 class="fw-bold text-primary mb-3">
                      <i class="bi bi-funnel me-2"></i>
                      Input Filter Current Measurements
                      <small class="text-muted ms-2">Filter current readings for each phase</small>
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Filter Current A Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-electric-scooter text-primary me-2"></i>
                              <span class="fw-semibold text-dark">Filter Current A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="filterCurrentA"
                                    id="inputFilterCurrentA"
                                  />
                                  <label for="inputFilterCurrentA" class="text-muted">Current (A)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="filterCurrentA_PF"
                                    id="inputFilterCurrentAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="inputFilterCurrentAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Filter Current B Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-electric-scooter text-primary me-2"></i>
                              <span class="fw-semibold text-dark">Filter Current B</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="filterCurrentB"
                                    id="inputFilterCurrentB"
                                  />
                                  <label for="inputFilterCurrentB" class="text-muted">Current (A)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="filterCurrentB_PF"
                                    id="inputFilterCurrentBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="inputFilterCurrentBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Filter Current C Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-electric-scooter text-primary me-2"></i>
                              <span class="fw-semibold text-dark">Filter Current C</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="filterCurrentC"
                                    id="inputFilterCurrentC"
                                  />
                                  <label for="inputFilterCurrentC" class="text-muted">Current (A)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="filterCurrentC_PF"
                                    id="inputFilterCurrentCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="inputFilterCurrentCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Input THD Detail Section - Card Design -->
                <div *ngIf="showInputTHD" class="dynamic-section mt-3">
                  <div class="mb-3">
                    <h6 class="fw-bold text-warning mb-3">
                      <i class="bi bi-graph-up-arrow me-2"></i>
                      Input THD (Total Harmonic Distortion) Measurements
                      <small class="text-muted ms-2">THD percentage readings for each phase</small>
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Input THD A Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-up text-warning me-2"></i>
                              <span class="fw-semibold text-dark">Input THD % A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="inputThdA"
                                    id="inputThdA"
                                  />
                                  <label for="inputThdA" class="text-muted">THD (%)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="inputThdA_PF"
                                    id="inputThdAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="inputThdAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Input THD B Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-up text-warning me-2"></i>
                              <span class="fw-semibold text-dark">Input THD % B</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="inputThdB"
                                    id="inputThdB"
                                  />
                                  <label for="inputThdB" class="text-muted">THD (%)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="inputThdB_PF"
                                    id="inputThdBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="inputThdBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Input THD C Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-up text-warning me-2"></i>
                              <span class="fw-semibold text-dark">Input THD % C</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="inputThdC"
                                    id="inputThdC"
                                  />
                                  <label for="inputThdC" class="text-muted">THD (%)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="inputThdC_PF"
                                    id="inputThdCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="inputThdCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>


              </form>
            </div>

            <!-- By-Pass Section -->
            <div class="mb-4">
              <form [formGroup]="bypassReadingsForm">
                <!-- Inline Configuration Bar -->
                <div class="input-config-bar d-flex align-items-center justify-content-between p-3 bg-light border rounded-3 shadow-sm">
                  <!-- Configuration Dropdown -->
                  <div class="config-item d-flex align-items-center">
                    <label class="form-label mb-0 me-2 fw-semibold text-white input-label">
                      <i class="bi bi-arrow-left-right me-1"></i>Bypass Configuration:
                    </label>
                    <select
                      class="form-select form-select-sm custom-select"
                      formControlName="configuration"
                      (change)="onVoltageConfigurationChange('bypass', $any($event.target).value)"
                      id="bypassConfiguration"
                      style="min-width: 150px; max-width: 150px;"
                    >
                      <option value="">Select...</option>
                      <option *ngFor="let config of voltageConfigurations" [value]="config.id">
                        {{ config.name }}
                      </option>
                    </select>
                  </div>

                  <!-- Tolerance Display -->
                  <div class="tolerance-info d-flex align-items-center" *ngIf="bypassConfig">
                    <div class="d-flex flex-column">
                      <small class="text-primary fw-semibold mb-1">
                        <i class="bi bi-info-circle me-1"></i>
                        V-Tolerance: {{ getVoltageToleranceRange(bypassReadingsForm.get('configuration')?.value, 'bypass') }}
                      </small>
                      <small class="text-info fw-semibold">
                        <i class="bi bi-speedometer me-1"></i>
                        Freq: {{ getFrequencyToleranceRange('bypass') }}
                      </small>
                    </div>
                  </div>



                  <!-- Phase Count Display -->
                  <div class="phase-indicator d-flex align-items-center" *ngIf="bypassConfig">
                    <span class="badge bg-primary fs-6 px-3 py-2">
                      <i class="bi bi-diagram-3 me-1"></i>
                      Phase {{ bypassConfig.phaseCount }}
                    </span>
                  </div>
                </div>

                <!-- Bypass Phase Cards -->
                <div *ngIf="bypassConfig" class="mb-4">
                  <h6 class="fw-bold text-warning mb-3">
                    <i class="bi bi-arrow-repeat me-2"></i>
                    Bypass Phase Measurements
                    <small class="text-muted ms-2">Voltage, Current, and Frequency readings</small>
                  </h6>
                  
                  <div class="row g-3">
                    <!-- Phase A/Single Phase -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="bypassConfig.phaseCount >= 1">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">
                              {{ bypassConfig.phaseCount === 1 ? 'Voltage A' : (bypassConfig.phaseCount === 2 ? 'Voltage A' : 'Voltage A-B') }}
                            </span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="voltA"
                                  step="0.01"
                                  id="bypassVoltA"
                                />
                                <label for="bypassVoltA" class="text-muted">Voltage</label>
                              </div>
                              <!-- Phase-to-Neutral Display under voltage label -->
                              <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('bypass')">
                                <small class="text-muted d-flex align-items-center justify-content-between">
                                  <span>
                                    <i class="bi bi-calculator text-info me-1"></i>
                                    {{ getPhaseToNeutralLabel('A') }}:
                                  </span>
                                  <span class="badge bg-light text-dark ms-2">
                                    {{ getPhaseToNeutralDisplay('bypass', 'A') || '—' }}V
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="voltA_PF"
                                  id="bypassVoltAStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassVoltAStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Current A -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="bypassConfig.phaseCount >= 1">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Current A</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="currA"
                                  step="0.01"
                                  id="bypassCurrA"
                                />
                                <label for="bypassCurrA" class="text-muted">Current</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="currA_PF"
                                  id="bypassCurrAStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassCurrAStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Phase B (for 2 and 3 phase) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="bypassConfig.phaseCount >= 2">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">

                            <span class="fw-semibold text-dark">
                              {{ bypassConfig.phaseCount === 2 ? 'Voltage B' : 'Voltage B-C' }}
                            </span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="voltB"
                                  step="0.01"
                                  id="bypassVoltB"
                                />
                                <label for="bypassVoltB" class="text-muted">Voltage</label>
                              </div>
                              <!-- Phase-to-Neutral Display under voltage label -->
                              <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('bypass')">
                                <small class="text-muted d-flex align-items-center justify-content-between">
                                  <span>
                                    <i class="bi bi-calculator text-info me-1"></i>
                                    {{ getPhaseToNeutralLabel('B') }}:
                                  </span>
                                  <span class="badge bg-light text-dark ms-2">
                                    {{ getPhaseToNeutralDisplay('bypass', 'B') || '—' }}V
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="voltB_PF"
                                  id="bypassVoltBStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassVoltBStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Current B (for 2 and 3 phase) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="bypassConfig.phaseCount >= 2">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">

                            <span class="fw-semibold text-dark">Current B</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="currB"
                                  step="0.01"
                                  [placeholder]="isBypassModeActive() ? '10 (Optional)' : '10'"
                                  id="bypassCurrB"
                                />
                                <label for="bypassCurrB" class="text-muted">Current</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="currB_PF"
                                  id="bypassCurrBStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassCurrBStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Phase C (for 3 phase only) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="bypassConfig.phaseCount >= 3">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Voltage C-A</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="voltC"
                                  step="0.01"
                                  id="bypassVoltC"
                                />
                                <label for="bypassVoltC" class="text-muted">Voltage</label>
                              </div>
                              <!-- Phase-to-Neutral Display under voltage label -->
                              <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('bypass')">
                                <small class="text-muted d-flex align-items-center justify-content-between">
                                  <span>
                                    <i class="bi bi-calculator text-info me-1"></i>
                                    {{ getPhaseToNeutralLabel('C') }}:
                                  </span>
                                  <span class="badge bg-light text-dark ms-2">
                                    {{ getPhaseToNeutralDisplay('bypass', 'C') || '—' }}V
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="voltC_PF"
                                  id="bypassVoltCStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassVoltCStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Current C (for 3 phase only) -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngIf="bypassConfig.phaseCount >= 3">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">

                            <span class="fw-semibold text-dark">Current C</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="currC"
                                  step="0.01"
                                  [placeholder]="isBypassModeActive() ? '10 (Optional)' : '10'"
                                  id="bypassCurrC"
                                />
                                <label for="bypassCurrC" class="text-muted">Current</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="currC_PF"
                                  id="bypassCurrCStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassCurrCStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Frequency -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                      <div class="power-measurement-card">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <span class="fw-semibold text-dark">Frequency</span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  formControlName="freq"
                                  step="0.01"
                                  id="bypassFreq"
                                />
                                <label for="bypassFreq" class="text-muted">Frequency</label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  formControlName="freq_PF"
                                  id="bypassFreqStatus"
                                >
                                  <option value="">Select status...</option>
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label for="bypassFreqStatus" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </form>
            </div>

            <!-- Output Section -->
            <div class="mb-4">
              <form [formGroup]="outputReadingsForm">
                <!-- Inline Configuration Bar -->
                <div class="input-config-bar d-flex align-items-center justify-content-between p-3 bg-light border rounded-3 shadow-sm">
                  <!-- Configuration Dropdown -->
                  <div class="config-item d-flex align-items-center">
                    <label class="form-label mb-0 me-2 fw-semibold text-white input-label">
                      <i class="bi bi-arrow-up-circle me-1"></i>Output Configuration:
                    </label>
                    <select
                      class="form-select form-select-sm custom-select"
                      formControlName="configuration"
                      (change)="onVoltageConfigurationChange('output', $any($event.target).value)"
                      id="outputConfiguration"
                      style="min-width: 150px; max-width: 150px;"
                    >
                      <option value="">Select...</option>
                      <option *ngFor="let config of voltageConfigurations" [value]="config.id">
                        {{ config.name }}
                      </option>
                    </select>
                  </div>

                  <!-- Tolerance Display -->
                  <div class="tolerance-info d-flex align-items-center" *ngIf="outputConfig">
                    <div class="d-flex flex-column">
                      <small class="text-primary fw-semibold mb-1">
                        <i class="bi bi-info-circle me-1"></i>
                        V-Tolerance: {{ getVoltageToleranceRange(outputReadingsForm.get('configuration')?.value, 'output') }}
                      </small>
                      <small class="text-info fw-semibold">
                        <i class="bi bi-speedometer me-1"></i>
                        Freq: {{ getFrequencyToleranceRange('output') }}
                      </small>
                    </div>
                  </div>

                  <!-- Filter Current Toggle -->
                  <div class="config-item d-flex align-items-center">
                    <div class="custom-toggle-container">
                      <input
                        class="custom-toggle-input"
                        type="checkbox"
                        formControlName="outputFilterCurrent"
                        id="outputFilterCurrent"
                      />
                      <label class="custom-toggle-label" for="outputFilterCurrent">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                          <i class="bi bi-funnel me-1"></i>Filter Current
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- THD % Toggle -->
                  <div class="config-item d-flex align-items-center">
                    <div class="custom-toggle-container">
                      <input
                        class="custom-toggle-input"
                        type="checkbox"
                        formControlName="outputThdPercent"
                        id="outputThdPercent"
                      />
                      <label class="custom-toggle-label" for="outputThdPercent">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                          <i class="bi bi-graph-up me-1"></i>THD %
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- Phase Count Display -->
                  <div class="phase-indicator d-flex align-items-center" *ngIf="outputConfig">
                    <span class="badge bg-primary fs-6 px-3 py-2">
                      <i class="bi bi-diagram-3 me-1"></i>
                      Phase {{ outputConfig.phaseCount }}
                    </span>
                  </div>
                </div>

                <!-- Output Phase Cards - Phase A Row -->
                <div *ngIf="outputConfig" class="mb-4">
                  <h6 class="fw-bold text-success mb-3">
                    <i class="bi bi-outlet me-2"></i>
                    Output Phase Measurements
                    <small class="text-muted ms-2">Voltage, Current, Load%, and Frequency readings</small>
                  </h6>
                  
                  <!-- Phase A Cards Row -->
                  <div class="phase-section mb-4">
                    <div class="row g-3">
                      <!-- Voltage A -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <span class="fw-semibold text-dark">
                                {{ outputConfig.phaseCount === 1 ? 'Voltage A' : (outputConfig.phaseCount === 2 ? 'Voltage A' : 'Voltage A-B') }}
                              </span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="voltA"
                                    step="0.01"
                                    id="outputVoltA"
                                  />
                                  <label for="outputVoltA" class="text-muted">Voltage</label>
                                </div>
                                <!-- Phase-to-Neutral Display under voltage label -->
                                <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('output')">
                                  <small class="text-muted d-flex align-items-center justify-content-between">
                                    <span>
                                      <i class="bi bi-calculator text-info me-1"></i>
                                      {{ getPhaseToNeutralLabel('A') }}:
                                    </span>
                                    <span class="badge bg-light text-dark ms-2">
                                      {{ getPhaseToNeutralDisplay('output', 'A') || '—' }}V
                                    </span>
                                  </small>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="voltA_PF"
                                    id="outputVoltAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputVoltAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Current A -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <span class="fw-semibold text-dark">Current A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="currA"
                                    step="0.01"
                                    id="outputCurrA"
                                  />
                                  <label for="outputCurrA" class="text-muted">Current</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="currA_PF"
                                    id="outputCurrAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputCurrAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Load A -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-speedometer2 text-info me-2"></i>
                              <span class="fw-semibold text-dark">Load(%) A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="loadA"
                                    step="0.01"
                                    id="outputLoadA"
                                  />
                                  <label for="outputLoadA" class="text-muted">Load %</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="loadA_PF"
                                    id="outputLoadAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputLoadAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Frequency (only show in Phase A row) -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">

                              <span class="fw-semibold text-dark">Frequency</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="freq"
                                    step="0.01"
                                    id="outputFreq"
                                  />
                                  <label for="outputFreq" class="text-muted">Frequency</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="freq_PF"
                                    id="outputFreqStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputFreqStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Phase B Cards Row (for 2 and 3 phase) -->
                  <div class="phase-section mb-4" *ngIf="outputConfig.phaseCount >= 2">
                    <div class="row g-3">
                      <!-- Voltage B -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <span class="fw-semibold text-dark">
                                {{ outputConfig.phaseCount === 2 ? 'Voltage B' : 'Voltage B-C' }}
                              </span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="voltB"
                                    step="0.01"
                                    id="outputVoltB"
                                  />
                                  <label for="outputVoltB" class="text-muted">Voltage</label>
                                </div>
                                <!-- Phase-to-Neutral Display under voltage label -->
                                <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('output')">
                                  <small class="text-muted d-flex align-items-center justify-content-between">
                                    <span>
                                      <i class="bi bi-calculator text-info me-1"></i>
                                      {{ getPhaseToNeutralLabel('B') }}:
                                    </span>
                                    <span class="badge bg-light text-dark ms-2">
                                      {{ getPhaseToNeutralDisplay('output', 'B') || '—' }}V
                                    </span>
                                  </small>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="voltB_PF"
                                    id="outputVoltBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputVoltBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Current B -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <span class="fw-semibold text-dark">Current B</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="currB"
                                    step="0.01"
                                    id="outputCurrB"
                                  />
                                  <label for="outputCurrB" class="text-muted">Current</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="currB_PF"
                                    id="outputCurrBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputCurrBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Load B -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-speedometer2 text-info me-2"></i>
                              <span class="fw-semibold text-dark">Load(%) B</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="loadB"
                                    step="0.01"
                                    id="outputLoadB"
                                  />
                                  <label for="outputLoadB" class="text-muted">Load %</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="loadB_PF"
                                    id="outputLoadBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputLoadBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Empty slot or Total Load in B row -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card" *ngIf="outputConfig.phaseCount === 2">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-calculator text-dark me-2"></i>
                              <span class="fw-semibold text-dark">Total Load</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="totalLoad"
                                    step="0.01"
                                    id="outputTotalLoad"
                                  />
                                  <label for="outputTotalLoad" class="text-muted">Total %</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <button
                                  type="button"
                                  class="btn btn-primary btn-sm w-100 h-100 d-flex flex-column align-items-center justify-content-center"
                                  (click)="calculateTotalLoad()"
                                  style="min-height: 2.5rem; gap: 2px;"
                                >
                                  <i class="bi bi-calculator" style="font-size: 1.2em;"></i>
                                  <small style="font-size: 0.7em; line-height: 1;">Calculate</small>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Phase C Cards Row (for 3 phase only) -->
                  <div class="phase-section mb-4" *ngIf="outputConfig.phaseCount >= 3">
                    <div class="row g-3">
                      <!-- Voltage C -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <span class="fw-semibold text-dark">Voltage C-A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="voltC"
                                    step="0.01"
                                    id="outputVoltC"
                                  />
                                  <label for="outputVoltC" class="text-muted">Voltage</label>
                                </div>
                                <!-- Phase-to-Neutral Display under voltage label -->
                                <div class="p-n-display-inline mt-1" *ngIf="shouldShowPhaseToNeutralDisplay('output')">
                                  <small class="text-muted d-flex align-items-center justify-content-between">
                                    <span>
                                      <i class="bi bi-calculator text-info me-1"></i>
                                      {{ getPhaseToNeutralLabel('C') }}:
                                    </span>
                                    <span class="badge bg-light text-dark ms-2">
                                      {{ getPhaseToNeutralDisplay('output', 'C') || '—' }}V
                                    </span>
                                  </small>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="voltC_PF"
                                    id="outputVoltCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputVoltCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Current C -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <span class="fw-semibold text-dark">Current C</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="currC"
                                    step="0.01"
                                    id="outputCurrC"
                                  />
                                  <label for="outputCurrC" class="text-muted">Current</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="currC_PF"
                                    id="outputCurrCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputCurrCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Load C -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-speedometer2 text-info me-2"></i>
                              <span class="fw-semibold text-dark">Load(%) C</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="loadC"
                                    step="0.01"
                                    id="outputLoadC"
                                  />
                                  <label for="outputLoadC" class="text-muted">Load %</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="loadC_PF"
                                    id="outputLoadCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option
                                      *ngFor="let option of powerVerificationOptions"
                                      [value]="option.value"
                                    >
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="outputLoadCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Total Load for 3-phase -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-calculator text-dark me-2"></i>
                              <span class="fw-semibold text-dark">Total Load</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="totalLoad"
                                    step="0.01"
                                    placeholder="0.00"
                                    id="outputTotalLoad3Phase"
                                  />
                                  <label for="outputTotalLoad3Phase" class="text-muted">Total %</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <button
                                  type="button"
                                  class="btn btn-primary btn-sm w-100 h-100 d-flex flex-column align-items-center justify-content-center"
                                  (click)="calculateTotalLoad()"
                                  style="min-height: 2.5rem; gap: 2px;"
                                >
                                  <i class="bi bi-calculator" style="font-size: 1.2em;"></i>
                                  <small style="font-size: 0.7em; line-height: 1;">Calculate</small>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Single Phase Total Load (for single phase only) -->
                  <div class="phase-section mb-4" *ngIf="outputConfig.phaseCount === 1">
                    <div class="row g-3">
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-calculator text-dark me-2"></i>
                              <span class="fw-semibold text-dark">Total Load</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="totalLoad"
                                    step="0.01"
                                    placeholder="0.00"
                                    id="outputTotalLoadSingle"
                                  />
                                  <label for="outputTotalLoadSingle" class="text-muted">Total %</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <button
                                  type="button"
                                  class="btn btn-primary btn-sm w-100 h-100 d-flex flex-column align-items-center justify-content-center"
                                  (click)="calculateTotalLoad()"
                                  style="min-height: 2.5rem; gap: 2px;"
                                >
                                  <i class="bi bi-calculator" style="font-size: 1.2em;"></i>
                                  <small style="font-size: 0.7em; line-height: 1;">Calculate</small>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Output Filter Current Detail Section - Card Design -->
                <div *ngIf="showOutputFilterCurrent" class="dynamic-section mt-3">
                  <div class="mb-3">
                    <h6 class="fw-bold text-success mb-3">
                      <i class="bi bi-funnel me-2"></i>
                      Output Filter Current Measurements
                      <small class="text-muted ms-2">Filter current readings for each output phase</small>
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Output Filter Current A Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-outlet text-success me-2"></i>
                              <span class="fw-semibold text-dark">Filter Current A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="outputFilterCurrentA"
                                    id="outputFilterCurrentA"
                                  />
                                  <label for="outputFilterCurrentA" class="text-muted">Current (A)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="outputFilterCurrentA_PF"
                                    id="outputFilterCurrentAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="outputFilterCurrentAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Output Filter Current B Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-outlet text-success me-2"></i>
                              <span class="fw-semibold text-dark">Filter Current B</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="outputFilterCurrentB"
                                    id="outputFilterCurrentB"
                                  />
                                  <label for="outputFilterCurrentB" class="text-muted">Current (A)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="outputFilterCurrentB_PF"
                                    id="outputFilterCurrentBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="outputFilterCurrentBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Output Filter Current C Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-outlet text-success me-2"></i>
                              <span class="fw-semibold text-dark">Filter Current C</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="outputFilterCurrentC"
                                    id="outputFilterCurrentC"
                                  />
                                  <label for="outputFilterCurrentC" class="text-muted">Current (A)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="outputFilterCurrentC_PF"
                                    id="outputFilterCurrentCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="outputFilterCurrentCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Output THD Detail Section - Card Design -->
                <div *ngIf="showOutputTHD" class="dynamic-section mt-3">
                  <div class="mb-3">
                    <h6 class="fw-bold text-info mb-3">
                      <i class="bi bi-graph-up-arrow me-2"></i>
                      Output THD (Total Harmonic Distortion) Measurements
                      <small class="text-muted ms-2">THD percentage readings for each output phase</small>
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Output THD A Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-down text-info me-2"></i>
                              <span class="fw-semibold text-dark">Output THD % A</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="outputThdA"
                                    id="outputThdA"
                                  />
                                  <label for="outputThdA" class="text-muted">THD (%)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="outputThdA_PF"
                                    id="outputThdAStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="outputThdAStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Output THD B Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-down text-info me-2"></i>
                              <span class="fw-semibold text-dark">Output THD % B</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="outputThdB"
                                    id="outputThdB"
                                  />
                                  <label for="outputThdB" class="text-muted">THD (%)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="outputThdB_PF"
                                    id="outputThdBStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="outputThdBStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Output THD C Card -->
                      <div class="col-xl-4 col-lg-6 col-md-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-down text-info me-2"></i>
                              <span class="fw-semibold text-dark">Output THD % C</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="text"
                                    class="form-control power-input"
                                    formControlName="outputThdC"
                                    id="outputThdC"
                                  />
                                  <label for="outputThdC" class="text-muted">THD (%)</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="outputThdC_PF"
                                    id="outputThdCStatus"
                                  >
                                    <option value="">Select status...</option>
                                    <option value="P">Pass</option>
                                    <option value="F">Fail</option>
                                    <option value="A">N/A</option>
                                  </select>
                                  <label for="outputThdCStatus" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>


              </form>
            </div>

            <!-- Rectifier Verification Cards -->
            <div class="mb-4">
              <div class="form-group-modern">
                <div class="d-flex align-items-center mb-3">
                  <h6 class="fw-bold text-info mb-0 me-3">
                    <i class="bi bi-gear me-2"></i>
                    Rectifier Verification
                    <small class="text-muted ms-2"
                      >Verify correct float voltage settings</small
                    >
                  </h6>
                  <select class="form-select form-select-sm" style="width: auto; min-width: 100px;" formControlName="rectifierVerificationStatus">
                    <option value="">Select</option>
                    <option value="Pass">Pass</option>
                    <option value="Fail">Fail</option>
                    <option value="N/A">N/A</option>
                  </select>
                </div>
              </div>
              
              <form [formGroup]="rectifierForm">
                <!-- Modern Card-based Layout -->
                <div class="row g-3">
                  <!-- DC Float Voltage Card -->
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="power-measurement-card">
                      <div class="power-card-header">
                        <div class="power-card-title">
                          <i class="bi bi-battery-half text-success me-2"></i>
                          <span class="fw-semibold text-dark">DC Float Voltage</span>
                        </div>
                      </div>
                      <div class="power-card-body">
                        <div class="row g-2">
                          <div class="col-8">
                            <div class="form-floating">
                              <input
                                type="number"
                                class="form-control power-input"
                                formControlName="dcFloatVoltage"
                                step="0.01"
                                id="dcFloatVoltage"
                              />
                              <label for="dcFloatVoltage" class="text-muted">Voltage</label>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="form-floating">
                              <select
                                class="form-select power-select"
                                formControlName="floatVolt_PF"
                                id="dcFloatVoltageStatus"
                              >
                                <option value="">Select status...</option>
                                <option
                                  *ngFor="let option of powerVerificationOptions"
                                  [value]="option.value"
                                >
                                  {{ option.text }}
                                </option>
                              </select>
                              <label for="dcFloatVoltageStatus" class="text-muted">Status</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- AC Ripple Voltage Card -->
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="power-measurement-card">
                      <div class="power-card-header">
                        <div class="power-card-title">
                          <i class="bi bi-graph-up-arrow text-warning me-2"></i>
                          <span class="fw-semibold text-dark">AC Ripple Voltage</span>
                        </div>
                      </div>
                      <div class="power-card-body">
                        <div class="row g-2">
                          <div class="col-8">
                            <div class="form-floating">
                              <input
                                type="number"
                                class="form-control power-input"
                                formControlName="acRippleVolt"
                                step="0.01"
                                id="acRippleVolt"
                              />
                              <label for="acRippleVolt" class="text-muted">Voltage</label>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="form-floating">
                              <select
                                class="form-select power-select"
                                formControlName="acRippleVolt_PF"
                                id="acRippleVoltStatus"
                              >
                                <option value="">Select status...</option>
                                <option
                                  *ngFor="let option of powerVerificationOptions"
                                  [value]="option.value"
                                >
                                  {{ option.text }}
                                </option>
                              </select>
                              <label for="acRippleVoltStatus" class="text-muted">Status</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- DC Current Card -->
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="power-measurement-card">
                      <div class="power-card-header">
                        <div class="power-card-title">

                          <span class="fw-semibold text-dark">DC Current</span>
                        </div>
                      </div>
                      <div class="power-card-body">
                        <div class="row g-2">
                          <div class="col-8">
                            <div class="form-floating">
                              <input
                                type="number"
                                class="form-control power-input"
                                formControlName="dcCurrent"
                                step="0.01"
                                id="dcCurrent"
                              />
                              <label for="dcCurrent" class="text-muted">Current</label>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="form-floating">
                              <select
                                class="form-select power-select"
                                formControlName="dcCurrent_PF"
                                id="dcCurrentStatus"
                              >
                                <option value="">Select status...</option>
                                <option
                                  *ngFor="let option of powerVerificationOptions"
                                  [value]="option.value"
                                >
                                  {{ option.text }}
                                </option>
                              </select>
                              <label for="dcCurrentStatus" class="text-muted">Status</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- POS to GND Card -->
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="power-measurement-card">
                      <div class="power-card-header">
                        <div class="power-card-title">
                          <i class="bi bi-plus-circle text-success me-2"></i>
                          <span class="fw-semibold text-dark">POS to GND</span>
                        </div>
                      </div>
                      <div class="power-card-body">
                        <div class="row g-2">
                          <div class="col-8">
                            <div class="form-floating">
                              <input
                                type="number"
                                class="form-control power-input"
                                formControlName="posToGND"
                                step="0.01"
                                id="posToGND"
                              />
                              <label for="posToGND" class="text-muted">Value</label>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="form-floating">
                              <select
                                class="form-select power-select"
                                formControlName="posToGND_PF"
                                id="posToGndStatus"
                              >
                                <option value="">Select status...</option>
                                <option
                                  *ngFor="let option of powerVerificationOptions"
                                  [value]="option.value"
                                >
                                  {{ option.text }}
                                </option>
                              </select>
                              <label for="posToGndStatus" class="text-muted">Status</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- NEG to GND Card -->
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="power-measurement-card">
                      <div class="power-card-header">
                        <div class="power-card-title">
                          <i class="bi bi-dash-circle text-danger me-2"></i>
                          <span class="fw-semibold text-dark">NEG to GND</span>
                        </div>
                      </div>
                      <div class="power-card-body">
                        <div class="row g-2">
                          <div class="col-8">
                            <div class="form-floating">
                              <input
                                type="number"
                                class="form-control power-input"
                                formControlName="negToGND"
                                step="0.01"
                                id="negToGND"
                              />
                              <label for="negToGND" class="text-muted">Value</label>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="form-floating">
                              <select
                                class="form-select power-select"
                                formControlName="negToGND_PF"
                                id="negToGndStatus"
                              >
                                <option value="">Select status...</option>
                                <option
                                  *ngFor="let option of powerVerificationOptions"
                                  [value]="option.value"
                                >
                                  {{ option.text }}
                                </option>
                              </select>
                              <label for="negToGndStatus" class="text-muted">Status</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- AC Ripple Current Card -->
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="power-measurement-card">
                      <div class="power-card-header">
                        <div class="power-card-title">

                          <span class="fw-semibold text-dark">AC Ripple Current</span>
                        </div>
                      </div>
                      <div class="power-card-body">
                        <div class="row g-2">
                          <div class="col-8">
                            <div class="form-floating">
                              <input
                                type="number"
                                class="form-control power-input"
                                formControlName="acRippleCurr"
                                step="0.01"
                                id="acRippleCurr"
                              />
                              <label for="acRippleCurr" class="text-muted">Current</label>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="form-floating">
                              <select
                                class="form-select power-select"
                                formControlName="acRippleCurr_PF"
                                id="acRippleCurrStatus"
                              >
                                <option value="">Select status...</option>
                                <option
                                  *ngFor="let option of powerVerificationOptions"
                                  [value]="option.value"
                                >
                                  {{ option.text }}
                                </option>
                              </select>
                              <label for="acRippleCurrStatus" class="text-muted">Status</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>


      <!-- Capacitor Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showCapacitor = !showCapacitor"
          >
            <div class="ups-section-title">
              <i class="bi bi-battery me-2 text-secondary"></i>
              <h5 class="mb-0">Capacitor Readings</h5>
              <small class="text-muted"
                >Assess capacitor condition and age</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showCapacitor"
              [class.bi-chevron-right]="!showCapacitor"
              [class.rotate-90]="showCapacitor"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showCapacitor">
            <form [formGroup]="capacitorForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-lightning-charge text-danger"></i>
                    <h6 class="mb-0">DC Capacitors</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >DC Caps Leaking/Swelling:</label
                    >
                    <div class="row g-2">
                      <div class="col-8">
                        <select class="form-select" formControlName="dcCaps_PF">
                          <option value="">Select status</option>
                          <option value="P">Pass</option>
                          <option value="F">Fail</option>
                          <option value="A">N/A</option>
                        </select>
                      </div>
                      <div class="col-4">
                        <input
                          type="text"
                          class="form-control"
                          formControlName="dcCapsAge"
                          placeholder="Year"
                          maxlength="4"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-plug text-primary"></i>
                    <h6 class="mb-0">AC Input Capacitors</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >AC Input Caps Leaking/Swelling:</label
                    >
                    <div class="row g-2">
                      <div class="col-8">
                        <select class="form-select" formControlName="acInputCaps_PF">
                          <option value="">Select status</option>
                          <option value="P">Pass</option>
                          <option value="F">Fail</option>
                          <option value="A">N/A</option>
                        </select>
                      </div>
                      <div class="col-4">
                        <input
                          type="text"
                          class="form-control"
                          formControlName="acInputCapsAge"
                          placeholder="Year"
                          maxlength="4"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-outlet text-success"></i>
                    <h6 class="mb-0">AC Output Capacitors</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >AC Output Caps Leaking/Swelling:</label
                    >
                    <div class="row g-2">
                      <div class="col-8">
                        <select class="form-select" formControlName="acOutputCaps_PF">
                          <option value="">Select status</option>
                          <option value="P">Pass</option>
                          <option value="F">Fail</option>
                          <option value="A">N/A</option>
                        </select>
                      </div>
                      <div class="col-4">
                        <input
                          type="text"
                          class="form-control"
                          formControlName="acOutputCapsAge"
                          placeholder="Year"
                          maxlength="4"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-router text-info"></i>
                    <h6 class="mb-0">Communication Capacitors</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Comm Caps Leaking/Swelling:</label
                    >
                    <div class="row g-2">
                      <div class="col-8">
                        <select class="form-select" formControlName="commCaps_PF">
                          <option value="">Select status</option>
                          <option value="P">Pass</option>
                          <option value="F">Fail</option>
                          <option value="A">N/A</option>
                        </select>
                      </div>
                      <div class="col-4">
                        <input
                          type="text"
                          class="form-control"
                          formControlName="commCapsAge"
                          placeholder="Year"
                          maxlength="4"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-fan text-warning"></i>
                    <h6 class="mb-0">Fan Date Code</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Fans DateCode:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      formControlName="fansYear"
                      placeholder="Year"
                      maxlength="4"
                    />
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Transfer Test Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showTransfer = !showTransfer"
          >
            <div class="ups-section-title">
              <i class="bi bi-arrow-left-right me-2 text-purple"></i>
              <h5 class="mb-0">
                Transfer Verification
                <span *ngIf="isMajorPM" class="badge bg-warning text-dark ms-2">
                  <i class="bi bi-star-fill me-1"></i>Major PM Required
                </span>
                <span *ngIf="!isMajorPM" class="badge bg-secondary ms-2"></span>
              </h5>
              <small class="text-muted">
                <span *ngIf="isMajorPM">
                  <strong>Major PM Service:</strong> All transfer verification tests are required
                </span>
                <span *ngIf="!isMajorPM">
                  Verify transfer modes and operational functionality
                </span>
              </small>
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showTransfer"
              [class.bi-chevron-right]="!showTransfer"
              [class.rotate-90]="showTransfer"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showTransfer">
            <form [formGroup]="transferForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-clipboard-check text-primary"></i>
                    <h6 class="mb-0">First Major Inspection</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >The first major inspection performed on this unit:</label
                    >
                    <select class="form-select" formControlName="firstMajor">
                      <option value="">Select option</option>
                      <option value="Ys">Yes</option>
                      <option value="No">No</option>
                      <option value="NA">N/A</option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-arrow-repeat text-info"></i>
                    <h6 class="mb-0">Static Bypass Transfer</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Transfer to Static By-Pass [Internal]:</label
                    >
                    <select class="form-select" formControlName="staticBypass">
                      <option value="">Select status</option>
                      <option value="P">Pass</option>
                      <option value="F">Fail</option>
                      <option value="A">N/A</option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-tools text-warning"></i>
                    <h6 class="mb-0">Maintenance Bypass</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Transfer to Maintenance By-Pass [Only When Required]:</label
                    >
                    <select
                      class="form-select"
                      formControlName="transMaintByPass"
                    >
                      <option value="">Select status</option>
                      <option value="P">Pass</option>
                      <option value="F">Fail</option>
                      <option value="A">N/A</option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-activity text-success"></i>
                    <h6 class="mb-0">Waveform Analysis</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Voltage / Current Wave Form:</label
                    >
                    <select class="form-select" formControlName="currentWave">
                      <option value="">Select status</option>
                      <option value="P">Pass</option>
                      <option value="F">Fail</option>
                      <option value="A">N/A</option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-arrow-clockwise text-primary"></i>
                    <h6 class="mb-0">Normal Mode Transfer</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Transfer to Normal Mode:</label
                    >
                    <select class="form-select" formControlName="normalMode">
                      <option value="">Select status</option>
                      <option value="P">Pass</option>
                      <option value="F">Fail</option>
                      <option value="A">N/A</option>
                    </select>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-bell text-danger"></i>
                    <h6 class="mb-0">Alarm Verification</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Verify any Active Alarm:</label
                    >
                    <select class="form-select" formControlName="verifyAlarm">
                      <option value="">Select status</option>
                      <option value="P">Pass</option>
                      <option value="F">Fail</option>
                      <option value="A">N/A</option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Action Required Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showActionRequired = !showActionRequired"
          >
            <div class="ups-section-title">
              <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
              <h5 class="mb-0">Action Required</h5>
              <small class="text-muted"
                >Specify follow-up actions and requirements</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showActionRequired"
              [class.bi-chevron-right]="!showActionRequired"
              [class.rotate-90]="showActionRequired"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showActionRequired">
            <form [formGroup]="actionRequiredForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-gear-wide-connected text-primary"></i>
                    <h6 class="mb-0">DC Group Action</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >DC Group Action Required:</label
                    >
                    <div class="d-flex align-items-center gap-2">
                      <select class="form-select flex-grow-1" formControlName="dcgAction1">
                        <option value="">Select option</option>
                        <option value="N">No</option>
                        <option value="Y">Yes</option>
                        <option value="A">N/A</option>
                      </select>
                      <div class="status-indicator">
                        <i
                          class="bi bi-check-circle-fill text-success fs-5"
                          *ngIf="
                            actionRequiredForm.get('dcgAction1')?.value === 'N'
                          "
                        ></i>
                        <i
                          class="bi bi-exclamation-triangle-fill text-warning fs-5"
                          *ngIf="
                            actionRequiredForm.get('dcgAction1')?.value === 'Y'
                          "
                        ></i>
                        <i
                          class="bi bi-dash-circle text-muted fs-5"
                          *ngIf="
                            actionRequiredForm.get('dcgAction1')?.value === 'A'
                          "
                        ></i>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-person-check text-info"></i>
                    <h6 class="mb-0">Customer Action</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Customer Action Required:</label
                    >
                    <div class="d-flex align-items-center gap-2">
                      <select class="form-select flex-grow-1" formControlName="custAction1">
                        <option value="">Select option</option>
                        <option value="N">No</option>
                        <option value="Y">Yes</option>
                        <option value="A">N/A</option>
                      </select>
                      <div class="status-indicator">
                        <i
                          class="bi bi-check-circle-fill text-success fs-5"
                          *ngIf="
                            actionRequiredForm.get('custAction1')?.value === 'N'
                          "
                        ></i>
                        <i
                          class="bi bi-exclamation-triangle-fill text-warning fs-5"
                          *ngIf="
                            actionRequiredForm.get('custAction1')?.value === 'Y'
                          "
                        ></i>
                        <i
                          class="bi bi-dash-circle text-muted fs-5"
                          *ngIf="
                            actionRequiredForm.get('custAction1')?.value === 'A'
                          "
                        ></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Action Buttons Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div class="ups-section-content show">
            <div class="ups-actions d-flex gap-3 justify-content-center">
              <button
                type="button"
                class="btn btn-primary btn-lg px-4"
                [disabled]="saving"
                (click)="onSave()"
              >
                <span
                  *ngIf="saving"
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                ></span>
                <i *ngIf="!saving" class="bi bi-check-circle me-2"></i>
                {{ saving ? "Saving..." : "Save UPS Data" }}
              </button>

              <button
                type="button"
                class="btn btn-primary btn-lg px-4"
                [disabled]="saving"
                (click)="onSaveAsDraft()"
              >
                <i class="bi bi-file-earmark me-2"></i>
                Save as Draft
              </button>

              <button
                type="button"
                class="btn btn-primary btn-lg px-4"
                (click)="onGoBack()"
              >
                <i class="bi bi-x-circle me-2"></i>
                Cancel
              </button>
            </div>
          </div>
        </div>
      </section>

<!-- Modern Footer Section -->
<footer class="ups-footer mt-5">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 text-center">
        <div class="footer-content">
          <small class="text-muted">
            <i class="bi bi-shield-check me-1"></i>
            Copyright DC-Group, 2013. All Rights Reserved
          </small>
        </div>
      </div>
    </div>
  </div>
</footer>