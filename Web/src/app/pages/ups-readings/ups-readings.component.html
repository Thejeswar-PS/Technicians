<!-- UPS Readings Page -->
<div class="container-fluid ups-readings-container">
  <!-- Loading spinner -->
  <div
    *ngIf="loading"
    class="d-flex justify-content-center align-items-center ups-readings-loading"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="ups-readings-header__top mb-4 d-flex justify-content-between align-items-center">
    <button
      type="button"
      class="btn btn-sm btn-primary ups-readings-header__back"
      (click)="onGoBack()"
      [disabled]="saving"
    >
      <i class="bi bi-arrow-left me-2"></i>
      Back
    </button>
    
    <!-- Page Title - Centered between buttons -->
    <div class="ups-page-title">
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-speedometer2 me-2"></i>
        UPS Readings & Verification
      </h2>
      <!-- Job and Equipment Information -->
      <div class="text-dark mt-2" *ngIf="!loading">
        <span class="fw-semibold">Job ID: {{ callNbr || 'N/A' }} | Equipment ID: {{ equipId || 'N/A' }} | UPS ID: {{ upsId || 'N/A' }}</span>
      </div>
    </div>
    
    <button
      type="button"
      class="btn btn-sm btn-primary ups-readings-header__action"
      (click)="onSave()"
      [disabled]="saving"
    >
      <span
        *ngIf="saving"
        class="spinner-border spinner-border-sm me-2"
        role="status"
      ></span>
      <i *ngIf="!saving" class="bi bi-check-circle me-2"></i>
      {{ saving ? "Saving..." : "Save UPS Data" }}
    </button>
  </div>

  <!-- Main content -->
  <div *ngIf="!loading">
    <div class="card shadow-sm ups-main-card">
      <div class="card-header border-0 py-4">
        <div class="ups-readings-header">
          <div class="ups-readings-header__group"></div>

        <!-- Messages -->
        <div
          class="ups-readings-messages"
          *ngIf="errorMessage || successMessage"
        >
          <div
            *ngIf="errorMessage"
            class="alert alert-danger d-inline-flex align-items-center"
          >
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span>{{ errorMessage }}</span>
          </div>
          <div
            *ngIf="
              successMessage && successMessage.includes('No Information Found')
            "
            class="alert alert-warning d-inline-flex align-items-center"
          >
            <i class="bi bi-info-circle-fill me-2"></i>
            <span>{{ successMessage }}</span>
          </div>
          <div
            *ngIf="
              successMessage && !successMessage.includes('No Information Found')
            "
            class="alert alert-success d-inline-flex align-items-center"
          >
            <i class="bi bi-check-circle-fill me-2"></i>
            <span>{{ successMessage }}</span>
          </div>
        </div>
      </div>

      <!-- Form sections within card body -->
      <div class="card-body">
        <div class="ups-readings-form">
      <!-- Equipment Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showReconciliation = !showReconciliation"
          >
            <div class="ups-section-title">
              <i class="bi bi-gear-wide-connected me-2 text-primary"></i>
              <h5 class="mb-0">Equipment Verification</h5>
              <small class="text-muted"
                >Verify UPS equipment details and specifications</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showReconciliation"
              [class.bi-chevron-right]="!showReconciliation"
              [class.rotate-90]="showReconciliation"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showReconciliation">
            <form [formGroup]="equipmentForm" class="ups-form">
              <!-- Basic Equipment Information -->
              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="manufacturer"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'manufacturer')"
                        id="manufacturer"
                      >
                        <option value="PS">Please Select</option>
                        <option
                          *ngFor="let mfg of manufacturers; trackBy: trackByValue"
                          [value]="mfg.value"
                        >
                          {{ mfg.text }}
                        </option>
                      </select>
                      <label for="manufacturer"
                        >Make <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'manufacturer')"
                      >
                        {{ getFieldError(equipmentForm, 'manufacturer') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="model"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'model')"
                        id="model"
                        placeholder="e.g., 9315-225"
                      />
                      <label for="model"
                        >Model No <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'model')"
                      >
                        {{ getFieldError(equipmentForm, 'model') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="ctoPartNo"
                        id="ctoPartNo"
                        placeholder="e.g., P30002167714104"
                      />
                      <label for="ctoPartNo">CTO / Part No</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="serialNo"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'serialNo')"
                        id="serialNo"
                        placeholder="e.g., EB033ZBX02"
                      />
                      <label for="serialNo"
                        >Serial No <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'serialNo')"
                      >
                        {{ getFieldError(equipmentForm, 'serialNo') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="location"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'location')"
                        id="location"
                        placeholder="e.g., Room A224A, 2nd Floor"
                      />
                      <label for="location"
                        >Location <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'location')"
                      >
                        {{ getFieldError(equipmentForm, 'location') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="status"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'status')"
                        id="status"
                      >
                        <option value="" disabled selected>Please select status</option>
                        <option
                          *ngFor="let status of currentStatusOptions; trackBy: trackByValue"
                          [value]="status.value"
                        >
                          {{ status.text }}
                        </option>
                      </select>
                      <label for="status"
                        >Status <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'status')"
                      >
                        {{ getFieldError(equipmentForm, 'status') }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Equipment Details -->
              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="maintByPass"
                        id="maintByPass"
                      >
                        <option value="">Choose bypass type...</option>
                        <option
                          *ngFor="let option of maintenanceBypassTypes; trackBy: trackByValue"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="maintByPass">Maintenance Bypass</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="number"
                        class="form-control"
                        formControlName="kva"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'kva')"
                        id="kva"
                        placeholder="225.00"
                        step="0.01"
                        min="0"
                      />
                      <label for="kva"
                        >KVA Rating <span class="text-danger">*</span></label
                      >
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'kva')"
                      >
                        {{ getFieldError(equipmentForm, 'kva') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="multiModule"
                        id="multiModule"
                      >
                        <option value="">Choose configuration...</option>
                        <option
                          *ngFor="let option of multiModuleTypes; trackBy: trackByValue"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="multiModule">Multi-Module</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group-modern">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="parallelCabinet"
                        id="parallelCabinet"
                      >
                        <option value="Y">Yes</option>
                        <option value="NO">No</option>
                        <option value="N/A">N/A</option>
                      </select>
                      <label for="parallelCabinet">Parallel Cabinet</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="snmpPresent"
                        id="snmpPresent"
                      >
                        <option *ngFor="let option of snmpOptions; trackBy: trackByValue" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="snmpPresent">SNMP Card Present</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        formControlName="upsType"
                        id="upsType"
                      >
                        <option value="">Choose type...</option>
                        <option
                          *ngFor="let option of upsTypes; trackBy: trackByValue"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label for="upsType">UPS Type</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating position-relative">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="monthName"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'monthName')"
                        id="monthName"
                        placeholder="Enter month (e.g., Jan, Feb, Mar...)"
                        (focus)="toggleMonthCalendar()">
                      
                      <label for="monthName">
                        Month <span class="text-danger">*</span>
                      </label>
                      
                      <!-- Month calendar toggle button -->
                      <button
                        type="button"
                        class="btn btn-sm btn-primary calendar-toggle-btn"
                        (click)="toggleMonthCalendar()"
                        [title]="showMonthCalendar ? 'Hide Month Picker' : 'Show Month Picker'"
                      >
                        <i class="bi bi-calendar-date"></i>
                      </button>
                      
                      <!-- Month Calendar Picker -->
                      <div class="compact-calendar-dropdown" *ngIf="showMonthCalendar">
                        <div class="calendar-header">
                          <h6 class="mb-0">Select Month</h6>
                        </div>
                        <div class="month-grid-compact">
                          <button
                            type="button"
                            *ngFor="let month of monthNames; let i = index"
                            class="btn btn-sm month-btn-compact"
                            [class.btn-primary]="isCurrentMonthSelected(i)"
                            [class.btn-outline-primary]="!isCurrentMonthSelected(i)"
                            (click)="onCalendarMonthSelect(i)"
                          >
                            {{ month.substring(0, 3) }}
                          </button>
                        </div>
                      </div>
                      
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'monthName')"
                      >
                        {{ getFieldError(equipmentForm, 'monthName') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating position-relative">
                      <input
                        type="text"
                        class="form-control"
                        formControlName="year"
                        [class.is-invalid]="isFieldInvalid(equipmentForm, 'year')"
                        id="year"
                        placeholder="Enter year (e.g., 2024, 2025...)"
                        (focus)="toggleYearCalendar()">
                      
                      <label for="year">
                        Year <span class="text-danger">*</span>
                      </label>
                      
                      <!-- Year calendar toggle button -->
                      <button
                        type="button"
                        class="btn btn-sm btn-primary calendar-toggle-btn"
                        (click)="toggleYearCalendar()"
                        [title]="showYearCalendar ? 'Hide Year Picker' : 'Show Year Picker'"
                      >
                        <i class="bi bi-calendar-date"></i>
                      </button>
                      
                      <!-- Year Calendar Picker -->
                      <div class="compact-calendar-dropdown" *ngIf="showYearCalendar" (click)="$event.stopPropagation()">
                        <div class="calendar-header">
                          <div class="year-navigation-header" (click)="$event.stopPropagation()">
                            <button 
                              type="button" 
                              class="btn btn-sm btn-link text-white year-nav-btn"
                              (click)="navigateYearRange('prev'); $event.stopPropagation()"
                              title="Previous years"
                              [disabled]="yearRangeStart <= minYear"
                            >
                              <i class="bi bi-chevron-double-left"></i>
                            </button>
                            <span class="year-range-display">{{ getCurrentYearRange() }}</span>
                            <button 
                              type="button" 
                              class="btn btn-sm btn-link text-white year-nav-btn"
                              (click)="navigateYearRange('next'); $event.stopPropagation()"
                              title="Next years"
                              [disabled]="yearRangeEnd >= maxYear"
                            >
                              <i class="bi bi-chevron-double-right"></i>
                            </button>
                          </div>
                        </div>
                        <div class="year-grid-compact">
                          <button
                            type="button"
                            *ngFor="let year of currentYears; trackBy: trackByYear"
                            class="btn btn-sm year-btn-compact"
                            [class.btn-primary]="isCurrentYearSelected(year)"
                            [class.btn-outline-primary]="!isCurrentYearSelected(year)"
                            (click)="onCalendarYearSelect(year)"
                          >
                            {{ year }}
                          </button>
                        </div>
                      </div>
                      
                      <div
                        class="invalid-feedback"
                        *ngIf="isFieldInvalid(equipmentForm, 'year')"
                      >
                        {{ getFieldError(equipmentForm, 'year') }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Equipment Reconciliation Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showReconciliationDetails = !showReconciliationDetails"
          >
            <div class="ups-section-title">
              <i class="bi bi-check2-square me-2 text-success"></i>
              <h5 class="mb-0">Equipment Reconciliation</h5>
              <small class="text-muted"
                >Verify equipment data matches physical observations</small
              >
            </div>
            <div class="d-flex align-items-center gap-3" [formGroup]="reconciliationForm" (click)="$event.stopPropagation()">
              <div class="verification-status">
                <div class="form-check d-flex align-items-center">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    formControlName="verified"
                    id="verifiedHeader"
                  />
                  <label
                    class="form-check-label fw-semibold"
                    [class]="
                      reconciliationForm.get('verified')?.value
                        ? 'text-success'
                        : 'text-muted'
                    "
                    for="verifiedHeader"
                  >
                    <i
                      class="bi me-1"
                      [class]="
                        reconciliationForm.get('verified')?.value
                          ? 'bi-check-circle-fill text-success'
                          : 'bi-circle text-muted'
                      "
                    ></i>
                    Verified
                  </label>
                </div>
              </div>
              <i
                class="bi transition-transform"
                [class.bi-chevron-down]="showReconciliationDetails"
                [class.bi-chevron-right]="!showReconciliationDetails"
                [class.rotate-90]="showReconciliationDetails"
              ></i>
            </div>
          </div>

          <div
            class="ups-section-content"
            [class.show]="showReconciliationDetails"
          >
            <div
              class="alert alert-info ups-info-tip d-flex align-items-center mb-4"
            >
              <i class="bi bi-info-circle me-2"></i>
              <small>
                Verify that the current equipment values match what is
                physically observed. Select "Yes" if correct, "No" if incorrect,
                or "N/A" if not applicable.
              </small>
            </div>

            <form [formGroup]="reconciliationForm" class="ups-form">
              <!-- Dynamic Reconciliation Rows -->
              <div class="reconciliation-row" *ngFor="let field of reconciliationFields; trackBy: trackByText">
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        [formControlName]="field.currentField"
                        [id]="'recon' + field.id"
                        readonly
                      />
                      <label [for]="'recon' + field.id">Current {{ field.label }}</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select
                        class="form-select"
                        [formControlName]="field.correctField"
                        [id]="field.correctField"
                      >
                        <option value="" disabled selected>Please select</option>
                        <option
                          *ngFor="let option of yesNoNAOptions; trackBy: trackByValue"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <label [for]="field.correctField">Is this Correct ?</label>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        [formControlName]="field.actualField"
                        [readonly]="isActualFieldReadonly(field.correctField)"
                        [id]="field.actualField"
                        [placeholder]="field.placeholder"
                      />
                      <label [for]="field.actualField"
                        >Actual {{ field.label }}
                        <span class="text-muted">(if different)</span></label
                      >
                    </div>
                  </div>
                  <div class="col-md-1 d-flex align-items-center justify-content-center">
                    <div class="verification-indicator">
                      <i
                        class="bi"
                        [class]="getVerificationIcon(reconciliationForm.get(field.correctField)?.value)"
                        *ngIf="getVerificationIcon(reconciliationForm.get(field.correctField)?.value)"
                      ></i>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Measurements Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showMeasurements = !showMeasurements"
          >
            <div class="ups-section-title">
              <i class="bi bi-clipboard-data me-2 text-warning"></i>
              <h5 class="mb-0">System Measurements</h5>
              <small class="text-muted"
                >Verify UPS operational parameters and performance</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showMeasurements"
              [class.bi-chevron-right]="!showMeasurements"
              [class.rotate-90]="showMeasurements"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showMeasurements">
            <form [formGroup]="measurementsForm" class="ups-form">
              <div class="measurements-grid">
                <!-- Dynamic System Measurement Cards -->
                <div class="measurement-card" *ngFor="let card of measurementCards; trackBy: trackByText">
                  <div class="measurement-header">
                    <i class="bi" [class]="card.icon + ' ' + card.iconColor"></i>
                    <h6 class="mb-0">{{ card.title }}</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label">{{ card.description }}</label>
                    <select class="form-select" [formControlName]="card.formControl">
                      <option
                        *ngFor="let option of getOptionsArray(card.options); trackBy: trackByValue"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Visual and Mechanical Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div class="ups-section-header" (click)="showVisual = !showVisual">
            <div class="ups-section-title">
              <i class="bi bi-eye me-2 text-info"></i>
              <h5 class="mb-0">Visual & Mechanical Verification</h5>
              <small class="text-muted"
                >Inspect physical condition and mechanical components</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showVisual"
              [class.bi-chevron-right]="!showVisual"
              [class.rotate-90]="showVisual"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showVisual">
            <form [formGroup]="visualForm" class="ups-form">
              <div class="measurements-grid">
                <!-- Dynamic Visual & Mechanical Cards -->
                <div class="measurement-card" *ngFor="let card of visualMechanicalCards; trackBy: trackByText">
                  <div class="measurement-header">
                    <i class="bi" [class]="card.icon + ' ' + card.iconColor"></i>
                    <h6 class="mb-0">{{ card.title }}</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label">{{ card.description }}</label>
                    <select class="form-select" [formControlName]="card.formControl">
                      <option
                        *ngFor="let option of getOptionsArray(card.options); trackBy: trackByValue"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Filter Information Section -->
              <div class="filter-section mt-4">
                <h6 class="section-title mb-3">Filter Information</h6>
                <div class="measurements-grid">
                  <!-- Dynamic Filter Set Cards -->
                  <div class="measurement-card" *ngFor="let filterSet of filterSets; trackBy: trackByValue">
                    <div class="measurement-header">
                      <i class="bi" [class]="filterSet.icon + ' ' + filterSet.iconColor"></i>
                      <h6 class="mb-0">{{ filterSet.title }}</h6>
                    </div>
                    <div class="measurement-content">
                      <div class="row g-2">
                        <!-- Dynamic Filter Fields -->
                        <div class="col-6" *ngFor="let field of filterSet.fields; trackBy: trackByText">
                          <div class="form-floating">
                            <input
                              type="text"
                              class="form-control"
                              [formControlName]="field.control"
                              readonly
                              [id]="field.id"
                            />
                            <label [for]="field.id">{{ field.label }}</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>



              <!-- Comments -->
              <div class="form-group-modern mt-4">
                <div class="form-floating">
                  <textarea
                    class="form-control"
                    formControlName="visualComments"
                    id="visualComments"
                    placeholder="Enter any additional comments or notes..."
                    style="height: 100px"
                  ></textarea>
                  <label for="visualComments"
                    >Visual and Mechanical Verification Comments</label
                  >
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Environment Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showEnvironment = !showEnvironment"
          >
            <div class="ups-section-title">
              <i class="bi bi-thermometer-half me-2 text-warning"></i>
              <h5 class="mb-0">Environment Verification</h5>
              <small class="text-muted"
                >Assess environmental conditions and safety requirements</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showEnvironment"
              [class.bi-chevron-right]="!showEnvironment"
              [class.rotate-90]="showEnvironment"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showEnvironment">
            <form [formGroup]="environmentForm" class="ups-form">
              <div class="measurements-grid">
                <!-- Dynamic Environment Verification Cards -->
                <div class="measurement-card" *ngFor="let card of environmentCards; trackBy: trackByText">
                  <div class="measurement-header">
                    <i class="bi" [class]="card.icon + ' ' + card.iconColor"></i>
                    <h6 class="mb-0">{{ card.title }}</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label">{{ card.description }}</label>
                    <select class="form-select" [formControlName]="card.formControl">
                      <option
                        *ngFor="let option of getOptionsArray(card.options); trackBy: trackByValue"
                        [value]="option.value"
                      >
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Action Buttons within Environment Verification -->
              <div class="ups-action-buttons d-flex justify-content-center gap-3 mt-4 pt-3 border-top">
                <button
                  type="button"
                  class="btn btn-primary btn-lg px-4 py-2 save-draft-btn"
                  (click)="onSaveAsDraft()"
                  [disabled]="saving"
                >
                  <span
                    *ngIf="saving && saveMode === 'draft'"
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  ></span>
                  <i *ngIf="!saving || saveMode !== 'draft'" class="bi bi-file-earmark me-2"></i>
                  {{ saving && saveMode === 'draft' ? "Saving Draft..." : "Save as Draft" }}
                </button>
                
                <button
                  type="button"
                  class="btn btn-primary btn-lg px-4 py-2 save-ups-btn"
                  (click)="onSaveUPS()"
                  [disabled]="saving"
                >
                  <span
                    *ngIf="saving && saveMode === 'ups'"
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  ></span>
                  <i *ngIf="!saving || saveMode !== 'ups'" class="bi bi-save me-2"></i>
                  {{ saving && saveMode === 'ups' ? "Saving UPS..." : "Save UPS" }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>
<!-- Power Verification Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showPowerVerification = !showPowerVerification"
          >
            <div class="ups-section-title">
              <i class="bi bi-lightning me-2 text-danger"></i>
              <h5 class="mb-0">Power Verification</h5>
              <small class="text-muted"
                >Verify electrical power readings and thresholds</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showPowerVerification"
              [class.bi-chevron-right]="!showPowerVerification"
              [class.rotate-90]="showPowerVerification"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showPowerVerification">
            <!-- Dynamic Power Verification Sections -->
            <div class="mb-4" *ngFor="let section of powerSections; trackBy: trackByText">
              <form [formGroup]="getFormGroup(section.form)">
                <!-- Dynamic Configuration Bar -->
                <div class="input-config-bar d-flex align-items-center justify-content-between p-3 bg-light border rounded-3 shadow-sm">
                  <!-- Configuration Dropdown -->
                  <div class="config-item d-flex align-items-center">
                    <label class="form-label mb-0 me-2 fw-semibold text-white input-label">
                      <i class="bi" [class]="section.icon + ' me-1'"></i>{{ section.title.replace(' Phase Measurements', '') }} Configuration:
                    </label>
                    <select
                      class="form-select form-select-sm custom-select" 
                      [formControlName]="section.configControl"
                      (change)="onVoltageConfigurationChange(section.id, $any($event.target).value)"
                      [id]="section.id + 'Configuration'"
                      style="min-width: 150px; max-width: 150px;"
                    >
                      <option value="">Select...</option>
                      <option *ngFor="let config of voltageConfigurations; trackBy: trackByValue" [value]="config.id">
                        {{ config.name }}
                      </option>
                    </select>
                  </div>

                  <!-- Tolerance Display -->
                  <div class="tolerance-info d-flex align-items-center" *ngIf="getPowerConfig(section.config)">
                    <div class="d-flex flex-column">
                      <small class="text-primary fw-semibold mb-1">
                        <i class="bi bi-info-circle me-1"></i>
                        V-Tolerance: {{ getVoltageToleranceRange(getFormGroup(section.form).get(section.configControl)?.value, section.toleranceType) }}
                      </small>
                      <small class="text-info fw-semibold">
                        <i class="bi bi-speedometer me-1"></i>
                        Freq: {{ getFrequencyToleranceRange(section.toleranceType) }}
                      </small>
                    </div>
                  </div>

                  <!-- Filter Current Toggle -->
                  <div class="config-item d-flex align-items-center" *ngIf="section.hasFilterToggle && section.filterControl">
                    <div class="custom-toggle-container">
                      <input
                        class="custom-toggle-input"
                        type="checkbox"
                        [formControlName]="section.filterControl!"
                        [id]="section.id + 'FilterCurrent'"
                      />
                      <label class="custom-toggle-label" [for]="section.id + 'FilterCurrent'">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                          <i class="bi bi-funnel me-1"></i>Filter Current
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- THD % Toggle -->
                  <div class="config-item d-flex align-items-center" *ngIf="section.hasThdToggle && section.thdControl">
                    <div class="custom-toggle-container">
                      <input
                        class="custom-toggle-input"
                        type="checkbox"
                        [formControlName]="section.thdControl!"
                        [id]="section.id + 'ThdPercent'"
                      />
                      <label class="custom-toggle-label" [for]="section.id + 'ThdPercent'">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                          <i class="bi bi-graph-up me-1"></i>THD %
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- Phase Count Display -->
                  <div class="phase-indicator d-flex align-items-center" *ngIf="getPowerConfig(section.config)">
                    <span class="badge bg-primary fs-6 px-3 py-2">
                      <i class="bi bi-diagram-3 me-1"></i>
                      Phase {{ getPowerConfig(section.config).phaseCount }}
                    </span>
                  </div>
                </div>

                <!-- Dynamic Phase Cards -->
                <div *ngIf="getPowerConfig(section.config)" class="mb-4">
                  <h6 class="fw-bold mb-3" [class]="section.iconColor">
                    <i class="bi" [class]="section.icon + ' me-2'"></i>
                    {{ section.title }}
                    <small class="text-muted ms-2">{{ section.subtitle }}</small>
                  </h6>
                  
                  <div class="row g-3">
                    <!-- Ordered Power Fields: Voltage A, Current A, Voltage B, Current B, Frequency, Load fields -->
                    <div 
                      class="col-xl-3 col-lg-4 col-md-6 col-sm-12" 
                      *ngFor="let field of getOrderedPowerFields(getPowerConfig(section.config).phaseCount, section.id); trackBy: trackByText">
                      <div class="power-measurement-card" *ngIf="field.type === 'frequency' || field.type === 'load' || getPhaseLabel(field, getPowerConfig(section.config).phaseCount)">
                        <div class="power-card-header">
                          <div class="power-card-title">
                            <!-- Handle phase fields (voltage/current) -->
                            <i 
                              *ngIf="field.type === 'voltage' || field.type === 'current'"
                              class="bi" 
                              [class]="field.icon + ' ' + getPhaseColor(field, getPowerConfig(section.config).phaseCount) + ' me-2'">
                            </i>
                            <!-- Handle additional fields (frequency/load) -->
                            <i 
                              *ngIf="field.type === 'frequency' || field.type === 'load'"
                              class="bi" 
                              [class]="field.icon + ' ' + field.iconColor + ' me-2'">
                            </i>
                            <span class="fw-semibold text-dark">
                              {{ field.type === 'frequency' || field.type === 'load' ? field.title : getPhaseLabel(field, getPowerConfig(section.config).phaseCount) }}
                            </span>
                          </div>
                        </div>
                        <div class="power-card-body">
                          <div class="row g-2">
                            <div class="col-8">
                              <div class="form-floating">
                                <input
                                  type="number"
                                  class="form-control power-input"
                                  [formControlName]="field.valueControl"
                                  step="0.01"
                                  [id]="section.id + field.valueControl"
                                />
                                <label [for]="section.id + field.valueControl" class="text-muted">
                                  {{ field.type === 'frequency' || field.type === 'load' ? field.fieldLabel : field.fieldLabel }}
                                </label>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="form-floating">
                                <select
                                  class="form-select power-select"
                                  [formControlName]="field.statusControl"
                                  [id]="section.id + field.statusControl"
                                >
                                  <option
                                    *ngFor="let option of powerVerificationOptions"
                                    [value]="option.value"
                                  >
                                    {{ option.text }}
                                  </option>
                                </select>
                                <label [for]="section.id + field.statusControl" class="text-muted">Status</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Filter Current Detail Section (Input Only) -->
                <div *ngIf="section.hasFilterToggle && showInputFilterCurrent" class="dynamic-section mt-3 p-3 border rounded bg-light">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Filter Current A:</label>
                      <input type="text" class="form-control" formControlName="filterCurrentA">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label fw-semibold">Pass:</label>
                      <select class="form-select" formControlName="filterCurrentA_PF">
                        <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Filter Current B:</label>
                      <input type="text" class="form-control" formControlName="filterCurrentB">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label fw-semibold">Pass:</label>
                      <select class="form-select" formControlName="filterCurrentB_PF">
                        <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Filter Current C:</label>
                      <input type="text" class="form-control" formControlName="filterCurrentC">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label fw-semibold">Pass:</label>
                      <select class="form-select" formControlName="filterCurrentC_PF">
                        <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- THD Detail Section (Input Only) -->
                <div *ngIf="section.hasThdToggle && showInputTHD" class="dynamic-section mt-3 p-3 border rounded bg-light">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Input THD % A:</label>
                      <input type="text" class="form-control" formControlName="inputThdA">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label fw-semibold">Pass:</label>
                      <select class="form-select" formControlName="inputThdA_PF">
                        <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Input THD % B:</label>
                      <input type="text" class="form-control" formControlName="inputThdB">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label fw-semibold">Pass:</label>
                      <select class="form-select" formControlName="inputThdB_PF">
                        <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Input THD % C:</label>
                      <input type="text" class="form-control" formControlName="inputThdC">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label fw-semibold">Pass:</label>
                      <select class="form-select" formControlName="inputThdC_PF">
                        <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                          {{ option.text }}
                        </option>
                      </select>
                    </div>
                  </div>
                </div>

              </form>
            </div>

            <!-- Total Load Calculation Section (Output) -->
            <div class="mb-4" *ngIf="outputReadingsForm">
              <form [formGroup]="outputReadingsForm">
                <div class="dynamic-section p-3 border rounded bg-light">
                  <h6 class="mb-3 text-primary">
                    <i class="bi bi-calculator me-2"></i>Load Calculation
                  </h6>
                  <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label fw-semibold">Total Load:</label>
                      <input 
                        type="text" 
                        class="form-control" 
                        formControlName="totalLoad" 
                        readonly
                        style="color: #000 !important; font-weight: 600;"
                      >
                    </div>
                    <div class="col-md-3">
                      <button 
                        type="button" 
                        class="btn btn-primary" 
                        (click)="calculateTotalLoad()"
                      >
                        <i class="bi bi-calculator me-2"></i>Calculate Total
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>

            <!-- Rectifier Verification Section -->
            <div class="mb-4">
              <form [formGroup]="rectifierForm">
                <div class="rectifier-section">
                  <div class="rectifier-header p-3 d-flex align-items-center">
                    <h6 class="mb-0 text-primary me-3">
                      <i class="bi bi-cpu me-2"></i>Rectifier Verification - Verify correct float voltage settings
                    </h6>
                    <select class="form-select form-select-sm" formControlName="floatVolt_PF" style="width: auto; min-width: 120px;">
                      <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                        {{ option.text }}
                      </option>
                    </select>
                  </div>
                  <div class="rectifier-content p-3">
                    <div class="row g-3">
                      <!-- DC Float Voltage Card -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-battery-charging text-success me-2"></i>
                              <span class="fw-semibold text-dark">DC Float Voltage</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="dcFloatVoltage"
                                    step="0.01"
                                    id="dcFloatVoltage"
                                  />
                                  <label for="dcFloatVoltage" class="text-muted">Voltage</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="dcFloatVoltage_PF"
                                    id="dcFloatVoltage_PF"
                                  >
                                    <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="dcFloatVoltage_PF" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- AC Ripple Voltage Card -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-activity text-warning me-2"></i>
                              <span class="fw-semibold text-dark">AC Ripple Voltage</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="acRippleVolt"
                                    step="0.01"
                                    id="acRippleVolt"
                                  />
                                  <label for="acRippleVolt" class="text-muted">Voltage</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="acRippleVolt_PF"
                                    id="acRippleVolt_PF"
                                  >
                                    <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="acRippleVolt_PF" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- DC Current Card -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-lightning text-primary me-2"></i>
                              <span class="fw-semibold text-dark">DC Current</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="dcCurrent"
                                    step="0.01"
                                    id="dcCurrent"
                                  />
                                  <label for="dcCurrent" class="text-muted">Current</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="dcCurrent_PF"
                                    id="dcCurrent_PF"
                                  >
                                    <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="dcCurrent_PF" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- POS to GND Card -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-plus-circle text-info me-2"></i>
                              <span class="fw-semibold text-dark">POS to GND</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="posToGND"
                                    step="0.01"
                                    id="posToGND"
                                  />
                                  <label for="posToGND" class="text-muted">Value</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="posToGND_PF"
                                    id="posToGND_PF"
                                  >
                                    <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="posToGND_PF" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- NEG to GND Card -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-dash-circle text-danger me-2"></i>
                              <span class="fw-semibold text-dark">NEG to GND</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="negToGND"
                                    step="0.01"
                                    id="negToGND"
                                  />
                                  <label for="negToGND" class="text-muted">Value</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="negToGND_PF"
                                    id="negToGND_PF"
                                  >
                                    <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="negToGND_PF" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- AC Ripple Current Card -->
                      <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="power-measurement-card">
                          <div class="power-card-header">
                            <div class="power-card-title">
                              <i class="bi bi-graph-up text-secondary me-2"></i>
                              <span class="fw-semibold text-dark">AC Ripple Current</span>
                            </div>
                          </div>
                          <div class="power-card-body">
                            <div class="row g-2">
                              <div class="col-8">
                                <div class="form-floating">
                                  <input
                                    type="number"
                                    class="form-control power-input"
                                    formControlName="acRippleCurr"
                                    step="0.01"
                                    id="acRippleCurr"
                                  />
                                  <label for="acRippleCurr" class="text-muted">Current</label>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="form-floating">
                                  <select
                                    class="form-select power-select"
                                    formControlName="acRippleCurr_PF"
                                    id="acRippleCurr_PF"
                                  >
                                    <option *ngFor="let option of powerVerificationOptions" [value]="option.value">
                                      {{ option.text }}
                                    </option>
                                  </select>
                                  <label for="acRippleCurr_PF" class="text-muted">Status</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>

          </div>
        </div>
      </section>

      <!-- Transfer Test Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showTransfer = !showTransfer"
          >
            <div class="ups-section-title">
              <i class="bi bi-arrow-repeat me-2 text-warning"></i>
              <h5 class="mb-0">Transfer Test</h5>
              <small class="text-muted"
                >Test UPS transfer functionality and timing</small
              >
            </div>
            <i
              class="bi transition-transform" 
              [class.bi-chevron-down]="showTransfer"
              [class.bi-chevron-right]="!showTransfer"
              [class.rotate-90]="showTransfer"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showTransfer">
            <!-- Transfer test content goes here -->
            <div class="text-center p-4">
              <i class="bi bi-construction text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-2">Transfer Test section to be implemented</p>
            </div>
          </div>
        </div>
      </section>


      <!-- Capacitor Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showCapacitor = !showCapacitor"
          >
            <div class="ups-section-title">
              <i class="bi bi-battery me-2 text-secondary"></i>
              <h5 class="mb-0">Capacitor Readings</h5>
              <small class="text-muted"
                >Assess capacitor condition and age</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showCapacitor"
              [class.bi-chevron-right]="!showCapacitor"
              [class.rotate-90]="showCapacitor"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showCapacitor">
            <form [formGroup]="capacitorForm" class="ups-form">
              <div class="measurements-grid">
                <!-- Dynamic Capacitor Cards -->
                <div class="measurement-card" *ngFor="let card of capacitorCards; trackBy: trackByText">
                  <div class="measurement-header">
                    <i class="bi" [class]="card.icon + ' ' + card.iconColor"></i>
                    <h6 class="mb-0">{{ card.title }}</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label">{{ card.description }}</label>
                    
                    <!-- Two-column layout for status + year -->
                    <div class="row g-2" *ngIf="card.statusControl && card.hasAgeField">
                      <div class="col-8">
                        <select class="form-select" [formControlName]="card.statusControl">
                          <option
                            *ngFor="let option of capacitorStatusOptions; trackBy: trackByValue"
                            [value]="option.value"
                          >
                            {{ option.text }}
                          </option>
                        </select>
                      </div>
                      <div class="col-4">
                        <input
                          type="text"
                          class="form-control"
                          [formControlName]="card.ageControl"
                          placeholder="Year"
                          maxlength="4"
                        />
                      </div>
                    </div>

                    <!-- Single year input for cards without status -->
                    <input
                      *ngIf="!card.statusControl && card.hasAgeField"
                      type="text"
                      class="form-control"
                      [formControlName]="card.ageControl"
                      placeholder="Year"
                      maxlength="4"
                    />
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Transfer Test Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showTransfer = !showTransfer"
          >
            <div class="ups-section-title">
              <i class="bi bi-arrow-left-right me-2 text-purple"></i>
              <h5 class="mb-0">Transfer Verification (Major PM Only)</h5>
              <small class="text-muted"
                >Verify transfer modes and operational functionality</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showTransfer"
              [class.bi-chevron-right]="!showTransfer"
              [class.rotate-90]="showTransfer"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showTransfer">
            <form [formGroup]="transferForm" class="ups-form">
              <div class="measurements-grid">
                <!-- Dynamic Transfer Verification Fields -->
                <div 
                  class="measurement-card"
                  *ngFor="let field of transferVerificationFields; trackBy: trackByValue"
                >
                  <div class="measurement-header">
                    <i class="bi" [ngClass]="[field.icon, field.iconColor]"></i>
                    <h6 class="mb-0">{{ field.title }}</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label">{{ field.description }}</label>
                    <div class="d-flex align-items-center gap-2">
                      <select 
                        class="form-select flex-grow-1" 
                        [formControlName]="field.formControl"
                        [class.is-invalid]="isFieldInvalid(transferForm, field.formControl)"
                      >
                        <option 
                          *ngFor="let option of getOptionsArray(field.optionsArray); trackBy: trackByValue"
                          [value]="option.value"
                        >
                          {{ option.text }}
                        </option>
                      </select>
                      <!-- Dynamic Status Indicator -->
                      <div class="status-indicator">
                        <i 
                          class="bi fs-5"
                          [ngClass]="getTransferStatusIcon(field, transferForm.get(field.formControl)?.value)"
                        ></i>
                      </div>
                    </div>
                    <div
                      class="invalid-feedback"
                      *ngIf="isFieldInvalid(transferForm, field.formControl)"
                    >
                      {{ getFieldError(transferForm, field.formControl) }}
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Action Required Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div
            class="ups-section-header"
            (click)="showActionRequired = !showActionRequired"
          >
            <div class="ups-section-title">
              <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
              <h5 class="mb-0">Action Required</h5>
              <small class="text-muted"
                >Specify follow-up actions and requirements</small
              >
            </div>
            <i
              class="bi transition-transform"
              [class.bi-chevron-down]="showActionRequired"
              [class.bi-chevron-right]="!showActionRequired"
              [class.rotate-90]="showActionRequired"
            ></i>
          </div>

          <div class="ups-section-content" [class.show]="showActionRequired">
            <form [formGroup]="actionRequiredForm" class="ups-form">
              <div class="measurements-grid">
                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-gear-wide-connected text-primary"></i>
                    <h6 class="mb-0">DC Group Action</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >DC Group Action Required:</label
                    >
                    <div class="d-flex align-items-center gap-2">
                      <select class="form-select flex-grow-1" formControlName="dcgAction1">
                        <option value="">Select option</option>
                        <option value="N">No</option>
                        <option value="Y">Yes</option>
                        <option value="A">N/A</option>
                      </select>
                      <div class="status-indicator">
                        <i
                          class="bi bi-check-circle-fill text-success fs-5"
                          *ngIf="
                            actionRequiredForm.get('dcgAction1')?.value === 'N'
                          "
                        ></i>
                        <i
                          class="bi bi-exclamation-triangle-fill text-warning fs-5"
                          *ngIf="
                            actionRequiredForm.get('dcgAction1')?.value === 'Y'
                          "
                        ></i>
                        <i
                          class="bi bi-dash-circle text-muted fs-5"
                          *ngIf="
                            actionRequiredForm.get('dcgAction1')?.value === 'A'
                          "
                        ></i>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="measurement-card">
                  <div class="measurement-header">
                    <i class="bi bi-person-check text-info"></i>
                    <h6 class="mb-0">Customer Action</h6>
                  </div>
                  <div class="measurement-content">
                    <label class="form-label"
                      >Customer Action Required:</label
                    >
                    <div class="d-flex align-items-center gap-2">
                      <select class="form-select flex-grow-1" formControlName="custAction1">
                        <option value="">Select option</option>
                        <option value="N">No</option>
                        <option value="Y">Yes</option>
                        <option value="A">N/A</option>
                      </select>
                      <div class="status-indicator">
                        <i
                          class="bi bi-check-circle-fill text-success fs-5"
                          *ngIf="
                            actionRequiredForm.get('custAction1')?.value === 'N'
                          "
                        ></i>
                        <i
                          class="bi bi-exclamation-triangle-fill text-warning fs-5"
                          *ngIf="
                            actionRequiredForm.get('custAction1')?.value === 'Y'
                          "
                        ></i>
                        <i
                          class="bi bi-dash-circle text-muted fs-5"
                          *ngIf="
                            actionRequiredForm.get('custAction1')?.value === 'A'
                          "
                        ></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Action Buttons Section -->
      <section class="ups-readings-section">
        <div class="ups-section-card">
          <div class="ups-section-content show">
            <div class="ups-actions d-flex gap-3 justify-content-center">
              <button
                type="button"
                class="btn btn-primary btn-lg px-4"
                [disabled]="saving"
                (click)="onSave()"
              >
                <span
                  *ngIf="saving"
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                ></span>
                <i *ngIf="!saving" class="bi bi-check-circle me-2"></i>
                {{ saving ? "Saving..." : "Save UPS Data" }}
              </button>

              <button
                type="button"
                class="btn btn-primary btn-lg px-4"
                [disabled]="saving"
                (click)="onSaveAsDraft()"
              >
                <i class="bi bi-file-earmark me-2"></i>
                Save as Draft
              </button>

              <button
                type="button"
                class="btn btn-primary btn-lg px-4"
                (click)="onGoBack()"
              >
                <i class="bi bi-x-circle me-2"></i>
                Cancel
              </button>
            </div>
          </div>
        </div>
      </section>

<!-- Modern Footer Section -->
<footer class="ups-footer mt-5">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 text-center">
        <div class="footer-content">
          <small class="text-muted">
            <i class="bi bi-shield-check me-1"></i>
            Copyright DC-Group, 2013. All Rights Reserved
          </small>
        </div>
      </div>
    </div>
  </div>
</footer>
