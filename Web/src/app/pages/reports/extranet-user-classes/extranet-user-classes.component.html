<!-- Extranet User Management Page -->
<div class="container-fluid extranet-user-container">

  <!-- Loading spinner -->
  <div
    *ngIf="isLoading"
    class="d-flex justify-content-center align-items-center extranet-user-loading"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Header Section -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary mb-0">Extranet User Management</h2>
  </div>

  <!-- Main content -->
  <div *ngIf="!isLoading">

    <!-- Status Messages -->
    <div class="message-section mb-4" *ngIf="successMessage || errorMessage">
      <!-- SUCCESS -->
      <div *ngIf="successMessage && !isSaving" class="modern-alert success">
        <div class="alert-icon">
          <i class="fa fa-check-circle"></i>
        </div>
        <div class="alert-content">
          <span class="alert-message">{{ successMessage }}</span>
        </div>
      </div>

      <!-- ERROR -->
      <div *ngIf="errorMessage && !isSaving" class="modern-alert error">
        <div class="alert-icon">
          <i class="fa fa-exclamation-triangle"></i>
        </div>
        <div class="alert-content">
          <span class="alert-message">{{ errorMessage }}</span>
        </div>
      </div>
    </div>

    <!-- Loading overlay -->
    <div *ngIf="isSaving || isDeleting" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <span class="loading-text" *ngIf="isSaving">Saving user information...</span>
        <span class="loading-text" *ngIf="isDeleting">Deleting user...</span>
      </div>
    </div>

    <!-- Form Sections Grid - Two Column Layout -->
    <div class="row g-4" *ngIf="!isSaving && !isDeleting">
      
      <!-- User Information Card (Left) -->
      <div class="col-lg-6">
        <div class="card shadow-sm modern-card-section">
          <div class="card-body">
            <div class="section-header">
              <div class="section-icon">
                <i class="fa fa-user-cog"></i>
              </div>
              <h3 class="section-title">User Information</h3>
            </div>

            <form [formGroup]="userForm" class="modern-form" (ngSubmit)="onSaveUser()">
              <div class="form-grid">
                
                <!-- Login/Username -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-user field-icon"></i>
                      <span>Login/Username</span>
                      <span class="required">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="login"
                      [class.error]="isFieldInvalid('login')"
                      placeholder="Enter username">
                    <div class="field-error" *ngIf="isFieldInvalid('login')">
                      {{ getFieldError('login') }}
                    </div>
                  </div>
                </div>

                <!-- Password -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-lock field-icon"></i>
                      <span>Password</span>
                      <span class="required">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <div class="input-with-toggle">
                      <input 
                        [type]="showPassword ? 'text' : 'password'" 
                        class="modern-input"
                        formControlName="password"
                        [class.error]="isFieldInvalid('password') || passwordValidationError"
                        placeholder="Enter password">
                      <button type="button" class="password-toggle" (click)="togglePasswordVisibility()">
                        <i [class]="showPassword ? 'fa fa-eye-slash' : 'fa fa-eye'"></i>
                      </button>
                    </div>
                    <div class="field-error" *ngIf="isFieldInvalid('password')">
                      {{ getFieldError('password') }}
                    </div>
                    <div class="field-error" *ngIf="passwordValidationError">
                      Password must be at least 8 characters long
                    </div>
                  </div>
                </div>

                <!-- Class ID -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-tag field-icon"></i>
                      <span>Class ID</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <select 
                      class="modern-input"
                      formControlName="classID">
                      <option *ngFor="let userClass of extranetUserClasses; trackBy: trackByClassId" 
                              [value]="userClass.classID">
                        {{ userClass.classID }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Customer Name -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-building field-icon"></i>
                      <span>Customer Name</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="customerName"
                      placeholder="Enter customer name">
                  </div>
                </div>

                <!-- Contact Name -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-address-card field-icon"></i>
                      <span>Contact Name</span>
                      <span class="required">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="contactName"
                      [class.error]="isFieldInvalid('contactName')"
                      placeholder="Enter contact name">
                    <div class="field-error" *ngIf="isFieldInvalid('contactName')">
                      {{ getFieldError('contactName') }}
                    </div>
                  </div>
                </div>

                <!-- Email -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-envelope field-icon"></i>
                      <span>Email</span>
                      <span class="required">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="email" 
                      class="modern-input"
                      formControlName="email"
                      [class.error]="isFieldInvalid('email')"
                      placeholder="Enter email address">
                    <div class="field-error" *ngIf="isFieldInvalid('email')">
                      {{ getFieldError('email') }}
                    </div>
                  </div>
                </div>

                <!-- Phone -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-phone field-icon"></i>
                      <span>Phone</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="tel" 
                      class="modern-input"
                      formControlName="phone"
                      placeholder="Enter phone number">
                  </div>
                </div>

                <!-- Address 1 -->
                <div class="form-field full-width">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-map-marker field-icon"></i>
                      <span>Address Line 1</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="address1"
                      placeholder="Enter address line 1">
                  </div>
                </div>

                <!-- Address 2 -->
                <div class="form-field full-width">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-map-marker-alt field-icon"></i>
                      <span>Address Line 2</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="address2"
                      placeholder="Enter address line 2 (optional)">
                  </div>
                </div>

                <!-- City, State, ZIP Row -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-city field-icon"></i>
                      <span>City</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="city"
                      placeholder="Enter city">
                  </div>
                </div>

                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-flag field-icon"></i>
                      <span>State</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="state"
                      placeholder="Enter state">
                  </div>
                </div>

                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-mail-bulk field-icon"></i>
                      <span>ZIP Code</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="zip"
                      placeholder="Enter ZIP code">
                  </div>
                </div>

                <!-- Permissions Section -->
                <div class="form-field permissions-section full-width">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-shield-alt field-icon"></i>
                      <span>User Permissions</span>
                    </label>
                  </div>
                  <div class="permissions-grid">
                    <div class="permission-item">
                      <label class="modern-checkbox">
                        <input type="checkbox" formControlName="viewFinancial">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label">
                          <i class="fa fa-dollar-sign me-1"></i>
                          View Financial Information
                        </span>
                      </label>
                    </div>
                    <div class="permission-item">
                      <label class="modern-checkbox">
                        <input type="checkbox" formControlName="underContract">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label">
                          <i class="fa fa-file-contract me-1"></i>
                          Under Contract
                        </span>
                      </label>
                    </div>
                  </div>
                </div>

              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <div class="action-buttons">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="onCancel()"
                    [disabled]="isSaving">
                    <i class="fa fa-times me-2"></i>
                    Cancel
                  </button>
                  
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="userForm.invalid || isSaving">
                    <i class="fa fa-save me-2" *ngIf="!isSaving"></i>
                    <div class="spinner-border spinner-border-sm me-2" *ngIf="isSaving"></div>
                    {{ isEditMode ? 'Update User' : 'Create User' }}
                  </button>
                  
                  <button
                    type="button"
                    class="btn btn-success"
                    (click)="onNewUser()"
                    [disabled]="isSaving"
                    *ngIf="!isNewUser">
                    <i class="fa fa-plus me-2"></i>
                    New User
                  </button>
                  
                  <button
                    type="button"
                    class="btn btn-danger"
                    (click)="onDeleteUser()"
                    [disabled]="isSaving || (!selectedLogin && !userForm.get('login')?.value?.trim())"
                    *ngIf="!isNewUser && (selectedLogin || userForm.get('login')?.value?.trim())">
                    <i class="fa fa-trash me-2"></i>
                    Delete User
                  </button>
                </div>
              </div>

            </form>
          </div>
        </div>
      </div>

      <!-- Customer Assignment Card (Right) -->
      <div class="col-lg-6">
        <div class="card shadow-sm modern-card-section">
          <div class="card-body">
            <div class="section-header">
              <div class="section-icon">
                <i class="fa fa-list-ul"></i>
              </div>
              <h3 class="section-title">Customer Number</h3>
            </div>

            <!-- Customer Assignment -->
            <div class="customer-assignment-section">
              <div class="assignment-header">
                <h4>
                  <i class="fa fa-link me-2"></i>
                  Customer Assignment<span *ngIf="selectedUserForCustomers"> for {{ selectedUserForCustomers }}</span>
                </h4>
              </div>

              <!-- Assign Customer Number Form -->
              <form [formGroup]="assignCustomerForm" (ngSubmit)="onAssignCustomer()" class="assign-customer-form">
                <div class="form-field mb-3">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-plus me-2"></i>
                      <span>Assign Customer Number</span>
                    </label>
                  </div>
                  <div class="assign-input-group">
                    <div class="field-input">
                      <input
                        type="text"
                        class="modern-input"
                        formControlName="customerNumber"
                        placeholder="Enter customer number to assign"
                        [class.error]="isFieldInvalid('customerNumber', assignCustomerForm)">
                      <div class="field-error" *ngIf="isFieldInvalid('customerNumber', assignCustomerForm)">
                        Customer number is required
                      </div>
                    </div>
                    <button
                      type="submit"
                      class="btn btn-primary"
                      [disabled]="isLoadingCustomerNumbers">
                      <i class="fa fa-plus me-1" *ngIf="!isLoadingCustomerNumbers"></i>
                      <div class="spinner-border spinner-border-sm me-1" *ngIf="isLoadingCustomerNumbers"></div>
                      Assign
                    </button>
                  </div>
                </div>
              </form>

              <!-- Customer Numbers List -->
              <div class="customer-numbers-section" *ngIf="customerNumbers.length > 0">
                <div class="customer-numbers-header">
                  <h5><i class="fa fa-building me-2"></i>Assigned Customers</h5>
                </div>
                
                <div class="customer-numbers-list">
                  <div 
                    *ngFor="let customer of customerNumbers; trackBy: trackByCustomerNumber"
                    class="customer-number-item">
                    <div class="customer-info">
                      <i class="fa fa-building me-2 text-primary"></i>
                      <span class="customer-number">{{ customer.custNmbr }}</span>
                    </div>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      (click)="onRemoveCustomer(customer.custNmbr)"
                      title="Remove customer assignment">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div *ngIf="customerNumbers.length === 0" class="no-customers-message">
                <div class="empty-state">
                  <i class="fa fa-building fa-2x text-muted mb-2"></i>
                  <p class="text-muted mb-0">No customers assigned. Add customer numbers above.</p>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>

    </div>

  </div>
</div>
