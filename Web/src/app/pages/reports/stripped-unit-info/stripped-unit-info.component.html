<!-- Stripped Unit Information Page -->
<div class="container-fluid stripped-unit-container">

  <!-- Loading spinner -->
  <div
    *ngIf="isLoading"
    class="d-flex justify-content-center align-items-center stripped-unit-loading"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Header Section -->
  <div class="stripped-unit-header__top mb-4 d-flex justify-content-between align-items-center">
    <button
      type="button"
      class="btn btn-sm btn-primary stripped-unit-header__back"
      (click)="onBack()"
      [disabled]="isLoading"
      title="Back to Stripped Units Status">
      <i class="fa fa-arrow-left me-2"></i>
      Back
    </button>
    
    <!-- Page Title - Centered -->
    <div class="stripped-unit-page-title">
      <h2 class="fw-bold text-primary mb-0">
        <i class="fa fa-cube me-2"></i>
        Stripped Unit Information
      </h2>
    </div>
    
    <!-- Unit Index Badge -->
    <div class="unit-badge-compact" *ngIf="!isLoading && currentUnit && !isNewUnit">
      <small class="text-danger fw-bold">
        <i class="fa fa-hashtag me-1"></i>Unit:
      </small>
      <span class="unit-value">{{ currentUnit.rowIndex }}</span>
    </div>
  </div>

  <!-- Main content -->
  <div *ngIf="!isLoading">

    <!-- Stripped Unit Form Section -->
    <div class="card shadow-sm stripped-main-card">
      
      <!-- Status Messages -->
      <div class="message-section" *ngIf="errorMessage || successMessage">
        <!-- SUCCESS -->
        <div *ngIf="successMessage && !isSaving" class="modern-alert success">
          <div class="alert-icon">
            <i class="fa fa-check-circle"></i>
          </div>
          <div class="alert-content">
            <span class="alert-message">{{ successMessage }}</span>
          </div>
        </div>

        <!-- ERROR -->
        <div *ngIf="errorMessage && !isSaving" class="modern-alert error">
          <div class="alert-icon">
            <i class="fa fa-exclamation-triangle"></i>
          </div>
          <div class="alert-content">
            <span class="alert-message">{{ errorMessage }}</span>
          </div>
        </div>
      </div>

      <!-- Form Content -->
      <div class="form-content">
        
        <!-- Loading overlay -->
        <div *ngIf="isSaving || isDeleting" class="loading-overlay">
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <span class="loading-text" *ngIf="isSaving">Saving unit information...</span>
            <span class="loading-text" *ngIf="isDeleting">Deleting unit...</span>
          </div>
        </div>

        <!-- Form Sections Grid -->
        <div class="form-sections" *ngIf="!isSaving && !isDeleting">
          
          <!-- Unit Information Section -->
          <div class="modern-card-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="fa fa-info-circle"></i>
              </div>
              <h3 class="section-title">Unit Information</h3>
            </div>

            <form id="unitInfoForm" [formGroup]="unitInfoForm" class="modern-form" (ngSubmit)="onSave()">
              <div class="form-grid">
                
                <!-- Make -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-industry field-icon"></i>
                      <span>Make</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="make"
                      [class.error]="isFieldInvalid('make')">
                    <div class="field-error" *ngIf="isFieldInvalid('make')">
                      {{ getFieldError('make') }}
                    </div>
                  </div>
                </div>

                <!-- Model -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-tag field-icon"></i>
                      <span>Model</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="model"
                      [class.error]="isFieldInvalid('model')">
                    <div class="field-error" *ngIf="isFieldInvalid('model')">
                      {{ getFieldError('model') }}
                    </div>
                  </div>
                </div>

                <!-- Serial Number -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-barcode field-icon"></i>
                      <span>Serial Number</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="serialNo"
                      [class.error]="isFieldInvalid('serialNo')">
                    <div class="field-error" *ngIf="isFieldInvalid('serialNo')">
                      {{ getFieldError('serialNo') }}
                    </div>
                  </div>
                </div>

                <!-- KVA -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-bolt field-icon"></i>
                      <span>KVA</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="kva"
                      inputmode="numeric"
                      maxlength="3"
                      pattern="[0-9]*">
                  </div>
                </div>

                <!-- Voltage -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-flash field-icon"></i>
                      <span>Voltage</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="voltage"
                      >
                  </div>
                </div>

                <!-- Status -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-flag field-icon"></i>
                      <span>Status</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <select 
                      class="modern-select"
                      [value]="unitInfoForm.get('status')?.value || ''"
                      (change)="onStatusChange($event)"
                      #statusSelect>
                      <option *ngFor="let status of getStatusOptions()" 
                              [value]="status.value"
                              [selected]="status.value === (unitInfoForm.get('status')?.value || '')">
                        {{ status.label }}
                      </option>
                    </select>
                    <!-- Hidden form control to maintain reactive form -->
                    <input type="hidden" formControlName="status">
                    <div class="field-error" *ngIf="isFieldInvalid('status')">
                      {{ getFieldError('status') }}
                    </div>
                  </div>
                </div>
                
              </div>

              <!-- Purchase Order Information Section -->
              <div class="section-header" style="margin-top: 2rem;">
                <div class="section-icon">
                  <i class="fa fa-file-text"></i>
                </div>
                <h4 class="section-title">Purchase Order Information</h4>
              </div>

              <div class="form-grid">
                
                <!-- PO Number -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-hashtag field-icon"></i>
                      <span>PO Number</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="poNumber"
                      readonly>
                  </div>
                </div>

                <!-- Shipping PO -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-truck field-icon"></i>
                      <span>Shipping PO</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="shippingPO"
                      readonly>
                  </div>
                </div>

                <!-- Unit Cost -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-dollar-sign field-icon"></i>
                      <span>Unit Cost</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="number" 
                      class="modern-input"
                      formControlName="unitCost"
                      readonly
                      step="0.01"
                      min="0">
                    <div class="field-error" *ngIf="isFieldInvalid('unitCost')">
                      {{ getFieldError('unitCost') }}
                    </div>
                  </div>
                </div>

                <!-- Shipping Cost -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-shipping-fast field-icon"></i>
                      <span>Shipping Cost</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="number" 
                      class="modern-input"
                      formControlName="shipCost"
                      readonly
                      step="0.01"
                      min="0">
                  </div>
                </div>
                
              </div>

              <!-- Personnel Information Section -->
              <div class="section-header" style="margin-top: 2rem;">
                <div class="section-icon">
                  <i class="fa fa-users"></i>
                </div>
                <h4 class="section-title">Personnel Information</h4>
              </div>

              <div class="form-grid">
                
                <!-- Stripped By -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-user field-icon"></i>
                      <span>Stripped By</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="strippedBy"
                      >
                  </div>
                </div>

                <!-- Put Away By -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-user-check field-icon"></i>
                      <span>Put Away By</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="putAwayBy"
                      >
                  </div>
                </div>

                <!-- Parts Location -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-map-marker-alt field-icon"></i>
                      <span>Stripped Parts Location</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="partsLocation"
                      >
                  </div>
                </div>
                
              </div>

              <!-- Action Buttons for Existing Units -->
              <div class="modern-button-group" *ngIf="currentUnit && !isNewUnit">
                <!-- View Mode Buttons (only show if not coming from Add Parts) -->
                <div *ngIf="!isEditMode && !fromAddParts" class="d-flex gap-3 justify-content-center">
                  <button 
                    type="button" 
                    class="modern-btn primary"
                    (click)="onEdit()"
                    [disabled]="isSaving || isDeleting">
                    <i class="fa fa-edit btn-icon"></i>
                    <span>Edit Unit</span>
                  </button>
                  <button 
                    type="button" 
                    class="modern-btn danger"
                    (click)="onDelete()"
                    [disabled]="isSaving || isDeleting">
                    <span class="btn-spinner" *ngIf="isDeleting"></span>
                    <span>{{ isDeleting ? 'Deleting...' : 'Delete Unit' }}</span>
                  </button>
                </div>
                
                <!-- Edit Mode Buttons (show when editing or coming from Add Parts) -->
                <div *ngIf="isEditMode || fromAddParts" class="d-flex gap-3 justify-content-center">
                  <button 
                    type="submit" 
                    class="modern-btn primary"
                    form="unitInfoForm"
                    (click)="onSave()"
                    [disabled]="isSaving || isDeleting">
                    <span class="btn-spinner" *ngIf="isSaving"></span>
                    <i class="fa fa-save btn-icon" *ngIf="!isSaving"></i>
                    <span>{{ isSaving ? 'Updating...' : 'Update' }}</span>
                  </button>
                  <button 
                    type="button" 
                    class="modern-btn danger"
                    (click)="onDelete()"
                    [disabled]="isSaving || isDeleting">
                    <span class="btn-spinner" *ngIf="isDeleting"></span>
                    <span>{{ isDeleting ? 'Deleting...' : 'Delete' }}</span>
                  </button>
                </div>
              </div>

              <!-- Action Buttons for New Units -->
              <div class="modern-button-group" *ngIf="isNewUnit">
                <button 
                  type="button" 
                  class="modern-btn secondary"
                  (click)="onCancel()"
                  [disabled]="isSaving">
                  <i class="fa fa-times btn-icon"></i>
                  <span>Cancel</span>
                </button>
                <button 
                  type="submit" 
                  class="modern-btn primary"
                  [disabled]="unitInfoForm.invalid || isSaving">
                  <span class="btn-spinner" *ngIf="isSaving"></span>
                  <i class="fa fa-save btn-icon" *ngIf="!isSaving"></i>
                  <span>{{ isSaving ? 'Creating...' : 'Create Unit' }}</span>
                </button>
              </div>

            </form>

          </div>
          
          <!-- Add Parts Section -->
          <div class="modern-card-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="fa fa-cogs"></i>
              </div>
              <h3 class="section-title">Add Parts from Stripped Unit</h3>
            </div>
            <p class="text-muted mb-4">This section can be used independently to add parts information</p>

            <form [formGroup]="strippedPartsForm" class="modern-form" (ngSubmit)="onSaveStrippedPart()">
              <div class="form-grid">
                
                <!-- DCG Part Group -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-layer-group field-icon"></i>
                      <span>DCG Part Group</span>
                      <span class="required-indicator">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <select 
                      class="modern-select"
                      formControlName="dcgPartGroup"
                      [class.error]="isPartsFieldInvalid('dcgPartGroup')"
                      [disabled]="isLoadingStripPartCodes">
                      <option value="">
                        <span *ngIf="isLoadingStripPartCodes">Loading...</span>
                        <span *ngIf="!isLoadingStripPartCodes">Select DCG Part Group</span>
                      </option>
                      <option *ngFor="let partCode of stripPartCodes" [value]="partCode.code">
                        {{ partCode.name }}
                      </option>
                    </select>
                    <div class="field-error" *ngIf="isPartsFieldInvalid('dcgPartGroup')">
                      DCG Part Group is required
                    </div>
                  </div>
                </div>

                <!-- DCG Part No -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-code field-icon"></i>
                      <span>DCG Part No</span>
                      <span class="required-indicator">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="text" 
                      class="modern-input"
                      formControlName="dcgPartNo"
                      [class.error]="isPartsFieldInvalid('dcgPartNo')">
                    <div class="field-error" *ngIf="isPartsFieldInvalid('dcgPartNo')">
                      DCG Part Number is required
                    </div>
                  </div>
                </div>

                <!-- Number Stripped -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-sort-numeric-up field-icon"></i>
                      <span>Number Stripped</span>
                      <span class="required-indicator">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <input 
                      type="number" 
                      class="modern-input"
                      formControlName="stripNo"
                      [class.error]="isPartsFieldInvalid('stripNo')"
                      min="1">
                    <div class="field-error" *ngIf="isPartsFieldInvalid('stripNo')">
                      Strip Number is required and must be at least 1
                    </div>
                  </div>
                </div>

                <!-- Keep or Throw -->
                <div class="form-field">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-tasks field-icon"></i>
                      <span>Keep or Throw</span>
                      <span class="required-indicator">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <select 
                      class="modern-select"
                      formControlName="keepThrow"
                      [class.error]="isPartsFieldInvalid('keepThrow')">
                      <option value="">Select Action</option>
                      <option *ngFor="let option of getKeepThrowOptions()" [value]="option.value">
                        {{ option.label }}
                      </option>
                    </select>
                    <div class="field-error" *ngIf="isPartsFieldInvalid('keepThrow')">
                      Please select Keep or Throw
                    </div>
                  </div>
                </div>

                <!-- Part Description -->
                <div class="form-field" style="grid-column: 1 / -1;">
                  <div class="field-header">
                    <label class="field-label">
                      <i class="fa fa-align-left field-icon"></i>
                      <span>Part Description</span>
                      <span class="required-indicator">*</span>
                    </label>
                  </div>
                  <div class="field-input">
                    <textarea 
                      class="modern-textarea"
                      formControlName="partDesc"
                      [class.error]="isPartsFieldInvalid('partDesc')"
                      rows="3">
                    </textarea>
                    <div class="field-error" *ngIf="isPartsFieldInvalid('partDesc')">
                      Part Description is required
                    </div>
                  </div>
                </div>
                
              </div>

              <!-- Hidden fields for system data -->
              <input type="hidden" formControlName="masterRowIndex">
              <input type="hidden" formControlName="rowIndex">
              <input type="hidden" formControlName="createdBy">
              <input type="hidden" formControlName="lastModifiedBy">
              <input type="hidden" formControlName="createdOn">
              <input type="hidden" formControlName="lastModifiedOn">

              <!-- Parts Action Buttons -->
              <div class="modern-button-group">
                <button 
                  type="button" 
                  class="modern-btn secondary"
                  (click)="onClearPartForm()"
                  title="Clear all form fields">
                  <i class="fa fa-eraser btn-icon"></i>
                  <span>Clear</span>
                </button>
                <button 
                  type="submit" 
                  class="modern-btn primary"
                  [disabled]="isSavingPart || strippedPartsForm.invalid"
                  title="Add or Update stripped part">
                  <span class="btn-spinner" *ngIf="isSavingPart"></span>
                  <i class="fa fa-save btn-icon" *ngIf="!isSavingPart"></i>
                  <span>{{ isSavingPart ? 'Saving...' : 'Save Part' }}</span>
                </button>
              </div>

              <!-- Disabled state message for new units -->
              <div class="modern-alert error" *ngIf="isNewUnit">
                <div class="alert-icon">
                  <i class="fa fa-info-circle"></i>
                </div>
                <div class="alert-content">
                  <span class="alert-message">Save the unit information first to add stripped parts.</span>
                </div>
              </div>

            </form>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>