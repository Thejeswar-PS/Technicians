<div class="container-fluid parts-test-status-container">

  <!-- Loading Overlay -->
  <div *ngIf="isLoading"
       class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center loading-overlay">
    <div class="spinner-border text-primary"></div>
  </div>

  <div class="card shadow-sm main-card">

    <!-- Header -->
    <div class="card-header border-0 py-4">
      <div class="d-flex align-items-center">
        <!-- LEFT: Back button -->
        <div class="flex-shrink-0">
          <button class="btn btn-sm btn-primary" (click)="goBack()">
            <i class="bi bi-arrow-left me-1"></i> Back
          </button>
        </div>

        <!-- CENTER: Title -->
        <div class="flex-grow-1 text-center">
          <h3 class="fw-bold text-primary mb-0">
            Parts Test Status
          </h3>
        </div>

        <!-- RIGHT: spacer to balance layout -->
        <div class="flex-shrink-0" style="width: 72px;"></div>
      </div>
    </div>

    <div class="card-body">
      <!-- Error -->
      <div class="mb-3" *ngIf="errorMessage">
        <div class="alert alert-danger d-inline-flex align-items-center">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage }}
        </div>
      </div>

      <!-- Color Legend -->
      <div class="color-legend justify-content-center"
           *ngIf="!filterForm.get('archive')?.value">
        <div class="legend-item">
          <div class="legend-box red"></div>
          <span>Red = Due Same day or Overdue</span>
        </div>
        <div class="legend-item">
          <div class="legend-box orange"></div>
          <span>Orange = Due Within 3 days</span>
        </div>
        <div class="legend-item">
          <div class="legend-box yellow"></div>
          <span>Yellow = Due within a week</span>
        </div>
      </div>

      <!-- Filters -->
      <div class="row mb-3 filter-panel" [formGroup]="filterForm">
        <div class="col-md-2">
          <label class="form-label">Job Type</label>
          <select class="form-select" formControlName="jobType">
            <option *ngFor="let option of jobTypeOptions"
                    [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Make</label>
          <select class="form-select" formControlName="make">
            <option value="All">All</option>
            <option *ngFor="let make of distinctMakes"
                    [value]="make.make">
              {{ make.make }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Model</label>
          <select class="form-select" formControlName="model">
            <option value="All">All</option>
            <option *ngFor="let model of modelsForSelectedMake"
                    [value]="model.make">
              {{ model.make }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Assigned To</label>
          <select class="form-select" formControlName="assignedTo">
            <option value="All">All</option>
            <option *ngFor="let tech of technicians"
                    [value]="tech.empName">
              {{ tech.empName }}
            </option>
          </select>
        </div>

        <div class="col-md-3 d-flex align-items-end">
          <div class="form-check form-switch">
            <input class="form-check-input"
                   type="checkbox"
                   formControlName="archive">
            <label class="form-check-label ms-2">
              Include Archive
            </label>
          </div>
        </div>
      </div>

      <!-- Records Per Page -->
      <div class="d-flex align-items-center mb-3">
        <label class="me-2 fw-semibold">Records per page:</label>
        <select class="form-select form-select-sm w-auto"
                (change)="changeItemsPerPage(+$any($event.target).value)">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100" selected>100</option>
        </select>
      </div>

      <!-- Loading message -->
      <div *ngIf="isLoading" class="text-center py-4 fw-semibold">
        <div class="spinner-border text-primary me-2"></div>
        {{ filterForm.get('archive')?.value
            ? 'Loading archive data…'
            : 'Loading active data…' }}
      </div>

      <!-- TABLE -->
      <div class="table-responsive"
           *ngIf="!isLoading && displayedData.length > 0">

        <table class="table table-bordered mb-0">
          <thead>
            <tr>
              <th class="sortable"><div class="header-cell">Row No <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable" (click)="onSort('callNbr')"><div class="header-cell">Job No <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th><div class="header-cell">Assembled</div></th>
              <th><div class="header-cell">Reviewed</div></th>
              <th><div class="header-cell">QC</div></th>
              <th class="sortable" (click)="onSort('dcgPartNo')"><div class="header-cell">DCG Part No <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable"><div class="header-cell">Site ID <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable"><div class="header-cell">Make <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable"><div class="header-cell">Model <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable"><div class="header-cell">Qty <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable" (click)="onSort('createdOn')"><div class="header-cell">Created On <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable" (click)="onSort('dueDate')"><div class="header-cell">Projected DueDt <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable"><div class="header-cell">Assigned To <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
              <th class="sortable"><div class="header-cell">Modified By <span class="sort-icons"><i class="up"></i><i class="down"></i></span></div></th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let item of displayedData"
                [ngClass]="getRowColorClass(item.dueDate)">

              <td class="text-center">{{ item.rowIndex }}</td>
              <td>{{ item.callNbr }}</td>

              <td class="text-center">
                <label class="custom-checkbox">
                  <input type="checkbox" [checked]="isAssembled(item)" disabled>
                  <span></span>
                </label>
              </td>

              <td class="text-center">
                <label class="custom-checkbox">
                  <input type="checkbox" [checked]="item.isPassed" disabled>
                  <span></span>
                </label>
              </td>

              <td class="text-center">
                <label class="custom-checkbox">
                  <input type="checkbox" [checked]="isQualityChecked(item)" disabled>
                  <span></span>
                </label>
              </td>

              <td>
                <a (click)="navigateToPartTestEntry(item.rowIndex)">
                  {{ item.dcgPartNo }}
                </a>
              </td>

              <td>{{ item.siteID }}</td>
              <td>{{ item.make }}</td>
              <td>{{ item.model }}</td>
              <td class="text-center">{{ item.quantity }}</td>
              <td>{{ formatDate(item.createdOn) }}</td>
              <td>{{ formatDate(item.dueDate) }}</td>
              <td>{{ item.assignedTo }}</td>
              <td>{{ item.lastModifiedBy || item.createdBy }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="alert alert-info text-center"
           *ngIf="!isLoading && displayedData.length === 0">
        No records to display
      </div>

    </div>
  </div>
</div>
