<!-- Parts Return Status Page -->
<div class="container-fluid parts-request-container">
  <!-- Loading spinner -->
  <div
    *ngIf="isLoading"
    class="d-flex justify-content-center align-items-center parts-request-loading"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Header Section -->
  <div class="parts-request-header__top mb-4 d-flex justify-content-between align-items-center">
    <button
      type="button"
      class="btn btn-sm btn-primary parts-request-header__back"
      (click)="goBack()"
      [disabled]="isLoading"
    >
      <i class="bi bi-arrow-left me-2"></i>
      Back
    </button>
    
    <!-- Page Title - Centered between buttons -->
    <div class="parts-page-title">
      <h2 class="fw-bold mb-0" style="color: #00a8ff !important;">
        <i class="bi bi-arrow-clockwise me-2" *ngIf="!showWeeklyDataGrid"></i>
        <i class="bi bi-calendar-week me-2" *ngIf="showWeeklyDataGrid"></i>
        {{ getCurrentGridType() }}
      </h2>
      <!-- Filter Information -->
      <div class="text-dark mt-2" *ngIf="!isLoading">
        <span class="fw-semibold" *ngIf="!showWeeklyDataGrid">Filtered by: {{ partReturnFilterForm.get('inventoryUser')?.value }}</span>
        <span class="fw-semibold" *ngIf="showWeeklyDataGrid">Week {{ selectedWeekNo }} Details - {{ getCurrentGridRecordCount() }} records</span>
        <button class="btn btn-sm btn-outline-secondary ms-3" *ngIf="showWeeklyDataGrid" (click)="switchToMainGrid()">
          <i class="bi bi-arrow-left me-1"></i>
          Back to Main View
        </button>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div *ngIf="!isLoading">

    <!--begin::Charts Section with Tabs-->
    <div class="card shadow-sm parts-main-card mb-4">
      <!-- Header with Tabs -->
      <div class="card-header border-0 py-4">
        <!--begin::Tabs Navigation-->
        <div class="chart-tabs-wrapper">
          <ul class="nav nav-tabs modern-tabs">
            <li class="nav-item">
              <a class="nav-link" 
                 [class.active]="activeGraphTab === 'graph1'" 
                 (click)="setActiveGraphTab('graph1')">
                <i class="bi bi-bar-chart me-2"></i>
                Parts to be Received
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" 
                 [class.active]="activeGraphTab === 'graph2'" 
                 (click)="setActiveGraphTab('graph2')">
                <i class="bi bi-graph-up me-2"></i>
                Weekly Parts Returned
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" 
                 [class.active]="activeGraphTab === 'graph3'" 
                 (click)="setActiveGraphTab('graph3')">
                <i class="bi bi-pie-chart me-2"></i>
                Parts Received by Warehouse
              </a>
            </li>
          </ul>
        </div>
        <!--end::Tabs Navigation-->
      </div>

      <!--begin::Card body-->
      <div class="card-body py-2">

          <!--begin::Tab Content-->
          <div class="tab-content">

            <!--begin::Graph 1 Tab-->
            <div class="tab-pane fade"
                 [class.show]="activeGraphTab === 'graph1'"
                 [class.active]="activeGraphTab === 'graph1'">

              <div class="row g-5">
                <div class="col-12">

                  <!--begin::Graph Section-->
                  <div class="chart-section" 
                      *ngIf="showChart || isLoadingChart || chartErrorMessage">

                    <!--begin::Card body-->
                    <div class="card-body" *ngIf="showChart">

                      <!-- Loading -->
                      <div *ngIf="isLoadingChart" 
                           class="d-flex justify-content-center py-10 chart-loading">
                        <div class="spinner-border text-primary"></div>
                      </div>

                      <!-- Error -->
                      <div *ngIf="chartErrorMessage && !isLoadingChart"
                           class="alert alert-warning d-flex align-items-center p-5 mb-10">
                        <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4"></i>
                        <div class="d-flex flex-column">
                          <h4 class="mb-1 text-warning">Chart Data Unavailable</h4>
                          <span>{{ chartErrorMessage }}</span>
                        </div>
                      </div>

                      <!-- Content -->
                      <div *ngIf="!isLoadingChart && chartData.length > 0">

                        <!-- Chart and Summary Layout -->
                        <div class="row g-4">
                          <!-- Chart Section - Left Side -->
                          <div class="col-lg-8">
                            <div class="chart-container">

                              <!-- Chart Type Selector -->
                              <div class="chart-selector-section">
                                <h4 class="chart-selector-title">Data Visualization</h4>

                                <div class="chart-type-controls">
                                  <input type="radio" class="btn-check" 
                                         name="chartType" id="barChart"
                                         checked (change)="setChartType('bar')">
                                  <label class="chart-type-btn" for="barChart">
                                    <i class="bi bi-bar-chart"></i>
                                    Bar Chart
                                  </label>

                                  <input type="radio" class="btn-check" 
                                         name="chartType" id="pieChart"
                                         (change)="setChartType('pie')">
                                  <label class="chart-type-btn" for="pieChart">
                                    <i class="bi bi-pie-chart"></i>
                                    Pie Chart
                                  </label>

                                  <input type="radio" class="btn-check" 
                                         name="chartType" id="dataTable"
                                         (change)="setChartType('table')">
                                  <label class="chart-type-btn" for="dataTable">
                                    <i class="bi bi-table"></i>
                                    Table
                                  </label>
                                </div>
                              </div>

                              <!-- Bar Chart -->
                              <div *ngIf="currentChartType === 'bar'" class="chart-wrapper">
                                <canvas #barChartCanvas class="chart-canvas" width="800" height="400"></canvas>
                              </div>

                              <!-- Pie Chart -->
                              <div *ngIf="currentChartType === 'pie'" class="chart-wrapper">
                                <canvas #pieChartCanvas class="chart-canvas" width="900" height="500"></canvas>
                                
                                <!-- Interactive Tooltip -->
                                <div class="pie-chart-tooltip" 
                                     [class.visible]="hoveredSliceIndex >= 0" 
                                     [style.left.px]="tooltipPosition.x" 
                                     [style.top.px]="tooltipPosition.y">
                                  <div *ngIf="chartData && hoveredSliceIndex >= 0 && chartData[hoveredSliceIndex]" class="tooltip-content">
                                    <div class="tooltip-header">
                                      <div class="tooltip-color-indicator" 
                                           [style.background]="getSliceColor(hoveredSliceIndex)"></div>
                                      <span class="tooltip-name">{{ chartData[hoveredSliceIndex].name }}</span>
                                    </div>
                                    <div class="tooltip-data">
                                      <div class="tooltip-row">
                                        <span class="tooltip-label">Jobs:</span>
                                        <span class="tooltip-value">{{ chartData[hoveredSliceIndex].jobsCount }}</span>
                                      </div>
                                      <div class="tooltip-row">
                                        <span class="tooltip-label">Percentage:</span>
                                        <span class="tooltip-value">{{ getChartItemPercentage(chartData[hoveredSliceIndex]) }}%</span>
                                      </div>
                                      <div class="tooltip-row" *ngIf="chartData && hoveredSliceIndex >= 0 && chartData[hoveredSliceIndex] && chartData[hoveredSliceIndex].faulty > 0">
                                        <span class="tooltip-label">Faulty:</span>
                                        <span class="tooltip-value text-danger">{{ chartData[hoveredSliceIndex].faulty }}</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Data Table -->
                              <div *ngIf="currentChartType === 'table'" class="modern-table-container">
                                <div class="table-wrapper">
                                  <table class="interactive-chart-table">
                                    <thead>
                                      <tr>
                                        <th class="user-col">
                                          <div class="header-content">
                                            <i class="bi bi-person-circle me-2"></i>
                                            <span>User</span>
                                          </div>
                                        </th>
                                        <th class="jobs-col">
                                          <div class="header-content">
                                            <i class="bi bi-briefcase me-2"></i>
                                            <span>Jobs Count</span>
                                          </div>
                                        </th>
                                        <th class="faulty-col">
                                          <div class="header-content">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <span>Faulty Parts</span>
                                          </div>
                                        </th>
                                        <th class="percentage-col">
                                          <div class="header-content">
                                            <i class="bi bi-percent me-2"></i>
                                            <span>Job %</span>
                                          </div>
                                        </th>
                                        <th class="progress-col">
                                          <div class="header-content">
                                            <i class="bi bi-bar-chart me-2"></i>
                                            <span>Progress</span>
                                          </div>
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr *ngFor="let item of chartData; let i = index" 
                                          class="table-row"
                                          (click)="onChartItemClick(item, 'parts-to-receive')"
                                          (mouseenter)="onRowHover(i, true)"
                                          (mouseleave)="onRowHover(i, false)"
                                          title="Click to view details for {{ item.name }}"
                                          [style.animation-delay.ms]="i * 100">
                                        <td class="user-cell">
                                          <div class="user-info">
                                            <div class="user-avatar">
                                              {{ getInitials(item.name) }}
                                            </div>
                                            <span class="user-name">{{ item.name }}</span>
                                          </div>
                                        </td>
                                        <td class="jobs-cell">
                                          <div class="metric-badge jobs-metric">
                                            <span class="metric-value">{{ item.jobsCount }}</span>
                                            <span class="metric-label">jobs</span>
                                          </div>
                                        </td>
                                        <td class="faulty-cell">
                                          <div class="metric-badge faulty-metric">
                                            <span class="metric-value">{{ item.faulty }}</span>
                                            <span class="metric-label">faulty</span>
                                          </div>
                                        </td>
                                        <td class="percentage-cell">
                                          <div class="percentage-display">
                                            <span class="percentage-value">{{ getChartItemPercentage(item) }}%</span>
                                            <div class="percentage-ring">
                                              <svg width="24" height="24" viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                                                <circle cx="12" cy="12" r="10" fill="none" stroke="#3b82f6" stroke-width="2" 
                                                        [style.stroke-dasharray]="'62.83'"
                                                        [style.stroke-dashoffset]="62.83 - (62.83 * getChartItemPercentage(item) / 100)"
                                                        transform="rotate(-90 12 12)"/>
                                              </svg>
                                            </div>
                                          </div>
                                        </td>
                                        <td class="progress-cell">
                                          <div class="animated-progress">
                                            <div class="progress-track">
                                              <div class="progress-fill" 
                                                   [style.width.%]="getChartItemPercentage(item)"
                                                   [style.animation-delay.ms]="i * 150 + 500">
                                                <div class="progress-glow"></div>
                                              </div>
                                            </div>
                                            <span class="progress-text">{{ getChartItemPercentage(item) }}%</span>
                                          </div>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </div>

                            </div>
                            <!--end::Chart Container-->
                          </div>

                          <!-- Summary Section - Right Side -->
                          <div class="col-lg-4">
                            <div class="parts-return-summary-sidebar">
                              <div class="summary-header mb-3">
                                <h5 class="summary-title">
                                  <i class="bi bi-graph-up-arrow me-2"></i>
                                  Parts Return Summary {{ partReturnFilterForm.get('year')?.value }}
                                </h5>
                                <p class="summary-subtitle">Current status overview</p>
                              </div>

                              <div class="summary-cards">
                                <!-- UnUsed To Be Returned -->
                                <div class="summary-card unused-to-return mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-clock-history"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">UnUsed To Be Returned</h6>
                                        <div class="summary-value">{{ chartTotals.unUsedTR || 0 }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Faulty To Be Returned -->
                                <div class="summary-card faulty-to-return mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-exclamation-triangle"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">Faulty To Be Returned</h6>
                                        <div class="summary-value">{{ chartTotals.faultyTR || 0 }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- UnUsed Returned -->
                                <div class="summary-card unused-returned mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-check-circle"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">UnUsed Returned</h6>
                                        <div class="summary-value">{{ getUnusedReturnedTotal() }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Faulty Returned -->
                                <div class="summary-card faulty-returned mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-x-circle"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">Faulty Returned</h6>
                                        <div class="summary-value">{{ getFaultyReturnedTotal() }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Summary Totals -->
                                <div class="summary-totals mt-4">
                                  <div class="total-row pending mb-2">
                                    <span class="total-label">Total Pending:</span>
                                    <span class="total-value">{{ (chartTotals.unUsedTR || 0) + (chartTotals.faultyTR || 0) }}</span>
                                  </div>
                                  <div class="total-row completed">
                                    <span class="total-label">Total Completed:</span>
                                    <span class="total-value">{{ getUnusedReturnedTotal() + getFaultyReturnedTotal() }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <!--end::Chart and Summary Layout-->

                      </div>
                      <!--end::Content-->

                    </div>
                    <!--end::Card body-->

                  </div>
                  <!--end::Graph Section-->

                </div>
              </div>

            </div>
            <!--end::Graph 1 Tab-->
<!--begin::Graph 2 Tab-->
<div class="tab-pane fade"
     [class.show]="activeGraphTab === 'graph2'"
     [class.active]="activeGraphTab === 'graph2'">

  <div class="row g-5">
    <div class="col-12">

      <!--begin::Weekly Chart Section-->
      <div class="chart-section"
           *ngIf="showWeeklyChart || isLoadingWeeklyChart || weeklyChartErrorMessage">

        <!--begin::Card body-->
        <div class="card-body" *ngIf="showWeeklyChart">

          <!-- Loading -->
          <div *ngIf="isLoadingWeeklyChart" 
               class="d-flex justify-content-center py-10 chart-loading">
            <div class="spinner-border text-primary"></div>
          </div>

          <!-- Error -->
          <div *ngIf="weeklyChartErrorMessage && !isLoadingWeeklyChart"
               class="alert alert-warning d-flex align-items-center p-5 mb-10">
            <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4"></i>
            <div class="d-flex flex-column">
              <h4 class="mb-1 text-warning">Weekly Chart Data Unavailable</h4>
              <span>{{ weeklyChartErrorMessage }}</span>
            </div>
          </div>

          <!-- Content -->
          <div *ngIf="!isLoadingWeeklyChart && weeklyPartsData.length > 0">

            <!-- Chart and Summary Layout -->
            <div class="row g-4">
              <!-- Chart Section - Left Side -->
              <div class="col-lg-8">
                <div class="chart-container">

                  <!-- Chart Type Selector -->
                  <div class="chart-selector-section">
                    <h4 class="chart-selector-title">Weekly Data Visualization</h4>

                    <div class="chart-type-controls">
                      <input type="radio" class="btn-check" 
                             name="weeklyChartType" id="weeklyBarChart"
                             checked (change)="setWeeklyChartType('bar')">
                      <label class="chart-type-btn" for="weeklyBarChart">
                        <i class="bi bi-bar-chart"></i>
                        Bar Chart
                      </label>

                      <input type="radio" class="btn-check" 
                             name="weeklyChartType" id="weeklyPieChart"
                             (change)="setWeeklyChartType('pie')">
                      <label class="chart-type-btn" for="weeklyPieChart">
                        <i class="bi bi-pie-chart"></i>
                        Pie Chart
                      </label>

                      <input type="radio" class="btn-check" 
                             name="weeklyChartType" id="weeklyDataTable"
                             (change)="setWeeklyChartType('table')">
                      <label class="chart-type-btn" for="weeklyDataTable">
                        <i class="bi bi-table"></i>
                        Table
                      </label>
                    </div>
                  </div>

                  <!-- Bar Chart -->
                  <div *ngIf="currentWeeklyChartType === 'bar'" class="chart-wrapper">
                    <canvas #weeklyBarChartCanvas class="chart-canvas" width="800" height="400"></canvas>
                  </div>

                  <!-- Pie Chart -->
                  <div *ngIf="currentWeeklyChartType === 'pie'" class="chart-wrapper">
                    <canvas #weeklyPieChartCanvas class="chart-canvas" width="900" height="500"></canvas>
                    
                    <!-- Interactive Tooltip -->
                    <div class="pie-chart-tooltip" 
                         [class.visible]="hoveredWeeklySliceIndex >= 0" 
                         [style.left.px]="weeklyTooltipPosition.x" 
                         [style.top.px]="weeklyTooltipPosition.y">
                      <div *ngIf="weeklyPartsData && hoveredWeeklySliceIndex >= 0 && weeklyPartsData[hoveredWeeklySliceIndex]" class="tooltip-content">
                        <div class="tooltip-header">
                          <div class="tooltip-color-indicator" 
                               [style.background]="getWeeklySliceColor(hoveredWeeklySliceIndex)"></div>
                          <span class="tooltip-name">Week {{ weeklyPartsData[hoveredWeeklySliceIndex].weekNo }}</span>
                        </div>
                        <div class="tooltip-data">
                          <div class="tooltip-row">
                            <span class="tooltip-label">Unused:</span>
                            <span class="tooltip-value">{{ weeklyPartsData[hoveredWeeklySliceIndex].unUsed }}</span>
                          </div>
                          <div class="tooltip-row">
                            <span class="tooltip-label">Faulty:</span>
                            <span class="tooltip-value">{{ weeklyPartsData[hoveredWeeklySliceIndex].faulty }}</span>
                          </div>
                          <div class="tooltip-row">
                            <span class="tooltip-label">Total:</span>
                            <span class="tooltip-value">{{ weeklyPartsData[hoveredWeeklySliceIndex].unUsed + weeklyPartsData[hoveredWeeklySliceIndex].faulty }}</span>
                          </div>
                          <div class="tooltip-row">
                            <span class="tooltip-label">Percentage:</span>
                            <span class="tooltip-value">{{ getWeeklyItemPercentage(weeklyPartsData[hoveredWeeklySliceIndex]) }}%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>


                  <!-- Data Table -->
                  <div *ngIf="currentWeeklyChartType === 'table'" class="modern-table-container">
                    <div class="table-wrapper">
                      <table class="interactive-chart-table">
                        <thead>
                          <tr>
                            <th class="week-col">
                              <div class="header-content">
                                <i class="bi bi-calendar-week me-2"></i>
                                <span>Week</span>
                              </div>
                            </th>
                            <th class="unused-col">
                              <div class="header-content">
                                <i class="bi bi-box me-2"></i>
                                <span>Unused Parts</span>
                              </div>
                            </th>
                            <th class="faulty-col">
                              <div class="header-content">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <span>Faulty Parts</span>
                              </div>
                            </th>
                            <th class="progress-col">
                              <div class="header-content">
                                <i class="bi bi-bar-chart me-2"></i>
                                <span>Progress</span>
                              </div>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of weeklyPartsData; let i = index" 
                              class="table-row"
                              (click)="onChartItemClick(item, 'weekly-returned')"
                              (mouseenter)="onWeeklyRowHover(i, true)"
                              (mouseleave)="onWeeklyRowHover(i, false)"
                              title="Click to view details for week {{ item.weekNo }}"
                              [style.animation-delay.ms]="i * 100">
                            <td class="week-cell">
                              <div class="week-info">
                                <div class="week-badge">
                                  Week {{ item.weekNo }}
                                </div>
                                <span class="week-end">{{ item.wkEnd | date:'dd-MMM' }}</span>
                              </div>
                            </td>
                            <td class="unused-cell">
                              <div class="metric-badge unused-metric" *ngIf="item.unUsed > 0">
                                <span class="metric-value">{{ item.unUsed }}</span>
                                <span class="metric-label">unused</span>
                              </div>
                              <div class="metric-badge unused-metric" *ngIf="item.unUsed === 0">
                                <span class="metric-label">unused</span>
                              </div>
                            </td>
                            <td class="faulty-cell">
                              <div class="metric-badge faulty-metric">
                                <span class="metric-value">{{ item.faulty }}</span>
                                <span class="metric-label">faulty</span>
                              </div>
                            </td>

                            <td class="progress-cell">
                              <div class="animated-progress">
                                <div class="progress-track">
                                  <div class="progress-fill" 
                                       [style.width.%]="getWeeklyItemPercentage(item)"
                                       [style.animation-delay.ms]="i * 150 + 500">
                                    <div class="progress-glow"></div>
                                  </div>
                                </div>
                                <span class="progress-text">{{ getWeeklyItemPercentage(item) }}%</span>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                </div>
                <!--end::Chart Container-->
              </div>

              <!-- Summary Section - Right Side -->
              <div class="col-lg-4">
                <div class="parts-return-summary-sidebar">
                  <div class="summary-header mb-3">
                    <h5 class="summary-title">
                      <i class="bi bi-calendar-week me-2"></i>
                      Weekly Parts Summary {{ partReturnFilterForm.get('year')?.value }}
                    </h5>
                    <p class="summary-subtitle">Weekly breakdown overview</p>
                  </div>

                  <div class="summary-cards">
                    <!-- Total Unused -->
                    <div class="summary-card unused-weekly mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-box"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Total Unused Parts</h6>
                            <div class="summary-value">{{ getTotalWeeklyUnused() || 0 }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Total Faulty -->
                    <div class="summary-card faulty-weekly mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-exclamation-triangle"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Total Faulty Parts</h6>
                            <div class="summary-value">{{ getTotalWeeklyFaulty() || 0 }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Total Weekly Parts -->
                    <div class="summary-card total-weekly mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-collection"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Total Weekly Parts</h6>
                            <div class="summary-value">{{ getTotalWeeklyParts() || 0 }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Average per Week -->
                    <div class="summary-card average-weekly mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-graph-up"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Average per Week</h6>
                            <div class="summary-value">{{ Math.round((getTotalWeeklyParts() || 0) / (weeklyPartsData.length || 1)) }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Summary Totals -->
                    <div class="summary-totals mt-4">
                      <div class="total-row weeks mb-2">
                        <span class="total-label">Total Weeks:</span>
                        <span class="total-value">{{ weeklyPartsData.length }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!--end::Chart and Summary Layout-->

          </div>
          <!--end::Content-->

        </div>
        <!--end::Card body-->

      </div>
      <!--end::Weekly Chart Section-->

    </div>
  </div>

</div>
<!--end::Graph 2 Tab-->
<!--begin::Graph 3 Tab-->
<div class="tab-pane fade"
     [class.show]="activeGraphTab === 'graph3'"
     [class.active]="activeGraphTab === 'graph3'">

  <div class="row g-5">
    <div class="col-12">

      <!--begin::Received Chart Section-->
      <div class="chart-section"
           *ngIf="showReceivedChart || isLoadingReceivedChart || receivedChartErrorMessage">

        <!--begin::Card body-->
        <div class="card-body" *ngIf="showReceivedChart">

          <!-- Loading -->
          <div *ngIf="isLoadingReceivedChart"
               class="d-flex justify-content-center py-10 chart-loading">
            <div class="spinner-border text-primary"></div>
          </div>

          <!-- Error -->
          <div *ngIf="receivedChartErrorMessage && !isLoadingReceivedChart"
               class="alert alert-warning d-flex align-items-center p-5 mb-10">
            <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4"></i>
            <div class="d-flex flex-column">
              <h4 class="mb-1 text-warning">Chart Data Unavailable</h4>
              <span>{{ receivedChartErrorMessage }}</span>
            </div>
          </div>

          <!-- Content -->
          <div *ngIf="!isLoadingReceivedChart && receivedChartData.length > 0">

            <!-- Chart and Summary Layout -->
            <div class="row g-4">
              <!-- Chart Section - Left Side -->
              <div class="col-lg-8">
                <div class="chart-container">

                  <!-- Chart Type Selector -->
                  <div class="chart-selector-section">
                    <h4 class="chart-selector-title">Received Parts Data Visualization</h4>

                    <div class="chart-type-controls">
                      <input type="radio" class="btn-check" 
                             name="receivedChartType" id="receivedBarChart"
                             checked (change)="setReceivedChartType('bar')">
                      <label class="chart-type-btn" for="receivedBarChart">
                        <i class="bi bi-bar-chart"></i>
                        Bar Chart
                      </label>

                      <input type="radio" class="btn-check" 
                             name="receivedChartType" id="receivedPieChart"
                             (change)="setReceivedChartType('pie')">
                      <label class="chart-type-btn" for="receivedPieChart">
                        <i class="bi bi-pie-chart"></i>
                        Pie Chart
                      </label>

                      <input type="radio" class="btn-check" 
                             name="receivedChartType" id="receivedDataTable"
                             (change)="setReceivedChartType('table')">
                      <label class="chart-type-btn" for="receivedDataTable">
                        <i class="bi bi-table"></i>
                        Table
                      </label>
                    </div>
                  </div>

                  <!-- Bar Chart -->
                  <div *ngIf="currentReceivedChartType === 'bar'" class="chart-wrapper">
                    <canvas #receivedBarChartCanvas class="chart-canvas" width="800" height="400"></canvas>
                  </div>

                  <!-- Pie Chart -->
                  <div *ngIf="currentReceivedChartType === 'pie'" class="chart-wrapper">
                    <canvas #receivedPieChartCanvas class="chart-canvas" width="900" height="500"
                            (mousemove)="onReceivedPieChartMouseMove($event)"
                            (mouseleave)="onReceivedPieChartMouseLeave()"
                            (click)="onReceivedPieChartClick($event)"></canvas>
                    
                    <!-- Interactive Tooltip -->
                    <div class="pie-chart-tooltip" 
                         [class.visible]="hoveredReceivedSliceIndex >= 0" 
                         [style.left.px]="receivedTooltipPosition.x" 
                         [style.top.px]="receivedTooltipPosition.y">
                      <div *ngIf="receivedChartData && hoveredReceivedSliceIndex >= 0 && receivedChartData[hoveredReceivedSliceIndex]" class="tooltip-content">
                        <div class="tooltip-header">
                          <div class="tooltip-color-indicator" 
                               [style.background]="getReceivedSliceColor(hoveredReceivedSliceIndex)"></div>
                          <span class="tooltip-name">{{ receivedChartData[hoveredReceivedSliceIndex].name }}</span>
                        </div>
                        <div class="tooltip-data">
                          <div class="tooltip-row">
                            <span class="tooltip-label">Jobs Count:</span>
                            <span class="tooltip-value">{{ receivedChartData[hoveredReceivedSliceIndex].jobsCount || 0 }}</span>
                          </div>
                          <div class="tooltip-row">
                            <span class="tooltip-label">Faulty Parts:</span>
                            <span class="tooltip-value">{{ receivedChartData[hoveredReceivedSliceIndex].faulty || 0 }}</span>
                          </div>
                          <div class="tooltip-row">
                            <span class="tooltip-label">Total:</span>
                            <span class="tooltip-value">{{ (receivedChartData[hoveredReceivedSliceIndex].jobsCount || 0) + (receivedChartData[hoveredReceivedSliceIndex].faulty || 0) }}</span>
                          </div>
                          <div class="tooltip-row">
                            <span class="tooltip-label">Percentage:</span>
                            <span class="tooltip-value">{{ getReceivedChartItemPercentage(receivedChartData[hoveredReceivedSliceIndex]) }}%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Data Table -->
                  <div *ngIf="currentReceivedChartType === 'table'" class="modern-table-container">
                    <div class="table-wrapper">
                      <table class="interactive-chart-table">
                        <thead>
                          <tr>
                            <th class="month-col">
                              <div class="header-content">
                                <i class="bi bi-person-check me-2"></i>
                                <span>User</span>
                              </div>
                            </th>
                            <th class="jobs-col">
                              <div class="header-content">
                                <i class="bi bi-briefcase me-2"></i>
                                <span>Jobs Count</span>
                              </div>
                            </th>
                            <th class="faulty-col">
                              <div class="header-content">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <span>Faulty Parts</span>
                              </div>
                            </th>
                            <th class="progress-col">
                              <div class="header-content">
                                <i class="bi bi-bar-chart me-2"></i>
                                <span>Progress</span>
                              </div>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of receivedChartData; let i = index" 
                              class="table-row"
                              (click)="onChartItemClick(item, 'parts-received')"
                              (mouseenter)="onReceivedRowHover(i, true)"
                              (mouseleave)="onReceivedRowHover(i, false)"
                              title="Click to view received parts details for {{ item.name }}"
                              [style.animation-delay.ms]="i * 100">
                            <td class="month-cell">
                              <div class="month-info">
                                <div class="month-badge">
                                  {{ item.name }}
                                </div>
                                <span class="month-year">{{ partReturnFilterForm.get('year')?.value }}</span>
                              </div>
                            </td>
                            <td class="jobs-cell">
                              <div class="metric-badge jobs-metric" *ngIf="(item.jobsCount || 0) > 0">
                                <span class="metric-value">{{ item.jobsCount || 0 }}</span>
                                <span class="metric-label">jobs</span>
                              </div>
                              <div class="metric-badge jobs-metric" *ngIf="(item.jobsCount || 0) === 0">
                                <span class="metric-label">jobs</span>
                              </div>
                            </td>
                            <td class="faulty-cell">
                              <div class="metric-badge faulty-metric" *ngIf="(item.faulty || 0) > 0">
                                <span class="metric-value">{{ item.faulty || 0 }}</span>
                                <span class="metric-label">faulty</span>
                              </div>
                              <div class="metric-badge faulty-metric" *ngIf="(item.faulty || 0) === 0">
                                <span class="metric-label">faulty</span>
                              </div>
                            </td>
                            <td class="progress-cell">
                              <div class="animated-progress">
                                <div class="progress-track">
                                  <div class="progress-fill" 
                                       [style.width.%]="getReceivedChartItemPercentage(item)"
                                       [style.animation-delay.ms]="i * 150 + 500">
                                    <div class="progress-glow"></div>
                                  </div>
                                </div>
                                <span class="progress-text">{{ getReceivedChartItemPercentage(item) }}%</span>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                </div>
                <!--end::Chart Container-->
              </div>

              <!-- Summary Section - Right Side -->
              <div class="col-lg-4">
                <div class="parts-return-summary-sidebar">
                  <div class="summary-header mb-3">
                    <h5 class="summary-title">
                      <i class="bi bi-inbox me-2"></i>
                      Received Parts Summary {{ partReturnFilterForm.get('year')?.value }}
                    </h5>
                    <p class="summary-subtitle">Monthly breakdown overview</p>
                  </div>

                  <div class="summary-cards">
                    <!-- Total Jobs Count -->
                    <div class="summary-card jobs-received mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-briefcase"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Total Jobs Count</h6>
                            <div class="summary-value">{{ receivedChartTotals.unUsedReceived || 0 }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Total Faulty Parts -->
                    <div class="summary-card faulty-received mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-exclamation-triangle"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Total Faulty Parts</h6>
                            <div class="summary-value">{{ receivedChartTotals.faultyReceived || 0 }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Total Received -->
                    <div class="summary-card total-received mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-collection"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Total Received</h6>
                            <div class="summary-value">{{ (receivedChartTotals.unUsedReceived || 0) + (receivedChartTotals.faultyReceived || 0) }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Average per Month -->
                    <div class="summary-card average-received mb-3">
                      <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                          <div class="summary-icon me-3">
                            <i class="bi bi-graph-up"></i>
                          </div>
                          <div class="summary-content flex-grow-1">
                            <h6 class="summary-label mb-1">Average per Month</h6>
                            <div class="summary-value">{{ Math.round(((receivedChartTotals.unUsedReceived || 0) + (receivedChartTotals.faultyReceived || 0)) / (receivedChartData.length || 1)) }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Summary Totals -->
                    <div class="summary-totals mt-4">
                      <div class="total-row months mb-2">
                        <span class="total-label">Total Warehouses:</span>
                        <span class="total-value">{{ receivedChartData.length }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!--end::Chart and Summary Layout-->

          </div>
          <!--end::Content-->

        </div>
        <!--end::Card body-->

      </div>
      <!--end::Received Chart Section-->

    </div>
  </div>

</div>
<!--end::Graph 3 Tab-->

    <!-- Spacer for better visual separation -->
    <div class="mb-4"></div>

    <!-- Filter & Data Section -->
    <div class="card shadow-sm parts-main-card mt-3">
      <!-- Filter Header -->
      <div class="card-header border-0 py-4">
        <div class="parts-filter-header">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="mb-0 fw-bold text-dark">
                <i class="bi bi-funnel me-2 text-primary"></i>
                Filters & Search
                <span class="badge ms-3 px-3 py-2 fs-6 fw-bold" [ngClass]="getFilterBadgeClass()" style="background: linear-gradient(45deg, #3b82f6, #1d4ed8); color: white; border-radius: 20px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                  <i class="bi bi-check-circle me-1" *ngIf="!showWeeklyDataGrid"></i>
                  <i class="bi bi-calendar-week me-1" *ngIf="showWeeklyDataGrid"></i>
                  {{getCurrentGridRecordCount()}} {{showWeeklyDataGrid ? 'Weekly' : ''}} Result{{getCurrentGridRecordCount() === 1 ? '' : 's'}}
                </span>
              </h5>
              <small class="text-muted">Customize your view with filters below</small>
            </div>
          </div>

          <!-- Filter Controls -->
          <div class="filter-controls-section mt-3">
            <form [formGroup]="partReturnFilterForm" class="parts-filter-form">
              <div class="row g-4">
                <!-- Inventory User Filter -->
                <div class="col-lg-3 col-md-6">
                  <div class="filter-group">
                    <label class="filter-label fw-semibold mb-2">
                      <i class="bi bi-person-check me-2 text-primary"></i>
                      Inventory User
                    </label>
                    <div class="position-relative">
                      <select class="form-select modern-select enhanced-dropdown" 
                              formControlName="inventoryUser" 
                              [disabled]="isLoadingInventoryUsers"
                              (change)="onInventoryUserChange($event)"
                              style="min-width: 200px; padding: 12px 16px; font-size: 14px; border-radius: 8px; border: 2px solid #e5e7eb; background: white;">
                        <option *ngFor="let user of inventoryUsers; trackBy: trackByUserId"
                                [value]="getInventoryUserValue(user)">
                          {{ getInventoryUserDisplayName(user) }}
                        </option>
                      </select>
                      <span *ngIf="isLoadingInventoryUsers" class="loading-indicator">
                        <i class="bi bi-arrow-repeat spin text-primary"></i>
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- Status Filter -->
                <div class="col-lg-3 col-md-6">
                  <div class="filter-group">
                    <label class="filter-label fw-semibold mb-2">
                      <i class="bi bi-tag me-2 text-success"></i>
                      Status
                    </label>
                    <select class="form-select modern-select enhanced-dropdown" 
                            formControlName="status"
                            (change)="onStatusChange($event)"
                            style="min-width: 200px; padding: 12px 16px; font-size: 14px; border-radius: 8px; border: 2px solid #e5e7eb; background: white;">
                      <option *ngFor="let option of statusOptions"
                              [value]="option.key">
                        {{ option.label }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Week Filter -->
                <div class="col-lg-3 col-md-6">
                  <div class="filter-group">
                    <label class="filter-label fw-semibold mb-2">
                      <i class="bi bi-calendar-week me-2 text-warning"></i>
                      Week
                    </label>
                    <select class="form-select modern-select enhanced-dropdown" 
                            formControlName="week"
                            (change)="onWeekChange($event)"
                            style="min-width: 200px; padding: 12px 16px; font-size: 14px; border-radius: 8px; border: 2px solid #e5e7eb; background: white;">
                      <option value="">All Weeks</option>
                      <option *ngFor="let week of availableWeeks"
                              [value]="week.value">
                        {{ week.label }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Year Filter -->
                <div class="col-lg-3 col-md-6">
                  <div class="filter-group">
                    <label class="filter-label fw-semibold mb-2">
                      <i class="bi bi-calendar me-2 text-info"></i>
                      Year
                    </label>
                    <select class="form-select modern-select enhanced-dropdown" 
                            formControlName="year"
                            (change)="onYearChange($event)"
                            style="min-width: 200px; padding: 12px 16px; font-size: 14px; border-radius: 8px; border: 2px solid #e5e7eb; background: white;">
                      <option *ngFor="let year of availableYears"
                              [value]="year">
                        {{ year }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>


      <!-- Data Display Section -->
      <div class="card-body py-4">
        
        <!-- Messages -->
        <div class="parts-messages" *ngIf="errorMessage">
          <div class="alert alert-danger d-inline-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span>{{ errorMessage }}</span>
          </div>
        </div>

        <!-- Loading indicator for data processing -->
        <div *ngIf="isLoading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary me-2"></div>
          <span class="text-muted">Processing data...</span>
        </div>




        <!-- Main Parts Return Data Table (Legacy: dgReturns table) -->
        <div class="table-section" *ngIf="!isLoading && !showWeeklyDataGrid">
          <div class="table-responsive">
            <table class="table modern-table">
              <thead class="table-header">
                <tr>
                  <th class="sortable header-cell" (click)="sortTable('serviceCallId')" [ngClass]="getSortClass('serviceCallId')">
                    <div class="header-content">
                      <span class="header-text">Service Call ID</span>
                      <i [class]="'sort-icon ' + sortIcon('serviceCallId')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('partNum')" [ngClass]="getSortClass('partNum')">
                    <div class="header-content">
                      <span class="header-text">Part Number</span>
                      <i [class]="'sort-icon ' + sortIcon('partNum')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('dcPartNum')" [ngClass]="getSortClass('dcPartNum')">
                    <div class="header-content">
                      <span class="header-text">DC Part Number</span>
                      <i [class]="'sort-icon ' + sortIcon('dcPartNum')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('description')" [ngClass]="getSortClass('description')">
                    <div class="header-content">
                      <span class="header-text">Description</span>
                      <i [class]="'sort-icon ' + sortIcon('description')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('totalQty')" [ngClass]="getSortClass('totalQty')">
                    <div class="header-content">
                      <span class="header-text">Total Qty</span>
                      <i [class]="'sort-icon ' + sortIcon('totalQty')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('faultyParts')" [ngClass]="getSortClass('faultyParts')">
                    <div class="header-content">
                      <span class="header-text">Faulty</span>
                      <i [class]="'sort-icon ' + sortIcon('faultyParts')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('unusedParts')" [ngClass]="getSortClass('unusedParts')">
                    <div class="header-content">
                      <span class="header-text">Unused</span>
                      <i [class]="'sort-icon ' + sortIcon('unusedParts')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('technician')" [ngClass]="getSortClass('technician')">
                    <div class="header-content">
                      <span class="header-text">Technician</span>
                      <i [class]="'sort-icon ' + sortIcon('technician')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('lastModified')" [ngClass]="getSortClass('lastModified')">
                    <div class="header-content">
                      <span class="header-text">Last Modified</span>
                      <i [class]="'sort-icon ' + sortIcon('lastModified')"></i>
                    </div>
                  </th>
                </tr>
              </thead>


              <tbody class="table-body">
                <tr *ngFor="let item of displayedData; trackBy: trackByServiceCallId" 
                    class="table-row">
                  
                  <td class="call-number-cell">
                    <a class="call-link" (click)="navigateToServiceCall(item.serviceCallId, item.technician)" 
                       [title]="'View parts for service call ' + item.serviceCallId + ' - Technician: ' + item.technician"
                       role="button">
                      {{ item.serviceCallId }}
                      <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                    </a>
                  </td>
                  
                  <td class="data-cell">
                    <span class="cell-content">{{ item.partNum }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="cell-content">{{ item.dcPartNum }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="cell-content">{{ item.description }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-primary">{{ item.totalQty }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-danger">{{ item.faultyParts }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-warning">{{ item.unusedParts }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <div class="technician-info">
                      <i class="bi bi-person-badge me-1 text-muted"></i>
                      <a class="technician-link" (click)="navigateToTechnicianJobs(item.serviceCallId, item.technician)"
                         [title]="'View parts for technician ' + item.technician + ' - Call: ' + item.serviceCallId"
                         role="button">
                        {{ item.technician }}
                        <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                      </a>
                    </div>
                  </td>
                  
                  <td class="date-cell">
                    <span class="date-content">{{ item.lastModified | date:'dd-MMM-yyyy HH:mm' }}</span>
                  </td>

                </tr>
              </tbody>

            </table>
          </div>
        </div>


        <!-- Weekly Parts Return Data Table (Legacy: dgWeekReturns table) -->
        <div class="table-section" *ngIf="!isLoading && showWeeklyDataGrid">
          <!-- Only show table when there's actual weekly data -->
          <div class="table-responsive" *ngIf="!isLoadingWeeklyData && partsReturnDataByWeekNo.length > 0">
            <table class="table modern-table weekly-data-table">
              <thead class="table-header">
                <tr>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Service Call ID</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Unused Sent Back</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Faulty Sent Back</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Return Status</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Return Notes</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Truck Stock</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Technician</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Maint Auth ID</span>
                    </div>
                  </th>
                  <th class="header-cell">
                    <div class="header-content">
                      <span class="header-text">Last Modified</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody class="table-body">
                <tr *ngFor="let item of partsReturnDataByWeekNo; trackBy: trackByWeeklyServiceCallId" 
                    class="table-row">
                  
                  <td class="call-number-cell">
                    <a class="call-link" (click)="navigateToServiceCall(item.serviceCallId, item.techName)" 
                       [title]="'View parts for service call ' + item.serviceCallId + ' - Technician: ' + item.techName"
                       role="button">
                      {{ item.serviceCallId }}
                      <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                    </a>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-success">{{ item.unusedSentBack }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-danger">{{ item.faultySentBack }}</span>
                  </td>
                  
                  <td class="status-cell">
                    <span class="status-badge" [ngClass]="getReturnStatusBadgeClass(item.returnStatus)">
                      {{ item.returnStatus }}
                    </span>
                  </td>
                  
                  <td class="notes-cell">
                    <div class="notes-content" [title]="item.returnNotes || 'No notes available'">
                      <span class="notes-text" [class.has-notes]="item.returnNotes && item.returnNotes.length > 0">
                        <ng-container *ngIf="item.returnNotes && item.returnNotes.length > 0; else noNotes">
                          {{ item.returnNotes }}
                        </ng-container>
                        <ng-template #noNotes>
                          <span class="text-muted fst-italic">No notes</span>
                        </ng-template>
                      </span>
                    </div>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-info">{{ item.truckStock }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <div class="technician-info">
                      <i class="bi bi-person-badge me-1 text-muted"></i>
                      <a class="technician-link" (click)="navigateToTechnicianJobs(item.serviceCallId, item.techName)"
                         [title]="'View parts for technician ' + item.techName + ' - Call: ' + item.serviceCallId"
                         role="button">
                        {{ item.techName }}
                        <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                      </a>
                    </div>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-secondary">{{ item.maintAuthId }}</span>
                  </td>
                  
                  <td class="date-cell">
                    <span class="date-content">{{ item.lastModified | date:'dd-MMM-yyyy HH:mm' }}</span>
                  </td>

                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Weekly Data Loading -->
          <div *ngIf="isLoadingWeeklyData" class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
            <span class="text-muted">Loading weekly data...</span>
          </div>
          
          <!-- Weekly Data Error -->
          <div *ngIf="weeklyDataErrorMessage && !isLoadingWeeklyData" class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ weeklyDataErrorMessage }}
          </div>
          
          <!-- Empty Weekly Data - No Rows Found (show immediately when no data) -->
          <div *ngIf="!isLoadingWeeklyData && !weeklyDataErrorMessage && partsReturnDataByWeekNo.length === 0" class="empty-state">
            <div class="empty-state-content">
              <i class="bi bi-calendar-x empty-icon"></i>
              <h4 class="empty-title">No Rows Found</h4>
              <p class="empty-text">No parts return data found for week {{ selectedWeekNo }}.</p>
              <button class="btn btn-primary" (click)="showWeeklyDataGrid = false">
                <i class="bi bi-arrow-left me-2"></i>Back to Main View
              </button>
            </div>
          </div>
        </div>

        <!-- Enhanced Pagination Controls - Below Table -->
        <div class="enhanced-pagination-wrapper" *ngIf="totalRecords > 0 && !showWeeklyDataGrid">
          <div class="enhanced-pagination-controls">
            <div class="row align-items-center g-3">
              <!-- Left side - Page size and record info -->
              <div class="col-md-6">
                <div class="pagination-info">
                  <div class="d-flex align-items-center gap-3 flex-wrap">
                    <div class="page-size-selector">
                      <label class="form-label mb-0 fw-semibold">Records per page:</label>
                      <select class="form-select form-select-lg" 
                              [value]="pageSize" #pageSizeSelect (change)="onPageSizeChange(+pageSizeSelect.value)">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                      </select>
                    </div>
                    <div class="record-info">
                      <span class="badge badge-info-custom">
                        <i class="bi bi-list-ol me-1"></i>
                        Showing {{startRecord}}-{{endRecord}} of {{totalRecords}} records
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Right side - Navigation controls -->
              <div class="col-md-6">
                <div class="pagination-navigation">
                  <div class="d-flex justify-content-end align-items-center gap-2">
                    <!-- First page -->
                    <button class="btn btn-pagination btn-first" 
                            [disabled]="currentPage === 1" 
                            (click)="onPageChange(1)"
                            title="First page">
                      <i class="bi bi-chevron-double-left"></i>
                    </button>
                    
                    <!-- Previous page -->
                    <button class="btn btn-pagination btn-prev" 
                            [disabled]="currentPage === 1" 
                            (click)="onPageChange(currentPage - 1)"
                            title="Previous page">
                      <i class="bi bi-chevron-left"></i>
                      <span class="d-none d-sm-inline">Previous</span>
                    </button>
                    
                    <!-- Current page indicator -->
                    <div class="current-page-indicator">
                      <span class="page-display">
                        Page <strong>{{currentPage}}</strong> of <strong>{{totalPages}}</strong>
                      </span>
                    </div>
                    
                    <!-- Next page -->
                    <button class="btn btn-pagination btn-next" 
                            [disabled]="currentPage === totalPages" 
                            (click)="onPageChange(currentPage + 1)"
                            title="Next page">
                      <span class="d-none d-sm-inline">Next</span>
                      <i class="bi bi-chevron-right"></i>
                    </button>
                    
                    <!-- Last page -->
                    <button class="btn btn-pagination btn-last" 
                            [disabled]="currentPage === totalPages" 
                            (click)="onPageChange(totalPages)"
                            title="Last page">
                      <i class="bi bi-chevron-double-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State for Main Grid -->
        <div *ngIf="totalRecords === 0 && !isLoading && !showWeeklyDataGrid" class="empty-state">
          <div class="empty-state-content">
            <i class="bi bi-inbox empty-icon"></i>
            <h4 class="empty-title">No Parts Return Data Found</h4>
            <p class="empty-text">There are no parts return records matching your current filters.</p>
            <button class="btn btn-primary" (click)="clearFilters()">
              <i class="bi bi-funnel-fill me-2"></i>Clear Filters
            </button>
          </div>
        </div>


      </div>
    </div>
  </div>
</div>
