<!--begin::Content-->
<div class="container-fluid" id="kt_content_container">
  
  <!--begin::Page title-->
  <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
    <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
      Parts Return Status Report
    </h1>
    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
      <li class="breadcrumb-item text-muted">
        <a routerLink="/dashboard" class="text-muted text-hover-primary">Home</a>
      </li>
      <li class="breadcrumb-item">
        <span class="bullet bg-gray-400 w-5px h-2px"></span>
      </li>
      <li class="breadcrumb-item text-muted">Reports</li>
      <li class="breadcrumb-item">
        <span class="bullet bg-gray-400 w-5px h-2px"></span>
      </li>
      <li class="breadcrumb-item text-dark">Parts Return Status</li>
    </ul>
  </div>
  <!--end::Page title-->

  <!--begin::Charts Row-->
  <div class="row g-5 mb-5">
    <!--begin::Parts to be Received Chart Column-->
    <div class="col-xl-6">
      <!--begin::Parts to be Received Chart-->
      <div class="card h-100 chart-section" *ngIf="showChart || isLoadingChart || chartErrorMessage">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-5">
      <h3 class="card-title align-items-start flex-column">
        <span class="card-label fw-bold fs-3 mb-1">Parts to be Received by Warehouse</span>
        <span class="text-muted fs-7">Monthly breakdown for {{ partReturnFilterForm.get('year')?.value }}</span>
      </h3>

    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body" *ngIf="showChart">
      
      <!--begin::Chart loading indicator-->
      <div *ngIf="isLoadingChart" class="d-flex justify-content-center py-10 chart-loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading chart...</span>
        </div>
      </div>
      <!--end::Chart loading indicator-->

      <!--begin::Chart error message-->
      <div *ngIf="chartErrorMessage && !isLoadingChart" class="alert alert-warning d-flex align-items-center p-5 mb-10">
        <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4">
          <span class="path1"></span>
          <span class="path2"></span>
          <span class="path3"></span>
        </i>
        <div class="d-flex flex-column">
          <h4 class="mb-1 text-warning">Chart Data Unavailable</h4>
          <span>{{ chartErrorMessage }}</span>
        </div>
      </div>
      <!--end::Chart error message-->

      <!--begin::Chart content-->
      <div *ngIf="!isLoadingChart && chartData.length > 0">
        
        <!--begin::Chart totals-->
        <div class="row g-6 g-xl-9 mb-6 chart-totals">
          <div class="col-lg-6 col-xxl-6">
            <div class="card bg-light-primary border-primary">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-primary">
                      <i class="ki-duotone ki-package fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="fw-bold fs-6 text-gray-800">Total Unused Parts</span>
                    <span class="fw-bold fs-3 text-primary">{{ chartTotals.unUsedTR }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-xxl-6">
            <div class="card bg-light-danger border-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-danger">
                      <i class="ki-duotone ki-cross-circle fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="fw-bold fs-6 text-gray-800">Total Faulty Parts</span>
                    <span class="fw-bold fs-3 text-danger">{{ chartTotals.faultyTR }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Chart totals-->

        <!--begin::Chart visualization-->
        <div class="chart-container">
          <!-- Chart Type Selector -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-gray-800 fw-bold mb-0">Data Visualization</h4>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="chartType" id="barChart" checked (change)="setChartType('bar')">
              <label class="btn btn-outline-primary btn-sm" for="barChart">
                <i class="ki-duotone ki-chart-simple fs-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                  <span class="path4"></span>
                </i>
                Bar Chart
              </label>
              
              <input type="radio" class="btn-check" name="chartType" id="pieChart" (change)="setChartType('pie')">
              <label class="btn btn-outline-primary btn-sm" for="pieChart">
                <i class="ki-duotone ki-chart-pie-simple fs-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                Pie Chart
              </label>
              
              <input type="radio" class="btn-check" name="chartType" id="dataTable" (change)="setChartType('table')">
              <label class="btn btn-outline-primary btn-sm" for="dataTable">
                <i class="ki-duotone ki-row-horizontal fs-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                Table
              </label>
            </div>
          </div>

          <!-- Bar Chart -->
          <div *ngIf="currentChartType === 'bar'" class="chart-wrapper">
            <div class="bar-chart">
              <div class="chart-grid">
                <canvas #barChartCanvas 
                        class="chart-canvas" 
                        width="800" 
                        height="400">
                </canvas>
                <div class="chart-legend mt-4">
                  <div class="d-flex justify-content-center flex-wrap gap-4">
                    <div class="legend-item d-flex align-items-center">
                      <div class="legend-color bg-primary me-2"></div>
                      <span class="fs-7 text-muted">Jobs Count</span>
                    </div>
                    <div class="legend-item d-flex align-items-center">
                      <div class="legend-color bg-danger me-2"></div>
                      <span class="fs-7 text-muted">Faulty Parts</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pie Chart -->
          <div *ngIf="currentChartType === 'pie'" class="chart-wrapper">
            <div class="pie-chart d-flex justify-content-center">
              <div class="pie-container">
                <canvas #pieChartCanvas 
                        class="chart-canvas" 
                        width="400" 
                        height="400">
                </canvas>
                <div class="chart-legend mt-4">
                  <div class="row">
                    <div class="col-md-6" *ngFor="let item of chartData; let i = index">
                      <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-color me-2" [style.background-color]="getChartColor(i)"></div>
                        <span class="fs-7 text-gray-800 fw-semibold">{{ item.name }}</span>
                        <span class="ms-auto fs-7 text-muted">({{ item.jobsCount }} jobs)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Table -->
          <div *ngIf="currentChartType === 'table'" class="table-responsive chart-table">
            <table class="table table-rounded table-striped border gy-7 gs-7">
              <thead>
                <tr class="fw-semibold fs-6 text-gray-800 border-bottom-2 border-gray-200">
                  <th class="min-w-200px">Period</th>
                  <th class="min-w-100px text-center">Jobs Count</th>
                  <th class="min-w-100px text-center">Faulty Parts</th>
                  <th class="min-w-100px text-center">Job %</th>
                  <th class="min-w-200px">Progress Bar</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of chartData" class="align-middle">
                  <td>
                    <span class="text-gray-800 fw-bold d-block fs-6">{{ item.name }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-light-primary fs-7 fw-semibold">{{ item.jobsCount }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-light-danger fs-7 fw-semibold" 
                          [class.badge-danger]="item.faulty > 0">
                      {{ item.faulty }}
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="text-muted fw-semibold">{{ getChartItemPercentage(item) }}%</span>
                  </td>
                  <td>
                    <div class="progress h-6px w-100">
                      <div class="progress-bar bg-primary" 
                           role="progressbar" 
                           [style.width.%]="getChartItemPercentage(item)"
                           [attr.aria-valuenow]="item.jobsCount"
                           [attr.aria-valuemin]="0"
                           [attr.aria-valuemax]="getTotalChartJobs()">
                      </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <span class="fs-8 text-muted">{{ item.jobsCount }} jobs</span>
                      <span class="fs-8 text-danger" *ngIf="item.faulty > 0">{{ item.faulty }} faulty</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!--end::Chart visualization-->

      </div>
      <!--end::Chart content-->

      </div>
      <!--end::Card body-->
      </div>
      <!--end::Parts to be Received Chart-->
    </div>
    <!--end::Parts to be Received Chart Column-->

    <!--begin::Weekly Parts Returned Count Chart Column-->
    <div class="col-xl-6">
      <!--begin::Weekly Parts Returned Count Chart-->
        <div class="card h-100 chart-section" *ngIf="showWeeklyChart || isLoadingWeeklyChart || weeklyChartErrorMessage">
        <!--begin::Card header-->
    <div class="card-header border-0 pt-5">
      <h3 class="card-title align-items-start flex-column">
        <span class="card-label fw-bold fs-3 mb-1">Weekly Parts Returned Count</span>
        <span class="text-muted fs-7">Weekly breakdown of unused and faulty parts returned</span>
      </h3>
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body" *ngIf="showWeeklyChart">
      
      <!--begin::Chart loading indicator-->
      <div *ngIf="isLoadingWeeklyChart" class="d-flex justify-content-center py-10 chart-loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading weekly chart...</span>
        </div>
      </div>
      <!--end::Chart loading indicator-->

      <!--begin::Chart error message-->
      <div *ngIf="weeklyChartErrorMessage && !isLoadingWeeklyChart" class="alert alert-warning d-flex align-items-center p-5 mb-10">
        <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4">
          <span class="path1"></span>
          <span class="path2"></span>
          <span class="path3"></span>
        </i>
        <div class="d-flex flex-column">
          <h4 class="mb-1 text-warning">Weekly Chart Data Unavailable</h4>
          <span>{{ weeklyChartErrorMessage }}</span>
        </div>
      </div>
      <!--end::Chart error message-->

      <!--begin::Chart content-->
      <div *ngIf="!isLoadingWeeklyChart && weeklyPartsData.length > 0">
        
        <!--begin::Chart totals-->
        <div class="row g-6 g-xl-9 mb-6 chart-totals">
          <div class="col-lg-4 col-xxl-4">
            <div class="card bg-light-primary border-primary">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-primary">
                      <i class="ki-duotone ki-package fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="fw-bold fs-6 text-gray-800">Total Unused</span>
                    <span class="fw-bold fs-3 text-primary">{{ getTotalWeeklyUnused() }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-xxl-4">
            <div class="card bg-light-danger border-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-danger">
                      <i class="ki-duotone ki-cross-circle fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="fw-bold fs-6 text-gray-800">Total Faulty</span>
                    <span class="fw-bold fs-3 text-danger">{{ getTotalWeeklyFaulty() }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-xxl-4">
            <div class="card bg-light-success border-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-success">
                      <i class="ki-duotone ki-abstract-27 fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="fw-bold fs-6 text-gray-800">Total Returned</span>
                    <span class="fw-bold fs-3 text-success">{{ getTotalWeeklyParts() }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Chart totals-->

        <!--begin::Chart visualization-->
        <div class="chart-container">
          <!-- Chart Type Selector -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-gray-800 fw-bold mb-0">Weekly Parts Data Visualization</h4>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="weeklyChartType" id="weeklyBarChart" checked (change)="setWeeklyChartType('bar')">
              <label class="btn btn-outline-primary btn-sm" for="weeklyBarChart">
                <i class="ki-duotone ki-chart-simple fs-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                  <span class="path4"></span>
                </i>
                Bar Chart
              </label>
              
              <input type="radio" class="btn-check" name="weeklyChartType" id="weeklyLineChart" (change)="setWeeklyChartType('line')">
              <label class="btn btn-outline-primary btn-sm" for="weeklyLineChart">
                <i class="ki-duotone ki-chart-line-up fs-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                Line Chart
              </label>
              
              <input type="radio" class="btn-check" name="weeklyChartType" id="weeklyDataTable" (change)="setWeeklyChartType('table')">
              <label class="btn btn-outline-primary btn-sm" for="weeklyDataTable">
                <i class="ki-duotone ki-row-horizontal fs-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                Table
              </label>
            </div>
          </div>

          <!-- Bar Chart -->
          <div *ngIf="currentWeeklyChartType === 'bar'" class="chart-wrapper">
            <div class="bar-chart">
              <div class="chart-grid">
                <canvas #weeklyBarChartCanvas 
                        class="chart-canvas" 
                        width="800" 
                        height="400">
                </canvas>
                <div class="chart-legend mt-4">
                  <div class="d-flex justify-content-center flex-wrap gap-4">
                    <div class="legend-item d-flex align-items-center">
                      <div class="legend-color bg-primary me-2"></div>
                      <span class="fs-7 text-muted">Unused Parts</span>
                    </div>
                    <div class="legend-item d-flex align-items-center">
                      <div class="legend-color bg-danger me-2"></div>
                      <span class="fs-7 text-muted">Faulty Parts</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Line Chart -->
          <div *ngIf="currentWeeklyChartType === 'line'" class="chart-wrapper">
            <div class="line-chart d-flex justify-content-center">
              <div class="line-container">
                <canvas #weeklyLineChartCanvas 
                        class="chart-canvas" 
                        width="800" 
                        height="400">
                </canvas>
                <div class="chart-legend mt-4">
                  <div class="d-flex justify-content-center flex-wrap gap-4">
                    <div class="legend-item d-flex align-items-center">
                      <div class="legend-color bg-primary me-2"></div>
                      <span class="fs-7 text-muted">Unused Parts Trend</span>
                    </div>
                    <div class="legend-item d-flex align-items-center">
                      <div class="legend-color bg-danger me-2"></div>
                      <span class="fs-7 text-muted">Faulty Parts Trend</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Table -->
          <div *ngIf="currentWeeklyChartType === 'table'" class="table-responsive chart-table">
            <table class="table table-rounded table-striped border gy-7 gs-7">
              <thead>
                <tr class="fw-semibold fs-6 text-gray-800 border-bottom-2 border-gray-200">
                  <th class="min-w-100px">Week End</th>
                  <th class="min-w-80px text-center">Week No</th>
                  <th class="min-w-100px text-center">Unused Parts</th>
                  <th class="min-w-100px text-center">Faulty Parts</th>
                  <th class="min-w-100px text-center">Total</th>
                  <th class="min-w-100px text-center">Week %</th>
                  <th class="min-w-200px">Progress Bar</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of weeklyPartsData" class="align-middle">
                  <td>
                    <span class="text-gray-800 fw-bold d-block fs-6">{{ item.wkEnd }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-light-info fs-7 fw-semibold">{{ item.weekNo }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-light-primary fs-7 fw-semibold">{{ item.unUsed }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-light-danger fs-7 fw-semibold" 
                          [class.badge-danger]="item.faulty > 0">
                      {{ item.faulty }}
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-light-success fs-7 fw-semibold">{{ item.unUsed + item.faulty }}</span>
                  </td>
                  <td class="text-center">
                    <span class="text-muted fw-semibold">{{ getWeeklyItemPercentage(item) }}%</span>
                  </td>
                  <td>
                    <div class="progress h-6px w-100">
                      <div class="progress-bar bg-primary" 
                           role="progressbar" 
                           [style.width.%]="(item.unUsed / getTotalWeeklyUnused()) * 100"
                           [attr.aria-valuenow]="item.unUsed"
                           [attr.aria-valuemin]="0"
                           [attr.aria-valuemax]="getTotalWeeklyUnused()">
                      </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <span class="fs-8 text-muted">{{ item.unUsed }} unused</span>
                      <span class="fs-8 text-danger" *ngIf="item.faulty > 0">{{ item.faulty }} faulty</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!--end::Chart visualization-->

      </div>
      <!--end::Chart content-->

    </div>
    <!--end::Card body-->
      </div>
      <!--end::Weekly Parts Returned Count Chart-->
    </div>
    <!--end::Weekly Parts Returned Count Chart Column-->
  </div>
  <!--end::Charts Row-->

  <!--begin::Parts Received by Warehouse Chart-->
  <div class="card mb-5">
    <app-parts-received-wh-chart
      chartHeight="280px">
    </app-parts-received-wh-chart>
  </div>
  <!--end::Parts Received by Warehouse Chart-->

  <!--begin::Parts Return Data by Week Number Section-->
  <div class="card mb-5" *ngIf="showWeeklyData || isLoadingWeeklyData || weeklyDataErrorMessage">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-5">
      <h3 class="card-title align-items-start flex-column">
        <span class="card-label fw-bold fs-3 mb-1">Parts Return Data - Week {{ partReturnFilterForm.get('weekNo')?.value }}</span>
        <span class="text-muted fs-7">Detailed return data for selected week</span>
      </h3>

    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body" *ngIf="showWeeklyData">
      
      <!--begin::Weekly data loading indicator-->
      <div *ngIf="isLoadingWeeklyData" class="d-flex justify-content-center py-10">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading weekly data...</span>
        </div>
      </div>
      <!--end::Weekly data loading indicator-->

      <!--begin::Weekly data error message-->
      <div *ngIf="weeklyDataErrorMessage && !isLoadingWeeklyData" class="alert alert-warning d-flex align-items-center p-5 mb-10">
        <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4">
          <span class="path1"></span>
          <span class="path2"></span>
          <span class="path3"></span>
        </i>
        <div class="d-flex flex-column">
          <h4 class="mb-1 text-warning">Weekly Data Unavailable</h4>
          <span>{{ weeklyDataErrorMessage }}</span>
        </div>
      </div>
      <!--end::Weekly data error message-->

      <!--begin::Weekly data content-->
      <div *ngIf="!isLoadingWeeklyData && partsReturnDataByWeekNo.length > 0">
        
        <!--begin::Weekly data summary-->
        <div class="row g-6 g-xl-9 mb-6">
          <div class="col-lg-3 col-xxl-3">
            <div class="card bg-light-primary border-primary">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-primary">
                      <i class="ki-duotone ki-package fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <div class="fw-semibold fs-6 text-gray-800 d-block lh-1">Total Returns</div>
                    <div class="fw-semibold fs-3 text-primary">{{ getTotalReturnsByWeek() }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-xxl-3">
            <div class="card bg-light-success border-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-success">
                      <i class="ki-duotone ki-check-circle fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <div class="fw-semibold fs-6 text-gray-800 d-block lh-1">Unused Parts</div>
                    <div class="fw-semibold fs-3 text-success">{{ getTotalUnusedByWeek() }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-xxl-3">
            <div class="card bg-light-danger border-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-danger">
                      <i class="ki-duotone ki-cross-circle fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <div class="fw-semibold fs-6 text-gray-800 d-block lh-1">Faulty Parts</div>
                    <div class="fw-semibold fs-3 text-danger">{{ getTotalFaultyByWeek() }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-xxl-3">
            <div class="card bg-light-warning border-warning">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <span class="symbol-label bg-warning">
                      <i class="ki-duotone ki-truck fs-2 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                        <span class="path5"></span>
                      </i>
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <div class="fw-semibold fs-6 text-gray-800 d-block lh-1">Total Truck Stock</div>
                    <div class="fw-semibold fs-3 text-warning">{{ getTotalTruckStockByWeek() }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Weekly data summary-->

        <!--begin::Weekly data table-->
        <div class="table-responsive">
          <table class="table table-rounded table-striped border gy-7 gs-7">
            <thead>
              <tr class="fw-semibold fs-6 text-gray-800 border-bottom-2 border-gray-200">
                <th class="min-w-150px">Service Call ID</th>
                <th class="min-w-100px text-center">Unused Sent Back</th>
                <th class="min-w-100px text-center">Faulty Sent Back</th>
                <th class="min-w-120px text-center">Return Status</th>
                <th class="min-w-100px text-center">Truck Stock</th>
                <th class="min-w-150px">Technician</th>
                <th class="min-w-120px">Maint Auth ID</th>
                <th class="min-w-200px">Return Notes</th>
                <th class="min-w-120px text-center">Last Modified</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of partsReturnDataByWeekNo; trackBy: trackByWeeklyServiceCallId" class="align-middle">
                <td>
                  <a class="text-primary fw-bold text-hover-primary cursor-pointer" 
                     (click)="navigateToServiceCall(item.serviceCallId)">
                    {{ item.serviceCallId }}
                  </a>
                </td>
                <td class="text-center">
                  <span class="badge badge-light-success fs-7 fw-semibold">{{ item.unusedSentBack }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-light-danger fs-7 fw-semibold" 
                        [class.badge-danger]="item.faultySentBack > 0">
                    {{ item.faultySentBack }}
                  </span>
                </td>
                <td class="text-center">
                  <span [class]="getReturnStatusBadgeClass(item.returnStatus)">{{ item.returnStatus }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-light-warning fs-7 fw-semibold">{{ item.truckStock }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="symbol symbol-circle symbol-50px overflow-hidden me-3">
                      <div class="symbol-label fs-3 bg-light-primary text-primary">{{ getInitials(item.techName) }}</div>
                    </div>
                    <div class="d-flex flex-column">
                      <span class="text-gray-800 fw-bold text-hover-primary fs-6">{{ item.techName }}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="text-muted fw-semibold">{{ item.maintAuthId }}</span>
                </td>
                <td>
                  <div class="text-muted fw-semibold" [title]="item.returnNotes">
                    {{ item.returnNotes | slice:0:50 }}{{ item.returnNotes && item.returnNotes.length > 50 ? '...' : '' }}
                  </div>
                </td>
                <td class="text-center">
                  <span class="text-muted fw-semibold">
                    {{ item.lastModified | date:'short' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!--end::Weekly data table-->
        
      </div>
      <!--end::Weekly data content-->
      
    </div>
    <!--end::Card body-->
  </div>
  <!--end::Parts Return Data by Week Number Section-->

  <!--begin::Card-->
  <div class="card">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-6">
      <div class="card-title">
        <div class="d-flex align-items-center position-relative my-1">
          <i class="ki-duotone ki-magnifier fs-1 position-absolute ms-6">
            <span class="path1"></span>
            <span class="path2"></span>
          </i>
          <input type="text" 
                 class="form-control form-control-solid w-250px ps-14" 
                 placeholder="Search parts..." 
                 #searchInput
                 (keyup)="applyFilter(searchInput.value)">
        </div>
      </div>
      
      <!--begin::Card toolbar-->
      <div class="card-toolbar">
        <!--begin::Filters-->
        <form [formGroup]="partReturnFilterForm" class="d-flex align-items-center gap-3 flex-wrap">
          
          <!--begin::Inventory User Filter-->
          <div class="form-group">
            <label class="form-label fw-semibold fs-7 text-gray-600">Inventory User:</label>
            <select class="form-select form-select-solid" 
                    formControlName="inventoryUser"
                    [disabled]="isLoadingInventoryUsers"
                    (change)="onInventoryUserChange($event)">
              <option *ngFor="let user of inventoryUsers; trackBy: trackByUserId" 
                      [value]="getInventoryUserValue(user)">
                {{ getInventoryUserDisplayName(user) }}
              </option>
            </select>
            <div *ngIf="isLoadingInventoryUsers" class="spinner-border spinner-border-sm ms-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          
          <!--begin::Status Filter-->
          <div class="form-group">
            <label class="form-label fw-semibold fs-7 text-gray-600">Status:</label>
            <select class="form-select form-select-solid" formControlName="status">
              <option *ngFor="let option of statusOptions" [value]="option.key">
                {{ option.label }}
              </option>
            </select>
          </div>
          
          <!--begin::Year Filter-->
          <div class="form-group">
            <label class="form-label fw-semibold fs-7 text-gray-600">Year:</label>
            <select class="form-select form-select-solid" formControlName="year">
              <option *ngFor="let year of availableYears" [value]="year">
                {{ year }}
              </option>
            </select>
          </div>
          
          <!--begin::Week Number Filter-->
          <div class="form-group">
            <label class="form-label fw-semibold fs-7 text-gray-600">Week Number:</label>
            <select class="form-select form-select-solid" 
                    formControlName="weekNo"
                    (change)="onWeekNumberChange()">
              <option *ngFor="let week of getAvailableWeeks()" [value]="week">
                Week {{ week }}
              </option>
            </select>
          </div>
          

        </form>
        <!--end::Filters-->
      </div>
      <!--end::Card toolbar-->
    </div>
    <!--end::Card header-->

    <!--begin::Summary Cards-->
    <div class="card-body pt-0">
      <div class="row g-6 g-xl-9 mb-6">
        <!--begin::Col-->
        <div class="col-lg-3 col-xxl-3">
          <div class="card bg-light-success border-success">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-40px me-3">
                  <span class="symbol-label bg-success">
                    <i class="ki-duotone ki-check-circle fs-2 text-white">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                  </span>
                </div>
                <div class="d-flex flex-column">
                  <span class="fw-bold fs-6 text-gray-800">Returned</span>
                  <span class="fw-bold fs-3 text-success">{{ getStatusCount('returned') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Col-->

        <!--begin::Col-->
        <div class="col-lg-3 col-xxl-3">
          <div class="card bg-light-secondary border-secondary">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-40px me-3">
                  <span class="symbol-label bg-secondary">
                    <i class="ki-duotone ki-cross-circle fs-2 text-white">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                  </span>
                </div>
                <div class="d-flex flex-column">
                  <span class="fw-bold fs-6 text-gray-800">Not Returned</span>
                  <span class="fw-bold fs-3 text-secondary">{{ getStatusCount('not-returned') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Col-->

        <!--begin::Col-->
        <div class="col-lg-3 col-xxl-3">
          <div class="card bg-light-warning border-warning">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-40px me-3">
                  <span class="symbol-label bg-warning">
                    <i class="ki-duotone ki-time fs-2 text-white">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                  </span>
                </div>
                <div class="d-flex flex-column">
                  <span class="fw-bold fs-6 text-gray-800">In Progress</span>
                  <span class="fw-bold fs-3 text-warning">{{ getStatusCount('in-progress') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Col-->

        <!--begin::Col-->
        <div class="col-lg-3 col-xxl-3">
          <div class="card bg-light-danger border-danger">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-40px me-3">
                  <span class="symbol-label bg-danger">
                    <i class="ki-duotone ki-clock fs-2 text-white">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                  </span>
                </div>
                <div class="d-flex flex-column">
                  <span class="fw-bold fs-6 text-gray-800">Pending</span>
                  <span class="fw-bold fs-3 text-danger">{{ getStatusCount('pending') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--end::Col-->
      </div>
    </div>
    <!--end::Summary Cards-->

    <!--begin::Card body-->
    <div class="card-body py-4">
      
      <!--begin::Loading indicator-->
      <div *ngIf="isLoading" class="d-flex justify-content-center py-10">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <!--end::Loading indicator-->

      <!--begin::Error message-->
      <div *ngIf="errorMessage && !isLoading" class="alert alert-danger d-flex align-items-center p-5 mb-10">
        <i class="ki-duotone ki-shield-tick fs-2hx text-danger me-4">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        <div class="d-flex flex-column">
          <h4 class="mb-1 text-danger">Error</h4>
          <span>{{ errorMessage }}</span>
        </div>
      </div>
      <!--end::Error message-->

      <!--begin::Filter Badge-->
      <div *ngIf="!isLoading && partReturnStatusList.length > 0" class="d-flex justify-content-between align-items-center mb-5">
        <div class="d-flex align-items-center gap-3">
          <span class="fw-bold fs-6 text-gray-800">Current Filter:</span>
          <span [class]="getFilterBadgeClass()">{{ getSelectedStatusLabel() }}</span>
          <span class="text-muted fs-7">({{ totalRecords }} records)</span>
        </div>
        
        <div class="d-flex align-items-center gap-3">
          <span class="text-muted fs-7">Showing {{ startRecord }} - {{ endRecord }} of {{ totalRecords }} records</span>
          <select class="form-select form-select-sm w-auto" (change)="onPageSizeChange($any($event.target).value)">
            <option value="25" [selected]="pageSize === 25">25 per page</option>
            <option value="50" [selected]="pageSize === 50">50 per page</option>
            <option value="100" [selected]="pageSize === 100">100 per page</option>
            <option value="200" [selected]="pageSize === 200">200 per page</option>
          </select>
        </div>
      </div>
      <!--end::Filter Badge-->

      <!--begin::Table-->
      <div *ngIf="!isLoading && partReturnStatusList.length > 0" class="table-responsive">
        <table class="table table-rounded table-striped border gy-7 gs-7">
          <thead>
            <tr class="fw-semibold fs-6 text-gray-800 border-bottom-2 border-gray-200">
              <th class="min-w-150px cursor-pointer" (click)="sortTable('serviceCallId')">
                <div class="d-flex align-items-center">
                  Service Call ID
                  <i [class]="'ki-duotone ' + sortIcon('serviceCallId') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-125px cursor-pointer" (click)="sortTable('partNum')">
                <div class="d-flex align-items-center">
                  Part Number
                  <i [class]="'ki-duotone ' + sortIcon('partNum') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-125px cursor-pointer" (click)="sortTable('dcPartNum')">
                <div class="d-flex align-items-center">
                  DC Part Number
                  <i [class]="'ki-duotone ' + sortIcon('dcPartNum') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-200px cursor-pointer" (click)="sortTable('description')">
                <div class="d-flex align-items-center">
                  Description
                  <i [class]="'ki-duotone ' + sortIcon('description') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-100px cursor-pointer text-center" (click)="sortTable('totalQty')">
                <div class="d-flex align-items-center justify-content-center">
                  Total Qty
                  <i [class]="'ki-duotone ' + sortIcon('totalQty') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-100px cursor-pointer text-center" (click)="sortTable('faultyParts')">
                <div class="d-flex align-items-center justify-content-center">
                  Faulty
                  <i [class]="'ki-duotone ' + sortIcon('faultyParts') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-100px cursor-pointer text-center" (click)="sortTable('unusedParts')">
                <div class="d-flex align-items-center justify-content-center">
                  Unused
                  <i [class]="'ki-duotone ' + sortIcon('unusedParts') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-150px cursor-pointer" (click)="sortTable('technician')">
                <div class="d-flex align-items-center">
                  Technician
                  <i [class]="'ki-duotone ' + sortIcon('technician') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-125px cursor-pointer" (click)="sortTable('invUserID')">
                <div class="d-flex align-items-center">
                  Inv User
                  <i [class]="'ki-duotone ' + sortIcon('invUserID') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-125px cursor-pointer" (click)="sortTable('status')">
                <div class="d-flex align-items-center">
                  Status
                  <i [class]="'ki-duotone ' + sortIcon('status') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-150px cursor-pointer" (click)="sortTable('lastModified')">
                <div class="d-flex align-items-center">
                  Last Modified
                  <i [class]="'ki-duotone ' + sortIcon('lastModified') + ' fs-5 ms-1 text-gray-400'">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </div>
              </th>
              <th class="min-w-100px text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of displayedData; trackBy: trackByServiceCallId" 
                class="align-middle">
              <td>
                <a href="javascript:void(0)" 
                   class="text-dark fw-bold text-hover-primary d-block mb-1 fs-6"
                   (click)="navigateToServiceCall(item.serviceCallId)">
                  {{ item.serviceCallId }}
                </a>
              </td>
              <td>
                <span class="text-gray-800 fw-bold d-block fs-6">{{ item.partNum }}</span>
              </td>
              <td>
                <span class="text-gray-600 fw-semibold d-block fs-7">{{ item.dcPartNum }}</span>
              </td>
              <td>
                <div class="d-flex flex-column">
                  <span class="text-gray-800 fw-bold mb-1">{{ item.description }}</span>
                </div>
              </td>
              <td class="text-center">
                <span class="badge badge-light-primary fs-7 fw-semibold">{{ item.totalQty }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-light-danger fs-7 fw-semibold" 
                      [class.badge-danger]="item.faultyParts > 0">
                  {{ item.faultyParts }}
                </span>
              </td>
              <td class="text-center">
                <span class="badge badge-light-warning fs-7 fw-semibold"
                      [class.badge-warning]="item.unusedParts > 0">
                  {{ item.unusedParts }}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-35px symbol-circle me-3">
                    <span class="symbol-label bg-light-info text-info fw-bold">
                      {{ getInitials(item.technician) }}
                    </span>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="text-gray-800 fw-bold lh-1">{{ item.technician }}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge badge-light-info fs-7 fw-semibold">{{ item.invUserID }}</span>
              </td>
              <td>
                <span class="badge fs-7 fw-semibold" [ngClass]="getStatusBadgeClass(item.status)">
                  {{ getStatusDisplayName(item.status) }}
                </span>
              </td>
              <td>
                <span class="text-muted fw-semibold text-muted d-block fs-7">
                  {{ item.lastModified | date:'MM/dd/yyyy HH:mm' }}
                </span>
              </td>
              <td class="text-end">
                <button type="button" 
                        class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1"
                        (click)="navigateToServiceCall(item.serviceCallId)"
                        data-bs-toggle="tooltip"
                        title="View Service Call">
                  <i class="ki-duotone ki-eye fs-3">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                  </i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!--end::Table-->

      <!--begin::No Data-->
      <div *ngIf="!isLoading && partReturnStatusList.length === 0" class="d-flex flex-column flex-center">
        <img src="assets/media/illustrations/sketchy-1/5.png" alt="" class="mw-300px">
        <div class="fs-1 fw-bolder text-dark mb-4">No Data Found.</div>
        <div class="fs-6">No part return status records match your current filters.
          <br>Try adjusting your search criteria or clearing the filters.
        </div>
        <div class="text-center py-5">
          <button type="button" class="btn btn-primary" (click)="clearFilters()">
            Clear Filters
          </button>
        </div>
      </div>
      <!--end::No Data-->

      <!--begin::Pagination-->
      <div *ngIf="!isLoading && partReturnStatusList.length > 0 && totalPages > 1" 
           class="d-flex flex-stack flex-wrap pt-10">
        <div class="fs-6 fw-semibold text-gray-700">
          Showing {{ startRecord }} to {{ endRecord }} of {{ totalRecords }} entries
        </div>
        
        <ul class="pagination">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" href="javascript:void(0)" (click)="onPageChange(currentPage - 1)">
              <i class="previous"></i>
            </a>
          </li>
          
          <li *ngFor="let page of getPaginationPages()" 
              class="page-item" 
              [class.active]="page === currentPage"
              [class.disabled]="page === null">
            <a class="page-link" 
               href="javascript:void(0)" 
               (click)="page !== null && onPageChange(page)">
              {{ page === null ? '...' : page }}
            </a>
          </li>
          
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" href="javascript:void(0)" (click)="onPageChange(currentPage + 1)">
              <i class="next"></i>
            </a>
          </li>
        </ul>
      </div>
      <!--end::Pagination-->

    </div>
    <!--end::Card body-->
  </div>
  <!--end::Card-->
</div>
<!--end::Content-->