<!-- Parts Return Status Page -->
<div class="container-fluid parts-request-container">
  <!-- Loading spinner -->
  <div
    *ngIf="isLoading"
    class="d-flex justify-content-center align-items-center parts-request-loading"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Header Section -->
  <div class="parts-request-header__top mb-4 d-flex justify-content-between align-items-center">
    <button
      type="button"
      class="btn btn-sm btn-primary parts-request-header__back"
      (click)="goBack()"
      [disabled]="isLoading"
    >
      <i class="bi bi-arrow-left me-2"></i>
      Back
    </button>
    
    <!-- Page Title - Centered between buttons -->
    <div class="parts-page-title">
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-arrow-clockwise me-2"></i>
        Parts Return Status Report
      </h2>
      <!-- Filter Information -->
      <div class="text-dark mt-2" *ngIf="!isLoading">
        <span class="fw-semibold">Filtered by: {{ partReturnFilterForm.get('inventoryUser')?.value }}</span>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div *ngIf="!isLoading">

    <!--begin::Charts Section with Tabs-->
    <div class="card shadow-sm parts-main-card mb-4">
      <!-- Charts Header -->
      <div class="card-header border-0 py-4">
        <div class="parts-filter-header">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="mb-0 fw-bold text-dark">
                <i class="bi bi-bar-chart me-2 text-primary"></i>
                Parts Return Analytics
                <span class="badge ms-2 bg-primary">
                  Interactive Charts
                </span>
              </h5>
              <small class="text-muted">Analyze parts return data with visual representations</small>
            </div>
          </div>
        </div>
      </div>

      <!--begin::Card body-->
      <div class="card-body py-2">

        <!--begin::Tabs Navigation-->
        <div class="chart-tabs-wrapper mb-2">
          <ul class="nav nav-tabs modern-tabs">
            <li class="nav-item">
              <a class="nav-link" 
                 [class.active]="activeGraphTab === 'graph1'" 
                 (click)="setActiveGraphTab('graph1')">
                <i class="bi bi-bar-chart me-2"></i>
                Parts to be Received
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" 
                 [class.active]="activeGraphTab === 'graph2'" 
                 (click)="setActiveGraphTab('graph2')">
                <i class="bi bi-graph-up me-2"></i>
                Weekly Parts Returned
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" 
                 [class.active]="activeGraphTab === 'graph3'" 
                 (click)="setActiveGraphTab('graph3')">
                <i class="bi bi-pie-chart me-2"></i>
                Parts Received by Warehouse
              </a>
            </li>
          </ul>
        </div>
        <!--end::Tabs Navigation-->

          <!--begin::Tab Content-->
          <div class="tab-content">

            <!--begin::Graph 1 Tab-->
            <div class="tab-pane fade"
                 [class.show]="activeGraphTab === 'graph1'"
                 [class.active]="activeGraphTab === 'graph1'">

              <div class="row g-5">
                <div class="col-12">

                  <!--begin::Graph Section-->
                  <div class="chart-section" 
                      *ngIf="showChart || isLoadingChart || chartErrorMessage">

                    <!--begin::Card body-->
                    <div class="card-body" *ngIf="showChart">

                      <!-- Loading -->
                      <div *ngIf="isLoadingChart" 
                           class="d-flex justify-content-center py-10 chart-loading">
                        <div class="spinner-border text-primary"></div>
                      </div>

                      <!-- Error -->
                      <div *ngIf="chartErrorMessage && !isLoadingChart"
                           class="alert alert-warning d-flex align-items-center p-5 mb-10">
                        <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4"></i>
                        <div class="d-flex flex-column">
                          <h4 class="mb-1 text-warning">Chart Data Unavailable</h4>
                          <span>{{ chartErrorMessage }}</span>
                        </div>
                      </div>

                      <!-- Content -->
                      <div *ngIf="!isLoadingChart && chartData.length > 0">

                        <!-- Chart and Summary Layout -->
                        <div class="row g-4">
                          <!-- Chart Section - Left Side -->
                          <div class="col-lg-8">
                            <div class="chart-container">

                              <!-- Chart Type Selector -->
                              <div class="chart-selector-section">
                                <h4 class="chart-selector-title">Data Visualization</h4>

                                <div class="chart-type-controls">
                                  <input type="radio" class="btn-check" 
                                         name="chartType" id="barChart"
                                         checked (change)="setChartType('bar')">
                                  <label class="chart-type-btn" for="barChart">
                                    <i class="bi bi-bar-chart"></i>
                                    Bar Chart
                                  </label>

                                  <input type="radio" class="btn-check" 
                                         name="chartType" id="pieChart"
                                         (change)="setChartType('pie')">
                                  <label class="chart-type-btn" for="pieChart">
                                    <i class="bi bi-pie-chart"></i>
                                    Pie Chart
                                  </label>

                                  <input type="radio" class="btn-check" 
                                         name="chartType" id="dataTable"
                                         (change)="setChartType('table')">
                                  <label class="chart-type-btn" for="dataTable">
                                    <i class="bi bi-table"></i>
                                    Table
                                  </label>
                                </div>
                              </div>

                              <!-- Bar Chart -->
                              <div *ngIf="currentChartType === 'bar'" class="chart-wrapper">
                                <canvas #barChartCanvas class="chart-canvas" width="800" height="400"></canvas>
                              </div>

                              <!-- Pie Chart -->
                              <div *ngIf="currentChartType === 'pie'" class="chart-wrapper">
                                <canvas #pieChartCanvas class="chart-canvas" width="900" height="500"></canvas>
                                
                                <!-- Interactive Tooltip -->
                                <div class="pie-chart-tooltip" 
                                     [class.visible]="hoveredSliceIndex >= 0" 
                                     [style.left.px]="tooltipPosition.x" 
                                     [style.top.px]="tooltipPosition.y">
                                  <div *ngIf="chartData && hoveredSliceIndex >= 0 && chartData[hoveredSliceIndex]" class="tooltip-content">
                                    <div class="tooltip-header">
                                      <div class="tooltip-color-indicator" 
                                           [style.background]="getSliceColor(hoveredSliceIndex)"></div>
                                      <span class="tooltip-name">{{ chartData[hoveredSliceIndex].name }}</span>
                                    </div>
                                    <div class="tooltip-data">
                                      <div class="tooltip-row">
                                        <span class="tooltip-label">Jobs:</span>
                                        <span class="tooltip-value">{{ chartData[hoveredSliceIndex].jobsCount }}</span>
                                      </div>
                                      <div class="tooltip-row">
                                        <span class="tooltip-label">Percentage:</span>
                                        <span class="tooltip-value">{{ getChartItemPercentage(chartData[hoveredSliceIndex]) }}%</span>
                                      </div>
                                      <div class="tooltip-row" *ngIf="chartData && hoveredSliceIndex >= 0 && chartData[hoveredSliceIndex] && chartData[hoveredSliceIndex].faulty > 0">
                                        <span class="tooltip-label">Faulty:</span>
                                        <span class="tooltip-value text-danger">{{ chartData[hoveredSliceIndex].faulty }}</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Data Table -->
                              <div *ngIf="currentChartType === 'table'" class="modern-table-container">
                                <div class="table-wrapper">
                                  <table class="interactive-chart-table">
                                    <thead>
                                      <tr>
                                        <th class="user-col">
                                          <div class="header-content">
                                            <i class="bi bi-person-circle me-2"></i>
                                            <span>User</span>
                                          </div>
                                        </th>
                                        <th class="jobs-col">
                                          <div class="header-content">
                                            <i class="bi bi-briefcase me-2"></i>
                                            <span>Jobs Count</span>
                                          </div>
                                        </th>
                                        <th class="faulty-col">
                                          <div class="header-content">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <span>Faulty Parts</span>
                                          </div>
                                        </th>
                                        <th class="percentage-col">
                                          <div class="header-content">
                                            <i class="bi bi-percent me-2"></i>
                                            <span>Job %</span>
                                          </div>
                                        </th>
                                        <th class="progress-col">
                                          <div class="header-content">
                                            <i class="bi bi-bar-chart me-2"></i>
                                            <span>Progress</span>
                                          </div>
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr *ngFor="let item of chartData; let i = index" 
                                          class="table-row"
                                          (click)="onChartItemClick(item, 'parts-to-receive')"
                                          (mouseenter)="onRowHover(i, true)"
                                          (mouseleave)="onRowHover(i, false)"
                                          title="Click to view details for {{ item.name }}"
                                          [style.animation-delay.ms]="i * 100">
                                        <td class="user-cell">
                                          <div class="user-info">
                                            <div class="user-avatar">
                                              {{ getInitials(item.name) }}
                                            </div>
                                            <span class="user-name">{{ item.name }}</span>
                                          </div>
                                        </td>
                                        <td class="jobs-cell">
                                          <div class="metric-badge jobs-metric">
                                            <span class="metric-value">{{ item.jobsCount }}</span>
                                            <span class="metric-label">jobs</span>
                                          </div>
                                        </td>
                                        <td class="faulty-cell">
                                          <div class="metric-badge faulty-metric">
                                            <span class="metric-value">{{ item.faulty }}</span>
                                            <span class="metric-label">faulty</span>
                                          </div>
                                        </td>
                                        <td class="percentage-cell">
                                          <div class="percentage-display">
                                            <span class="percentage-value">{{ getChartItemPercentage(item) }}%</span>
                                            <div class="percentage-ring">
                                              <svg width="24" height="24" viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                                                <circle cx="12" cy="12" r="10" fill="none" stroke="#3b82f6" stroke-width="2" 
                                                        [style.stroke-dasharray]="'62.83'"
                                                        [style.stroke-dashoffset]="62.83 - (62.83 * getChartItemPercentage(item) / 100)"
                                                        transform="rotate(-90 12 12)"/>
                                              </svg>
                                            </div>
                                          </div>
                                        </td>
                                        <td class="progress-cell">
                                          <div class="animated-progress">
                                            <div class="progress-track">
                                              <div class="progress-fill" 
                                                   [style.width.%]="getChartItemPercentage(item)"
                                                   [style.animation-delay.ms]="i * 150 + 500">
                                                <div class="progress-glow"></div>
                                              </div>
                                            </div>
                                            <span class="progress-text">{{ getChartItemPercentage(item) }}%</span>
                                          </div>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </div>

                            </div>
                            <!--end::Chart Container-->
                          </div>

                          <!-- Summary Section - Right Side -->
                          <div class="col-lg-4">
                            <div class="parts-return-summary-sidebar">
                              <div class="summary-header mb-3">
                                <h5 class="summary-title">
                                  <i class="bi bi-graph-up-arrow me-2"></i>
                                  Parts Return Summary {{ partReturnFilterForm.get('year')?.value }}
                                </h5>
                                <p class="summary-subtitle">Current status overview</p>
                              </div>

                              <div class="summary-cards">
                                <!-- UnUsed To Be Returned -->
                                <div class="summary-card unused-to-return mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-clock-history"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">UnUsed To Be Returned</h6>
                                        <div class="summary-value">{{ chartTotals.unUsedTR || 0 }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Faulty To Be Returned -->
                                <div class="summary-card faulty-to-return mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-exclamation-triangle"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">Faulty To Be Returned</h6>
                                        <div class="summary-value">{{ chartTotals.faultyTR || 0 }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- UnUsed Returned -->
                                <div class="summary-card unused-returned mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-check-circle"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">UnUsed Returned</h6>
                                        <div class="summary-value">{{ getUnusedReturnedTotal() }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Faulty Returned -->
                                <div class="summary-card faulty-returned mb-3">
                                  <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                      <div class="summary-icon me-3">
                                        <i class="bi bi-x-circle"></i>
                                      </div>
                                      <div class="summary-content flex-grow-1">
                                        <h6 class="summary-label mb-1">Faulty Returned</h6>
                                        <div class="summary-value">{{ getFaultyReturnedTotal() }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Summary Totals -->
                                <div class="summary-totals mt-4">
                                  <div class="total-row pending mb-2">
                                    <span class="total-label">Total Pending:</span>
                                    <span class="total-value">{{ (chartTotals.unUsedTR || 0) + (chartTotals.faultyTR || 0) }}</span>
                                  </div>
                                  <div class="total-row completed">
                                    <span class="total-label">Total Completed:</span>
                                    <span class="total-value">{{ getUnusedReturnedTotal() + getFaultyReturnedTotal() }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <!--end::Chart and Summary Layout-->

                      </div>
                      <!--end::Content-->

                    </div>
                    <!--end::Card body-->

                  </div>
                  <!--end::Graph Section-->

                </div>
              </div>

            </div>
            <!--end::Graph 1 Tab-->
<!--begin::Graph 2 Tab-->
<div class="tab-pane fade"
     [class.show]="activeGraphTab === 'graph2'"
     [class.active]="activeGraphTab === 'graph2'">

  <div class="row g-5">
    <div class="col-12">

      <!--begin::Weekly Chart Section-->
      <div class="chart-section"
           *ngIf="showWeeklyChart || isLoadingWeeklyChart || weeklyChartErrorMessage">

        <!--begin::Card header-->
        <div class="card-header border-0 pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold fs-3 mb-1">
              Weekly Parts Returned Count
            </span>
            <span class="text-muted fs-7">
              Weekly breakdown of unused and faulty parts returned
            </span>
          </h3>
        </div>
        <!--end::Card header-->

        <!--begin::Card body-->
        <div class="card-body" *ngIf="showWeeklyChart">

          <!--begin::Loading-->
          <div *ngIf="isLoadingWeeklyChart"
               class="d-flex justify-content-center py-10 chart-loading">
            <div class="spinner-border text-primary"></div>
          </div>
          <!--end::Loading-->

          <!--begin::Error-->
          <div *ngIf="weeklyChartErrorMessage && !isLoadingWeeklyChart"
               class="alert alert-warning d-flex align-items-center p-5 mb-10">
            <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4"></i>
            <div class="d-flex flex-column">
              <h4 class="mb-1 text-warning">Weekly Chart Data Unavailable</h4>
              <span>{{ weeklyChartErrorMessage }}</span>
            </div>
          </div>
          <!--end::Error-->

          <!--begin::Chart Content-->
          <div *ngIf="!isLoadingWeeklyChart && weeklyPartsData.length > 0">

            <!--begin::Totals-->
            <div class="row g-6 g-xl-9 mb-6 chart-totals">

              <!-- Total Unused -->
              <div class="col-lg-4 col-xxl-4">
                <div class="card bg-light-primary border-primary">
                  <div class="card-body d-flex align-items-center">
                    <div class="symbol symbol-40px me-3">
                      <span class="symbol-label bg-primary">
                        <i class="ki-duotone ki-package fs-2 text-white"></i>
                      </span>
                    </div>
                    <div class="d-flex flex-column">
                      <span class="fw-bold fs-6 text-gray-800">Total Unused</span>
                      <span class="fw-bold fs-3 text-primary">
                        {{ getTotalWeeklyUnused() }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Total Faulty -->
              <div class="col-lg-4 col-xxl-4">
                <div class="card bg-light-danger border-danger">
                  <div class="card-body d-flex align-items-center">
                    <div class="symbol symbol-40px me-3">
                      <span class="symbol-label bg-danger">
                        <i class="ki-duotone ki-cross-circle fs-2 text-white"></i>
                      </span>
                    </div>
                    <div class="d-flex flex-column">
                      <span class="fw-bold fs-6 text-gray-800">Total Faulty</span>
                      <span class="fw-bold fs-3 text-danger">
                        {{ getTotalWeeklyFaulty() }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Total Returned -->
              <div class="col-lg-4 col-xxl-4">
                <div class="card bg-light-success border-success">
                  <div class="card-body d-flex align-items-center">
                    <div class="symbol symbol-40px me-3">
                      <span class="symbol-label bg-success">
                        <i class="ki-duotone ki-abstract-27 fs-2 text-white"></i>
                      </span>
                    </div>
                    <div class="d-flex flex-column">
                      <span class="fw-bold fs-6 text-gray-800">Total Returned</span>
                      <span class="fw-bold fs-3 text-success">
                        {{ getTotalWeeklyParts() }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            <!--end::Totals-->

            <!--begin::Chart Container-->
            <div class="chart-container">

              <!--begin::Chart Selector-->
              <div class="chart-selector-section">
                <h4 class="chart-selector-title">Weekly Parts Data Visualization</h4>

                <div class="chart-type-controls">

                  <!-- Bar -->
                  <input type="radio" class="btn-check"
                         name="weeklyChartType" id="weeklyBarChart"
                         checked (change)="setWeeklyChartType('bar')">
                  <label class="chart-type-btn" for="weeklyBarChart">
                    <i class="bi bi-bar-chart"></i>
                    Bar Chart
                  </label>

                  <!-- Line -->
                  <input type="radio" class="btn-check"
                         name="weeklyChartType" id="weeklyLineChart"
                         (change)="setWeeklyChartType('line')">
                  <label class="chart-type-btn" for="weeklyLineChart">
                    <i class="bi bi-graph-up"></i>
                    Line Chart
                  </label>

                  <!-- Table -->
                  <input type="radio" class="btn-check"
                         name="weeklyChartType" id="weeklyDataTable"
                         (change)="setWeeklyChartType('table')">
                  <label class="chart-type-btn" for="weeklyDataTable">
                    <i class="bi bi-table"></i>
                    Table
                  </label>

                </div>
              </div>
              <!--end::Chart Selector-->

              <!--begin::Bar Chart-->
              <div *ngIf="currentWeeklyChartType === 'bar'" class="chart-wrapper">
                <canvas #weeklyBarChartCanvas class="chart-canvas" width="800" height="400"></canvas>
              </div>
              <!--end::Bar Chart-->

              <!--begin::Line Chart-->
              <div *ngIf="currentWeeklyChartType === 'line'" class="chart-wrapper">
                <canvas #weeklyLineChartCanvas class="chart-canvas" width="800" height="400"></canvas>
              </div>
              <!--end::Line Chart-->

              <!--begin::Data Table-->
              <div *ngIf="currentWeeklyChartType === 'table'"
                   class="table-responsive chart-table">

                <table class="table table-rounded table-striped border gy-7 gs-7">

                  <thead>
                    <tr class="fw-semibold fs-6 text-gray-800 border-bottom-2 border-gray-200">
                      <th>Week End</th>
                      <th class="text-center">Week No</th>
                      <th class="text-center">Unused Parts</th>
                      <th class="text-center">Faulty Parts</th>
                      <th class="text-center">Total</th>
                      <th class="text-center">Week %</th>
                      <th>Progress Bar</th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr *ngFor="let item of weeklyPartsData" 
                        class="align-middle clickable-row"
                        (click)="onChartItemClick(item, 'weekly-returned')"
                        title="Click to view details for week {{ item.weekNo }}">

                      <td>{{ item.wkEnd }}</td>

                      <td class="text-center">
                        <span class="badge badge-light-info">{{ item.weekNo }}</span>
                      </td>

                      <td class="text-center">
                        <span class="badge badge-light-primary">{{ item.unUsed }}</span>
                      </td>

                      <td class="text-center">
                        <span class="badge badge-light-danger">{{ item.faulty }}</span>
                      </td>

                      <td class="text-center">
                        <span class="badge badge-light-success">
                          {{ item.unUsed + item.faulty }}
                        </span>
                      </td>

                      <td class="text-center">
                        {{ getWeeklyItemPercentage(item) }}%
                      </td>

                      <td>
                        <div class="progress h-6px w-100">
                          <div class="progress-bar bg-primary"
                               [style.width.%]="(item.unUsed / getTotalWeeklyUnused()) * 100">
                          </div>
                        </div>
                      </td>

                    </tr>
                  </tbody>

                </table>

              </div>
              <!--end::Data Table-->

            </div>
            <!--end::Chart Container-->

          </div>
          <!--end::Chart Content-->

        </div>
        <!--end::Card body-->

      </div>
      <!--end::Weekly Chart Section-->

    </div>
  </div>

</div>
<!--end::Graph 2 Tab-->
<!--begin::Graph 3 Tab-->
<div class="tab-pane fade"
     [class.show]="activeGraphTab === 'graph3'"
     [class.active]="activeGraphTab === 'graph3'">

  <div class="row g-5">
    <div class="col-12">

      <!--begin::Received Chart Section-->
      <div class="chart-section"
           *ngIf="showReceivedChart || isLoadingReceivedChart || receivedChartErrorMessage">

        <!--begin::Card header-->
        <div class="card-header border-0 pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold fs-3 mb-1">Parts Received by Warehouse</span>
            <span class="text-muted fs-7">
              Monthly breakdown of received parts for {{ partReturnFilterForm.get('year')?.value }}
            </span>
          </h3>
        </div>
        <!--end::Card header-->

        <!--begin::Card body-->
        <div class="card-body" *ngIf="showReceivedChart">

          <!--begin::Loading-->
          <div *ngIf="isLoadingReceivedChart"
               class="d-flex justify-content-center py-10 chart-loading">
            <div class="spinner-border text-primary"></div>
          </div>
          <!--end::Loading-->

          <!--begin::Error Message-->
          <div *ngIf="receivedChartErrorMessage && !isLoadingReceivedChart"
               class="alert alert-warning d-flex align-items-center p-5 mb-10">
            <i class="ki-duotone ki-information-5 fs-2hx text-warning me-4"></i>
            <div class="d-flex flex-column">
              <h4 class="mb-1 text-warning">Chart Data Unavailable</h4>
              <span>{{ receivedChartErrorMessage }}</span>
            </div>
          </div>
          <!--end::Error Message-->

          <!--begin::Chart Content-->
          <div *ngIf="!isLoadingReceivedChart && receivedChartData.length > 0">

            <!--begin::Totals-->
            <div class="row g-6 g-xl-9 mb-6 chart-totals">

              <!-- Total Jobs Count -->
              <div class="col-lg-6 col-xxl-6">
                <div class="card bg-light-success border-success">
                  <div class="card-body d-flex align-items-center">
                    <div class="symbol symbol-40px me-3">
                      <span class="symbol-label bg-success">
                        <i class="ki-duotone ki-check-circle fs-2 text-white"></i>
                      </span>
                    </div>
                    <div class="d-flex flex-column">
                      <span class="fw-bold fs-6 text-gray-800">Total Jobs Count</span>
                      <span class="fw-bold fs-3 text-success">
                        {{ receivedChartTotals.unUsedReceived }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Total Faulty Parts -->
              <div class="col-lg-6 col-xxl-6">
                <div class="card bg-light-warning border-warning">
                  <div class="card-body d-flex align-items-center">
                    <div class="symbol symbol-40px me-3">
                      <span class="symbol-label bg-warning">
                        <i class="ki-duotone ki-information fs-2 text-white"></i>
                      </span>
                    </div>
                    <div class="d-flex flex-column">
                      <span class="fw-bold fs-6 text-gray-800">Total Faulty Parts</span>
                      <span class="fw-bold fs-3 text-warning">
                        {{ receivedChartTotals.faultyReceived }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            <!--end::Totals-->

            <!--begin::Chart Container-->
            <div class="chart-container">

              <!--begin::Chart Selector-->
              <div class="chart-selector-section">
                <h4 class="chart-selector-title">Data Visualization</h4>

                <div class="chart-type-controls">

                  <!-- Bar -->
                  <input type="radio" class="btn-check"
                         name="receivedChartType" id="receivedBarChart"
                         checked (change)="setReceivedChartType('bar')">
                  <label class="chart-type-btn" for="receivedBarChart">
                    <i class="bi bi-bar-chart"></i>
                    Bar Chart
                  </label>

                  <!-- Pie -->
                  <input type="radio" class="btn-check"
                         name="receivedChartType" id="receivedPieChart"
                         (change)="setReceivedChartType('pie')">
                  <label class="chart-type-btn" for="receivedPieChart">
                    <i class="bi bi-pie-chart"></i>
                    Pie Chart
                  </label>

                  <!-- Table -->
                  <input type="radio" class="btn-check"
                         name="receivedChartType" id="receivedDataTable"
                         (change)="setReceivedChartType('table')">
                  <label class="chart-type-btn" for="receivedDataTable">
                    <i class="bi bi-table"></i>
                    Table
                  </label>

                </div>
              </div>
              <!--end::Chart Selector-->

              <!--begin::Bar Chart-->
              <div *ngIf="currentReceivedChartType === 'bar'" class="chart-wrapper">
                <canvas #receivedBarChartCanvas
                        class="chart-canvas"
                        width="800" height="400">
                </canvas>
              </div>
              <!--end::Bar Chart-->

              <!--begin::Pie Chart-->
              <div *ngIf="currentReceivedChartType === 'pie'" class="chart-wrapper d-flex justify-content-center">
                <canvas #receivedPieChartCanvas
                        class="chart-canvas"
                        width="400" height="400">
                </canvas>
              </div>
              <!--end::Pie Chart-->

              <!--begin::Data Table-->
              <div *ngIf="currentReceivedChartType === 'table'" class="table-responsive">
                <table class="table table-hover border-0">
                  <thead class="bg-light">
                    <tr class="fw-bold fs-6 text-gray-800">
                      <th>Month</th>
                      <th class="text-center">Jobs Count</th>
                      <th class="text-center">Faulty Parts</th>
                      <th class="text-center">Total</th>
                      <th class="text-center">Percentage</th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr *ngFor="let item of receivedChartData; let i = index"
                        class="clickable-row"
                        (click)="onChartItemClick(item, 'parts-received')"
                        title="Click to view received parts details for {{ item.name }}">

                      <td class="fw-bold text-gray-800">{{ item.name }}</td>

                      <td class="text-center text-success fw-semibold">
                        {{ item.jobsCount || 0 }}
                      </td>

                      <td class="text-center text-warning fw-semibold">
                        {{ item.faulty || 0 }}
                      </td>

                      <td class="text-center fw-bold">
                        {{ (item.jobsCount || 0) + (item.faulty || 0) }}
                      </td>

                      <td class="text-center">
                        <span class="badge badge-light-primary">
                          {{ getReceivedChartItemPercentage(item) }}%
                        </span>
                      </td>

                    </tr>
                  </tbody>
                </table>
              </div>
              <!--end::Data Table-->

            </div>
            <!--end::Chart Container-->

          </div>
          <!--end::Chart Content-->

        </div>
        <!--end::Card body-->

      </div>
      <!--end::Received Chart Section-->

    </div>
  </div>

</div>
<!--end::Graph 3 Tab-->

    <!-- Filter & Data Section -->
    <div class="card shadow-sm parts-main-card">
      <!-- Filter Header -->
      <div class="card-header border-0 py-4">
        <div class="parts-filter-header">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="mb-0 fw-bold text-dark">
                <i class="bi bi-funnel me-2 text-primary"></i>
                Filters & Search
                <span class="badge ms-2" [ngClass]="getFilterBadgeClass()">
                  {{totalRecords}} Result{{totalRecords === 1 ? '' : 's'}}
                </span>
              </h5>
              <small class="text-muted">Customize your view with filters below</small>
            </div>
          </div>

          <!-- Filter Controls -->
          <div class="filter-controls-section mt-3">
            <form [formGroup]="partReturnFilterForm" class="parts-filter-form">
              <div class="row g-3">
                <!-- Inventory User Filter -->
                <div class="col-md-4">
                  <div class="filter-group">
                    <label class="filter-label">
                      <i class="bi bi-person-check me-1"></i>
                      Inventory User
                    </label>
                    <div class="position-relative">
                      <select class="form-select modern-select" 
                              formControlName="inventoryUser" 
                              [disabled]="isLoadingInventoryUsers"
                              (change)="onInventoryUserChange($event)">
                        <option *ngFor="let user of inventoryUsers; trackBy: trackByUserId"
                                [value]="getInventoryUserValue(user)">
                          {{ getInventoryUserDisplayName(user) }}
                        </option>
                      </select>
                      <span *ngIf="isLoadingInventoryUsers" class="loading-indicator">
                        <i class="bi bi-arrow-repeat spin"></i>
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- Status Filter -->
                <div class="col-md-4">
                  <div class="filter-group">
                    <label class="filter-label">
                      <i class="bi bi-tag me-1"></i>
                      Status
                    </label>
                    <select class="form-select modern-select" formControlName="status">
                      <option *ngFor="let option of statusOptions"
                              [value]="option.key">
                        {{ option.label }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Year Filter -->
                <div class="col-md-4">
                  <div class="filter-group">
                    <label class="filter-label">
                      <i class="bi bi-calendar me-1"></i>
                      Year
                    </label>
                    <select class="form-select modern-select" formControlName="year">
                      <option *ngFor="let year of availableYears"
                              [value]="year">
                        {{ year }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>


      <!-- Data Display Section -->
      <div class="card-body py-4">
        
        <!-- Messages -->
        <div class="parts-messages" *ngIf="errorMessage">
          <div class="alert alert-danger d-inline-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span>{{ errorMessage }}</span>
          </div>
        </div>

        <!-- Loading indicator for data processing -->
        <div *ngIf="isLoading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary me-2"></div>
          <span class="text-muted">Processing data...</span>
        </div>


        <!-- Data Table Section -->
        <div class="table-section" *ngIf="!isLoading">
          <div class="table-responsive">
            <table class="table modern-table">
              <thead class="table-header">
                <tr>
                  <th class="sortable header-cell" (click)="sortTable('serviceCallId')" [ngClass]="getSortClass('serviceCallId')">
                    <div class="header-content">
                      <span class="header-text">Service Call ID</span>
                      <i [class]="'sort-icon ' + sortIcon('serviceCallId')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('partNum')" [ngClass]="getSortClass('partNum')">
                    <div class="header-content">
                      <span class="header-text">Part Number</span>
                      <i [class]="'sort-icon ' + sortIcon('partNum')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('dcPartNum')" [ngClass]="getSortClass('dcPartNum')">
                    <div class="header-content">
                      <span class="header-text">DC Part Number</span>
                      <i [class]="'sort-icon ' + sortIcon('dcPartNum')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('description')" [ngClass]="getSortClass('description')">
                    <div class="header-content">
                      <span class="header-text">Description</span>
                      <i [class]="'sort-icon ' + sortIcon('description')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('totalQty')" [ngClass]="getSortClass('totalQty')">
                    <div class="header-content">
                      <span class="header-text">Total Qty</span>
                      <i [class]="'sort-icon ' + sortIcon('totalQty')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('faultyParts')" [ngClass]="getSortClass('faultyParts')">
                    <div class="header-content">
                      <span class="header-text">Faulty</span>
                      <i [class]="'sort-icon ' + sortIcon('faultyParts')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('unusedParts')" [ngClass]="getSortClass('unusedParts')">
                    <div class="header-content">
                      <span class="header-text">Unused</span>
                      <i [class]="'sort-icon ' + sortIcon('unusedParts')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('technician')" [ngClass]="getSortClass('technician')">
                    <div class="header-content">
                      <span class="header-text">Technician</span>
                      <i [class]="'sort-icon ' + sortIcon('technician')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('invUserID')" [ngClass]="getSortClass('invUserID')">
                    <div class="header-content">
                      <span class="header-text">Inv User</span>
                      <i [class]="'sort-icon ' + sortIcon('invUserID')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('status')" [ngClass]="getSortClass('status')">
                    <div class="header-content">
                      <span class="header-text">Status</span>
                      <i [class]="'sort-icon ' + sortIcon('status')"></i>
                    </div>
                  </th>
                  <th class="sortable header-cell" (click)="sortTable('lastModified')" [ngClass]="getSortClass('lastModified')">
                    <div class="header-content">
                      <span class="header-text">Last Modified</span>
                      <i [class]="'sort-icon ' + sortIcon('lastModified')"></i>
                    </div>
                  </th>
                </tr>
              </thead>


              <tbody class="table-body">
                <tr *ngFor="let item of displayedData; trackBy: trackByServiceCallId" 
                    class="table-row">
                  
                  <td class="call-number-cell">
                    <a class="call-link" (click)="navigateToServiceCall(item.serviceCallId, item.technician)" 
                       [title]="'View parts for service call ' + item.serviceCallId + ' - Technician: ' + item.technician"
                       role="button">
                      {{ item.serviceCallId }}
                      <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                    </a>
                  </td>
                  
                  <td class="data-cell">
                    <span class="cell-content">{{ item.partNum }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="cell-content">{{ item.dcPartNum }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="cell-content">{{ item.description }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-primary">{{ item.totalQty }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-danger">{{ item.faultyParts }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-warning">{{ item.unusedParts }}</span>
                  </td>
                  
                  <td class="data-cell">
                    <div class="technician-info">
                      <i class="bi bi-person-badge me-1 text-muted"></i>
                      <a class="technician-link" (click)="navigateToTechnicianJobs(item.serviceCallId, item.technician)"
                         [title]="'View parts for technician ' + item.technician + ' - Call: ' + item.serviceCallId"
                         role="button">
                        {{ item.technician }}
                        <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                      </a>
                    </div>
                  </td>
                  
                  <td class="data-cell">
                    <span class="badge badge-light-info">{{ item.invUserID }}</span>
                  </td>
                  
                  <td class="status-cell">
                    <span class="status-badge" [ngClass]="getStatusBadgeClass(item.status)">
                      {{ getStatusDisplayName(item.status) }}
                    </span>
                  </td>
                  
                  <td class="date-cell">
                    <span class="date-content">{{ item.lastModified | date:'dd-MMM-yyyy HH:mm' }}</span>
                  </td>

                </tr>
              </tbody>

            </table>
          </div>
        </div>


        <!-- Enhanced Pagination Controls - Below Table -->
        <div class="enhanced-pagination-wrapper" *ngIf="totalRecords > 0">
          <div class="enhanced-pagination-controls">
            <div class="row align-items-center g-3">
              <!-- Left side - Page size and record info -->
              <div class="col-md-6">
                <div class="pagination-info">
                  <div class="d-flex align-items-center gap-3 flex-wrap">
                    <div class="page-size-selector">
                      <label class="form-label mb-0 fw-semibold">Records per page:</label>
                      <select class="form-select form-select-lg" 
                              [value]="pageSize" #pageSizeSelect (change)="onPageSizeChange(+pageSizeSelect.value)">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                      </select>
                    </div>
                    <div class="record-info">
                      <span class="badge badge-info-custom">
                        <i class="bi bi-list-ol me-1"></i>
                        Showing {{startRecord}}-{{endRecord}} of {{totalRecords}} records
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Right side - Navigation controls -->
              <div class="col-md-6">
                <div class="pagination-navigation">
                  <div class="d-flex justify-content-end align-items-center gap-2">
                    <!-- First page -->
                    <button class="btn btn-pagination btn-first" 
                            [disabled]="currentPage === 1" 
                            (click)="onPageChange(1)"
                            title="First page">
                      <i class="bi bi-chevron-double-left"></i>
                    </button>
                    
                    <!-- Previous page -->
                    <button class="btn btn-pagination btn-prev" 
                            [disabled]="currentPage === 1" 
                            (click)="onPageChange(currentPage - 1)"
                            title="Previous page">
                      <i class="bi bi-chevron-left"></i>
                      <span class="d-none d-sm-inline">Previous</span>
                    </button>
                    
                    <!-- Current page indicator -->
                    <div class="current-page-indicator">
                      <span class="page-display">
                        Page <strong>{{currentPage}}</strong> of <strong>{{totalPages}}</strong>
                      </span>
                    </div>
                    
                    <!-- Next page -->
                    <button class="btn btn-pagination btn-next" 
                            [disabled]="currentPage === totalPages" 
                            (click)="onPageChange(currentPage + 1)"
                            title="Next page">
                      <span class="d-none d-sm-inline">Next</span>
                      <i class="bi bi-chevron-right"></i>
                    </button>
                    
                    <!-- Last page -->
                    <button class="btn btn-pagination btn-last" 
                            [disabled]="currentPage === totalPages" 
                            (click)="onPageChange(totalPages)"
                            title="Last page">
                      <i class="bi bi-chevron-double-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="totalRecords === 0 && !isLoading" class="empty-state">
          <div class="empty-state-content">
            <i class="bi bi-inbox empty-icon"></i>
            <h4 class="empty-title">No Parts Return Data Found</h4>
            <p class="empty-text">There are no parts return records matching your current filters.</p>
            <button class="btn btn-primary" (click)="clearFilters()">
              <i class="bi bi-funnel-fill me-2"></i>Clear Filters
            </button>
          </div>
        </div>


      </div>
    </div>
  </div>
</div>
