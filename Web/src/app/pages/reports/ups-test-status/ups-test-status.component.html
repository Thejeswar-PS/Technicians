<!-- UPS Test Status Page -->
<div class="container-fluid ups-test-status-container">

  <!-- Page Title -->
  <div class="container-fluid">
    <div class="text-center mb-4">
      <h2 class="fw-bold text-primary mb-02 display-4.9">
        <i class="bi bi-activity me-2"></i>
        UPS Test Status
      </h2>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner-border text-primary"></div>
  </div>

  <!-- Make Distribution Chart -->
  <div class="container-fluid">
    <div class="vertical-bar-chart mb-4">
    <div *ngIf="isLoadingMakeChart" class="text-center py-24">
      <div class="spinner-border text-primary"></div>
    </div>

    <div *ngIf="!isLoadingMakeChart && makeCounts.length > 0">
      <!-- Chart Header -->
      <div class="chart-header">
        <h6 class="chart-title">
          <i class="bi bi-bar-chart-fill me-2 text-primary"></i>
          Make Distribution
        </h6>
        <span class="chart-subtitle">Units by Make Type</span>
      </div>

      <!-- Chart Body -->
      <div class="chart-wrapper">

        <!-- Y Axis -->
        <div class="y-axis">
          <div class="y-label" *ngFor="let tick of getYAxisTicks()">
            {{ tick }}
          </div>
        </div>

        <!-- Bars Area -->
        <div class="bars-area">

          <div [class]="getBarCssClass(make.make)"
               *ngFor="let make of makeCounts; let i = index"
               [style.height.%]="getBarHeightPercentage(make.makeCount)">

            <div class="bar-value">
              {{ make.makeCount }}
            </div>

          </div>

        </div>

      </div>

      <!-- X Axis Labels -->
      <div class="x-axis">
        <div class="x-label"
             *ngFor="let make of makeCounts">
          {{ make.make }}
        </div>
      </div>
    </div>

    <div *ngIf="!isLoadingMakeChart && makeCounts.length === 0" class="no-data-placeholder">
      <div class="no-data-content">
        <i class="bi bi-bar-chart display-1 mb-3 text-muted"></i>
        <h5 class="text-muted">No Make Data Available</h5>
        <p class="text-muted mb-0">Chart will appear when make data is loaded</p>
      </div>
    </div>
    </div>
  </div>

  <!-- FILTER PANEL -->
  <div class="container-fluid">
    <div class="filter-panel mb-16" [formGroup]="filterForm">
    <div class="row g-12">
      <div class="col-md-3">
        <label class="form-label">Assigned To</label>
        <select class="form-select"
                formControlName="assignedTo"
                (change)="onStatusChange()">
          <option *ngFor="let option of technicianOptions"
                  [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select"
                formControlName="status"
                (change)="onStatusChange()">
          <option *ngFor="let option of statusOptions"
                  [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Priority</label>
        <select class="form-select"
                formControlName="priority"
                (change)="onStatusChange()">
          <option *ngFor="let option of priorityOptions"
                  [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Show</label>
        <div class="form-check form-switch">
          <input class="form-check-input"
                 type="checkbox"
                 id="archiveToggle"
                 formControlName="archive"
                 (change)="onStatusChange()">
          <label class="form-check-label" for="archiveToggle">Active</label>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGINATION HEADER -->
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3" 
       *ngIf="!isLoading && filteredUnitsList.length > 0">
    
    <!-- LEFT: Records per page -->
    <div class="d-flex align-items-center">
      <label class="me-2 fw-semibold">Records per page:</label>
      <select class="form-select form-select-sm w-auto"
              [value]="itemsPerPage"
              (change)="changeItemsPerPage(+$any($event.target).value)">
        <option value="200">200</option>
        <option value="300">300</option>
        <option value="400">400</option>
        <option value="100">100</option>
      </select>
    </div>

    <!-- CENTER: Showing X - Y of Z records -->
    <div class="flex-fill text-center fw-semibold">
      Showing
      {{ totalItems ? ((currentPage - 1) * itemsPerPage + 1) : 0 }}
      -
      {{ totalItems ? Math.min(currentPage * itemsPerPage, totalItems) : 0 }}
      of {{ totalItems }} records
    </div>

    <!-- RIGHT: Prev, Page X of Y, Next -->
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-secondary" 
              [disabled]="currentPage <= 1"
              (click)="goToPage(currentPage - 1)">
        Prev
      </button>
      <span class="fw-semibold">Page {{ currentPage }} of {{ totalPages }}</span>
      <button class="btn btn-sm btn-outline-secondary" 
              [disabled]="currentPage >= totalPages"
              (click)="goToPage(currentPage + 1)">
        Next
      </button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-scroll-wrapper"
       *ngIf="!isLoading && paginatedItems.length > 0">

    <table class="table parts-status-table">
      <thead>
        <tr>
          <th class="sortable" (click)="sortBy('rowIndex')">
            <span class="header-cell">
              No.
              <span class="sort-icons" [class.active]="sortColumn === 'rowIndex'">
                <i class="up" [class.on]="sortColumn === 'rowIndex' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'rowIndex' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('make')">
            <span class="header-cell">
              Make
              <span class="sort-icons" [class.active]="sortColumn === 'make'">
                <i class="up" [class.on]="sortColumn === 'make' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'make' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('model')">
            <span class="header-cell">
              Model
              <span class="sort-icons" [class.active]="sortColumn === 'model'">
                <i class="up" [class.on]="sortColumn === 'model' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'model' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('serialNo')">
            <span class="header-cell">
              Serial No
              <span class="sort-icons" [class.active]="sortColumn === 'serialNo'">
                <i class="up" [class.on]="sortColumn === 'serialNo' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'serialNo' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('poNumber')">
            <span class="header-cell">
              PO #
              <span class="sort-icons" [class.active]="sortColumn === 'poNumber'">
                <i class="up" [class.on]="sortColumn === 'poNumber' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'poNumber' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('shippingPO')">
            <span class="header-cell">
              Shipping PO#
              <span class="sort-icons" [class.active]="sortColumn === 'shippingPO'">
                <i class="up" [class.on]="sortColumn === 'shippingPO' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'shippingPO' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('unitCost')">
            <span class="header-cell">
              Unit Cost
              <span class="sort-icons" [class.active]="sortColumn === 'unitCost'">
                <i class="up" [class.on]="sortColumn === 'unitCost' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'unitCost' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('shipCost')">
            <span class="header-cell">
              Shipping Cost
              <span class="sort-icons" [class.active]="sortColumn === 'shipCost'">
                <i class="up" [class.on]="sortColumn === 'shipCost' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'shipCost' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('status')">
            <span class="header-cell">
              Status
              <span class="sort-icons" [class.active]="sortColumn === 'status'">
                <i class="up" [class.on]="sortColumn === 'status' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'status' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('priority')">
            <span class="header-cell">
              Priority
              <span class="sort-icons" [class.active]="sortColumn === 'priority'">
                <i class="up" [class.on]="sortColumn === 'priority' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'priority' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('assignedTo')">
            <span class="header-cell">
              Assigned To
              <span class="sort-icons" [class.active]="sortColumn === 'assignedTo'">
                <i class="up" [class.on]="sortColumn === 'assignedTo' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'assignedTo' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('kva')">
            <span class="header-cell">
              KVA
              <span class="sort-icons" [class.active]="sortColumn === 'kva'">
                <i class="up" [class.on]="sortColumn === 'kva' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'kva' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
          <th class="sortable" (click)="sortBy('createdOn')">
            <span class="header-cell">
              Created On
              <span class="sort-icons" [class.active]="sortColumn === 'createdOn'">
                <i class="up" [class.on]="sortColumn === 'createdOn' && sortDirection === 'asc'"></i>
                <i class="down" [class.on]="sortColumn === 'createdOn' && sortDirection === 'desc'"></i>
              </span>
            </span>
          </th>
        </tr>
      </thead>

<tbody>
  <tr *ngFor="let item of paginatedItems"
    [ngClass]="{
      'row-high-priority': item.priority === 'High' && !hasStripSerial(item),
      'row-strip-serial': hasStripSerial(item)
    }">


    <td class="text-center">{{ item.rowIndex }}</td>

    <td>
      <button class="btn btn-link p-0"
              type="button"
              (click)="navigateToNewUnitTest(item)"
              [style.color]="'#2563eb'"
              [style.text-decoration]="'underline'"
              [style.font-weight]="'500'">
        {{ item.make }}
      </button>
    </td>

    <td>{{ item.model }}</td>
    <td class="wrap">{{ item.serialNo }}</td>
    <td class="wrap">{{ item.poNumber }}</td>
    <td class="wrap">{{ item.shippingPO }}</td>
    <td class="text-end">{{ formatCurrency(item.unitCost) }}</td>
    <td class="text-end">{{ formatCurrency(item.shipCost) }}</td>

    <td class="text-center">
  <span class="status-badge"
      [ngClass]="{
        'status-completed': item.status?.toLowerCase() === 'completed',
        'status-inprogress': item.status?.toLowerCase() === 'in progress',
        'status-needs-components': item.status?.toLowerCase()?.includes('needs') || false,
        'status-missing-parts': item.status?.toLowerCase()?.includes('missing') || false
      }">
  {{ item.status }}
</span>
</td>


    <td class="text-center">
      <span class="priority-badge"
            [ngClass]="{
              'priority-high': item.priority === 'High',
              'priority-medium': item.priority === 'Medium',
              'priority-low': item.priority === 'Low'
            }">
        {{ item.priority }}
      </span>
    </td>

    <td>{{ item.assignedTo }}</td>
    <td class="text-center">{{ item.kva }}</td>
    <td>{{ formatDate(item.createdOn) }}</td>

  </tr>
</tbody>

    </table>
  </div>

  <!-- PAGINATION FOOTER -->
  <div class="d-flex align-items-center justify-content-between mt-16 pagination-footer"
       *ngIf="!isLoading && filteredUnitsList.length > 0 && totalPages > 1">
    
    <!-- LEFT: Previous button -->
    <div>
      <button class="btn btn-sm btn-outline-primary" 
              [disabled]="currentPage <= 1"
              (click)="goToPage(currentPage - 1)">
        Previous
      </button>
    </div>

    <!-- CENTER: Page numbers -->
    <div class="d-flex align-items-center gap-2">
      <button *ngFor="let page of getVisiblePages()" 
              class="btn btn-sm"
              [class.btn-primary]="page === currentPage"
              [class.btn-outline-secondary]="page !== currentPage"
              (click)="goToPage(page)">
        {{ page }}
      </button>
    </div>

    <!-- RIGHT: Next button -->
    <div>
      <button class="btn btn-sm btn-outline-primary" 
              [disabled]="currentPage >= totalPages"
              (click)="goToPage(currentPage + 1)">
        Next
      </button>
    </div>
  </div>
  </div>

  <!-- NO DATA MESSAGE -->
  <div class="container-fluid">
    <div *ngIf="!isLoading && paginatedItems.length === 0" 
         class="text-center py-5 no-data-message">
      <i class="bi bi-inbox display-1 text-muted"></i>
      <h4 class="text-muted mt-3">No UPS Units Found</h4>
      <p class="text-muted">No units match the current filter criteria.</p>
    </div>
  </div>

</div>