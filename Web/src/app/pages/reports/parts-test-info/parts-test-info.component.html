<!-- Parts Test Info Page -->
<div class="container-fluid p-4">
  
  <!-- Page Header -->
  <div class="parts-test-header__top d-flex justify-content-between align-items-center mb-4">
    <button type="button" class="btn btn-sm btn-primary parts-test-header__back" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>Back
    </button>
    
    <div class="parts-page-title">
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-clipboard-data me-2"></i>Parts Test Info
      </h2>
    </div>
    
    <div class="flex-shrink-0"></div>
  </div>

  <form [formGroup]="editForm">
    
    <!-- Auto Generated ID Section - Badge/Pill Style -->
    <div class="auto-gen-id-container d-flex align-items-center justify-content-center mb-4">
      <div class="d-flex align-items-center gap-3">
        <span class="auto-gen-label">
          <i class="bi bi-hash me-2"></i>Auto Generated ID
        </span>
        <div class="auto-gen-badge">
          <i class="bi bi-barcode-scan me-2"></i>
          <span class="auto-gen-id-text">{{ getFormattedAutoGenId() }}</span>
        </div>
      </div>
    </div>

    <!-- Main Content: Two Column Layout -->
    <div class="row g-4">
      <!-- Left Column: Parts Testing Info Entry -->
      <div class="col-lg-6">
        <div class="card shadow border h-100">
          <div class="card-header bg-info">
            <h5 class="card-title text-white mb-0 fw-bold">
              <i class="ki-outline ki-setting-2 fs-2 me-2"></i>
              Parts Testing Info Entry
            </h5>
          </div>
          <div class="card-body bg-white">


            <!-- Basic Information -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-category me-1 text-primary"></i>Job Type <span class="text-danger">*</span>
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="jobFrom" (change)="onJobTypeChange($any($event.target).value)" [class.is-invalid]="isFieldInvalid('jobFrom')">
                  <option value="1">Fan Rebuild</option>
                  <option value="2">Cap Assy.</option>
                  <option value="4">Batt Module</option>
                  <option value="3">Inventory</option>
                  <option value="7">Board Setup</option>
                  <option value="6">Retest</option>
                </select>
                <div class="invalid-feedback fw-semibold">{{ getFieldError('jobFrom') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-abstract-26 me-1 text-primary"></i>Job Number
                </label>
                <div class="input-group">
                  <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="jobNumber" maxlength="11" placeholder="Enter job number" (blur)="onJobNumberBlur()" />
                  <div class="input-group-text" *ngIf="jobValidationMessage" [ngClass]="jobValidationClass">
                    <span *ngIf="isValidatingJob" class="spinner-border spinner-border-sm"></span>
                    <span *ngIf="!isValidatingJob">{{ jobValidationMessage }}</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-geolocation me-1 text-primary"></i>Site ID
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="siteID" placeholder="Enter site ID" [class.is-invalid]="isFieldInvalid('siteID')" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('siteID') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-cube-2 me-1 text-primary"></i>Make
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="make" maxlength="21" placeholder="Enter make" [class.is-invalid]="isFieldInvalid('make')" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('make') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-element-7 me-1 text-primary"></i>Model
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="model" maxlength="21" placeholder="Enter model" [class.is-invalid]="isFieldInvalid('model')" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('model') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-electricity me-1 text-primary"></i>KVA
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="kva" placeholder="Enter KVA" (keypress)="onlyNumbersAndDecimal($event)" (paste)="onPasteDecimals($event)" [class.is-invalid]="isFieldInvalid('kva')" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('kva') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-flash me-1 text-primary"></i>Voltage
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="voltage" placeholder="Enter voltage" (keypress)="onlyNumbersAndDecimal($event)" (paste)="onPasteDecimals($event)" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-barcode me-1 text-primary"></i>Manuf Part # <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="manufPartNo" [class.is-invalid]="isFieldInvalid('manufPartNo')" placeholder="Enter manufacturer part number" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('manufPartNo') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-scan-barcode me-1 text-primary"></i>DCG Part # <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="dcgPartNo" [class.is-invalid]="isFieldInvalid('dcgPartNo')" placeholder="Enter DCG part number" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('dcgPartNo') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-lots-shopping me-1 text-primary"></i>Quantity <span class="text-danger">*</span>
                </label>
                <input type="number" class="form-control form-control-solid text-dark fw-semibold" formControlName="quantity" min="1" max="999" [class.is-invalid]="isFieldInvalid('quantity')" placeholder="Enter quantity" (keypress)="onlyNumbers($event)" (paste)="onPasteNumbers($event)" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('quantity') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-tag me-1 text-primary"></i>Serial No
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="serialNo" placeholder="Enter serial number" />
              </div>
            </div>
            
            <!-- Work Type Section -->
            <div class="card border shadow-sm mb-4">
              <div class="card-header bg-primary">
                <h6 class="card-title mb-0 text-white fw-bold">
                  <i class="ki-outline ki-setting-3 me-2"></i>Work Type Selection <span class="text-warning">*</span>
                </h6>
              </div>
              <div class="card-body bg-white">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType1" id="wt1" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt1">Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType2" id="wt2" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt2">Repair</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType3" id="wt3" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt3">WH Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType4" id="wt4" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt4">Field Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType5" id="wt5" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt5">Shipping Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType6" id="wt6" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt6">Shipping Damage</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType7" id="wt7" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt7">Clean Parts/Components</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType8" id="wt8" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt8">Parts ASSY</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType9" id="wt9" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt9">Remove from Unit to Ship</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType10" id="wt10" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt10">Re-test from Inventory</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType11" id="wt11" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt11">Test</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType12" id="wt12" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt12">Board Setup</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Assignment Information -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-profile-user me-1 text-primary"></i>Assigned To <span class="text-danger">*</span>
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="assignedTo" [class.is-invalid]="isFieldInvalid('assignedTo')" [disabled]="isLoadingEmployees">
                  <option value="">{{ isLoadingEmployees ? 'Loading TC Employees...' : 'Select Employee' }}</option>
                  <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                    {{ getEmployeeDisplayName(employee) }}
                  </option>
                </select>
                <div class="invalid-feedback fw-semibold">{{ getFieldError('assignedTo') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-calendar me-1 text-primary"></i>Due Date <span class="text-danger">*</span>
                </label>
                <input type="date" class="form-control form-control-solid text-dark fw-semibold" formControlName="dueDate" [class.is-invalid]="isFieldInvalid('dueDate')" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('dueDate') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-calendar-add me-1 text-primary"></i>Submitted On
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="submittedOn" readonly placeholder="Auto-populated" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-user-square me-1 text-primary"></i>Inventory Specialist
                </label>
                <div class="form-control form-control-solid text-dark fw-semibold bg-light">{{ editForm.get('inventorySpecialist')?.value || 'Auto-assigned' }}</div>
              </div>
              <div class="col-md-6 d-flex align-items-center">
                <div class="form-check form-check-custom form-check-solid mt-8 p-3 border rounded" [ngClass]="{'bg-danger text-white': editForm.get('emergency')?.value, 'bg-light': !editForm.get('emergency')?.value}">
                  <input class="form-check-input" type="checkbox" formControlName="emergency" id="emergency" (change)="toggleEmergencyFlag()" />
                  <label class="form-check-label fw-bold fs-6" for="emergency" [ngClass]="{'text-white': editForm.get('emergency')?.value, 'text-dark': !editForm.get('emergency')?.value}">
                    <i class="ki-outline ki-warning me-1 text-warning"></i>Emergency
                  </label>
                </div>
              </div>
              <div class="col-md-6 d-flex align-items-center">
                <div class="form-check form-check-custom form-check-solid mt-8 p-3 border rounded bg-light">
                  <input class="form-check-input" type="checkbox" formControlName="approved" id="approved" (change)="onApprovedChange()" />
                  <label class="form-check-label fw-bold text-dark fs-6" for="approved">
                    <i class="ki-outline ki-verify me-1 text-success"></i>Approved
                  </label>
                </div>
              </div>
            </div>

            <!-- Description and Notes -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-note-2 me-1 text-primary"></i>Description
                </label>
                <textarea class="form-control form-control-solid text-dark fw-semibold" formControlName="description" rows="3" placeholder="Enter description..." style="resize: vertical;"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-message-text me-1 text-primary"></i>Deficiency Notes <span class="text-danger">*</span>
                </label>
                <textarea class="form-control form-control-solid text-dark fw-semibold" formControlName="problemNotes" rows="3" [class.is-invalid]="isFieldInvalid('problemNotes')" placeholder="Enter deficiency notes..." style="resize: vertical;"></textarea>
                <div class="invalid-feedback fw-semibold">{{ getFieldError('problemNotes') }}</div>
              </div>
            </div>
            
              <!-- Action Buttons - Match Legacy Layout -->
            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
              <!-- Left: Update/Add/Clear buttons -->
              <div class="flex-fill">
                <button type="button" class="btn btn-primary btn-lg fw-bold me-2" (click)="saveItem()" [disabled]="isSaving || !isAddEntryEnabled">
                  <i class="ki-outline ki-check fs-3 me-2" *ngIf="!isSaving"></i>
                  <span class="spinner-border spinner-border-sm me-2" *ngIf="isSaving"></span>
                  {{ editingItem ? 'Update' : 'Add' }}
                </button>
                <button type="button" class="btn btn-secondary btn-lg fw-bold" (click)="clearForm()">
                  <i class="ki-outline ki-eraser fs-3 me-2"></i>
                  Clear
                </button>
              </div>
              <!-- Center: Final Approve button -->
              <div class="flex-fill text-center">
                <button type="button" 
                        class="btn btn-success btn-lg fw-bold" 
                        (click)="onFinalApprove()" 
                        [disabled]="!(
                          (isAssemblyJob && editForm.get('assyWorkStatus')?.value === '1' && editForm.get('qcWorkStatus')?.value === '1') ||
                          (isBoardSetupJob && editForm.get('boardQualityStatus')?.value === '1') ||
                          (isComponentJob && editForm.get('compQualityStatus')?.value === '1')
                        ) || isArchived || isSaving">
                  <i class="ki-outline ki-security-check fs-3 me-2" *ngIf="!isSaving"></i>
                  <span class="spinner-border spinner-border-sm me-2" *ngIf="isSaving"></span>
                  Final Approve
                </button>
              </div>
              <!-- Right: Delete button -->
              <div class="flex-fill text-end">
                <button type="button" class="btn btn-danger btn-lg fw-bold" (click)="confirmDeleteItem(editingItem)" *ngIf="editingItem">
                  <i class="ki-outline ki-trash fs-4 me-1"></i>
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Result Of Inspection -->
      <div class="col-lg-6">
        <div class="card shadow border h-100">
          <div class="card-header bg-success">
            <h5 class="card-title text-white mb-0 fw-bold">
              <i class="ki-outline ki-verify fs-2 me-2"></i>
              Result Of Inspection
            </h5>
          </div>
          <div class="card-body bg-white">
            <!-- Success/Error Messages -->
            <div *ngIf="saveMessage" class="alert alert-success d-flex align-items-center mb-4">
              <i class="ki-outline ki-check-circle fs-2 me-3"></i>
              <span class="text-dark fw-semibold">{{ saveMessage }}</span>
            </div>
            <div *ngIf="errorMessage" class="alert alert-danger d-flex align-items-center mb-4">
              <i class="ki-outline ki-cross-circle fs-2 me-3"></i>
              <span class="text-dark fw-semibold">{{ errorMessage }}</span>
            </div>

            <!-- Board Setup Section - Job Type 7 Only -->
            <div *ngIf="isBoardSetupJob" class="mb-4">
              <label class="form-label fw-bold text-dark fs-6">
                <i class="ki-outline ki-technology-4 me-1 text-primary"></i>Board Setup Status:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" formControlName="boardSetup">
                <option value="0">Please Select</option>
                <option value="1">Completed</option>
                <option value="2">Boards Are Completed</option>
                <option value="3">In Progress</option>
                <option value="4">Need Parts</option>
              </select>

              <!-- Quality - Work Done -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-shield-check me-1 text-primary"></i>Quality – Work Done:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityWorkDone1" id="bqw1" /><label class="form-check-label text-dark fw-bold fs-6" for="bqw1">Visual Inspection</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityWorkDone2" id="bqw2" /><label class="form-check-label text-dark fw-bold fs-6" for="bqw2">Function Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityWorkDone3" id="bqw3" /><label class="form-check-label text-dark fw-bold fs-6" for="bqw3">Load Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityWorkDone4" id="bqw4" /><label class="form-check-label text-dark fw-bold fs-6" for="bqw4">High Pot Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityWorkDone5" id="bqw5" /><label class="form-check-label text-dark fw-bold fs-6" for="bqw5">Discrete Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityWorkDone6" id="bqw6" /><label class="form-check-label text-dark fw-bold fs-6" for="bqw6">Other</label></div></div>
              </div>

              <!-- Quality Procedure Followed -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-check-square me-1 text-primary"></i>Quality Procedure Followed:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityProcFollowed1" id="bqpf1" /><label class="form-check-label text-dark fw-bold fs-6" for="bqpf1">Yes</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityProcFollowed2" id="bqpf2" /><label class="form-check-label text-dark fw-bold fs-6" for="bqpf2">No</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityProcFollowed3" id="bqpf3" /><label class="form-check-label text-dark fw-bold fs-6" for="bqpf3">N/A</label></div></div>
              </div>

              <!-- Quality Approved -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-shield-tick me-1 text-primary"></i>Quality Approved:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityApproved1" id="bqa1" /><label class="form-check-label text-dark fw-bold text-success fs-6" for="bqa1">Pass</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityApproved2" id="bqa2" /><label class="form-check-label text-dark fw-bold text-danger fs-6" for="bqa2">Fail</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="boardQualityApproved3" id="bqa3" /><label class="form-check-label text-dark fw-bold fs-6" for="bqa3">N/A</label></div></div>
              </div>

              <!-- Quality Status -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-shield-cross me-1 text-primary"></i>Quality Status:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" formControlName="boardQualityStatus">
                <option value="0">Please Select</option>
                <option value="1">Completed</option>
                <option value="2">In Progress</option>
                <option value="3">Not Acceptable</option>
              </select>

              <!-- Approved By -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-user-edit me-1 text-primary"></i>Approved By:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" 
                      formControlName="boardApprovedBy"
                      [disabled]="!editForm.get('boardQualityStatus')?.value || editForm.get('boardQualityStatus')?.value !== '1'">
                <option value="">Please Select</option>
                <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                  {{ getEmployeeDisplayName(employee) }}
                </option>
              </select>

              <!-- Passed Checkbox -->
              <div class="form-check form-check-custom form-check-solid p-3 border rounded bg-light mb-3">
                <input type="checkbox" class="form-check-input" formControlName="boardPassed" id="boardPassed" />
                <label class="form-check-label fw-bold text-success fs-6" for="boardPassed">
                  <i class="ki-outline ki-verify me-1"></i>Passed
                </label>
              </div>
            </div>

            <!-- divGrp1: Component/Testing Section - Job Types 3,6 (Inventory, Retest) -->
            <div *ngIf="isComponentJob" class="mb-4">
              <label class="form-label fw-bold text-dark fs-6 mb-3">
                <i class="ki-outline ki-wrench me-1 text-primary"></i>Component – Work Done:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone1" id="cw1" /><label class="form-check-label text-dark fw-bold fs-6" for="cw1">Cleaned</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone2" id="cw2" /><label class="form-check-label text-dark fw-bold fs-6" for="cw2">Refurbished</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone3" id="cw3" /><label class="form-check-label text-dark fw-bold fs-6" for="cw3">Parts Replaced</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone4" id="cw4" /><label class="form-check-label text-dark fw-bold fs-6" for="cw4">Repaired</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone5" id="cw5" /><label class="form-check-label text-dark fw-bold fs-6" for="cw5">Inspected for Damage</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone6" id="cw6" /><label class="form-check-label text-dark fw-bold fs-6" for="cw6">Not Repairable</label></div></div>
              </div>

              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-status me-1 text-primary"></i>Part Repair Status:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" formControlName="partRepairStatus">
                <option value="0">Please Select</option>
                <option value="1">Ready For Test</option>
                <option value="2">Non Repairable</option>
                <option value="3">Need Parts</option>
                <option value="4">In Progress</option>
              </select>

              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-rocket me-1 text-primary"></i>Testing – Work Done:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="testWorkDone1" id="tw1" /><label class="form-check-label text-dark fw-bold fs-6" for="tw1">Testing In Unit</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="testWorkDone2" id="tw2" /><label class="form-check-label text-dark fw-bold fs-6" for="tw2">Load Tested</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="testWorkDone3" id="tw3" /><label class="form-check-label text-dark fw-bold fs-6" for="tw3">No Unit To Test</label></div></div>
              </div>

              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-check-circle me-1 text-primary"></i>Final Status:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" formControlName="testWorkStatus">
                <option value="0">Please Select</option>
                <option value="1">Completed</option>
                <option value="2">In Progress</option>
                <option value="3">Needs Unit</option>
                <option value="4">Non Testable</option>
              </select>

              <!-- Quality - Work Done -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-shield-check me-1 text-primary"></i>Quality – Work Done:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityWorkDone1" id="cqw1" /><label class="form-check-label text-dark fw-bold fs-6" for="cqw1">Visual Inspection</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityWorkDone2" id="cqw2" /><label class="form-check-label text-dark fw-bold fs-6" for="cqw2">Function Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityWorkDone3" id="cqw3" /><label class="form-check-label text-dark fw-bold fs-6" for="cqw3">Load Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityWorkDone4" id="cqw4" /><label class="form-check-label text-dark fw-bold fs-6" for="cqw4">High Pot Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityWorkDone5" id="cqw5" /><label class="form-check-label text-dark fw-bold fs-6" for="cqw5">Discrete Test</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityWorkDone6" id="cqw6" /><label class="form-check-label text-dark fw-bold fs-6" for="cqw6">Other</label></div></div>
              </div>

              <!-- Quality Procedure Followed -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-check-square me-1 text-primary"></i>Quality Procedure Followed:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityProcFollowed1" id="cqpf1" /><label class="form-check-label text-dark fw-bold fs-6" for="cqpf1">Yes</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityProcFollowed2" id="cqpf2" /><label class="form-check-label text-dark fw-bold fs-6" for="cqpf2">No</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityProcFollowed3" id="cqpf3" /><label class="form-check-label text-dark fw-bold fs-6" for="cqpf3">N/A</label></div></div>
              </div>

              <!-- Quality Approved -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-shield-tick me-1 text-primary"></i>Quality Approved:
              </label>
              <div class="row g-2 mb-3">
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityApproved1" id="cqa1" /><label class="form-check-label text-dark fw-bold text-success fs-6" for="cqa1">Pass</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityApproved2" id="cqa2" /><label class="form-check-label text-dark fw-bold text-danger fs-6" for="cqa2">Fail</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compQualityApproved3" id="cqa3" /><label class="form-check-label text-dark fw-bold fs-6" for="cqa3">N/A</label></div></div>
              </div>

              <!-- Quality Status -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-shield-cross me-1 text-primary"></i>Quality Status:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" formControlName="compQualityStatus">
                <option value="0">Please Select</option>
                <option value="1">Completed</option>
                <option value="2">In Progress</option>
                <option value="3">Not Acceptable</option>
              </select>

              <!-- Approved By -->
              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-user-edit me-1 text-primary"></i>Approved By:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" 
                      formControlName="compApprovedBy"
                      [disabled]="!editForm.get('compQualityStatus')?.value || editForm.get('compQualityStatus')?.value !== '1'">
                <option value="">Please Select</option>
                <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                  {{ getEmployeeDisplayName(employee) }}
                </option>
              </select>

              <!-- Passed Checkbox -->
              <div class="form-check form-check-custom form-check-solid p-3 border rounded bg-light mb-3">
                <input type="checkbox" class="form-check-input" formControlName="compPassed" id="compPassed" />
                <label class="form-check-label fw-bold text-success fs-6" for="compPassed">
                  <i class="ki-outline ki-verify me-1"></i>Passed
                </label>
              </div>
            </div>

            <!-- divGrp3: Assembly Section - Job Types 1,2,4 (Fan Rebuild, Cap Assy, Batt Module) -->
            <div *ngIf="isAssemblyJob" class="mb-4">
              <label class="form-label fw-bold text-dark fs-6 mb-2">
                <i class="ki-outline ki-user-tick me-1 text-primary"></i>Completed By:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold mb-3" formControlName="completedBy">
                <option value="">Please Select</option>
                <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                  {{ getEmployeeDisplayName(employee) }}
                </option>
              </select>

              <label class="form-label fw-bold text-dark fs-6 mt-3 mb-2">
                <i class="ki-outline ki-abstract-35 me-1 text-primary"></i>Assembly – Work Done:
              </label>
              <div class="row g-2 mb-3">
                <!-- Legacy NON-CONTIGUOUS values: 1,2,4,5,6,7 (no value 3) -->
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone1" id="aw1" /><label class="form-check-label text-dark fw-bold fs-6" for="aw1">Cleaned</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone2" id="aw2" /><label class="form-check-label text-dark fw-bold fs-6" for="aw2">Parts Replaced</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone3" id="aw4" /><label class="form-check-label text-dark fw-bold fs-6" for="aw4">Inspected For Damage</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone4" id="aw5" /><label class="form-check-label text-dark fw-bold fs-6" for="aw5">Refurbished</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone5" id="aw6" /><label class="form-check-label text-dark fw-bold fs-6" for="aw6">Repaired</label></div></div>
                <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone6" id="aw7" /><label class="form-check-label text-dark fw-bold fs-6" for="aw7">Not Repairable</label></div></div>
              </div>

              <!-- Procedure Followed -->  
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-3">
                  <i class="ki-outline ki-check-square me-1 text-primary"></i>Assembly - Procedure Followed:
                </label>
                <div class="row g-2">
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyProcFollowed1" id="apf1" /><label class="form-check-label text-dark fw-bold fs-6" for="apf1">Yes</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyProcFollowed2" id="apf2" /><label class="form-check-label text-dark fw-bold fs-6" for="apf2">No</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyProcFollowed3" id="apf3" /><label class="form-check-label text-dark fw-bold fs-6" for="apf3">N/A</label></div></div>
                </div>
              </div>

              <!-- Assembly Status -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-status me-1 text-primary"></i>Assembly Status:
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="assyWorkStatus">
                  <option value="0">Please Select</option>
                  <option value="1">Completed</option>
                  <option value="2">In Progress</option>
                  <option value="3">Waiting on Parts</option>
                </select>
              </div>

              <!-- Reviewed By + Passed -->
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark fs-6">
                    <i class="ki-outline ki-user-edit me-1 text-primary"></i>Reviewed By:
                  </label>
                  <select class="form-select form-select-solid text-dark fw-semibold" 
                          formControlName="reviewedBy"
                          [disabled]="!editForm.get('assyWorkStatus')?.value || editForm.get('assyWorkStatus')?.value !== '1'">
                    <option value="">Please Select</option>
                    <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                      {{ getEmployeeDisplayName(employee) }}
                    </option>
                  </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-check form-check-custom form-check-solid p-3 border rounded bg-light">
                    <input type="checkbox" class="form-check-input" formControlName="isPassed" id="passed" (change)="onPassedCheck()" />
                    <label class="form-check-label fw-bold text-success fs-6" for="passed">
                      <i class="ki-outline ki-verify me-1"></i>Passed
                    </label>
                  </div>
                </div>
              </div>

              <!-- Quality Check - Work Done -->
              <div class="card border shadow-sm mb-4">
                <div class="card-header bg-success">
                  <h6 class="card-title mb-0 text-white fw-bold">
                    <i class="ki-outline ki-shield-check me-2"></i>Quality Check - Work Done
                  </h6>
                </div>
                <div class="card-body bg-white">
                  <div class="row g-2">
                    <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcWorkDone1" id="qc1" /><label class="form-check-label text-dark fw-bold fs-6" for="qc1">Cleaned</label></div></div>
                    <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcWorkDone2" id="qc2" /><label class="form-check-label text-dark fw-bold fs-6" for="qc2">Torqued</label></div></div>
                    <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcWorkDone3" id="qc3" /><label class="form-check-label text-dark fw-bold fs-6" for="qc3">Inspected</label></div></div>
                  </div>
                </div>
              </div>

              <!-- QC Procedure Followed -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-3">
                  <i class="ki-outline ki-check-square me-1 text-primary"></i>QC - Procedure Followed:
                </label>
                <div class="row g-2">
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcProcFollowed1" id="qcpf1" /><label class="form-check-label text-dark fw-bold fs-6" for="qcpf1">Yes</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcProcFollowed2" id="qcpf2" /><label class="form-check-label text-dark fw-bold fs-6" for="qcpf2">No</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcProcFollowed3" id="qcpf3" /><label class="form-check-label text-dark fw-bold fs-6" for="qcpf3">N/A</label></div></div>
                </div>
              </div>

              <!-- Quality Approved -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-3">
                  <i class="ki-outline ki-shield-tick me-1 text-primary"></i>Quality Approved:
                </label>
                <div class="row g-2">
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcApproved1" id="qca1" /><label class="form-check-label text-dark fw-bold text-success fs-6" for="qca1">Pass</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcApproved2" id="qca2" /><label class="form-check-label text-dark fw-bold text-danger fs-6" for="qca2">Fail</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcApproved3" id="qca3" /><label class="form-check-label text-dark fw-bold fs-6" for="qca3">N/A</label></div></div>
                </div>
              </div>

              <!-- Quality Status -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-shield-cross me-1 text-primary"></i>Quality Status:
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="qcWorkStatus">
                  <option value="0">Please Select</option>
                  <option value="1">Completed</option>
                  <option value="2">In Progress</option>
                  <option value="3">Not Acceptable</option>
                </select>
              </div>

              <!-- COMMENTED OUT: QC Approved By and QC Passed section
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark fs-6">
                    <i class="ki-outline ki-user-edit me-1 text-primary"></i>QC Approved By:
                  </label>
                  <select class="form-select form-select-solid text-dark fw-semibold" 
                          formControlName="qcApprovedBy"
                          [disabled]="!editForm.get('qcWorkStatus')?.value || editForm.get('qcWorkStatus')?.value !== '1'">
                    <option value="">Please Select</option>
                    <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                      {{ getEmployeeDisplayName(employee) }}
                    </option>
                  </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-check form-check-custom form-check-solid p-3 border rounded bg-light">
                    <input type="checkbox" class="form-check-input" formControlName="qcPassed" id="qcPassed" />
                    <label class="form-check-label fw-bold text-success fs-6" for="qcPassed">
                      <i class="ki-outline ki-verify me-1"></i>QC Passed
                    </label>
                  </div>
                </div>
              </div>
              -->

            <!-- Always Visible Quality Section -->
            <div class="mb-4">
              <label class="form-label fw-bold text-dark fs-6 mb-2">
                <i class="ki-outline ki-shield-check me-1 text-primary"></i>Quality:
              </label>
              <select class="form-select form-select-solid text-dark fw-semibold" formControlName="qualityStatus">
                <option value="0">Please Select</option>
                <option value="1">Pass</option>
                <option value="2">Fail</option>
                <option value="3">N/A</option>
              </select>
            </div>

            <!-- Common txtResolveNotes - Always Visible -->
            <div class="card border shadow-sm mb-4">
              <div class="card-header bg-primary">
                <h6 class="card-title mb-0 text-white fw-bold">
                  <i class="ki-outline ki-notepad-edit me-2"></i>Resolution Notes
                </h6>
              </div>
              <div class="card-body bg-white">
                <div class="mb-0">
                  <textarea class="form-control form-control-solid text-dark fw-semibold auto-resize-textarea" 
                           formControlName="resolveNotes" 
                           rows="6" 
                           placeholder="Enter resolution notes..." 
                           style="min-height: 120px; resize: vertical; overflow-y: auto;"
                           (input)="onTextareaInput($event)"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <!-- </form> -->
</div>

<!-- Delete Confirmation Dialog (Only when needed) -->
<div *ngIf="showDeleteConfirm" class="modal fade show d-block" style="background: rgba(0,0,0,.5); z-index: 1050;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-danger">
        <h5 class="modal-title text-white fw-bold">
          <i class="ki-outline ki-warning fs-2 me-2"></i>
          Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body bg-white">
        <div class="text-center py-3">
          <i class="ki-outline ki-information-5 fs-3x text-warning mb-3"></i>
          <p class="text-dark fw-semibold fs-5 mb-2">Are you sure you want to delete this Parts Test entry?</p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-light-secondary fw-bold" (click)="cancelDelete()">
          <i class="ki-outline ki-cross me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-danger fw-bold" (click)="deleteItem()">
          <i class="ki-outline ki-trash me-2"></i>Delete Entry
        </button>
      </div>
    </div>
  </div>
</div>
