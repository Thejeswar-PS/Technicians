<!-- Parts Test Info Page -->
<div class="container-fluid p-4">
  
  <!-- Page Header -->
  <div class="parts-test-header__top d-flex justify-content-between align-items-center mb-4">
    <button type="button" class="btn btn-sm btn-primary parts-test-header__back" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>Back
    </button>
    
    <div class="parts-page-title">
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-clipboard-data me-2"></i>Parts Test Info
      </h2>
    </div>
    
    <div class="flex-shrink-0"></div>
  </div>

  <form [formGroup]="editForm">
    
    <!-- Auto Generated ID Section - Badge/Pill Style -->
    <div class="auto-gen-id-container d-flex align-items-center justify-content-center mb-4">
      <div class="d-flex align-items-center gap-3">
        <span class="auto-gen-label">
          <i class="bi bi-hash me-2"></i>Auto Generated ID
        </span>
        <div class="auto-gen-badge">
          <i class="bi bi-barcode-scan me-2"></i>
          <span class="auto-gen-id-text">{{ getFormattedAutoGenId() }}</span>
        </div>
      </div>
    </div>

    <!-- Main Content: Two Column Layout -->
    <div class="row g-4">
      <!-- Left Column: Parts Testing Info Entry -->
      <div class="col-lg-6">
        <div class="card shadow border h-100">
          <div class="card-header bg-info">
            <h5 class="card-title text-white mb-0 fw-bold">
              <i class="ki-outline ki-setting-2 fs-2 me-2"></i>
              Parts Testing Info Entry
            </h5>
          </div>
          <div class="card-body bg-white">


            <!-- Basic Information -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-category me-1 text-primary"></i>Job Type <span class="text-danger">*</span>
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="jobFrom" (change)="onJobTypeChange($any($event.target).value)">
                  <option value="1">Fan Rebuild</option>
                  <option value="2">Cap Assy.</option>
                  <option value="4">Batt Module</option>
                  <option value="3">Inventory</option>
                  <option value="7">Board Setup</option>
                  <option value="6">Retest</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-abstract-26 me-1 text-primary"></i>Job Number
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="jobNumber" maxlength="11" placeholder="Enter job number" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-geolocation me-1 text-primary"></i>Site ID
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="siteID" placeholder="Enter site ID" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-cube-2 me-1 text-primary"></i>Make
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="make" maxlength="21" placeholder="Enter make" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-element-7 me-1 text-primary"></i>Model
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="model" maxlength="21" placeholder="Enter model" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-electricity me-1 text-primary"></i>KVA
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="kva" placeholder="Enter KVA" (keypress)="onlyNumbersAndDecimal($event)" (paste)="onPasteDecimals($event)" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-flash me-1 text-primary"></i>Voltage
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="voltage" placeholder="Enter voltage" (keypress)="onlyNumbersAndDecimal($event)" (paste)="onPasteDecimals($event)" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-barcode me-1 text-primary"></i>Manuf Part # <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="manufPartNo" [class.is-invalid]="isFieldInvalid('manufPartNo')" placeholder="Enter manufacturer part number" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('manufPartNo') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-scan-barcode me-1 text-primary"></i>DCG Part # <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="dcgPartNo" [class.is-invalid]="isFieldInvalid('dcgPartNo')" placeholder="Enter DCG part number" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('dcgPartNo') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-lots-shopping me-1 text-primary"></i>Quantity <span class="text-danger">*</span>
                </label>
                <input type="number" class="form-control form-control-solid text-dark fw-semibold" formControlName="quantity" min="1" max="999" [class.is-invalid]="isFieldInvalid('quantity')" placeholder="Enter quantity" (keypress)="onlyNumbers($event)" (paste)="onPasteNumbers($event)" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('quantity') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-tag me-1 text-primary"></i>Serial No
                </label>
                <input type="text" class="form-control form-control-solid text-dark fw-semibold" formControlName="serialNo" placeholder="Enter serial number" />
              </div>
            </div>
            
            <!-- Work Type Section -->
            <div class="card border shadow-sm mb-4">
              <div class="card-header bg-primary">
                <h6 class="card-title mb-0 text-white fw-bold">
                  <i class="ki-outline ki-setting-3 me-2"></i>Work Type Selection <span class="text-warning">*</span>
                </h6>
              </div>
              <div class="card-body bg-white">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType1" id="wt1" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt1">Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType2" id="wt2" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt2">Repair</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType3" id="wt3" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt3">WH Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType4" id="wt4" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt4">Field Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType5" id="wt5" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt5">Shipping Refurbish</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType6" id="wt6" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt6">Shipping Damage</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType7" id="wt7" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt7">Clean Parts/Components</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType8" id="wt8" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt8">Parts ASSY</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType9" id="wt9" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt9">Remove from Unit to Ship</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType10" id="wt10" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt10">Re-test from Inventory</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType11" id="wt11" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt11">Test</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-check-custom form-check-solid p-2 border rounded">
                      <input class="form-check-input" type="checkbox" formControlName="workType12" id="wt12" />
                      <label class="form-check-label text-dark fw-bold fs-6" for="wt12">Board Setup</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Assignment Information -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-user-tick me-1 text-primary"></i>Created By <span class="text-danger">*</span>
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="createdBy" [class.is-invalid]="isFieldInvalid('createdBy')" [disabled]="isLoadingCreatedByEmployees || !!editingItem">
                  <option value="">{{ isLoadingCreatedByEmployees ? 'Loading P & T Employees...' : 'Select Employee' }}</option>
                  <option *ngFor="let employee of getCreatedByEmployeeOptions()" [value]="employee.windowsID">
                    {{ getEmployeeDisplayName(employee) }}
                  </option>
                </select>
                <div class="invalid-feedback fw-semibold">{{ getFieldError('createdBy') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-profile-user me-1 text-primary"></i>Assigned To <span class="text-danger">*</span>
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="assignedTo" [class.is-invalid]="isFieldInvalid('assignedTo')" [disabled]="isLoadingEmployees">
                  <option value="">{{ isLoadingEmployees ? 'Loading TC Employees...' : 'Select Employee' }}</option>
                  <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                    {{ getEmployeeDisplayName(employee) }}
                  </option>
                </select>
                <div class="invalid-feedback fw-semibold">{{ getFieldError('assignedTo') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-calendar me-1 text-primary"></i>Due Date <span class="text-danger">*</span>
                </label>
                <input type="date" class="form-control form-control-solid text-dark fw-semibold" formControlName="dueDate" [class.is-invalid]="isFieldInvalid('dueDate')" />
                <div class="invalid-feedback fw-semibold">{{ getFieldError('dueDate') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-calendar-2 me-1 text-primary"></i>Submitted Date
                </label>
                <input type="date" class="form-control form-control-solid text-dark fw-semibold" formControlName="submittedDate" />
              </div>
              <div class="col-md-6 d-flex align-items-center">
                <div class="form-check form-check-custom form-check-solid mt-8 p-3 border rounded bg-light">
                  <input class="form-check-input" type="checkbox" formControlName="approved" id="approved" (change)="onApprovedChange()" />
                  <label class="form-check-label fw-bold text-dark fs-6" for="approved">
                    <i class="ki-outline ki-verify me-1 text-success"></i>Approved
                  </label>
                </div>
              </div>
            </div>

            <!-- Description and Notes -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-note-2 me-1 text-primary"></i>Description
                </label>
                <textarea class="form-control form-control-solid text-dark fw-semibold" formControlName="description" rows="3" placeholder="Enter description..." style="resize: vertical;"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-message-text me-1 text-primary"></i>Deficiency Notes <span class="text-danger">*</span>
                </label>
                <textarea class="form-control form-control-solid text-dark fw-semibold" formControlName="problemNotes" rows="3" [class.is-invalid]="isFieldInvalid('problemNotes')" placeholder="Enter deficiency notes..." style="resize: vertical;"></textarea>
                <div class="invalid-feedback fw-semibold">{{ getFieldError('problemNotes') }}</div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-3 flex-wrap justify-content-end mt-4 pt-3 border-top">
              <button type="button" class="btn btn-primary btn-lg fw-bold" (click)="saveItem()" [disabled]="isSaving || !isAddEntryEnabled">
                <i class="ki-outline ki-check fs-3 me-2" *ngIf="!isSaving"></i>
                <span class="spinner-border spinner-border-sm me-2" *ngIf="isSaving"></span>
                {{ editingItem ? 'Update Entry' : 'Add Entry' }}
              </button>
              <button type="button" class="btn btn-success btn-lg fw-bold" (click)="createNewItem()" *ngIf="editingItem && saveMessage">
                <i class="ki-outline ki-plus fs-3 me-2"></i>
                Create New Entry
              </button>
              <button type="button" class="btn btn-secondary btn-lg fw-bold" (click)="clearForm()">
                <i class="ki-outline ki-eraser fs-3 me-2"></i>
                {{ editingItem && saveMessage ? 'Clear & Start New' : 'Clear Form' }}
              </button>
              <button type="button" class="btn btn-danger" (click)="confirmDeleteItem(editingItem)" *ngIf="editingItem">
                <i class="ki-outline ki-trash fs-4 me-1"></i>
                Delete Entry
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Result Of Inspection -->
      <div class="col-lg-6">
        <div class="card shadow border h-100">
          <div class="card-header bg-success">
            <h5 class="card-title text-white mb-0 fw-bold">
              <i class="ki-outline ki-verify fs-2 me-2"></i>
              Result Of Inspection
            </h5>
          </div>
          <div class="card-body bg-white">
            <!-- Success/Error Messages -->
            <div *ngIf="saveMessage" class="alert alert-success d-flex align-items-center mb-4">
              <i class="ki-outline ki-check-circle fs-2 me-3"></i>
              <span class="text-dark fw-semibold">{{ saveMessage }}</span>
            </div>
            <div *ngIf="errorMessage" class="alert alert-danger d-flex align-items-center mb-4">
              <i class="ki-outline ki-cross-circle fs-2 me-3"></i>
              <span class="text-dark fw-semibold">{{ errorMessage }}</span>
            </div>

            <!-- divGrp1: Inventory/Retest Job Types (3, 6) -->
            <div *ngIf="isComponentJob" class="card border shadow-sm mb-4">
              <div class="card-header bg-primary">
                <h6 class="card-title mb-0 text-white fw-bold">
                  <i class="ki-outline ki-wrench me-2"></i>Component Testing & Work Done
                </h6>
              </div>
              <div class="card-body bg-white">
              <!-- Component - Work Done -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-3">
                  <i class="ki-outline ki-wrench me-1 text-primary"></i>Component - Work Done:
                </label>
                <div class="row g-2">
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone1" id="cw1" /><label class="form-check-label text-dark fw-bold fs-6" for="cw1">Cleaned</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone2" id="cw2" /><label class="form-check-label text-dark fw-bold fs-6" for="cw2">Refurbished</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone3" id="cw3" /><label class="form-check-label text-dark fw-bold fs-6" for="cw3">Parts Replaced</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone4" id="cw4" /><label class="form-check-label text-dark fw-bold fs-6" for="cw4">Repaired</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone5" id="cw5" /><label class="form-check-label text-dark fw-bold fs-6" for="cw5">Inspected for Damage</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="compWorkDone6" id="cw6" /><label class="form-check-label text-dark fw-bold fs-6" for="cw6">Not Repairable</label></div></div>
                </div>
              </div>

              <!-- Part Repair Status -->
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark fs-6">
                    <i class="ki-outline ki-status me-1 text-primary"></i>Part Repair Status:
                  </label>
                  <select class="form-select form-select-solid text-dark fw-semibold" formControlName="partRepairStatus">
                    <option value="0">Please Select</option>
                    <option value="1">Ready For Test</option>
                    <option value="2">Non Repairable</option>
                    <option value="3">Need Parts</option>
                    <option value="4">In Progress</option>
                  </select>
                </div>
              </div>

              <!-- Testing Work Done -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-3">
                  <i class="ki-outline ki-rocket me-1 text-primary"></i>Testing - Work Done:
                </label>
                <div class="row g-2">
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="testWorkDone1" id="tw1" /><label class="form-check-label text-dark fw-bold fs-6" for="tw1">Testing In Unit</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="testWorkDone2" id="tw2" /><label class="form-check-label text-dark fw-bold fs-6" for="tw2">Load Tested</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="testWorkDone3" id="tw3" /><label class="form-check-label text-dark fw-bold fs-6" for="tw3">No Unit To Test</label></div></div>
                </div>
              </div>

              <!-- Final Status -->
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark fs-6">
                    <i class="ki-outline ki-check-circle me-1 text-primary"></i>Final Status:
                  </label>
                  <select class="form-select form-select-solid text-dark fw-semibold" formControlName="testWorkStatus">
                    <option value="0">Please Select</option>
                    <option value="1">Completed</option>
                    <option value="2">In Progress</option>
                    <option value="3">Needs Unit</option>
                    <option value="4">Non Testable</option>
                  </select>
                </div>
              </div>
              </div>
            </div>

            <!-- Assembly & QC Section (Conditional) -->
            <div *ngIf="isAssemblyJob" class="card mb-4 border shadow-sm">
              <div class="card-header bg-primary">
                <h6 class="card-title text-white mb-0 fw-bold">
                  <i class="ki-outline ki-delivery-3 me-2"></i>
                  Assembly & Quality Control
                </h6>
              </div>
              <div class="card-body bg-white">
                <!-- Completed By -->
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-dark fs-6">
                      <i class="ki-outline ki-user-tick me-1 text-primary"></i>Completed By:
                    </label>
                    <select class="form-select form-select-solid text-dark fw-semibold" formControlName="completedBy">
                      <option value="">Please Select</option>
                      <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                        {{ getEmployeeDisplayName(employee) }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Assembly Work Done -->
                <div class="mb-4">
                  <label class="form-label fw-bold text-dark fs-6 mb-3">
                    <i class="ki-outline ki-abstract-35 me-1 text-primary"></i>Assembly - Work Done:
                  </label>
                <div class="row g-2">
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone1" id="aw1" /><label class="form-check-label text-dark fw-bold fs-6" for="aw1">Cleaned</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone2" id="aw2" /><label class="form-check-label text-dark fw-bold fs-6" for="aw2">Parts Replaced</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone3" id="aw3" /><label class="form-check-label text-dark fw-bold fs-6" for="aw3">Inspected For Damage</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone4" id="aw4" /><label class="form-check-label text-dark fw-bold fs-6" for="aw4">Refurbished</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone5" id="aw5" /><label class="form-check-label text-dark fw-bold fs-6" for="aw5">Repaired</label></div></div>
                  <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="assyWorkDone6" id="aw6" /><label class="form-check-label text-dark fw-bold fs-6" for="aw6">Not Repairable</label></div></div>
                </div>
              </div>

              <!-- Test Procedure Link -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-document me-1 text-primary"></i>Test Procedure:
                </label>
                <div class="mt-2">
                  <button type="button" 
                          (click)="openTestProcedure()"
                          class="btn btn-light-primary btn-sm fw-bold">
                    <i class="ki-outline ki-file-down me-1"></i>Click Here
                  </button>
                </div>
              </div>

              <!-- Procedure Followed -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-2">
                  <i class="ki-outline ki-check-square me-1 text-primary"></i>Procedure Followed:
                </label>
                <div class="d-flex gap-3">
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="assyProcFollowed" value="1" id="proc1" />
                    <label class="form-check-label text-dark fw-bold" for="proc1">Yes</label>
                  </div>
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="assyProcFollowed" value="2" id="proc2" />
                    <label class="form-check-label text-dark fw-bold" for="proc2">No</label>
                  </div>
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="assyProcFollowed" value="3" id="proc3" />
                    <label class="form-check-label text-dark fw-bold" for="proc3">NA</label>
                  </div>
                </div>
              </div>

              <!-- Assembly Status -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-status me-1 text-primary"></i>Assembly Status:
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="assyWorkStatus">
                  <option value="0">Please Select</option>
                  <option value="1">Completed</option>
                  <option value="2">In Progress</option>
                  <option value="3">Waiting on Parts</option>
                </select>
              </div>

              <!-- Reviewed By + Passed -->
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark fs-6">
                    <i class="ki-outline ki-user-edit me-1 text-primary"></i>Reviewed By:
                  </label>
                  <select class="form-select form-select-solid text-dark fw-semibold" formControlName="reviewedBy">
                    <option value="">Please Select</option>
                    <option *ngFor="let employee of getEmployeeOptions()" [value]="employee.empName">
                      {{ getEmployeeDisplayName(employee) }}
                    </option>
                  </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-check form-check-custom form-check-solid p-3 border rounded bg-light">
                    <input type="checkbox" class="form-check-input" formControlName="isPassed" id="passed" (change)="onPassedCheck()" />
                    <label class="form-check-label fw-bold text-success fs-6" for="passed">
                      <i class="ki-outline ki-verify me-1"></i>Passed
                    </label>
                  </div>
                </div>
              </div>

              <!-- Quality Check - Work Done -->
              <div class="card border shadow-sm mb-4">
                <div class="card-header bg-success">
                  <h6 class="card-title mb-0 text-white fw-bold">
                    <i class="ki-outline ki-shield-check me-2"></i>Quality Check - Work Done
                  </h6>
                </div>
                <div class="card-body bg-white">
                  <div class="row g-2">
                    <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcWorkDone1" id="qc1" /><label class="form-check-label text-dark fw-bold fs-6" for="qc1">Cleaned</label></div></div>
                    <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcWorkDone2" id="qc2" /><label class="form-check-label text-dark fw-bold fs-6" for="qc2">Torqued</label></div></div>
                    <div class="col-md-4"><div class="form-check form-check-custom form-check-solid p-2 border rounded"><input type="checkbox" class="form-check-input" formControlName="qcWorkDone3" id="qc3" /><label class="form-check-label text-dark fw-bold fs-6" for="qc3">Inspected</label></div></div>
                  </div>
                </div>
              </div>

              <!-- QC Procedure Followed -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-2">
                  <i class="ki-outline ki-check-square me-1 text-primary"></i>QC Procedure Followed:
                </label>
                <div class="d-flex gap-3">
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="qcProcFollowed" value="1" id="qcProc1" />
                    <label class="form-check-label text-dark fw-bold" for="qcProc1">Yes</label>
                  </div>
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="qcProcFollowed" value="2" id="qcProc2" />
                    <label class="form-check-label text-dark fw-bold" for="qcProc2">No</label>
                  </div>
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="qcProcFollowed" value="3" id="qcProc3" />
                    <label class="form-check-label text-dark fw-bold" for="qcProc3">NA</label>
                  </div>
                </div>
              </div>

              <!-- Quality Approved -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6 mb-2">
                  <i class="ki-outline ki-shield-tick me-1 text-primary"></i>Quality Approved:
                </label>
                <div class="d-flex gap-3">
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="qcApproved" value="1" id="qcApp1" />
                    <label class="form-check-label text-dark fw-bold text-success" for="qcApp1">Pass</label>
                  </div>
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="qcApproved" value="2" id="qcApp2" />
                    <label class="form-check-label text-dark fw-bold text-danger" for="qcApp2">Fail</label>
                  </div>
                  <div class="form-check form-check-custom form-check-solid">
                    <input type="radio" class="form-check-input" formControlName="qcApproved" value="3" id="qcApp3" />
                    <label class="form-check-label text-dark fw-bold" for="qcApp3">NA</label>
                  </div>
                </div>
              </div>

              <!-- Quality Status -->
              <div class="mb-4">
                <label class="form-label fw-bold text-dark fs-6">
                  <i class="ki-outline ki-shield-cross me-1 text-primary"></i>Quality Status:
                </label>
                <select class="form-select form-select-solid text-dark fw-semibold" formControlName="qcWorkStatus">
                  <option value="0">Please Select</option>
                  <option value="1">Completed</option>
                  <option value="2">In Progress</option>
                  <option value="3">Not Acceptable</option>
                </select>
              </div>
            </div>

            <!-- Board Setup Section (Conditional) -->
            <div *ngIf="isBoardSetupJob" class="card mb-4 border shadow-sm">
              <div class="card-header bg-primary">
                <h6 class="card-title text-white mb-0 fw-bold">
                  <i class="ki-outline ki-technology-4 me-2"></i>
                  Board Setup Configuration
                </h6>
              </div>
              <div class="card-body bg-white">
                <!-- Board Setup Status -->
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-dark fs-6">
                      <i class="ki-outline ki-technology-4 me-1 text-primary"></i>Board Setup Status:
                    </label>
                    <select class="form-select form-select-solid text-dark fw-semibold" formControlName="boardSetup">
                      <option value="0">Please Select</option>
                      <option value="1">Completed</option>
                      <option value="2">Boards Are Completed</option>
                      <option value="3">In Progress</option>
                      <option value="4">Need Parts</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Common txtResolveNotes - Always Visible -->
            <div class="card border shadow-sm mb-4">
              <div class="card-header bg-primary">
                <h6 class="card-title mb-0 text-white fw-bold">
                  <i class="ki-outline ki-notepad-edit me-2"></i>Resolution Notes
                </h6>
              </div>
              <div class="card-body bg-white">
                <div class="mb-0">
                  <textarea class="form-control form-control-solid text-dark fw-semibold auto-resize-textarea" 
                           formControlName="resolveNotes" 
                           rows="6" 
                           placeholder="Enter resolution notes..." 
                           style="min-height: 120px; resize: vertical; overflow-y: auto;"
                           (input)="onTextareaInput($event)"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </form>
</div>

<!-- Delete Confirmation Dialog (Only when needed) -->
<div *ngIf="showDeleteConfirm" class="modal fade show d-block" style="background: rgba(0,0,0,.5); z-index: 1050;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-danger">
        <h5 class="modal-title text-white fw-bold">
          <i class="ki-outline ki-warning fs-2 me-2"></i>
          Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body bg-white">
        <div class="text-center py-3">
          <i class="ki-outline ki-information-5 fs-3x text-warning mb-3"></i>
          <p class="text-dark fw-semibold fs-5 mb-2">Are you sure you want to delete this Parts Test entry?</p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-light-secondary fw-bold" (click)="cancelDelete()">
          <i class="ki-outline ki-cross me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-danger fw-bold" (click)="deleteItem()">
          <i class="ki-outline ki-trash me-2"></i>Delete Entry
        </button>
      </div>
    </div>
  </div>
</div>
